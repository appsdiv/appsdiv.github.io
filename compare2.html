<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Similarity Analyzer</title>
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"
            integrity="sha256-R9JjPbyS/N/0sS+T52L/lVbqKEPOH/ovE/9L8xKvVGM="
            crossorigin="anonymous"></script>

    <style>
        /* --- General Styles --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1, h2 {
            color: #0d1a4e;
            text-align: center;
            font-weight: 600;
        }

        /* --- Loading Overlay --- */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            font-size: 1.2em;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Main Layout --- */
        .container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            width: 100%;
            max-width: 1400px;
            margin-top: 20px;
        }

        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        /* --- Section Styles (Reference & Comparison) --- */
        .section {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 25px;
        }

        /* --- File Input Styles --- */
        .upload-box {
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background-color: #f8faff;
            transition: background-color 0.2s ease;
        }
        
        .upload-box:hover {
            background-color: #eef5ff;
        }
        
        .upload-box p {
            margin: 0;
            font-size: 1.1em;
            color: #007bff;
            font-weight: 500;
        }

        input[type="file"] {
            display: none;
        }

        /* --- Reference Image Display --- */
        #reference-display {
            margin-top: 20px;
            text-align: center;
        }
        
        #reference-display .status {
            font-weight: 500;
            color: #555;
            margin-bottom: 10px;
        }
        
        .image-container {
            position: relative;
            max-width: 100%;
            margin: 0 auto;
        }

        .image-container img,
        .image-container canvas {
            max-width: 100%;
            border-radius: 6px;
        }
        
        .image-container canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        /* --- Comparison Results Grid --- */
        #comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-card {
            background: #fdfdfd;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
            padding-bottom: 10px;
        }

        .result-card .image-container {
            width: 100%;
            height: auto;
            aspect-ratio: 1 / 1; /* Makes the image container square */
        }

        .result-card img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensures image fills the square container */
            border-radius: 0;
        }
        
        .result-card canvas {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Scale canvas to fit */
        }

        .result-card .score {
            font-size: 1.5em;
            font-weight: 700;
            color: #0d1a4e;
            margin: 10px 0 5px;
        }

        .result-card .score-label {
            font-size: 0.9em;
            color: #65676b;
            margin: 0;
        }
        
        .result-card .status {
            font-size: 0.9em;
            color: #d93025; /* Red for errors */
            font-weight: 500;
            padding: 10px;
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p>Loading AI Models... (This may take a moment)</p>
    </div>

    <h1>Face Similarity Analyzer</h1>

    <div class="container">
        <div class="section" id="reference-section">
            <h2>1. Reference Face</h2>
            <label for="reference-input" class="upload-box" id="reference-dropzone">
                <p>Click or Drop Reference Image Here</p>
            </label>
            <input type="file" id="reference-input" accept="image/png, image/jpeg">
            
            <div id="reference-display">
                <p class="status">Please select a reference image.</p>
                <div class="image-container" id="reference-container">
                    </div>
            </div>
        </div>

        <div class="section" id="comparison-section">
            <h2>2. Comparison Faces</h2>
            <label for="comparison-input" class="upload-box" id="comparison-dropzone">
                <p>Click or Drop One or More Images to Compare</p>
            </label>
            <input type="file" id="comparison-input" accept="image/png, image/jpeg" multiple>
            
            <div id="comparison-grid">
                </div>
        </div>
    </div>

    <script>
        // --- Globals ---

        // ====================================================================
        // !! THIS IS THE CORRECTED LINE !!
        // The models are in the 'weights' folder of the GitHub repo, 
        // not a 'models' folder on the NPM package.
        // ====================================================================
        const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
        
        let referenceDescriptor = null;
        let isModelsLoaded = false;
        
        // --- DOM Elements ---
        const loader = document.getElementById('loader');
        const refInput = document.getElementById('reference-input');
        const refContainer = document.getElementById('reference-container');
        const refStatus = document.querySelector('#reference-display .status');
        const compInput = document.getElementById('comparison-input');
        const compGrid = document.getElementById('comparison-grid');
        
        // --- Drag & Drop Handlers ---
        function setupDragDrop(dropzoneId, inputId) {
            const dropzone = document.getElementById(dropzoneId);
            const fileInput = document.getElementById(inputId);

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, () => dropzone.style.backgroundColor = '#eef5ff', false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, () => dropzone.style.backgroundColor = '#f8faff', false);
            });

            dropzone.addEventListener('drop', (e) => {
                fileInput.files = e.dataTransfer.files;
                // Manually trigger the 'change' event
                fileInput.dispatchEvent(new Event('change'));
            }, false);

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
        }

        // --- Model Loading ---
        async function loadModels() {
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                loader.style.display = 'none';
                isModelsLoaded = true;
                console.log("AI Models loaded successfully.");
            } catch (error) {
                console.error("Error loading models:", error);
                loader.innerHTML = "<p>Error loading AI models. Please refresh the page.</p>";
            }
        }

        // --- Reference Image Handling ---
        async function handleReferenceImage(event) {
            if (!isModelsLoaded) return;
            
            const file = event.target.files[0];
            if (!file) return;

            // Clear previous state
            referenceDescriptor = null;
            refContainer.innerHTML = '';
            compGrid.innerHTML = '';
            refStatus.textContent = 'Processing...';

            // Create image and canvas elements
            const img = await faceapi.bufferToImage(file);
            const canvas = faceapi.createCanvasFromMedia(img);
            refContainer.append(img);
            refContainer.append(canvas);

            // Set canvas dimensions
            const displaySize = { width: img.width, height: img.height };
            faceapi.matchDimensions(canvas, displaySize);

            // Detect face
            const detection = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions())
                                           .withFaceLandmarks()
                                           .withFaceDescriptor();

            if (!detection) {
                refStatus.textContent = 'Error: No face detected.';
                refContainer.innerHTML = '';
                return;
            }

            // Draw detection box and landmarks
            const resizedDetection = faceapi.resizeResults(detection, displaySize);
            faceapi.draw.drawDetections(canvas, resizedDetection);
            faceapi.draw.drawFaceLandmarks(canvas, resizedDetection);

            // Store the descriptor
            referenceDescriptor = detection.descriptor;
            refStatus.textContent = 'Reference face processed.';
        }
        
        // --- Comparison Image Handling ---
        async function handleComparisonImages(event) {
            if (!isModelsLoaded) return;
            
            if (!referenceDescriptor) {
                alert("Please set a reference image first.");
                return;
            }
            
            const files = event.target.files;
            if (!files.length) return;

            compGrid.innerHTML = ''; // Clear previous results

            // Process all files concurrently
            const processingPromises = Array.from(files).map(file => processSingleComparison(file));
            await Promise.all(processingPromises);
        }

        async function processSingleComparison(file) {
            // Create a result card
            const card = document.createElement('div');
            card.className = 'result-card';
            
            const imageContainer = document.createElement('div');
            imageContainer.className = 'image-container';
            
            const statusText = document.createElement('p');
            statusText.className = 'status';
            statusText.textContent = 'Processing...';

            card.append(imageContainer);
            card.append(statusText);
            compGrid.append(card);

            try {
                // Create image and canvas
                const img = await faceapi.bufferToImage(file);
                const canvas = faceapi.createCanvasFromMedia(img);
                imageContainer.append(img);
                imageContainer.append(canvas);

                const displaySize = { width: img.width, height: img.height };
                faceapi.matchDimensions(canvas, displaySize);

                // Detect face
                const detection = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions())
                                               .withFaceLandmarks()
                                               .withFaceDescriptor();

                if (!detection) {
                    statusText.textContent = 'No face found';
                    imageContainer.innerHTML = ''; // Clear image if no face
                    imageContainer.append(img); // Re-add image without canvas
                    return;
                }

                // Draw detection
                const resizedDetection = faceapi.resizeResults(detection, displaySize);
                faceapi.draw.drawDetections(canvas, resizedDetection);
                faceapi.draw.drawFaceLandmarks(canvas, resizedDetection);

                // Calculate similarity
                const distance = faceapi.euclideanDistance(referenceDescriptor, detection.descriptor);
                
                // Convert distance to a 1-100 score
                // A distance of 0.0 is a perfect match (100)
                // A distance of 0.6 is the default "no match" threshold (0)
                const similarityScore = Math.max(0, (1 - distance / 0.6) * 100);
                const score = Math.round(similarityScore);

                // Display score
                statusText.remove(); // Remove "Processing..."
                card.innerHTML += `
                    <p class="score">${score}</p>
                    <p class="score-label">Similarity</p>
                `;

            } catch (error) {
                console.error("Error processing comparison image:", error);
                statusText.textContent = 'Error processing';
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            loadModels();
            refInput.addEventListener('change', handleReferenceImage);
            compInput.addEventListener('change', handleComparisonImages);
            
            // Setup drag & drop
            setupDragDrop('reference-dropzone', 'reference-input');
            setupDragDrop('comparison-dropzone', 'comparison-input');
        });

    </script>
</body>
</html>