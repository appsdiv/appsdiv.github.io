<!DOCTYPE html>
<html lang="fa" dir="rtl" class="">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>روزا | مدیریت عادت و هدف</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/tZQx9M8/rooza-app.png">
    <link rel="apple-touch-icon" href="https://i.ibb.co/tZQx9M8/rooza-app.png">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: 'Vazirmatn', sans-serif; }
        .sortable-ghost { opacity: 0.4; background-color: #cce7ff; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Animations */
        .goal-anim-in { animation: goal-fade-in 0.4s ease-out forwards; }
        .goal-anim-out { animation: goal-fade-out 0.3s ease-in forwards; }
        @keyframes goal-fade-in { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes goal-fade-out { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .cell-swipe-up { animation: cell-pop 0.2s ease-out forwards; }
        .cell-swipe-down { animation: cell-shrink 0.2s ease-out forwards; }
        @keyframes cell-pop { 0% { transform: scale(1); } 50% { transform: scale(1.15); background-color: hsla(120, 73%, 75%, 0.5); } 100% { transform: scale(1); } }
        @keyframes cell-shrink { 0% { transform: scale(1); } 50% { transform: scale(0.85); background-color: hsla(0, 100%, 80%, 0.5); } 100% { transform: scale(1); } }
        
        /* Glassmorphism & Modals */
        .glass-modal-content { @apply bg-slate-50/95 dark:bg-slate-900/95 backdrop-blur-xl border border-slate-200/50 dark:border-slate-700/50; background-color: #fbfbfbf2; }
        .dark .glass-modal-content { background-color: #0e0e0ef2; }
        
        /* Day Styles */
        .day-completed { background-color: #ebfaee !important; }
        .dark .day-completed { background-color: #163d228f !important; }

        /* Settings Menu */
        #settingsMenu { display: none; }
        #settingsMenu.visible { display: block; }
        
        /* Emoji Container */
        .emoji-container { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 9999px; transition: background-color 0.2s; background-color: #f1f5f9; }
        .dark .emoji-container { background-color: rgb(59 130 246 / 13%); }
        
        /* Reporting & Stats Modal Styles */
        .report-tab-btn { @apply flex-grow md:flex-grow-0 px-4 py-2.5 rounded-lg text-slate-600 dark:text-slate-300 transition-colors font-semibold flex items-center justify-center gap-2 bg-slate-200/60 dark:bg-slate-700/60 hover:bg-slate-300/70 dark:hover:bg-slate-600/80; }
        .report-tab-btn.active { @apply bg-indigo-600 text-white shadow-lg shadow-indigo-500/30; }

        .summary-card { @apply bg-white dark:bg-slate-800/70 p-4 rounded-xl text-center shadow-sm; }
        .summary-value { @apply text-2xl font-bold text-indigo-600 dark:text-indigo-400 mb-1; }
        .summary-label { @apply text-xs text-slate-500 dark:text-slate-400 font-semibold; }

        /* Yearly Heatmap Styles */
        .year-heatmap-container { @apply grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6; }
        .month-grid { @apply p-3 bg-white dark:bg-slate-800/50 rounded-xl shadow-sm; }
        .day-squares-grid { @apply grid grid-cols-7 gap-1.5; }
        .heatmap-square { @apply aspect-square rounded transition-colors relative; }
        .heatmap-square .tooltip { 
            @apply invisible opacity-0 absolute -top-10 left-1/2 -translate-x-1/2 w-max max-w-xs bg-slate-800 text-white text-xs rounded-md px-2 py-1 z-10 transition-opacity pointer-events-none; 
        }
        .heatmap-square:hover .tooltip { @apply visible opacity-100; }
        .heatmap-level-0 { @apply bg-slate-200 dark:bg-slate-700/60; }
        .heatmap-level-1 { @apply bg-indigo-200 dark:bg-indigo-900/60; }
        .heatmap-level-2 { @apply bg-indigo-400 dark:bg-indigo-700; }
        .heatmap-level-3 { @apply bg-indigo-600 dark:bg-indigo-500; }
        .heatmap-level-4 { @apply bg-indigo-800 dark:bg-indigo-400; }
    </style>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { primary: { DEFAULT: 'hsl(250, 85%, 60%)', dark: 'hsl(250, 90%, 70%)' }, accent: 'hsl(205, 90%, 55%)' } } } }
    </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 antialiased">
    <div class="min-h-screen pt-[env(safe-area-inset-top)]">
        <header id="navbar" class="sticky top-0 z-50 bg-white/80 dark:bg-slate-900/80 backdrop-blur-lg flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700">
            <div class="flex-1">
                <img src="https://i.ibb.co/tZQx9M8/rooza-app.png" alt="Rooza Logo" class="h-8 w-8">
            </div>
            <div class="flex items-center gap-2">
                <button id="nextWeekBtn" aria-label="هفته بعد" class="text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full p-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
                <div id="weekTitle" class="text-base md:text-lg font-bold text-indigo-600 dark:text-indigo-400 w-40 text-center"></div>
                <button id="prevWeekBtn" aria-label="هفته قبل" class="text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full p-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
            </div>
            <div class="flex-1 flex justify-end">
                <div class="relative">
                    <button id="settingsMenuBtn" aria-label="تنظیمات" class="text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full p-2 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                    <div id="settingsMenu" class="absolute left-0 mt-2 w-56 origin-top-left bg-white/80 dark:bg-slate-800/80 backdrop-blur-lg shadow-2xl rounded-xl border border-slate-200 dark:border-slate-700 p-2 text-base z-[1001]">
                        <button id="reportBtn" class="w-full text-right flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                            <span>گزارش‌ها</span>
                        </button>
                        <button id="archiveToggleBtn" class="w-full text-right flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                           <span>نمایش آرشیو</span>
                        </button>
                         <button id="darkModeBtn" class="w-full text-right flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                           <span class="text-xl w-5 text-center">🌙</span>
                           <span>تغییر تم</span>
                        </button>
                        <div class="my-1 h-px bg-slate-200 dark:bg-slate-700"></div>
                        <button id="backupBtn" class="w-full text-right flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M12 15l-3-3m0 0l3-3m-3 3h12" />
                           </svg>
                           <span>پشتیبان‌گیری</span>
                        </button>
                         <button id="aboutBtn" class="w-full text-right flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                           </svg>
                           <span>درباره روزا</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main id="mainContent" class="max-w-4xl mx-auto p-4 pb-32">
            <div id="currentDateDisplay" class="text-center text-sm text-slate-500 dark:text-slate-400 mb-6 font-semibold"></div>
            <div id="weekdayRow" class="grid grid-cols-7 gap-2 text-center mb-6"></div>
            <div id="categoryFilters" class="flex justify-center gap-2 mb-6 flex-wrap"></div>
            <div id="goalList" class="flex flex-col gap-4"></div>
            <div id="archivedGoalList" class="hidden">
                <h3 class="text-lg font-bold text-slate-500 dark:text-slate-400 my-4 p-2 border-b-2 border-slate-200 dark:border-slate-700">آرشیو شده‌ها</h3>
                <div class="flex flex-col gap-4"></div>
            </div>
        </main>

        <footer id="totalsBar" class="fixed bottom-0 left-0 right-0 z-40 bg-white/80 dark:bg-slate-900/80 backdrop-blur-lg border-t border-slate-200 dark:border-slate-700 flex items-center justify-around pb-[calc(env(safe-area-inset-bottom)+0.5rem)] pt-3 text-center"></footer>

        <button id="fab" aria-label="افزودن هدف" class="fixed right-6 bottom-[calc(env(safe-area-inset-bottom)+5rem)] z-50 w-16 h-16 bg-indigo-600 text-white rounded-full flex items-center justify-center text-3xl shadow-lg hover:bg-indigo-700 active:scale-90 transition-transform">＋</button>
    </div>

    <div id="modalArea"></div>
    <div id="contextMenu" class="fixed z-[1000] min-w-[180px] bg-white/80 dark:bg-slate-800/80 backdrop-blur-lg shadow-2xl rounded-xl border border-slate-200 dark:border-slate-700 p-2 text-base" style="display:none"></div>

<script>
    // --- CONSTANTS & CONFIG ---
    const EMOJIS = ['✅','🎉','🔥','💪','🎯','👍','👎','❌','🤔','😴','🍔','💻','🧘','📖'];
    const CATEGORIES = { 'ورزش': 'bg-sky-100 text-sky-800 dark:bg-sky-900/50 dark:text-sky-300', 'کار': 'bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300', 'شخصی': 'bg-violet-100 text-violet-800 dark:bg-violet-900/50 dark:text-violet-300', 'سلامتی': 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300' };
    const STORAGE_KEY = 'rooza_data_v1';
    const STORAGE_ORDER = 'rooza_order_v1';
    const STORAGE_THEME = 'rooza_theme_v1';
    const WEEKDAY_NAMES_SHORT = ['ش', 'ی', 'د', 'س', 'چ', 'پ', 'ج'];
    const JALALI_MONTH_NAMES = ["فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"];

    // --- STATE MANAGEMENT ---
    let appState = { currentWeek: getStartOfWeek(new Date()), goals: [], order: [], theme: 'auto', editing: null, showArchived: false, activeCategory: 'all', contextMenuGoalId: null };

    // --- JALALI DATE UTILITIES ---
    function toJalali(gy, gm, gd) { let g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334]; let jy = (gy <= 1600) ? 0 : 979; gy -= (gy <= 1600) ? 621 : 1600; let gy2 = (gm > 2) ? (gy + 1) : gy; let days = (365 * gy) + (parseInt((gy2 + 3) / 4)) - (parseInt((gy2 + 99) / 100)) + (parseInt((gy2 + 399) / 400)) - 80 + gd + g_d_m[gm - 1]; jy += 33 * (parseInt(days / 12053)); days %= 12053; jy += 4 * (parseInt(days / 1461)); days %= 1461; jy += parseInt((days - 1) / 365); if (days > 365) days = (days - 1) % 365; let jm = (days < 186) ? 1 + parseInt(days / 31) : 7 + parseInt((days - 186) / 30); let jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30)); return [jy, jm, jd]; }
    function toGregorian(jy, jm, jd) { let gy = (jy <= 979) ? 621 : 1600; jy -= (jy <= 979) ? 0 : 979; let days = (365 * jy) + (parseInt(jy / 33) * 8) + (parseInt(((jy % 33) + 3) / 4)) + 78 + jd + ((jm < 7) ? (jm - 1) * 31 : ((jm - 7) * 30) + 186); gy += 400 * (parseInt(days / 146097)); days %= 146097; if (days > 36524) { gy += 100 * (parseInt(--days / 36524)); days %= 36524; if (days >= 365) days++; } gy += 4 * (parseInt(days / 1461)); days %= 1461; gy += parseInt((days - 1) / 365); if (days > 365) days = (days - 1) % 365; let gd = days + 1; let sal_a = [0, 31, ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]; let gm; for (gm = 0; gm < 13 && gd > sal_a[gm]; gm++) gd -= sal_a[gm]; return new Date(gy, gm - 1, gd); }
    function isJalaliLeap(year) { return (((((year - 474) % 2820) + 512) * 682) % 2816) < 682; }
    function jalaliMonthLength(year, month) { if (month <= 6) return 31; if (month <= 11) return 30; if (isJalaliLeap(year)) return 30; return 29; }

    // --- UTILITY FUNCTIONS ---
    function toFa(num) { return (''+num).replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[+d]); }
    function getStartOfWeek(date) { const d = new Date(date); d.setHours(0, 0, 0, 0); d.setDate(d.getDate() - ((d.getDay() + 1) % 7)); return d; }
    function formatWeekRange(base) { const week = Array.from({length: 7}, (_, i) => { const d = new Date(base); d.setDate(base.getDate() + i); return d; }); const fmt = (d) => d.toLocaleDateString('fa-IR', { month: 'short', day: 'numeric' }); return `${fmt(week[6])} – ${fmt(week[0])}`; }
    function isToday(date) { const now = new Date(); return date.toDateString() === now.toDateString(); }
    function weekIdForDate(date) { const d = getStartOfWeek(date); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }
    function escapeHtml(txt) { return (''+txt).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g, '&quot;'); }

    // --- DATA PERSISTENCE & MIGRATION ---
    function getDefaultGoals() { const creationDate = new Date().toISOString(); const goals = [ { id: 'default_1', name: 'ورزش روزانه', emoji: '💪', days: [true, true, true, true, true, false, false], history: {}, type: 'binary', archived: false, category: 'ورزش', creationDate }, { id: 'default_2', name: 'خواندن کتاب', emoji: '📖', days: [true, true, true, true, true, true, true], history: {}, type: 'binary', archived: false, category: 'شخصی', creationDate }, { id: 'default_3', name: 'تمرین یک مهارت', emoji: '💻', days: [false, true, false, true, false, true, false], history: {}, type: 'binary', archived: false, category: 'کار', creationDate } ]; return { goals, order: goals.map(g => g.id) }; }
    function loadStateFromStorage() {
        let goals, orderArr;
        try {
            const data = localStorage.getItem(STORAGE_KEY);
            const order = localStorage.getItem(STORAGE_ORDER);
            if (data && order) { goals = JSON.parse(data); orderArr = JSON.parse(order); } else { const defaults = getDefaultGoals(); goals = defaults.goals; orderArr = defaults.order; }
        } catch (e) { console.error("Could not parse storage data, resetting to defaults.", e); const defaults = getDefaultGoals(); goals = defaults.goals; orderArr = defaults.order; }
        
        goals.forEach(g => { g.type = g.type || 'binary'; g.archived = g.archived || false; g.category = g.category || 'شخصی'; g.creationDate = g.creationDate || new Date().toISOString(); if (g.history) { Object.values(g.history).forEach(week => { if (Array.isArray(week)) { week.forEach((day, i) => { if (day && typeof day !== 'object') { week[i] = { entries: [day === 1 ? '✅' : '❌'], note: '' }; } else if (day && !day.entries) { week[i] = { entries: [], note: ''}; } }); } }); } });
        appState.goals = goals; appState.order = orderArr.filter(id => goals.some(g => g.id === id)); appState.theme = localStorage.getItem(STORAGE_THEME) || 'auto';
    }
    function persistState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appState.goals)); localStorage.setItem(STORAGE_ORDER, JSON.stringify(appState.order)); }
    function setTheme(theme) { appState.theme = theme; localStorage.setItem(STORAGE_THEME, theme); applyTheme(); }
    function applyTheme() { let themeToApply = appState.theme; if (themeToApply === 'auto') { themeToApply = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'; } document.documentElement.classList.toggle('dark', themeToApply === 'dark'); if(document.querySelector('#darkModeBtn .text-xl')) { document.querySelector('#darkModeBtn .text-xl').innerText = themeToApply === 'dark' ? '🌞' : '🌙'; } }

    // --- RENDER FUNCTIONS (Main UI) ---
    function fullRender() { renderHeader(); renderGoals(); renderTotals(); renderCategoryFilters(); applyTheme(); initSortable(); setupCellListeners(); if (appState.editing) { setTimeout(() => initEditInput(appState.editing), 30); } }
    function renderHeader() { document.getElementById('weekTitle').innerText = formatWeekRange(appState.currentWeek); const today = new Date(); document.getElementById('currentDateDisplay').innerText = `امروز ${today.toLocaleDateString('fa-IR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`; const weekDates = Array.from({length: 7}, (_, i) => { const d = new Date(appState.currentWeek); d.setDate(appState.currentWeek.getDate() + i); return d; }); document.getElementById('weekdayRow').innerHTML = weekDates.map((d, i) => { const dayNumber = toFa(new Date(d).toLocaleDateString('fa-IR-u-nu-latn', { day: 'numeric' })); let classes = "flex flex-col items-center justify-center p-2 rounded-lg transition-colors text-slate-500 dark:text-slate-400"; if (isToday(d)) { classes = "flex flex-col items-center justify-center p-2 rounded-lg transition-colors bg-indigo-600 text-white font-bold shadow-lg shadow-indigo-500/30"; } return `<div class="${classes}" data-day="${i}"><span class="text-sm font-semibold">${WEEKDAY_NAMES_SHORT[i]}</span><span class="text-xs mt-1">${dayNumber}</span></div>`; }).join(''); }
    function renderCategoryFilters() { const filters = ['all', ...Object.keys(CATEGORIES)]; document.getElementById('categoryFilters').innerHTML = filters.map(cat => { const isActive = appState.activeCategory === cat; const activeClass = 'bg-indigo-600 text-white'; const inactiveClass = 'bg-white dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600'; return `<button data-category="${cat}" class="px-4 py-2 text-sm font-semibold rounded-full shadow-sm transition-colors ${isActive ? activeClass : inactiveClass}">${cat === 'all' ? 'همه' : cat}</button>`; }).join(''); }
    function renderGoals() { const filteredGoals = appState.order.map(id => appState.goals.find(g => g.id === id)).filter(g => g && !g.archived && (appState.activeCategory === 'all' || g.category === appState.activeCategory)); const archivedGoals = appState.goals.filter(g => g && g.archived); document.getElementById('goalList').innerHTML = filteredGoals.length > 0 ? filteredGoals.map(renderSingleGoalCard).join('') : `<div class="text-center p-10 bg-white dark:bg-slate-800 rounded-2xl shadow-sm"><h3 class="font-bold text-lg text-slate-700 dark:text-slate-200 mb-2">شروع کنید!</h3><p class="text-slate-500 dark:text-slate-400 text-sm">هنوز هیچ عادتی نساخته‌اید. برای افزودن اولین عادت، دکمه ＋ را بزنید.</p></div>`; const archivedContainer = document.getElementById('archivedGoalList'); if (appState.showArchived && archivedGoals.length > 0) { archivedContainer.classList.remove('hidden'); archivedContainer.querySelector('.flex').innerHTML = archivedGoals.map(renderSingleGoalCard).join(''); } else { archivedContainer.classList.add('hidden'); } }
    function renderSingleGoalCard(goal) { const currentWeekId = weekIdForDate(appState.currentWeek); const { weekly } = calculateScores(goal); const dayCellsHtml = Array.from({length: 7}, (_, i) => { const date = new Date(appState.currentWeek); date.setDate(appState.currentWeek.getDate() + i); const dayData = goal.history?.[currentWeekId]?.[i] || { entries: [], note: '' }; const dayCompleted = dayData.entries.length > 0; let classes = "goal-day group aspect-square rounded-full flex items-center justify-center relative transition-colors cursor-pointer " + (goal.days[i] ? "active bg-slate-200 dark:bg-slate-700/50 hover:bg-slate-300 dark:hover:bg-slate-600" : "bg-slate-100 dark:bg-slate-800/50 opacity-60 !cursor-not-allowed"); if(dayCompleted) classes += ' day-completed'; if (goal.days[i] && isToday(date)) classes += " border-2 border-sky-500 shadow-md shadow-sky-500/30"; let cellContent = `<div class="flex flex-wrap items-center justify-center gap-px leading-none p-1">${dayData.entries.map(em => `<span class="text-sm md:text-base">${escapeHtml(em)}</span>`).join('')}</div>`; return `<div class="${classes}" data-goal-id="${goal.id}" data-day-index="${i}" tabindex="0">${cellContent}${dayData.note ? `<div class="absolute top-0 right-0 w-2 h-2 bg-amber-400 rounded-full" title="${escapeHtml(dayData.note)}"></div>` : ''}</div>`; }).join(''); return `<div class="goal-card bg-white dark:bg-slate-800 shadow-md rounded-2xl p-4 goal-anim-in ${goal.archived ? 'opacity-60' : ''}" data-id="${goal.id}"><div class="flex items-center gap-2 mb-4"><div class="emoji-container text-3xl">${goal.emoji || '🎯'}</div><div class="flex-grow min-w-0"><div class="flex items-center gap-2">${appState.editing === goal.id ? `<input class="w-full bg-slate-100 dark:bg-slate-700 text-lg font-bold p-2 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" id="edit-${goal.id}" value="${escapeHtml(goal.name)}">` : `<h3 class="text-lg font-bold truncate cursor-pointer hover:text-indigo-600" onclick="showStatsModal('${goal.id}')">${escapeHtml(goal.name || 'بی‌نام')}</h3>`}</div><div class="flex items-center gap-2 flex-wrap text-sm text-slate-500 dark:text-slate-400 mt-1"><span class="text-xs font-semibold px-3 py-1 rounded-full ${CATEGORIES[goal.category] || ''}">${goal.category}</span><span>|</span><span class="weekly-score">امتیاز هفته: ${toFa(weekly)}</span></div></div><button onclick="showContextMenu(event, '${goal.id}')" class="text-slate-400 dark:text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full p-2 transition-colors"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4zm0 10a2 2 0 110-4 2 2 0 010 4z"/></svg></button>${!goal.archived ? `<div class="goal-handle text-slate-400 dark:text-slate-500 cursor-grab p-2 text-xl">&#x2630;</div>` : ''}</div><div class="grid grid-cols-7 gap-2">${dayCellsHtml}</div></div>`; }
    function renderTotals() { const activeGoals = appState.goals.filter(g => !g.archived); let weeklyScore = 0, allTimeScore = 0; activeGoals.forEach(g => { const scores = calculateScores(g); weeklyScore += scores.weekly; allTimeScore += scores.allTime; }); document.getElementById('totalsBar').innerHTML = `<div class="flex-1"><div class="font-bold text-lg text-indigo-600 dark:text-indigo-400">${toFa(weeklyScore)}</div><div class="text-xs text-slate-500">امتیاز هفته</div></div><div class="flex-1"><div class="font-bold text-lg text-indigo-600 dark:text-indigo-400">${toFa(allTimeScore)}</div><div class="text-xs text-slate-500">امتیاز کل</div></div>`; }

    // --- CALCULATIONS ---
    function getEntryCountOnDate(goal, date) { if (!date || !goal) return 0; const dayOfWeek = (new Date(date.getFullYear(), date.getMonth(), date.getDate()).getDay() + 1) % 7; return goal.history?.[weekIdForDate(date)]?.[dayOfWeek]?.entries?.length || 0; }
    function calculateScores(goal) { let weekly = 0, allTime = 0; if (goal.history) { for (const [weekId, weekData] of Object.entries(goal.history)) { let scoreForWeek = 0; if (weekData) weekData.forEach((dayData, i) => { if (dayData && goal.days[i]) scoreForWeek += dayData.entries.length; }); if (weekId === weekIdForDate(appState.currentWeek)) weekly = scoreForWeek; allTime += scoreForWeek; } } return { weekly, allTime }; }

    // --- MODALS & MENUS ---
    function closeModal() { const modalArea = document.getElementById('modalArea'); if (modalArea.firstChild) modalArea.innerHTML = ''; }
    function closeContextMenu() { document.getElementById('contextMenu').style.display = 'none'; appState.contextMenuGoalId = null; }
    function toggleSettingsMenu(visible) { const menu = document.getElementById('settingsMenu'); menu.classList.toggle('visible', visible); if (visible) setTimeout(() => document.addEventListener('click', (e) => { if (!e.target.closest('#settingsMenuBtn') && !e.target.closest('#settingsMenu')) toggleSettingsMenu(false); }, { once: true }), 10); }

    function showAboutModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="modal-content glass-modal-content rounded-2xl p-6 w-full max-w-sm shadow-2xl">
                <div class="flex flex-col items-center text-center">
                    <img src="https://i.ibb.co/tZQx9M8/rooza-app.png" alt="لوگوی روزا" class="w-24 h-24 mb-4">
                    <h2 class="text-2xl font-bold mb-1 text-slate-900 dark:text-white">روزا (Rooza)</h2>
                    <p class="text-sm text-slate-600 dark:text-slate-300 mb-5">اپلیکیشن مدیریت عادت و هدف</p>
                    <div class="text-xs text-slate-500 dark:text-slate-400 space-y-1">
                        <p>نسخه ۱.۲.۰</p>
                        <p>© ${new Date().getFullYear()} Rooza - تمامی حقوق محفوظ است.</p>
                    </div>
                    <button class="close-modal-btn w-full mt-8 p-3 rounded-lg font-bold bg-indigo-600 text-white hover:bg-indigo-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">بستن</button>
                </div>
            </div>`;
        document.getElementById('modalArea').appendChild(modal);
        modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };
    }

    function showBackupModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';
        modal.innerHTML = `<div class="modal-content glass-modal-content rounded-2xl p-6 w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto no-scrollbar"><div class="flex justify-between items-center mb-5"><h2 class="text-2xl font-bold text-slate-900 dark:text-white">پشتیبان‌گیری و بازیابی</h2><button class="close-modal-btn text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full p-2 transition-colors">&times;</button></div><div class="space-y-6"><div class="bg-white/50 dark:bg-slate-800/50 p-5 rounded-xl border border-slate-200 dark:border-slate-700"><div class="flex items-start gap-4"><div class="flex-shrink-0 w-12 h-12 rounded-full bg-green-100 dark:bg-green-900/50 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg></div><div><h3 class="font-bold text-lg text-slate-800 dark:text-slate-100">خروجی گرفتن اطلاعات</h3><p class="text-sm text-slate-600 dark:text-slate-400 mt-1 mb-4">یک فایل JSON از تمام اهداف و تاریخچه خود دانلود کنید.</p><button id="exportBtn" class="w-full sm:w-auto px-5 py-2.5 rounded-lg font-bold bg-green-600 text-white hover:bg-green-700 transition-colors">دانلود فایل پشتیبان</button></div></div></div><div class="bg-white/50 dark:bg-slate-800/50 p-5 rounded-xl border border-slate-200 dark:border-slate-700"><div class="flex items-start gap-4"><div class="flex-shrink-0 w-12 h-12 rounded-full bg-sky-100 dark:bg-sky-900/50 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-sky-600 dark:text-sky-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg></div><div><h3 class="font-bold text-lg text-slate-800 dark:text-slate-100">ورودی گرفتن اطلاعات</h3><p class="text-sm text-slate-600 dark:text-slate-400 mt-1 mb-4">یک فایل پشتیبان JSON را برای بازیابی اطلاعات خود انتخاب کنید.</p><div class="p-3 mb-4 rounded-lg bg-amber-100/50 dark:bg-amber-900/30 border border-amber-300 dark:border-amber-800 text-amber-800 dark:text-amber-300 text-sm"><strong>هشدار:</strong> این عمل تمام اطلاعات فعلی شما را بازنویسی خواهد کرد.</div><button id="importBtn" class="w-full sm:w-auto px-5 py-2.5 rounded-lg font-bold bg-sky-600 text-white hover:bg-sky-700 transition-colors">انتخاب فایل و بازیابی</button></div></div></div></div><input type="file" id="importFile" class="hidden" accept=".json"></div>`;
        document.getElementById('modalArea').appendChild(modal);
        modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };
        modal.querySelector('#exportBtn').onclick = exportData;
        modal.querySelector('#importBtn').onclick = () => document.getElementById('importFile').click();
        modal.querySelector('#importFile').onchange = importData;
    }

    function exportData() {
        try {
            const dataToExport = { goals: appState.goals, order: appState.order };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.download = `Rooza-Backup-${new Date().toISOString().slice(0, 10)}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
            closeModal();
        } catch (error) { console.error("Error exporting data:", error); alert("خطا در خروجی گرفتن اطلاعات."); }
    }
    function importData(event) {
        const file = event.target.files[0];
        if (!file || !confirm("آیا مطمئن هستید؟ این عمل تمام اطلاعات فعلی شما را بازنویسی خواهد کرد.")) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData && Array.isArray(importedData.goals) && Array.isArray(importedData.order)) {
                    appState.goals = importedData.goals; appState.order = importedData.order;
                    persistState(); loadStateFromStorage(); fullRender(); closeModal(); alert("اطلاعات با موفقیت وارد شد.");
                } else { throw new Error("Invalid file format."); }
            } catch (error) { console.error("Error importing data:", error); alert("خطا در وارد کردن اطلاعات. فایل انتخاب شده معتبر نیست."); }
        };
        reader.readAsText(file);
    }
    
    // --- REPORT MODAL ---
    function showReportModal() {
        let currentReportDate = new Date();
        let currentReportView = 'month';

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-2 sm:p-4';
        modal.innerHTML = `<div class="modal-content glass-modal-content rounded-2xl p-4 sm:p-6 w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl"><div class="flex-shrink-0 flex justify-between items-center mb-4"><h2 class="text-xl sm:text-2xl font-bold text-slate-900 dark:text-white">گزارش عملکرد</h2><button class="close-modal-btn text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full p-2 transition-colors">&times;</button></div><div class="flex-shrink-0 flex flex-col sm:flex-row items-center justify-between gap-4 mb-4 p-2 bg-slate-200/50 dark:bg-slate-800/50 rounded-xl"><div id="report-tabs" class="flex items-center gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg"><button data-view="day" class="report-tab-btn">روزانه</button><button data-view="week" class="report-tab-btn">هفتگی</button><button data-view="month" class="report-tab-btn active">ماهانه</button><button data-view="year" class="report-tab-btn">سالیانه</button></div><div id="report-nav-container" class="flex items-center gap-2"><button id="report-next-btn" class="p-2 rounded-full hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button><div id="report-date-display" class="w-36 text-center font-bold text-indigo-600 dark:text-indigo-400"></div><button id="report-prev-btn" class="p-2 rounded-full hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button></div></div><div id="report-body" class="flex-grow overflow-y-auto p-1 -mr-2 pr-2 no-scrollbar"></div></div>`;
        document.getElementById('modalArea').appendChild(modal);

        const reportBody = modal.querySelector('#report-body'), dateDisplay = modal.querySelector('#report-date-display');
        const updateReportView = () => {
            modal.querySelector('#report-nav-container').style.visibility = currentReportView === 'all_time' ? 'hidden' : 'visible';
            modal.querySelectorAll('.report-tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.view === currentReportView));
            if (currentReportView === 'year') renderYearlyReport(reportBody, dateDisplay, currentReportDate);
            else renderSummaryAndListReport(reportBody, dateDisplay, currentReportView, currentReportDate);
        };
        modal.querySelector('#report-tabs').addEventListener('click', e => { if (e.target.closest('.report-tab-btn')) { currentReportView = e.target.closest('.report-tab-btn').dataset.view; updateReportView(); } });
        modal.querySelector('#report-prev-btn').addEventListener('click', () => { if (currentReportView === 'day') currentReportDate.setDate(currentReportDate.getDate() - 1); else if (currentReportView === 'week') currentReportDate.setDate(currentReportDate.getDate() - 7); else if (currentReportView === 'month') currentReportDate.setMonth(currentReportDate.getMonth() - 1); else if (currentReportView === 'year') currentReportDate.setFullYear(currentReportDate.getFullYear() - 1); updateReportView(); });
        modal.querySelector('#report-next-btn').addEventListener('click', () => { if (currentReportView === 'day') currentReportDate.setDate(currentReportDate.getDate() + 1); else if (currentReportView === 'week') currentReportDate.setDate(currentReportDate.getDate() + 7); else if (currentReportView === 'month') currentReportDate.setMonth(currentReportDate.getMonth() + 1); else if (currentReportView === 'year') currentReportDate.setFullYear(currentReportDate.getFullYear() + 1); updateReportView(); });
        modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };
        updateReportView();
    }

    function renderSummaryAndListReport(container, dateDisplay, view, date) {
        const goals = appState.goals.filter(g => !g.archived);
        if (goals.length === 0) { container.innerHTML = `<div class="text-center text-slate-500 p-8">هیچ عادت فعالی برای گزارش وجود ندارد.</div>`; dateDisplay.innerText = '-'; return; }
        
        let startDate, endDate;
        if (view === 'day') { startDate = new Date(date); startDate.setHours(0,0,0,0); endDate = new Date(date); endDate.setHours(23,59,59,999); dateDisplay.innerText = date.toLocaleDateString('fa-IR', { day: 'numeric', month: 'long', year: 'numeric' });
        } else if (view === 'week') { startDate = getStartOfWeek(date); endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); endDate.setHours(23,59,59,999); dateDisplay.innerText = formatWeekRange(startDate);
        } else { const [jYear, jMonth] = toJalali(date.getFullYear(), date.getMonth() + 1, date.getDate()); startDate = toGregorian(jYear, jMonth, 1); endDate = toGregorian(jYear, jMonth, jalaliMonthLength(jYear, jMonth)); endDate.setHours(23,59,59,999); dateDisplay.innerText = startDate.toLocaleDateString('fa-IR', { month: 'long', year: 'numeric' }); }
        
        let overallCompletions = 0, overallTargets = 0;
        const goalStats = goals.map(goal => { let totalCompletions = 0, totalTarget = 0; for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) { if (goal.days[(d.getDay() + 1) % 7]) { totalTarget++; totalCompletions += getEntryCountOnDate(goal, d); } } overallCompletions += totalCompletions; overallTargets += totalTarget; return { goal, totalCompletions, totalTarget, percentage: totalTarget > 0 ? Math.round((totalCompletions / totalTarget) * 100) : 0 }; });
        const bestGoal = goalStats.length > 0 ? [...goalStats].sort((a, b) => b.percentage - a.percentage || b.totalCompletions - a.totalCompletions)[0] : null;
        
        container.innerHTML = `<div class="mb-6"><h3 class="font-bold text-lg mb-3 text-slate-800 dark:text-slate-200">خلاصه عملکرد</h3><div class="grid grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4"><div class="summary-card"><div class="summary-value">${toFa(overallTargets > 0 ? Math.round((overallCompletions / overallTargets) * 100) : 0)}٪</div><div class="summary-label">موفقیت کلی</div></div><div class="summary-card"><div class="summary-value">${toFa(overallCompletions)} / ${toFa(overallTargets)}</div><div class="summary-label">کل انجام شده</div></div><div class="summary-card col-span-2 lg:col-span-1"><div class="summary-value truncate text-xl">${bestGoal ? escapeHtml(bestGoal.goal.name) : '-'}</div><div class="summary-label">پرتلاش‌ترین عادت</div></div></div></div><h3 class="font-bold text-lg my-3 text-slate-800 dark:text-slate-200">جزئیات عادت‌ها</h3><div class="space-y-3">${goalStats.map(({ goal, totalCompletions, totalTarget, percentage }) => `<div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm"><div class="flex items-center justify-between mb-2"><div class="flex items-center gap-3"><span class="text-2xl">${goal.emoji}</span><span class="font-bold text-slate-700 dark:text-slate-200">${escapeHtml(goal.name)}</span></div><div class="text-sm font-semibold text-slate-500 dark:text-slate-400"><span>${toFa(totalCompletions)}</span> / <span>${toFa(totalTarget)}</span></div></div><div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5"><div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${percentage}%"></div></div><div class="text-right text-xs font-bold text-indigo-500 mt-1">${toFa(percentage)}٪</div></div>`).join('')}</div>`;
    }

    function renderYearlyReport(container, dateDisplay, date) {
        const [jYear] = toJalali(date.getFullYear(), date.getMonth() + 1, date.getDate());
        dateDisplay.innerText = `سال ${toFa(jYear)}`;
        const goals = appState.goals.filter(g => !g.archived);
        let dailyActivities = {}, maxActivity = 0;
        for (let jm = 1; jm <= 12; jm++) { for (let jd = 1; jd <= jalaliMonthLength(jYear, jm); jd++) { const gDate = toGregorian(jYear, jm, jd); const dateString = gDate.toISOString().split('T')[0]; let totalEntries = goals.reduce((sum, goal) => sum + getEntryCountOnDate(goal, gDate), 0); dailyActivities[dateString] = totalEntries; if (totalEntries > maxActivity) maxActivity = totalEntries; } }
        const getLevel = (count) => { if (count === 0) return 0; if (maxActivity <= 1) return 2; const ratio = count / maxActivity; if (ratio > 0.75) return 4; if (ratio > 0.5) return 3; if (ratio > 0.25) return 2; return 1; };
        
        let heatmapHtml = '<div class="year-heatmap-container">';
        for (let jm = 1; jm <= 12; jm++) { const firstDayOfMonth = toGregorian(jYear, jm, 1); const startOffset = (firstDayOfMonth.getDay() + 1) % 7; heatmapHtml += `<div class="month-grid"><h4 class="text-center font-bold mb-3 text-slate-700 dark:text-slate-300">${JALALI_MONTH_NAMES[jm-1]}</h4><div class="day-squares-grid">${'<div></div>'.repeat(startOffset)}`; for (let jd = 1; jd <= jalaliMonthLength(jYear, jm); jd++) { const gDate = toGregorian(jYear, jm, jd); const count = dailyActivities[gDate.toISOString().split('T')[0]] || 0; const tooltip = `${toFa(jd)} ${JALALI_MONTH_NAMES[jm-1]} - ${toFa(count)} فعالیت`; heatmapHtml += `<div class="heatmap-square heatmap-level-${getLevel(count)}"><div class="tooltip">${tooltip}</div></div>`; } heatmapHtml += '</div></div>'; }
        
        container.innerHTML = heatmapHtml + `</div><div class="mt-6 flex items-center justify-center gap-2 text-xs text-slate-500 dark:text-slate-400"><span>کم</span><div class="heatmap-square heatmap-level-0 w-4 h-4 rounded"></div><div class="heatmap-square heatmap-level-1 w-4 h-4 rounded"></div><div class="heatmap-square heatmap-level-2 w-4 h-4 rounded"></div><div class="heatmap-square heatmap-level-3 w-4 h-4 rounded"></div><div class="heatmap-square heatmap-level-4 w-4 h-4 rounded"></div><span>زیاد</span></div>`;
    }

    // --- OTHER MODALS ---
    function showStatsModal(goalId) { const goal = appState.goals.find(g => g.id === goalId); if (!goal) return; const modal = document.createElement('div'); modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4'; modal.innerHTML = `<div class="modal-content bg-slate-100 dark:bg-slate-800 rounded-2xl p-4 md:p-6 w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl no-scrollbar"><div class="flex justify-between items-center mb-4"><h2 class="text-xl md:text-2xl font-bold text-indigo-600 dark:text-indigo-400 flex items-center gap-3"><span class="text-2xl">${goal.emoji}</span><span>${escapeHtml(goal.name)}</span></h2><button class="close-modal-btn text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full p-2 transition-colors">&times;</button></div><div><h3 class="font-bold mb-3 text-slate-700 dark:text-slate-300 text-center">تقویم فعالیت</h3><div id="heatmap-container" class="p-3 bg-white dark:bg-slate-700/50 rounded-xl shadow-inner"></div></div></div>`; document.getElementById('modalArea').appendChild(modal); const heatmapContainer = modal.querySelector('#heatmap-container'); const today = new Date(); const [jYear, jMonth] = toJalali(today.getFullYear(), today.getMonth() + 1, today.getDate()); renderMonthlyHeatmap(heatmapContainer, goal, jYear, jMonth); modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); }; }
    function renderMonthlyHeatmap(container, goal, jYear, jMonth) { const monthLength = jalaliMonthLength(jYear, jMonth); const firstGregorianDate = toGregorian(jYear, jMonth, 1); const startOffset = (firstGregorianDate.getDay() + 1) % 7; let html = `<div class="flex items-center justify-between mb-3 px-1"><button data-action="prev" class="heatmap-nav-btn p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg></button><span class="font-bold text-sm">${firstGregorianDate.toLocaleDateString('fa-IR',{month:'long',year:'numeric'})}</span><button data-action="next" class="heatmap-nav-btn p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg></button></div><div class="grid grid-cols-7 gap-1 text-center text-xs text-slate-400 mb-2">${WEEKDAY_NAMES_SHORT.map(d=>`<div>${d}</div>`).join('')}</div><div class="grid grid-cols-7 gap-1.5">${'<div></div>'.repeat(startOffset)}`; for (let jd = 1; jd <= monthLength; jd++) { const gDate = toGregorian(jYear, jMonth, jd); let colorClass = 'bg-slate-200/80 dark:bg-slate-700/80'; const entryCount = getEntryCountOnDate(goal, gDate); if (entryCount > 0) colorClass = 'bg-green-500 text-white font-bold'; else if (!goal.days[(gDate.getDay() + 1) % 7]) colorClass = 'bg-slate-100 dark:bg-slate-800/60 opacity-70'; if(isToday(gDate)) colorClass += ' ring-2 ring-sky-500'; html += `<div class="aspect-square rounded-lg flex items-center justify-center text-sm transition-colors relative ${colorClass}" title="${gDate.toLocaleDateString('fa-IR')}"><span class="text-xl font-semibold">${toFa(jd)}</span>${entryCount>0?`<span class="absolute -top-1.5 -right-1.5 bg-sky-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center border-2 border-white dark:border-slate-800 shadow-lg">${toFa(entryCount)}</span>`:''}</div>`; } html += `</div>`; container.innerHTML = html; container.querySelectorAll('.heatmap-nav-btn').forEach(btn => { btn.onclick = () => { let newMonth = jMonth, newYear = jYear; if (btn.dataset.action === 'next') { newMonth++; if (newMonth > 12) { newMonth = 1; newYear++; } } else { newMonth--; if (newMonth < 1) { newMonth = 12; newYear--; } } renderMonthlyHeatmap(container, goal, newYear, newMonth); } }); }

    // --- CORE LOGIC & EVENT LISTENERS ---
    function initSortable() { if (sortable) sortable.destroy(); const list = document.getElementById('goalList'); if(!list) return; sortable = Sortable.create(list, { handle: '.goal-handle', animation: 200, ghostClass: 'sortable-ghost', onEnd: (evt) => { appState.order = Array.from(evt.to.children).map(card => card.dataset.id); persistState(); setupCellListeners(); } }); }
    function initEditInput(goalId) { const el = document.getElementById('edit-' + goalId); if (!el) return; el.focus(); el.select(); const save = () => { if (appState.editing !== goalId) return; const goal = appState.goals.find(g => g.id === goalId); if (goal) goal.name = el.value.trim() || 'بی‌نام'; appState.editing = null; persistState(); fullRender(); }; el.onblur = save; el.onkeydown = (e) => { if (e.key === "Enter") el.blur(); if (e.key === "Escape") { appState.editing = null; fullRender(); } }; }
    function showGoalModal(goal) { const isEdit = !!goal; const draft = isEdit ? JSON.parse(JSON.stringify(goal)) : { id: ''+Date.now(), name: '', emoji: '🎯', days: Array(7).fill(true), history: {}, type: 'binary', archived: false, category: 'شخصی', creationDate: new Date().toISOString() }; const modal = document.createElement('div'); modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm z-[100] flex items-end justify-center'; modal.innerHTML = `<div class="modal-content bg-slate-50 dark:bg-slate-900 rounded-t-2xl p-4 w-full max-w-lg pb-[calc(env(safe-area-inset-bottom)+1rem)] shadow-2xl"><h2 class="text-xl font-bold text-center mb-6 text-indigo-600 dark:text-indigo-400">${isEdit?'ویرایش هدف':'هدف جدید'}</h2><div class="space-y-4"><div class="flex gap-4"><div class="flex-grow"><label class="font-semibold mb-2 block text-sm">نام هدف</label><input id="goalName" value="${escapeHtml(draft.name)}" placeholder="مثلا: ورزش روزانه" class="w-full p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none transition"></div><div><label class="font-semibold mb-2 block text-sm">ایموجی</label><input id="goalEmoji" value="${draft.emoji}" maxlength="2" class="w-20 text-center p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none transition"></div></div><div><label class="font-semibold mb-2 block text-sm">دسته‌بندی</label><select id="goalCategory" class="w-full p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none transition">${Object.keys(CATEGORIES).map(cat=>`<option value="${cat}" ${draft.category===cat?'selected':''}>${cat}</option>`).join('')}</select></div><div><label class="font-semibold mb-2 block text-sm">روزهای فعال</label><div class="grid grid-cols-7 gap-2 rounded-lg bg-slate-200 dark:bg-slate-800 p-1 weekday-toggle-row">${WEEKDAY_NAMES_SHORT.map((d,i)=>`<div class="weekday-toggle text-center font-bold p-2 rounded-md cursor-pointer transition-colors ${draft.days[i]?'bg-indigo-500 text-white':'hover:bg-slate-300'}" data-day="${i}">${d}</div>`).join('')}</div></div></div><div class="grid grid-cols-2 gap-4 mt-8"><button class="action-btn-cancel p-4 rounded-lg font-bold bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600">لغو</button><button id="saveGoalBtn" class="p-4 rounded-lg font-bold bg-indigo-600 text-white hover:bg-indigo-700">${isEdit?'ذخیره':'افزودن'}</button></div></div>`; document.getElementById('modalArea').appendChild(modal); modal.querySelector('#goalName').focus(); modal.onclick = e => { if (e.target === modal) closeModal(); }; modal.querySelector('.action-btn-cancel').onclick = closeModal; modal.querySelectorAll('.weekday-toggle').forEach(t => t.onclick = () => { t.classList.toggle('bg-indigo-500'); t.classList.toggle('text-white'); }); modal.querySelector('#saveGoalBtn').onclick = () => { draft.name = modal.querySelector('#goalName').value.trim() || 'بی‌نام'; draft.emoji = modal.querySelector('#goalEmoji').value || '🎯'; draft.category = modal.querySelector('#goalCategory').value; draft.days = Array.from(modal.querySelectorAll('.weekday-toggle')).map(t => t.classList.contains('bg-indigo-500')); if (isEdit) { const index = appState.goals.findIndex(g => g.id === goal.id); if (index > -1) appState.goals[index] = draft; } else { appState.goals.push(draft); appState.order.push(draft.id); } persistState(); closeModal(); fullRender(); }; }
    function showLogModal(goalId, dayIndex) { const goal = appState.goals.find(g => g.id === goalId); if (!goal || !goal.days[dayIndex]) return; const weekId = weekIdForDate(appState.currentWeek); if (!goal.history) goal.history = {}; if (!goal.history[weekId]) goal.history[weekId] = Array(7).fill(null).map(() => ({ entries: [], note: '' })); if (!goal.history[weekId][dayIndex]) goal.history[weekId][dayIndex] = { entries: [], note: '' }; const dayData = goal.history[weekId][dayIndex]; const modal = document.createElement('div'); modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm z-[100] flex items-end justify-center'; const renderEntries = c => c.innerHTML = dayData.entries.map((e,i) => `<div class="flex items-center gap-1 bg-slate-200 dark:bg-slate-700 rounded-full px-3 py-1 text-sm"><span>${e}</span><button data-index="${i}" class="delete-entry-btn text-red-500 hover:text-red-700">&times;</button></div>`).join('') || '<span class="text-slate-400">موردی ثبت نشده</span>'; modal.innerHTML = `<div class="modal-content bg-slate-50 dark:bg-slate-900 rounded-t-2xl p-4 w-full max-w-lg pb-[calc(env(safe-area-inset-bottom)+1rem)] shadow-2xl"><h2 class="text-xl font-bold text-center mb-4 truncate">${goal.name}</h2><div class="space-y-4"><div><label class="font-semibold mb-2 block text-sm">موارد ثبت شده</label><div id="entries-list" class="flex flex-wrap gap-2 min-h-[40px] bg-white dark:bg-slate-800 p-2 rounded-lg"></div></div><div><label class="font-semibold mb-2 block text-sm">ثبت ایموجی</label><div class="grid grid-cols-7 gap-2 text-3xl">${EMOJIS.map(em=>`<button class="emoji-btn text-center rounded-lg p-2 hover:bg-slate-200 dark:hover:bg-slate-700 transition-transform hover:scale-125">${em}</button>`).join('')}</div></div><div><label for="note-input" class="font-semibold mb-2 block text-sm">یادداشت</label><textarea id="note-input" class="w-full p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none transition" rows="2" placeholder="یادداشت امروز...">${escapeHtml(dayData.note)}</textarea></div></div><div class="mt-8"><button class="action-btn-done w-full p-4 rounded-lg font-bold bg-indigo-600 text-white hover:bg-indigo-700">انجام شد</button></div></div>`; document.getElementById('modalArea').appendChild(modal); const entriesList = modal.querySelector('#entries-list'); renderEntries(entriesList); const save = () => { dayData.note = modal.querySelector('#note-input').value; persistState(); fullRender(); closeModal(); }; modal.onclick = e => { if (e.target === modal) save(); }; modal.querySelector('.action-btn-done').onclick = save; entriesList.addEventListener('click', e => { if (e.target.classList.contains('delete-entry-btn')) { dayData.entries.splice(parseInt(e.target.dataset.index), 1); persistState(); renderEntries(entriesList); } }); modal.querySelectorAll('.emoji-btn').forEach(btn => btn.onclick = () => { dayData.entries.push(btn.innerText); persistState(); renderEntries(entriesList); }); }
    function showDayDetailModal(goalId, dayIndex) { const goal = appState.goals.find(g => g.id === goalId); if (!goal) return; const date = new Date(appState.currentWeek); date.setDate(appState.currentWeek.getDate() + dayIndex); const dayData = goal.history?.[weekIdForDate(appState.currentWeek)]?.[dayIndex] || { entries: [], note: '' }; const modal = document.createElement('div'); modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4'; modal.innerHTML = `<div class="modal-content bg-slate-50 dark:bg-slate-800 rounded-2xl p-5 w-full max-w-sm shadow-2xl"><h3 class="font-bold text-lg text-indigo-600 dark:text-indigo-400 mb-2">${escapeHtml(goal.name)}</h3><p class="text-sm text-slate-500 dark:text-slate-400 font-semibold mb-4">${date.toLocaleDateString('fa-IR',{weekday:'long',month:'long',day:'numeric'})}</p><div class="space-y-4"><div><h4 class="font-semibold text-sm mb-2">موارد ثبت شده</h4><div class="flex flex-wrap gap-3 items-center min-h-[40px] bg-white dark:bg-slate-700/50 p-3 rounded-lg">${dayData.entries.length>0?dayData.entries.map(e=>`<span class="text-2xl">${escapeHtml(e)}</span>`).join(''):'<span class="text-sm text-slate-400">موردی ثبت نشده</span>'}</div></div><div><h4 class="font-semibold text-sm mb-2">یادداشت</h4><div class="min-h-[40px]">${dayData.note?`<p class="text-sm bg-amber-100 dark:bg-amber-900/50 p-3 rounded-lg">${escapeHtml(dayData.note)}</p>`:'<span class="text-sm text-slate-400">یادداشتی وجود ندارد</span>'}</div></div></div><button class="close-modal-btn w-full mt-6 p-3 rounded-lg font-bold bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600">بستن</button></div>`; document.getElementById('modalArea').appendChild(modal); modal.onclick = e => { if (e.target === modal || e.target.classList.contains('close-modal-btn')) closeModal(); }; }
    function showContextMenu(e, goalId) { e.preventDefault(); e.stopPropagation(); if (appState.contextMenuGoalId === goalId) { closeContextMenu(); return; } closeContextMenu(); const goal = appState.goals.find(g => g.id === goalId); if (!goal) return; const menu = document.getElementById('contextMenu'); menu.innerHTML = `<button onclick="showGoalModal(appState.goals.find(g=>g.id==='${goalId}'))" class="w-full text-right flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">✏️ <span>ویرایش</span></button><button onclick="duplicateGoal('${goalId}')" class="w-full text-right flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">🗂️ <span>کپی</span></button><button onclick="toggleArchiveGoal('${goalId}')" class="w-full text-right flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">${goal.archived ? '📂 <span>لغو آرشیو</span>' : '🗄️ <span>آرشیو</span>'}</button><div class="my-1 h-px bg-slate-200 dark:bg-slate-700"></div><button onclick="deleteGoal('${goalId}')" class="w-full text-right flex items-center gap-3 p-3 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/40 rounded-lg">🗑️ <span>حذف</span></button>`; menu.style.display = 'block'; const rect = menu.getBoundingClientRect(); menu.style.left = `${Math.min(e.clientX, window.innerWidth - rect.width - 10)}px`; menu.style.top = `${Math.min(e.clientY, window.innerHeight - rect.height - 10)}px`; appState.contextMenuGoalId = goalId; setTimeout(() => document.addEventListener('click', closeContextMenu, { once: true }), 10); }
    function duplicateGoal(goalId) { const original = appState.goals.find(g=>g.id===goalId); if (!original) return; const newGoal = JSON.parse(JSON.stringify(original)); newGoal.id = ''+Date.now(); newGoal.name = `${original.name} (کپی)`; newGoal.history = {}; newGoal.archived = false; appState.goals.push(newGoal); appState.order.splice(appState.order.indexOf(goalId) + 1, 0, newGoal.id); persistState(); fullRender(); }
    function toggleArchiveGoal(goalId) { const goal = appState.goals.find(g=>g.id===goalId); if (goal) { goal.archived = !goal.archived; persistState(); fullRender(); } }
    function deleteGoal(goalId) { const modal = document.createElement('div'); modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4'; modal.innerHTML = `<div class="modal-content bg-slate-50 dark:bg-slate-800 rounded-2xl p-5 w-full max-w-sm shadow-2xl text-center"><h3 class="font-bold text-lg mb-2">تایید حذف</h3><p class="text-sm text-slate-600 dark:text-slate-300 mb-6">آیا از حذف این هدف مطمئن هستید؟ این عمل غیرقابل بازگشت است.</p><div class="grid grid-cols-2 gap-4"><button id="cancel-delete" class="p-3 rounded-lg font-bold bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition">لغو</button><button id="confirm-delete" class="p-3 rounded-lg font-bold bg-red-500 text-white hover:bg-red-600 transition">حذف</button></div></div>`; document.getElementById('modalArea').appendChild(modal); modal.querySelector('#cancel-delete').onclick = closeModal; modal.querySelector('#confirm-delete').onclick = () => { closeModal(); const card = document.querySelector(`.goal-card[data-id="${goalId}"]`); if (card) { card.classList.add('goal-anim-out'); setTimeout(() => { appState.goals = appState.goals.filter(g => g.id !== goalId); appState.order = appState.order.filter(id => id !== goalId); persistState(); fullRender(); }, 300); } else { appState.goals = appState.goals.filter(g => g.id !== goalId); appState.order = appState.order.filter(id => id !== goalId); persistState(); fullRender(); } }; }
    function setupCellListeners() { document.querySelectorAll('.goal-day.active').forEach(cell => { let pressTimer = null, longPressTriggered = false, startY, startX, hasMoved = false; const start = (e) => { e.preventDefault(); startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY; startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX; hasMoved = false; pressTimer = setTimeout(() => { longPressTriggered = true; showDayDetailModal(cell.dataset.goalId, parseInt(cell.dataset.dayIndex)); }, 500); document.addEventListener('mousemove', move); document.addEventListener('touchmove', move); document.addEventListener('mouseup', end, { once: true }); document.addEventListener('touchend', end, { once: true }); }; const move = (e) => { if (!pressTimer && !longPressTriggered) return; const currentY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY; const currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX; const deltaY = currentY - startY; const deltaX = currentX - startX; if (Math.abs(deltaY) > 10 || Math.abs(deltaX) > 10) { hasMoved = true; clearTimeout(pressTimer); } if (hasMoved && Math.abs(deltaY) > 30 && Math.abs(deltaY) > Math.abs(deltaX)) { clearTimeout(pressTimer); pressTimer = null; if (deltaY < 0) { addCheckmark(cell.dataset.goalId, parseInt(cell.dataset.dayIndex), cell); } else { removeLastEmoji(cell.dataset.goalId, parseInt(cell.dataset.dayIndex), cell); } end(); } }; const end = () => { clearTimeout(pressTimer); if (!hasMoved && !longPressTriggered) { showLogModal(cell.dataset.goalId, parseInt(cell.dataset.dayIndex)); } longPressTriggered = false; document.removeEventListener('mousemove', move); document.removeEventListener('touchmove', move); }; cell.onmousedown = start; cell.ontouchstart = start; }); }
    function addCheckmark(goalId, dayIndex, cell) { const goal = appState.goals.find(g => g.id === goalId); if (!goal) return; const weekId = weekIdForDate(appState.currentWeek); if (!goal.history) goal.history = {}; if (!goal.history[weekId]) goal.history[weekId] = Array(7).fill(null).map(() => ({ entries: [], note: '' })); if (!goal.history[weekId][dayIndex]) goal.history[weekId][dayIndex] = { entries: [], note: '' }; goal.history[weekId][dayIndex].entries.push('✅'); persistState(); partialRender(cell, goal); cell.classList.add('cell-swipe-up'); cell.addEventListener('animationend', () => cell.classList.remove('cell-swipe-up'), { once: true }); }
    function removeLastEmoji(goalId, dayIndex, cell) { const goal = appState.goals.find(g => g.id === goalId); if (!goal) return; const weekId = weekIdForDate(appState.currentWeek); if (!goal.history?.[weekId]?.[dayIndex]?.entries.length > 0) return; goal.history[weekId][dayIndex].entries.pop(); persistState(); partialRender(cell, goal); cell.classList.add('cell-swipe-down'); cell.addEventListener('animationend', () => cell.classList.remove('cell-swipe-down'), { once: true }); }
    function partialRender(cell, goal) { const dayData = goal.history[weekIdForDate(appState.currentWeek)][parseInt(cell.dataset.dayIndex)]; cell.querySelector('div').innerHTML = dayData.entries.map(em => `<span class="text-sm md:text-base">${escapeHtml(em)}</span>`).join(''); cell.classList.toggle('day-completed', dayData.entries.length > 0); const card = cell.closest('.goal-card'); if (card) card.querySelector('.weekly-score').innerText = `امتیاز هفته: ${toFa(calculateScores(goal).weekly)}`; renderTotals(); }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('navbar').onclick = e => { let target = e.target.closest('button'); if (!target) return; if (target.id === 'prevWeekBtn') { appState.currentWeek.setDate(appState.currentWeek.getDate() - 7); fullRender(); } else if (target.id === 'nextWeekBtn') { appState.currentWeek.setDate(appState.currentWeek.getDate() + 7); fullRender(); } else if (target.id === 'settingsMenuBtn') { toggleSettingsMenu(!document.getElementById('settingsMenu').classList.contains('visible')); } };
        document.getElementById('settingsMenu').addEventListener('click', e => { const btn = e.target.closest('button'); if (!btn) return; switch(btn.id) { case 'reportBtn': showReportModal(); break; case 'archiveToggleBtn': appState.showArchived = !appState.showArchived; document.getElementById('archiveToggleBtn').classList.toggle('text-indigo-500', appState.showArchived); fullRender(); break; case 'darkModeBtn': const t = {'dark':'light','light':'auto','auto':'dark'}; let nt = t[appState.theme] || 'dark'; if(appState.theme==='auto' && (window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light')===nt) {nt=t[nt];} setTheme(nt); break; case 'aboutBtn': showAboutModal(); break; case 'backupBtn': showBackupModal(); break; } toggleSettingsMenu(false); });
        document.getElementById('fab').onclick = () => showGoalModal(null);
        document.getElementById('categoryFilters').onclick = (e) => { if(e.target.closest('button')) { appState.activeCategory = e.target.closest('button').dataset.category; renderGoals(); renderCategoryFilters(); } };
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);
        
        loadStateFromStorage();
        fullRender();
    });
</script>
</body>
</html>