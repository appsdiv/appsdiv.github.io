<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ConvoEnglish | Practice App</title>

    <link rel="manifest" href="data:application/manifest+json;base64,ew0KICAibmFtZSI6ICJDb252b0VuZ2xpc2ggUHJhY3RpY2UiLA0KICAic2hvcnRfbmFtZSI6ICJDb252b0VOIiwNCiAgInN0YXJ0X3VybCI6ICIuIiwNCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsDQogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMxRTQ5NEUiLA0KICAidGhlbWVfY29sb3IiOiAiIzJBNjhGNyIsDQogICJkZXNjcmlwdGlvbiI6ICJBbiBlbmdhZ2luZyBhcHAgdG8gcHJhY3RpY2UgRW5nbGlzaCBjb252ZXJzYXRpb24uIiwNCiAgImljb25zIjogWw0KICAgIHsNCiAgICAgICJzcmMiOiAiaWNvbi0xOTIucG5nIiwNCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwNCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyINCiAgICB9LA0KICAgIHsNCiAgICAgICJzcmMiOiAiaWNvbi01MTIucG5nIiwNCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwNCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyINCiAgICB9DQogIF0NCn0=">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ConvoEN">
    <meta name="theme-color" content="#1E494E">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Vazirmatn:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pop-in {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #111827; /* Dark gray */
            overscroll-behavior: none;
        }
        .persian-text {
            font-family: 'Vazirmatn', sans-serif;
            direction: rtl;
        }
        .screen {
            animation: fade-in 0.5s ease-out forwards;
        }
        .interactive-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .interactive-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        #quiz-completion-state {
            animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
    </style>
</head>
<body class="text-slate-100 antialiased overflow-hidden">

    <div id="app-wrapper" class="h-screen w-screen flex flex-col p-4 bg-gray-900">
        </div>

    <script src="en2.js"></script>
    
    <script>
        // --- SERVICE WORKER REGISTRATION ---
        const serviceWorkerScript = `
            const CACHE_NAME = 'convo-english-v3';
            const urlsToCache = [
              '.',
              'index.html',
              'en2.js',
              'https://cdn.tailwindcss.com',
              'https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Vazirmatn:wght@400;500;600&display=swap'
            ];
            self.addEventListener('install', event => {
              event.waitUntil(
                caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
              );
            });
            self.addEventListener('fetch', event => {
              event.respondWith(
                caches.match(event.request).then(response => response || fetch(event.request))
              );
            });
        `;
        if ('serviceWorker' in navigator) {
            const blob = new Blob([serviceWorkerScript], { type: 'application/javascript' });
            const swURL = URL.createObjectURL(blob);
            navigator.serviceWorker.register(swURL)
              .then(reg => console.log('Service Worker registered successfully.'))
              .catch(err => console.error('Service Worker registration failed:', err));
        }

        // --- APPLICATION LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof appData === 'undefined') {
                document.body.innerHTML = `<div class="text-red-500 text-center p-8">Error: Could not load data from en2.js.</div>`;
                return;
            }

            const appWrapper = document.getElementById('app-wrapper');
            let shuffledData = [];
            let quizCurrentIndex = 0;

            const shuffleArray = (array) => [...array].sort(() => Math.random() - 0.5);

            const speak = (text, btn) => {
                if (!text || !window.speechSynthesis) return;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                
                let voices = speechSynthesis.getVoices();
                let preferredVoice = voices.find(v => v.name.includes('Google') && v.name.includes('US English'));
                if (preferredVoice) utterance.voice = preferredVoice;

                if (btn) {
                    const icon = btn.querySelector('svg');
                    utterance.onstart = () => icon.classList.add('text-yellow-400');
                    utterance.onend = () => icon.classList.remove('text-yellow-400');
                }
                speechSynthesis.cancel();
                speechSynthesis.speak(utterance);
            };

            const renderHomeScreen = () => {
                appWrapper.innerHTML = `
                    <div class="screen flex flex-col items-center justify-center h-full text-center">
                        <header class="mb-12">
                            <h1 class="text-5xl font-bold tracking-tight text-white">ConvoEnglish</h1>
                            <p class="text-blue-400 font-persian text-xl mt-2">تمرین مکالمه انگلیسی</p>
                        </header>
                        <div class="w-full max-w-xs space-y-4">
                            <button onclick="startQuiz()" class="interactive-card w-full bg-blue-600 hover:bg-blue-700 transition p-6 rounded-2xl shadow-lg">
                                <h2 class="text-xl font-semibold">Quiz Mode</h2>
                                <p class="opacity-80 font-persian">حالت آزمون</p>
                            </button>
                            <button onclick="renderLearningTopics()" class="interactive-card w-full bg-gray-700 hover:bg-gray-600 transition p-6 rounded-2xl shadow-lg">
                                <h2 class="text-xl font-semibold">Learning Mode</h2>
                                <p class="opacity-80 font-persian">حالت یادگیری</p>
                            </button>
                        </div>
                    </div>
                `;
            };
            
            window.startQuiz = () => {
                shuffledData = shuffleArray(appData);
                quizCurrentIndex = 0;
                renderQuizQuestion();
            };

            window.renderQuizQuestion = () => {
                if (quizCurrentIndex >= shuffledData.length) {
                    renderQuizCompletion();
                    return;
                }
                const item = shuffledData[quizCurrentIndex];
                const progressPercentage = ((quizCurrentIndex + 1) / shuffledData.length) * 100;

                appWrapper.innerHTML = `
                    <div class="screen flex flex-col h-full">
                        <header class="mb-4">
                            <p class="text-sm text-center text-slate-400 mb-1">Question ${quizCurrentIndex + 1} / ${shuffledData.length}</p>
                            <div class="w-full bg-gray-700 rounded-full h-2.5">
                                <div class="bg-blue-500 h-2.5 rounded-full" style="width: ${progressPercentage}%"></div>
                            </div>
                        </header>
                        
                        <div class="bg-gray-800 rounded-2xl p-6 space-y-4 flex-grow flex flex-col justify-between">
                            <div>
                                <p class="text-sm font-semibold text-blue-400">SPOKEN BY: ${item.role.toUpperCase()}</p>
                                <div class="flex justify-between items-start mt-2">
                                    <div class="flex-1 pr-4">
                                        <p class="text-2xl font-semibold text-white">${item.q}</p>
                                        <p class="persian-text font-persian text-slate-400 text-lg mt-1">${item.q_persien}</p>
                                    </div>
                                    <button onclick="speak('${item.q.replace(/'/g, "\\'")}', this)" class="text-slate-400 hover:text-blue-400 p-2 flex-shrink-0">
                                        <svg class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="space-y-3">
                                ${item.a.map((ans, i) => `
                                    <button class="w-full text-left p-4 bg-gray-700 rounded-lg">
                                        <p>${ans}</p>
                                        <p class="persian-text font-persian text-slate-400 text-md mt-1">${item.a_persien[i] || ''}</p>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-4">
                            <button onclick="renderHomeScreen()" class="w-1/3 bg-gray-700 hover:bg-gray-600 font-bold py-3 px-6 rounded-xl transition">Home</button>
                            <button onclick="renderQuizQuestion()" class="w-2/3 bg-blue-600 hover:bg-blue-700 font-bold py-3 px-6 rounded-xl transition">Next</button>
                        </div>
                    </div>
                `;
                quizCurrentIndex++;
            };

            window.renderQuizCompletion = () => {
                appWrapper.innerHTML = `
                <div id="quiz-completion-state" class="screen flex flex-col items-center justify-center h-full text-center">
                    <div class="bg-gray-800 p-8 rounded-2xl shadow-lg w-full max-w-sm">
                        <svg class="w-20 h-20 mx-auto mb-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.25 2.25a.75.75 0 00-1.5 0v1.164a13.43 13.43 0 00-3.322 2.296C5.073 6.83 4.5 8.353 4.5 10c0 1.55.022 3.32.062 4.802.035 1.284.162 2.441.385 3.498a.75.75 0 00.728.65h7.65a.75.75 0 00.728-.65c.223-1.057.35-2.214.385-3.498.04-1.482.062-3.252.062-4.802 0-1.647-.573-3.17-1.928-4.29a13.43 13.43 0 00-3.322-2.296V2.25zM8.625 10a.75.75 0 00-1.5 0v.63c-.881.25-1.7.64-2.438 1.156a.75.75 0 00.825 1.185 8.92 8.92 0 011.613-.801V10zm2.75 0v2.17c.563.218 1.096.52 1.613.801a.75.75 0 10.825-1.185c-.738-.516-1.557-.905-2.438-1.156V10a.75.75 0 00-1.5 0z" clip-rule="evenodd"></path></svg>
                        <h2 class="text-3xl font-bold text-white mb-2">Quiz Complete!</h2>
                        <p class="text-slate-400 mb-6">You've finished the quiz. Great job practicing!</p>
                        <div class="space-y-3">
                            <button onclick="startQuiz()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition">Play Again</button>
                            <button onclick="renderHomeScreen()" class="w-full bg-gray-600 hover:bg-gray-500 font-semibold py-3 rounded-xl transition">Return Home</button>
                        </div>
                    </div>
                </div>
                `;
            };

            // Initial load
            renderHomeScreen();
        });
    </script>
</body>
</html>