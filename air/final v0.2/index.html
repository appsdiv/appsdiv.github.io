<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#000000" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<link rel="icon" type="image/png" sizes="32x32" href="https://8upload.com/image/171db5bf84cf07d4/AppIcon_2x.png" />
<link rel="icon" type="image/png" sizes="192x192" href="https://8upload.com/image/171db5bf84cf07d4/AppIcon_2x.png" />
<link rel="apple-touch-icon" sizes="180x180" href="https://8upload.com/image/171db5bf84cf07d4/AppIcon_2x.png" />

<meta name="apple-mobile-web-app-title" content="Ù‡ÙˆØ§ÛŒ Ù¾Ø§Ú© Ù¾Ù„Ø§Ø³" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<link rel="manifest" href="./manifest.webmanifest" />
<title>Ù‡ÙˆØ§ÛŒ Ù¾Ø§Ú© Ù¾Ù„Ø§Ø³ | Ultra iOS</title>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@200..900&display=swap" rel="stylesheet" />

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* =========================
   Design System (iOS / visionOS)
========================= */
:root{
  --bg-color:#020617;
  --bg-gradient:linear-gradient(180deg,#020617 0%,#0b1224 55%,#0f172a 100%);
  --text-primary:#f8fafc;
  --text-secondary:#94a3b8;

  --glass-bg:rgba(15,23,42,.56);
  --glass-border:rgba(255,255,255,.085);
  --glass-highlight:rgba(255,255,255,.045);
  --glass-blur:44px;

  --card-shadow:0 20px 45px -14px rgba(0,0,0,.72);
  --inner-shadow:inset 0 1px 1px rgba(255,255,255,.12);

  --accent-color:#34d399;
  --liquid-1:#4f46e5;
  --liquid-2:#db2777;
  --liquid-3:#22c55e;

  --danger:#f87171;
  --warn:#fb923c;
  --ok:#34d399;
  --info:#60a5fa;
  --purple:#a78bfa;

  --uv-green:#22c55e;
  --uv-yellow:#facc15;
  --uv-orange:#fb923c;
  --uv-red:#f87171;
  --uv-purple:#a78bfa;

  /* spacing */
  --space-1: 6px;
  --space-2: 10px;
  --space-3: 14px;
  --space-4: 18px;
  --space-5: 22px;
  --space-6: 28px;

  --stack-gap: 18px;
  --card-pad: 22px;
  --card-pad-lg: 26px;

  --radius-xl: 34px;
  --radius-lg: 26px;
  --radius-md: 18px;

  /* type */
  --text-xs: 12px;
  --text-sm: 13.5px;
  --text-base: 15px;
  --text-lg: 17px;
  --text-xl: 19px;
  --text-2xl: 22px;

  --lh-tight: 1.25;
  --lh-normal: 1.7;
  --lh-relaxed: 2.0;

  --tracking-tight: -0.3px;

  /* unified motion curve + durations */
  --ease-ios: cubic-bezier(.16, 1, .3, 1);
  --dur-1: 180ms;
  --dur-2: 320ms;
  --dur-3: 520ms;
}

body.light-mode{
  --bg-color:#f8fafc;
  --bg-gradient:linear-gradient(180deg,#f1f5f9 0%,#e2e8f0 100%);
  --text-primary:#0f172a;
  --text-secondary:#475569;

  --glass-bg:rgba(255,255,255,.76);
  --glass-border:rgba(255,255,255,.92);
  --glass-highlight:rgba(255,255,255,.88);
  --glass-blur:34px;

  --card-shadow:0 16px 38px -10px rgba(15,23,42,.12);
  --inner-shadow:inset 0 1px 2px rgba(255,255,255,.9);

  --liquid-1:#60a5fa;
  --liquid-2:#f472b6;
  --liquid-3:#34d399;
}

*{
  box-sizing:border-box;
  -webkit-tap-highlight-color: transparent;
  outline:none;
  margin:0;
  padding:0;
}
body{
  background-color:var(--bg-color);
  background-image:var(--bg-gradient);
  color:var(--text-primary);
  font-family:'Vazirmatn', -apple-system, system-ui, sans-serif;
  min-height:100vh;
  overflow-x:hidden;
  transition: background var(--dur-3) var(--ease-ios), color var(--dur-3) var(--ease-ios);
  position:relative;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
  letter-spacing: var(--tracking-tight);
}

/* =========================
   Background (very subtle, low distraction)
========================= */
.liquid-blob{
  position:fixed; inset:0;
  overflow:hidden;
  z-index:0;
  pointer-events:none;
}
.blob{
  position:absolute;
  border-radius:50%;
  filter: blur(110px);
  opacity: 0.22;
  animation: floatBlob 26s infinite alternate var(--ease-ios);
  mix-blend-mode: screen;
  will-change: transform;
}
body.light-mode .blob{ mix-blend-mode:multiply; opacity:0.14; }

.blob-1{ top:-22%; left:-22%; width:62vw; height:62vw; background:var(--liquid-1); }
.blob-2{ bottom:-24%; right:-24%; width:72vw; height:72vw; background:var(--liquid-2); animation-delay:-13s; }
.blob-3{ top:35%; left:65%; width:40vw; height:40vw; background:var(--liquid-3); animation-delay:-7s; opacity:0.14; }

@keyframes floatBlob{
  0% { transform: translate3d(0,0,0) scale(1) rotate(0deg); }
  100%{ transform: translate3d(22px,26px,0) scale(1.03) rotate(4deg); }
}

/* super subtle noise layer */
.noise{
  position:fixed; inset:0; z-index:1; pointer-events:none; opacity:0.06;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
  mix-blend-mode: overlay;
}
body.light-mode .noise{ opacity:0.04; mix-blend-mode:multiply; }

/* particles (very soft) */
#particles{
  position:fixed; inset:0; pointer-events:none; z-index:2;
  opacity:0.0;
  transition: opacity var(--dur-3) var(--ease-ios);
}
body.weather-rain #particles{ opacity:0.28;
  background-image: url("data:image/svg+xml,%3Csvg width='26' height='26' viewBox='0 0 26 26' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M16 0 L10 16' stroke='rgba(120,120,255,0.22)' stroke-width='1'/%3E%3C/svg%3E");
  animation: rainFall 1.2s linear infinite;
}
body.weather-snow #particles{ opacity:0.24;
  background-image: radial-gradient(rgba(255,255,255,0.55) 26%, transparent 28%);
  background-size: 14px 14px;
  animation: snowFall 7s linear infinite;
}
@keyframes rainFall{ from{ background-position:0 0; } to{ background-position:-20px 520px; } }
@keyframes snowFall{ from{ background-position:0 0; } to{ background-position:30px 240px; } }

/* Reduced motion */
@media (prefers-reduced-motion: reduce){
  .blob, #particles{ animation:none !important; }
  *{ transition: none !important; }
}

/* =========================
   App Layout
========================= */
#app{
  position:relative; z-index:10;
  padding: calc(max(14px, env(safe-area-inset-top))) 22px 40px 22px;
  padding-bottom: 110px;
  max-width: 620px;
  margin:0 auto;
  width:100%;
  display:flex;
  flex-direction:column;
  gap: var(--stack-gap);
}

/* entrance animation (subtle) */
.fade-in-up{
  animation: fadeInUp 720ms var(--ease-ios) forwards;
  opacity:0;
  transform: translateY(18px);
}
@keyframes fadeInUp{ to{ opacity:1; transform: translateY(0); } }

/* =========================
   Glass Header (Sticky)
========================= */
header{
  position: sticky;
  top: calc(env(safe-area-inset-top) + 12px);
  z-index: 80;
  padding: 12px;
  border-radius: 30px;
  background: rgba(15,23,42,.34);
  border: 1px solid rgba(255,255,255,.10);
  border-top: 1px solid rgba(255,255,255,.14);
  backdrop-filter: blur(26px) saturate(170%);
  -webkit-backdrop-filter: blur(26px) saturate(170%);
  box-shadow: 0 18px 55px -28px rgba(0,0,0,.75), inset 0 1px 0 rgba(255,255,255,.14);
  transition: transform var(--dur-2) var(--ease-ios),
              background var(--dur-3) var(--ease-ios),
              box-shadow var(--dur-3) var(--ease-ios),
              border-color var(--dur-3) var(--ease-ios);
  display:flex;
  justify-content:space-between;
  align-items:center;
  width:100%;
  gap: 12px;
  overflow:hidden;
}

body.light-mode header{
  background: rgba(255,255,255,.62);
  border: 1px solid rgba(15,23,42,.10);
  border-top: 1px solid rgba(255,255,255,.82);
  box-shadow: 0 16px 42px -22px rgba(15,23,42,.18), inset 0 1px 0 rgba(255,255,255,.9);
}
header::before{
  content:"";
  position:absolute; inset:0;
  border-radius:inherit;
  pointer-events:none;
  background:
    radial-gradient(900px circle at 18% 0%, rgba(255,255,255,.12), transparent 45%),
    radial-gradient(800px circle at 88% 30%, rgba(96,165,250,.12), transparent 52%),
    radial-gradient(700px circle at 60% 120%, rgba(52,211,153,.10), transparent 55%);
  opacity: .70;
  mix-blend-mode: overlay;
}
body.light-mode header::before{ opacity:.50; mix-blend-mode:multiply; }
header > *{ position:relative; z-index:1; }

header.scrolled{
  background: rgba(15,23,42,.50);
  border-color: rgba(255,255,255,.14);
  box-shadow: 0 26px 70px -34px rgba(0,0,0,.82), inset 0 1px 0 rgba(255,255,255,.16);
}
body.light-mode header.scrolled{
  background: rgba(255,255,255,.74);
  border-color: rgba(15,23,42,.12);
}

.location-pill{
  display:flex; align-items:center; gap:10px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  border-top: 1px solid rgba(255,255,255,.18);
  padding: 12px 16px;
  border-radius: 999px;
  font-size: var(--text-base);
  font-weight: 850;
  cursor:pointer;
  transition: transform var(--dur-2) var(--ease-ios), background var(--dur-2) var(--ease-ios);
  color:var(--text-primary);
  max-width: 58%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
body.light-mode .location-pill{
  background: rgba(15,23,42,.04);
  border: 1px solid rgba(15,23,42,.10);
  border-top: 1px solid rgba(255,255,255,.7);
}
.location-pill:active{ transform: scale(.98); }

.header-actions{
  display:flex;
  gap: 10px;
  align-items:center;
  flex-direction: row;
}
.btn-circle{
  width: 48px;
  height: 48px;
  border-radius: 999px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  border-top: 1px solid rgba(255,255,255,.18);
  display:flex;
  align-items:center;
  justify-content:center;
  color:var(--text-primary);
  cursor:pointer;
  transition: transform var(--dur-2) var(--ease-ios), background var(--dur-2) var(--ease-ios);
  flex-shrink:0;
}
body.light-mode .btn-circle{
  background: rgba(15,23,42,.04);
  border: 1px solid rgba(15,23,42,.10);
  border-top: 1px solid rgba(255,255,255,.7);
}
.btn-circle:active{ transform: scale(.97); }

/* =========================
   Cards (glass)
========================= */
.glass-card{
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-top: 1px solid var(--glass-highlight);
  border-radius: var(--radius-xl);
  padding: var(--card-pad);
  backdrop-filter: blur(var(--glass-blur)) saturate(150%);
  -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(150%);
  box-shadow: var(--card-shadow), var(--inner-shadow);
  position: relative;
  overflow:hidden;
  transition: transform var(--dur-2) var(--ease-ios), box-shadow var(--dur-2) var(--ease-ios);
}
@media (hover:hover){
  .glass-card:hover{
    transform: translateY(-2px);
    box-shadow: 0 26px 65px -26px rgba(0,0,0,0.70), var(--inner-shadow);
  }
}
.glass-card::after{
  content:"";
  position:absolute; inset:-1px;
  border-radius:inherit;
  pointer-events:none;
  background: radial-gradient(1200px circle at 20% -10%, rgba(255,255,255,.07), transparent 35%);
  opacity:.65;
}

/* standardized title/subtitle (Apple-like) */
.card-head{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: 12px;
  margin-bottom: 14px;
}
.card-title{
  display:flex;
  align-items:center;
  gap: 10px;
  font-size: var(--text-xl);
  font-weight: 900;
  letter-spacing: var(--tracking-tight);
  line-height: var(--lh-tight);
}
.card-icon{
  width: 34px; height: 34px;
  display:flex; align-items:center; justify-content:center;
  border-radius: 12px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
}
body.light-mode .card-icon{
  background: rgba(15,23,42,.04);
  border: 1px solid rgba(15,23,42,.10);
}
.card-subtitle{
  font-size: var(--text-sm);
  color: var(--text-secondary);
  line-height: 1.85;
  margin-top: 6px;
}
.card-meta{
  font-size: var(--text-xs);
  color: var(--text-secondary);
  opacity:.9;
  text-align:left;
  direction:ltr;
  white-space:nowrap;
}

/* hero AQI */
.hero-section{
  display:flex;
  flex-direction:column;
  align-items:center;
  position:relative;
  margin-top: 10px;
}
.gauge-wrapper{
  width: 300px; height: 300px;
  position: relative;
  filter: drop-shadow(0 18px 38px rgba(0,0,0,0.28));
}
.gauge-svg{ width:100%; height:100%; transform: rotate(-90deg); }
.track{ fill:none; stroke: rgba(255,255,255,0.07); stroke-width: 16; stroke-linecap: round; }
.progress{
  fill:none; stroke: var(--accent-color); stroke-width:16; stroke-linecap: round;
  stroke-dasharray: 660; stroke-dashoffset: 660;
  transition: stroke-dashoffset 1500ms var(--ease-ios), stroke 700ms var(--ease-ios);
  filter: drop-shadow(0 0 10px color-mix(in srgb, var(--accent-color) 75%, transparent));
}
.hero-center{
  position:absolute; top:50%; left:50%;
  transform: translate(-50%,-50%);
  text-align:center;
  display:flex;
  flex-direction:column;
  align-items:center;
}
.hero-val{
  font-size: 86px;
  font-weight: 950;
  line-height: 0.92;
  letter-spacing: -3px;
  text-shadow: 0 10px 28px rgba(0,0,0,0.24);
}
.hero-label{
  font-size: 15px;
  font-weight: 900;
  color:#00130b;
  margin-top: 14px;
  background: var(--accent-color);
  padding: 8px 18px;
  border-radius: 999px;
  box-shadow: 0 12px 24px rgba(0,0,0,0.20);
}

/* friendly card */
.friendly-card{
  text-align:right;
  border-right: 6px solid #fbbf24;
  background: linear-gradient(90deg, rgba(255,255,255,0.04) 0%, rgba(0,0,0,0) 70%);
}
.friendly-text{
  font-size: var(--text-base);
  line-height: var(--lh-relaxed);
  font-weight: 520;
  text-align: justify;
  color: var(--text-primary);
  opacity: .96;
}

/* weather visual */
.weather-visual-card{
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
  padding: var(--card-pad-lg);
  background: linear-gradient(160deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
}
.weather-anim-container{
  width: 170px; height:170px;
  margin-bottom: 8px;
  position:relative;
  z-index:2;
  filter: drop-shadow(0 16px 34px rgba(0,0,0,0.18));
}
.visual-temp{
  font-size: 78px;
  font-weight: 950;
  line-height: 1;
  margin-bottom: 8px;
  background: linear-gradient(to bottom, var(--text-primary), var(--text-secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.visual-desc{
  font-size: 18px;
  font-weight: 900;
  color: var(--accent-color);
  margin-bottom: 18px;
}
.visual-grid{
  display:flex;
  gap: 18px;
  width:100%;
  justify-content:center;
  padding-top: 18px;
  border-top: 1px solid rgba(255,255,255,0.08);
}
.v-item{ display:flex; flex-direction:column; align-items:center; gap:6px; flex:1; }
.v-icon{ font-size: 22px; opacity:.95; }
.v-val{ font-size: 18px; font-weight: 900; }
.v-lbl{ font-size: 12px; font-weight: 600; color: var(--text-secondary); }

/* moon card */
.moon-card{
  border-right: 6px solid var(--purple);
  background: linear-gradient(135deg, rgba(167,139,250,0.10), rgba(0,0,0,0.10));
  display:flex;
  flex-direction:column;
  gap: 16px;
}
.moon-header{ display:flex; align-items:center; gap:16px; }
.moon-visual{
  width: 92px; height:92px;
  border-radius: 50%;
  flex-shrink:0;
  background-color: rgba(15,23,42,0.8);
  overflow:hidden;
  box-shadow: 0 0 34px rgba(167,139,250,0.18);
}
.moon-phase-name{
  font-size: var(--text-lg);
  font-weight: 950;
  color: var(--purple);
}
.moon-desc{
  font-size: var(--text-base);
  line-height: var(--lh-relaxed);
  opacity: .95;
  text-align: justify;
}

/* charts */
.chart-card{ padding: var(--card-pad-lg); }
.chart-container{ position:relative; height: 280px; width:100%; margin-top: 10px; }

/* segmented switch (iOS-like) */
.segment{
  display:flex;
  gap: 6px;
  padding: 6px;
  border-radius: 999px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
}
body.light-mode .segment{
  background: rgba(15,23,42,.04);
  border: 1px solid rgba(15,23,42,.10);
}
.seg-btn{
  flex:1;
  border: none;
  border-radius: 999px;
  padding: 10px 12px;
  font-family: inherit;
  font-weight: 900;
  font-size: var(--text-sm);
  cursor:pointer;
  background: transparent;
  color: var(--text-secondary);
  transition: background var(--dur-2) var(--ease-ios), color var(--dur-2) var(--ease-ios), transform var(--dur-1) var(--ease-ios);
}
.seg-btn:active{ transform: scale(.98); }
.seg-btn.active{
  background: rgba(255,255,255,.10);
  color: var(--text-primary);
}
body.light-mode .seg-btn.active{
  background: rgba(15,23,42,.06);
}

/* forecast list */
.forecast-list{ display:flex; flex-direction:column; gap: 12px; }
.forecast-item{
  display:flex; flex-direction:column; gap: 10px;
  padding: 18px;
  background: rgba(0,0,0,0.18);
  border-radius: 24px;
  border: 1px solid rgba(255,255,255,0.10);
  transition: background var(--dur-2) var(--ease-ios);
}
body.light-mode .forecast-item{ background: rgba(15,23,42,0.03); border-color: rgba(15,23,42,0.08); }
.f-top-row{ display:flex; justify-content:space-between; align-items:center; width:100%; }
.f-day-group{ display:flex; align-items:center; gap: 10px; }
.f-day{ font-weight: 950; font-size: var(--text-base); }
.f-icon{ font-size: 22px; }
.f-temp{ font-weight: 900; font-size: 17px; direction:ltr; color: var(--accent-color); }
.f-bot-row{
  font-size: var(--text-sm);
  opacity: 0.9;
  line-height: 1.95;
  text-align: justify;
  color: var(--text-secondary);
  padding-top: 10px;
  border-top: 1px solid rgba(255,255,255,0.08);
  width:100%;
}

/* info card */
.info-card{ padding: var(--card-pad-lg); }
.info-body{
  font-size: var(--text-base);
  line-height: var(--lh-relaxed);
  opacity: .95;
  white-space: pre-line;
  text-align: justify;
}

/* rain card */
.rain-row{
  font-size: var(--text-base);
  line-height: var(--lh-relaxed);
  opacity: .95;
}

/* elevation */
.elevation-card{
  text-align:center;
  border-bottom: 6px solid var(--accent-color);
}
.elev-icon{ font-size: 44px; margin-bottom: 12px; display:block; }
.elev-val{ font-size: 34px; font-weight: 950; color: var(--accent-color); margin: 6px 0; }
.elev-desc{ font-size: var(--text-base); opacity: 0.85; font-weight: 520; margin-top: 10px; line-height: 1.9; text-align: justify; }

/* pollutants grid */
.pollutant-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.p-card{
  background: rgba(255,255,255,0.04);
  border-radius: 28px;
  padding: 22px;
  border: 1px solid rgba(255,255,255,0.10);
  text-align:center;
  backdrop-filter: blur(var(--glass-blur));
  box-shadow: var(--inner-shadow);
}
body.light-mode .p-card{ background: rgba(15,23,42,0.03); border-color: rgba(15,23,42,0.08); }
.p-val{ font-size: 34px; font-weight: 950; margin: 10px 0; color: var(--accent-color); }

/* calendar card */
.calendar-card{ padding: var(--card-pad-lg); }
.date-grid{
  display:grid;
  grid-template-columns: 1fr;
  gap: 12px;
}
.date-line{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: 10px;
  padding: 14px 16px;
  border-radius: 20px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.10);
}
body.light-mode .date-line{ background: rgba(15,23,42,0.03); border-color: rgba(15,23,42,0.08); }
.date-label{ font-size: var(--text-sm); color: var(--text-secondary); font-weight: 800; }
.date-value{ font-size: var(--text-base); font-weight: 950; color: var(--text-primary); }
.progress-wrap{
  margin-top: 14px;
  display:flex;
  flex-direction:column;
  gap: 12px;
}
.pbar{
  width:100%;
  height: 14px;
  border-radius: 999px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.10);
  overflow:hidden;
}
body.light-mode .pbar{ background: rgba(15,23,42,0.03); border-color: rgba(15,23,42,0.08); }
.pfill{
  height:100%;
  width: 0%;
  border-radius: 999px;
  background: linear-gradient(90deg, rgba(255,255,255,0.14), rgba(255,255,255,0.06));
  transform-origin: right center;
  transition: width 900ms var(--ease-ios);
}
.pmeta{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap: 10px;
  font-size: var(--text-sm);
  color: var(--text-secondary);
  line-height: 1.9;
}
.pmeta b{ color: var(--text-primary); }

/* UV card */
.uv-card{ padding: var(--card-pad-lg); border-right: 6px solid color-mix(in srgb, var(--accent-color) 55%, var(--uv-yellow)); }
.uv-top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  margin-top: 10px;
}
.uv-pill{
  display:inline-flex;
  align-items:center;
  gap: 8px;
  padding: 10px 12px;
  border-radius: 999px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.10);
  font-weight: 950;
  font-size: var(--text-sm);
}
body.light-mode .uv-pill{ background: rgba(15,23,42,0.03); border-color: rgba(15,23,42,0.08); }
.uv-pill .dot{
  width: 10px; height:10px; border-radius:999px;
  background: var(--uv-green);
  box-shadow: 0 0 18px color-mix(in srgb, currentColor 50%, transparent);
}
.uv-desc{
  margin-top: 12px;
  font-size: var(--text-base);
  line-height: var(--lh-relaxed);
  text-align: justify;
  color: var(--text-primary);
  opacity: .95;
}
.uv-mini{
  margin-top: 8px;
  font-size: var(--text-sm);
  color: var(--text-secondary);
  line-height: 1.95;
}

/* loader */
#loader{
  position:fixed; inset:0;
  background: var(--bg-color);
  z-index:200;
  display:flex;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  transition: opacity var(--dur-3) var(--ease-ios);
}
#loader .t{
  margin-top: 22px;
  font-size: var(--text-lg);
  font-weight: 800;
  opacity: .9;
}

/* modals */
.modal-overlay{
  position:fixed; inset:0;
  background: rgba(0,0,0,0.66);
  z-index:100;
  backdrop-filter: blur(18px);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  opacity:0;
  pointer-events:none;
  transition: opacity var(--dur-3) var(--ease-ios);
}
.modal-overlay.open{ opacity:1; pointer-events:auto; }

.modal-sheet{
  width:100%;
  max-width: 620px;
  background: rgba(2,6,23,0.92);
  border-top-left-radius: 34px;
  border-top-right-radius: 34px;
  padding: 26px 22px 22px 22px;
  transform: translateY(105%);
  transition: transform var(--dur-3) var(--ease-ios);
  border-top: 1px solid rgba(255,255,255,0.12);
  box-shadow: 0 -10px 50px rgba(0,0,0,0.55);
}
body.light-mode .modal-sheet{
  background: rgba(248,250,252,0.92);
  border-top: 1px solid rgba(15,23,42,0.10);
}
.modal-overlay.open .modal-sheet{ transform: translateY(0); }

.search-input{
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.12);
  padding: 16px;
  border-radius: 22px;
  color: var(--text-primary);
  font-family: inherit;
  font-weight: 800;
  font-size: var(--text-base);
  width:100%;
  margin-top: 16px;
  text-align: center;
}
body.light-mode .search-input{ background: rgba(15,23,42,0.03); border-color: rgba(15,23,42,0.10); color: var(--text-primary); }

.search-item{
  padding: 16px;
  border-bottom: 1px solid rgba(255,255,255,0.10);
  cursor:pointer;
  text-align:center;
  color: var(--text-primary);
  font-weight: 650;
  transition: background var(--dur-2) var(--ease-ios);
}
.search-item:hover{ background: rgba(255,255,255,0.06); }

/* Welcome modal */
.welcome-modal{
  position:fixed; inset:0; z-index:300;
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(14px);
  display:flex;
  justify-content:center;
  align-items:center;
  opacity:0;
  pointer-events:none;
  transition: opacity var(--dur-3) var(--ease-ios);
}
.welcome-modal.active{ opacity:1; pointer-events:auto; }
.welcome-card{
  width: 92%;
  max-width: 420px;
  background: rgba(2,6,23,0.92);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 34px;
  padding: 30px;
  text-align:center;
  box-shadow: 0 40px 90px rgba(0,0,0,0.6);
  transform: scale(0.96);
  transition: transform var(--dur-3) var(--ease-ios);
}
body.light-mode .welcome-card{ background: rgba(248,250,252,0.92); border-color: rgba(15,23,42,0.10); }
.welcome-modal.active .welcome-card{ transform: scale(1); }
.welcome-icon{ font-size: 52px; margin-bottom: 14px; display:inline-block; opacity: .95; }
.welcome-btn{
  width:100%;
  padding: 16px;
  border-radius: 18px;
  border:none;
  font-family: inherit;
  font-size: var(--text-base);
  font-weight: 900;
  margin-top: 12px;
  cursor:pointer;
  transition: transform var(--dur-1) var(--ease-ios), filter var(--dur-2) var(--ease-ios);
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 10px;
}
.welcome-btn:active{ transform: scale(.98); }
.btn-primary{ background: var(--accent-color); color:#00130b; }
.btn-secondary{ background: rgba(255,255,255,0.06); color: var(--text-primary); border: 1px solid rgba(255,255,255,0.12); }
body.light-mode .btn-secondary{ background: rgba(15,23,42,0.03); border-color: rgba(15,23,42,0.10); }

/* Notifications modal (icon in header) */
.notif-modal .welcome-icon{ font-size: 54px; }
.notif-list{
  margin-top: 12px;
  text-align: right;
  font-size: var(--text-sm);
  line-height: 1.95;
  color: var(--text-secondary);
}
.notif-tip{
  margin-top: 12px;
  font-size: var(--text-base);
  line-height: var(--lh-relaxed);
  text-align: justify;
  color: var(--text-primary);
  opacity: .95;
}

/* footer */
footer{
  text-align:center;
  font-size: var(--text-sm);
  font-weight: 600;
  opacity: 0.45;
  margin-top: 24px;
}

/* =========================
   SVG anims (kept but softened)
========================= */
.anim-sun{ animation: spin 34s linear infinite; transform-origin: center; opacity:.98; }
.anim-cloud{ animation: float 9s ease-in-out infinite; }
.anim-rain{ animation: rainDrop 1.1s linear infinite; opacity:.9; }
.anim-snow{ animation: snowDrop 4.2s linear infinite; opacity:.9; }
.anim-thunder{ animation: flash 6.6s infinite; }
@keyframes spin{ 100%{ transform: rotate(360deg); } }
@keyframes float{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-10px); } }
@keyframes rainDrop{ 0%{ transform: translateY(0); opacity:1; } 100%{ transform: translateY(20px); opacity:0; } }
@keyframes snowDrop{ 0%{ transform: translateY(0); opacity:1; } 100%{ transform: translateY(16px); opacity:0.2; } }
@keyframes flash{ 0%, 92%, 100%{ opacity:0; } 94%, 97%{ opacity:1; filter: drop-shadow(0 0 18px #facc15); } }

/* small screens */
@media (max-width: 420px){
  :root{ --stack-gap: 16px; --card-pad: 20px; --card-pad-lg: 22px; }
  header{ border-radius: 26px; padding: 10px; }
  .location-pill{ max-width: 56%; }
  .gauge-wrapper{ width: 280px; height:280px; }
}
</style>
</head>

<body>
  <div class="liquid-blob">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
  </div>
  <div class="noise"></div>
  <div id="particles"></div>

  <div id="loader">
    <svg width="80" height="80" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <defs>
        <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" style="stop-color:var(--accent-color);stop-opacity:1" />
          <stop offset="100%" style="stop-color:var(--liquid-1);stop-opacity:1" />
        </linearGradient>
      </defs>
      <circle cx="12" cy="12" r="10" fill="none" stroke-dasharray="32" stroke-dashoffset="32" stroke="url(#grad1)">
        <animate attributeName="stroke-dashoffset" from="64" to="0" dur="1.25s" repeatCount="indefinite"/>
        <animate attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="2.2s" repeatCount="indefinite"/>
      </circle>
    </svg>
    <div class="t">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§...</div>
  </div>

  <!-- Welcome modal -->
  <div class="welcome-modal" id="welcome-modal">
    <div class="welcome-card">
      <div class="welcome-icon">ğŸŒ</div>
      <h2 style="font-size:24px;margin-bottom:10px;font-weight:950;letter-spacing:var(--tracking-tight);">Ø³Ù„Ø§Ù…! Ø¨Ù‡ Ù‡ÙˆØ§ÛŒ Ù¾Ø§Ú© Ù¾Ù„Ø§Ø³ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
      <p style="opacity:0.85;margin-bottom:18px;line-height:1.9;font-size:var(--text-base);">
        Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ Ø¯Ù‚ÛŒÙ‚ Ùˆ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒâ€ŒØ´Ø¯Ù‡ Ø¨Ø§Ø´Ù†ØŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ Ø±Ùˆ Ù…Ø´Ø®Øµ Ú©Ù†.
        (Ù‡Ø± Ø²Ù…Ø§Ù† Ù‡Ù… Ø®ÙˆØ§Ø³ØªÛŒ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§Ø² Ù‡Ø¯Ø± ØªØºÛŒÛŒØ±Ø´ Ø¨Ø¯ÛŒ.)
      </p>
      <button class="welcome-btn btn-primary" onclick="handleWelcomeGPS()">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 2v20M2 12h20"/><circle cx="12" cy="12" r="6"/></svg>
        ÛŒØ§ÙØªÙ† Ø®ÙˆØ¯Ú©Ø§Ø± Ù…ÙˆÙ‚Ø¹ÛŒØª
      </button>
      <button class="welcome-btn btn-secondary" onclick="handleWelcomeManual()">Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¯Ø³ØªÛŒ Ø´Ù‡Ø±</button>
    </div>
  </div>

  <!-- Notifications modal (icon in header) -->
  <div class="welcome-modal notif-modal" id="notif-modal">
    <div class="welcome-card">
      <div class="welcome-icon">ğŸ””</div>
      <h2 style="font-size:22px;margin-bottom:8px;font-weight:950;letter-spacing:var(--tracking-tight);">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†â€ŒÙ‡Ø§</h2>
      <div class="notif-tip">
        Ø§Ú¯Ø± Ø§Ø¬Ø§Ø²Ù‡ Ø¨Ø¯ÛŒØŒ ÙˆÙ‚ØªÛŒ <b>Ú©ÛŒÙÛŒØª Ù‡ÙˆØ§ Ø¨Ø¯</b> Ø´Ø¯ ÛŒØ§ <b>Ø¨Ø§Ø±Ø´ Ù†Ø²Ø¯ÛŒÚ©</b> Ø¨ÙˆØ¯ØŒ Ø¨Ù‡Øª Ø§Ø·Ù„Ø§Ø¹ Ù…ÛŒâ€ŒØ¯Ù….
        (Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø¨Ø¯ÙˆÙ† Ø³Ø±ÙˆØ±ØŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†â€ŒÙ‡Ø§ Ø±Ùˆ Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø² Ø¨ÙˆØ¯Ù† Ø§Ù¾ ÛŒØ§ Ø¯Ø± Ø¨Ø±Ø®ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§ Ø¨Ø§ Service Worker Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡.)
      </div>
      <div class="notif-list">
        â€¢ Ù‡Ø´Ø¯Ø§Ø± AQI: ÙˆÙ‚ØªÛŒ Ø´Ø§Ø®Øµ Ø§Ø² Ø­Ø¯ÛŒ Ø¨Ø§Ù„Ø§ØªØ± Ø±ÙØª<br>
        â€¢ Ù‡Ø´Ø¯Ø§Ø± Ø¨Ø§Ø±Ø´: ÙˆÙ‚ØªÛŒ Ø§Ø­ØªÙ…Ø§Ù„ Ø¨Ø§Ø±Ø´ Ø¯Ø± Ú†Ù†Ø¯ Ø³Ø§Ø¹Øª Ø¢ÛŒÙ†Ø¯Ù‡ Ø¨Ø§Ù„Ø§ Ø±ÙØª<br>
        â€¢ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ù‡Ø± Ø²Ù…Ø§Ù† Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø±ÙˆØ±Ú¯Ø± Ø®Ø§Ù…ÙˆØ´Ø´ Ú©Ù†ÛŒ
      </div>
      <button class="welcome-btn btn-primary" onclick="enableNotifications()">
        âœ… ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ
      </button>
      <button class="welcome-btn btn-secondary" onclick="toggleNotifModal(false)">ÙØ¹Ù„Ø§Ù‹ Ù†Ù‡</button>
    </div>
  </div>

  <!-- Search modal -->
  <div class="modal-overlay" id="search-modal">
    <div class="modal-sheet">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <span style="font-size:20px;font-weight:950;letter-spacing:var(--tracking-tight);">Ú©Ø¬Ø§ Ù‡Ø³ØªÛŒØ¯ØŸ</span>
        <button onclick="toggleSearch(false)" style="background:none;border:none;color:var(--text-primary);font-size:28px;cursor:pointer;">âœ•</button>
      </div>
      <div style="margin-top:6px;font-size:var(--text-sm);color:var(--text-secondary);line-height:1.8;">
        Ù†Ø§Ù… Ø´Ù‡Ø± Ø±Ø§ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù† (Ù…Ø«Ù„Ø§Ù‹: tehran) â€” Ù†ØªØ§ÛŒØ¬ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯ÛŒØªØ§ÛŒ Open-Meteo Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯.
      </div>
      <input type="text" class="search-input" id="city-input" placeholder="Ù…Ø«Ù„Ø§Ù‹: tehran" dir="ltr" />
      <div id="search-list" style="margin-top:14px;max-height:320px;overflow-y:auto;"></div>
    </div>
  </div>

  <div id="app">
    <!-- Header -->
    <header class="fade-in-up" style="animation-delay: 0.08s;">
      <div class="location-pill" onclick="toggleSearch(true)">
        <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
        <span id="loc-name">ØªÙ‡Ø±Ø§Ù†</span>
      </div>

      <div class="header-actions">
        <div class="btn-circle" onclick="toggleNotifModal(true)" title="Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†â€ŒÙ‡Ø§">
          <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M18 8a6 6 0 10-12 0c0 7-3 7-3 7h18s-3 0-3-7"/>
            <path d="M13.73 21a2 2 0 01-3.46 0"/>
          </svg>
        </div>
        <div class="btn-circle" onclick="toggleTheme()" title="ØªØºÛŒÛŒØ± ØªÙ…">
          <svg id="theme-icon" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
          </svg>
        </div>
        <div class="btn-circle" onclick="getLocation()" title="Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ Ù…Ù†">
          <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2v20M2 12h20"/><circle cx="12" cy="12" r="6"/></svg>
        </div>
      </div>
    </header>

    <!-- AQI gauge -->
    <div class="hero-section fade-in-up" style="animation-delay: 0.14s;">
      <div class="gauge-wrapper">
        <svg class="gauge-svg" viewBox="0 0 240 240">
          <circle class="track" cx="120" cy="120" r="110"></circle>
          <circle id="aqi-ring" class="progress" cx="120" cy="120" r="110"></circle>
        </svg>
        <div class="hero-center">
          <div class="hero-val" id="aqi-val">--</div>
          <div class="hero-label" id="aqi-text">...</div>
        </div>
      </div>
    </div>

    <!-- Friendly -->
    <div class="glass-card friendly-card fade-in-up" style="animation-delay: 0.20s;">
      <div class="card-head">
        <div>
          <div class="card-title"><span class="card-icon">ğŸ‘‹</span>Ú¯Ø²Ø§Ø±Ø´ Ø§Ø®ØªØµØ§ØµÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§</div>
          <div class="card-subtitle">Ù…ØªÙ† Ø¯ÙˆØ³ØªØ§Ù†Ù‡â€ŒÛŒ Ø§Ù…Ø±ÙˆØ²ØŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ù…Ø§/Ø¨Ø§Ø¯/Ø±Ø·ÙˆØ¨Øª Ùˆ Ú©ÙØ¯ Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ.</div>
        </div>
        <div class="card-meta" id="last-update">--</div>
      </div>
      <div class="friendly-text" id="friendly-text">Ø¯Ø± Ø­Ø§Ù„ Ù†Ú¯Ø§Ø±Ø´ Ú¯Ø²Ø§Ø±Ø´ Ø§Ø®ØªØµØ§ØµÛŒ...</div>
    </div>

    <!-- Weather visual -->
    <div class="glass-card weather-visual-card fade-in-up" style="animation-delay: 0.26s;">
      <div class="card-head" style="width:100%; margin-bottom: 8px;">
        <div>
          <div class="card-title"><span class="card-icon">ğŸŒ¤ï¸</span>ÙˆØ¶Ø¹ÛŒØª Ø¢Ø¨â€ŒÙˆÙ‡ÙˆØ§</div>
          <div class="card-subtitle">Ù†Ù…Ø§ÛŒ Ú©Ù„ÛŒ + Ø±Ø·ÙˆØ¨Øª Ùˆ Ø¨Ø§Ø¯ (Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø§Ø² Open-Meteo).</div>
        </div>
        <div class="card-meta" id="day-night-tag">--</div>
      </div>

      <div class="weather-anim-container" id="weather-icon-container"></div>
      <div class="visual-temp" id="visual-temp">--Â°</div>
      <div class="visual-desc" id="visual-desc">--</div>

      <div class="visual-grid">
        <div class="v-item">
          <span class="v-icon">ğŸ’§</span>
          <span class="v-val" id="hum-val">--%</span>
          <span class="v-lbl">Ø±Ø·ÙˆØ¨Øª Ù†Ø³Ø¨ÛŒ</span>
        </div>
        <div class="v-item">
          <span class="v-icon">ğŸ’¨</span>
          <span class="v-val" id="wind-val">--</span>
          <span class="v-lbl">Ø¨Ø§Ø¯ (km/h)</span>
        </div>
      </div>
    </div>

    <!-- Calendar card (Shamsi + Gregorian + Hijri) -->
    <div class="glass-card calendar-card fade-in-up" style="animation-delay: 0.32s;">
      <div class="card-head">
        <div>
          <div class="card-title"><span class="card-icon">ğŸ—“ï¸</span>ØªÙ‚ÙˆÛŒÙ… Ø§Ù…Ø±ÙˆØ²</div>
          <div class="card-subtitle">ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒØŒ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ùˆ Ù‡Ø¬Ø±ÛŒ Ù‚Ù…Ø±ÛŒ + Ø±ÙˆØ²Ø´Ù…Ø§Ø± Ø³Ø§Ù„â€ŒÙ‡Ø§ (Ø¨Ø¯ÙˆÙ† Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ø§ÛŒØ±Ù‡â€ŒØ§ÛŒ).</div>
        </div>
      </div>

      <div class="date-grid">
        <div class="date-line">
          <div>
            <div class="date-label">Ø´Ù…Ø³ÛŒ</div>
            <div class="date-value" id="date-jalali">--</div>
          </div>
          <div style="text-align:left;">
            <div class="date-label">Ø±ÙˆØ² Ù‡ÙØªÙ‡</div>
            <div class="date-value" id="weekday-fa">--</div>
          </div>
        </div>

        <div class="date-line">
          <div>
            <div class="date-label">Ù…ÛŒÙ„Ø§Ø¯ÛŒ</div>
            <div class="date-value" id="date-greg">--</div>
          </div>
          <div style="text-align:left;">
            <div class="date-label">UTC</div>
            <div class="date-value" id="utc-time">--</div>
          </div>
        </div>

        <div class="date-line">
          <div>
            <div class="date-label">Ù‡Ø¬Ø±ÛŒ Ù‚Ù…Ø±ÛŒ</div>
            <div class="date-value" id="date-hijri">--</div>
          </div>
          <div style="text-align:left;">
            <div class="date-label">ÙˆØ¶Ø¹ÛŒØª</div>
            <div class="date-value" id="hijri-note">--</div>
          </div>
        </div>
      </div>

      <div class="progress-wrap">
        <div>
          <div class="pmeta">
            <span>Ø³Ø§Ù„ Ø´Ù…Ø³ÛŒ</span>
            <span><b id="j-pass">--</b> Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡ â€¢ <b id="j-left">--</b> Ø±ÙˆØ² Ù…Ø§Ù†Ø¯Ù‡</span>
          </div>
          <div class="pbar"><div class="pfill" id="j-fill"></div></div>
        </div>

        <div>
          <div class="pmeta">
            <span>Ø³Ø§Ù„ Ù…ÛŒÙ„Ø§Ø¯ÛŒ</span>
            <span><b id="g-pass">--</b> Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡ â€¢ <b id="g-left">--</b> Ø±ÙˆØ² Ù…Ø§Ù†Ø¯Ù‡</span>
          </div>
          <div class="pbar"><div class="pfill" id="g-fill"></div></div>
        </div>

        <div>
          <div class="pmeta">
            <span>Ø³Ø§Ù„ Ù‚Ù…Ø±ÛŒ</span>
            <span><b id="h-pass">--</b> Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡ â€¢ <b id="h-left">--</b> Ø±ÙˆØ² Ù…Ø§Ù†Ø¯Ù‡</span>
          </div>
          <div class="pbar"><div class="pfill" id="h-fill"></div></div>
        </div>
      </div>
    </div>

    <!-- UV card -->
    <div class="glass-card uv-card fade-in-up" style="animation-delay: 0.38s;">
      <div class="card-head">
        <div>
          <div class="card-title"><span class="card-icon">ğŸ§´</span>UV Ø®ÙˆØ±Ø´ÛŒØ¯</div>
          <div class="card-subtitle">Ø´Ø§Ø®Øµ UV Ø¯Ù‚ÛŒÙ‚ (Ø³Ø§Ø¹ØªÛŒ/Ø±ÙˆØ²Ø§Ù†Ù‡) + ØªÙˆØµÛŒÙ‡ Ø¯ÙˆØ³ØªØ§Ù†Ù‡ + Ù†Ù…ÙˆØ¯Ø§Ø± Ø±Ù†Ú¯ÛŒ.</div>
        </div>
        <div class="card-meta" id="uv-meta">--</div>
      </div>

      <div class="uv-top">
        <div class="uv-pill" id="uv-pill">
          <span class="dot" id="uv-dot"></span>
          <span>UV Ø§Ù„Ø§Ù†: <span id="uv-now" style="direction:ltr;">--</span></span>
        </div>
        <div class="uv-pill" id="uv-max-pill">
          ğŸŒ Ø¨ÛŒØ´ÛŒÙ†Ù‡ Ø§Ù…Ø±ÙˆØ²: <span id="uv-max" style="direction:ltr;">--</span>
        </div>
      </div>

      <div class="uv-desc" id="uv-desc">Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ UV...</div>
      <div class="uv-mini" id="uv-mini">â€”</div>

      <div class="chart-container" style="height:220px;margin-top:12px;">
        <canvas id="uvChart"></canvas>
      </div>
    </div>

    <!-- Moon -->
    <div class="glass-card moon-card fade-in-up" style="animation-delay: 0.44s;">
      <div class="card-head" style="margin-bottom: 10px;">
        <div>
          <div class="card-title"><span class="card-icon">ğŸŒ™</span>ÙØ§Ø² Ù…Ø§Ù‡</div>
          <div class="card-subtitle">Ù†Ù…Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚ ÙØ§Ø² + Ø±ÙˆØ´Ù†Ø§ÛŒÛŒ + ÙØ§ØµÙ„Ù‡ + Ø´Ù…Ø§Ø±Ø´ ØªØ§ Ù…Ø§Ù‡ Ú©Ø§Ù…Ù„ Ùˆ Ù…Ø§Ù‡ Ù†Ùˆ.</div>
        </div>
      </div>

      <div class="moon-header">
        <div class="moon-visual" id="moon-render"></div>
        <div style="flex:1;">
          <div class="moon-phase-name" id="moon-phase-name">--</div>
          <div style="font-size:var(--text-sm);opacity:0.75;color:var(--text-secondary);line-height:1.85;">
            ÙˆØ¶Ø¹ÛŒØª Ú©ÛŒÙ‡Ø§Ù†ÛŒ Ø§Ù…Ø´Ø¨ â€¢ <span id="moon-countdown">--</span>
          </div>
        </div>
      </div>
      <div class="moon-desc" id="moon-desc">--</div>
    </div>

    <!-- Charts: Weekly/Hourly switch -->
    <div class="glass-card chart-card fade-in-up" style="animation-delay: 0.50s;">
      <div class="card-head" style="margin-bottom: 10px;">
        <div>
          <div class="card-title"><span class="card-icon">ğŸ“ˆ</span>Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§</div>
          <div class="card-subtitle">Ø³ÙˆÛŒÛŒÚ†Ø± Ø¨ÛŒÙ† Â«Ù‡ÙØªÚ¯ÛŒÂ» Ùˆ Â«Ø³Ø§Ø¹ØªÛŒÂ» (Ø¯Ù…Ø§ + Ø§Ø­ØªÙ…Ø§Ù„ Ø¨Ø§Ø±Ø´ + Ø¨Ø§Ø¯).</div>
        </div>
      </div>

      <div class="segment" role="tablist" aria-label="Chart switch">
        <button class="seg-btn active" id="btn-weekly" onclick="setChartMode('weekly')">Ù‡ÙØªÚ¯ÛŒ</button>
        <button class="seg-btn" id="btn-hourly" onclick="setChartMode('hourly')">Ø³Ø§Ø¹ØªÛŒ</button>
      </div>

      <div class="chart-container">
        <canvas id="mainChart"></canvas>
      </div>
    </div>

    <!-- Forecast list -->
    <div class="glass-card fade-in-up" style="animation-delay: 0.56s;">
      <div class="card-head">
        <div>
          <div class="card-title"><span class="card-icon">ğŸ—“ï¸</span>Ú†Ø´Ù…â€ŒØ§Ù†Ø¯Ø§Ø² Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø¢ÛŒÙ†Ø¯Ù‡</div>
          <div class="card-subtitle">Ø§Ø² ÙØ±Ø¯Ø§ ØªØ§ Û¶ Ø±ÙˆØ² Ø¨Ø¹Ø¯: ØªÙˆØ¶ÛŒØ­ Ú©ÙˆØªØ§Ù‡ + Ø¯Ù…Ø§ÛŒ Ø¨ÛŒØ´ÛŒÙ†Ù‡/Ú©Ù…ÛŒÙ†Ù‡.</div>
        </div>
      </div>
      <div class="forecast-list" id="forecast-list"></div>
    </div>

    <!-- AQI recommendation -->
    <div class="glass-card info-card fade-in-up" style="animation-delay: 0.62s; border-right:6px solid var(--accent-color);">
      <div class="card-head">
        <div>
          <div class="card-title"><span class="card-icon">ğŸƒ</span><span id="aqi-reco-head">ØªÙˆØµÛŒÙ‡ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø³Ù„Ø§Ù…ØªÛŒ</span></div>
          <div class="card-subtitle">Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ US AQI Ùˆ Ø¢Ù„Ø§ÛŒÙ†Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ.</div>
        </div>
      </div>
      <div class="info-body" id="aqi-reco-body">Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ù„Ø§Ù…ØªÛŒ...</div>
    </div>

    <!-- Story -->
    <div class="glass-card info-card fade-in-up" style="animation-delay: 0.68s; border-right:6px solid var(--info);">
      <div class="card-head">
        <div>
          <div class="card-title"><span class="card-icon" id="story-icon-box">âœ¨</span><span id="story-head">Ø¯Ø§Ø³ØªØ§Ù† Ø¢Ø³Ù…Ø§Ù†</span></div>
          <div class="card-subtitle">Ø±ÙˆØ§ÛŒØª Ø·ÙˆÙ„Ø§Ù†ÛŒâ€ŒØªØ±ØŒ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ùˆ Ù‡Ù…Ú†Ù†Ø§Ù† Ø®ÙˆØ´â€ŒØ®ÙˆØ§Ù† Ùˆ Ø¯ÙˆØ³ØªØ§Ù†Ù‡.</div>
        </div>
      </div>
      <div class="info-body" id="story-body">Ø¯Ø± Ø­Ø§Ù„ Ø´Ù†ÛŒØ¯Ù† ØµØ¯Ø§ÛŒ Ø¢Ø³Ù…Ø§Ù†...</div>
    </div>

    <!-- Rain (24h) -->
    <div class="glass-card fade-in-up" style="animation-delay: 0.74s; border-right:6px solid #818cf8;">
      <div class="card-head">
        <div>
          <div class="card-title"><span class="card-icon">ğŸŒ§ï¸</span>Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø¨Ø§Ø±Ø´ (Û²Û´ Ø³Ø§Ø¹Øª)</div>
          <div class="card-subtitle">Ø¬Ù…Ø¹â€ŒØ¨Ù†Ø¯ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§Ø² Ø§Ø­ØªÙ…Ø§Ù„ Ø¨Ø§Ø±Ø´ Ø³Ø§Ø¹ØªÛŒ.</div>
        </div>
      </div>
      <div class="rain-row">
        <div style="font-size:var(--text-lg); font-weight:950; margin-bottom: 6px;" id="rain-title">--</div>
        <div style="color:var(--text-primary); opacity:.92;" id="rain-desc">--</div>
      </div>
    </div>

    <!-- Elevation -->
    <div class="glass-card elevation-card fade-in-up" style="animation-delay: 0.80s;">
      <span class="elev-icon">ğŸ”ï¸</span>
      <div style="font-size:var(--text-base);font-weight:800;color:var(--text-secondary);">Ø§Ø±ØªÙØ§Ø¹ Ø´Ù…Ø§ Ø§Ø² Ø³Ø·Ø­ Ø¯Ø±ÛŒØ§</div>
      <div class="elev-val" id="elev-val">--</div>
      <div class="elev-desc" id="elev-desc">--</div>
    </div>

    <!-- Pollutants -->
    <div class="pollutant-grid fade-in-up" style="animation-delay: 0.86s;">
      <div class="p-card">
        <div style="font-size:30px;">ğŸ˜·</div>
        <div class="p-val" id="pm25-val">--</div>
        <div style="font-size:var(--text-sm); font-weight:800; color:var(--text-secondary);">PM2.5 (Âµg/mÂ³)</div>
      </div>
      <div class="p-card">
        <div style="font-size:30px;">ğŸŒ«ï¸</div>
        <div class="p-val" id="no2-val">--</div>
        <div style="font-size:var(--text-sm); font-weight:800; color:var(--text-secondary);">NOâ‚‚ (Âµg/mÂ³)</div>
      </div>
    </div>

    <footer class="fade-in-up" style="animation-delay: 0.92s;">
      Ø·Ø±Ø§Ø­ÛŒ Ùˆ ØªÙˆØ³Ø¹Ù‡ ØªÙˆØ³Ø· Ù¾ÛŒÙ…Ø§Ù† Ø¹Ø§Ø¨Ø¯ÛŒÙ† Ù¾ÙˆØ±  | Ù†Ø³Ø®Ù‡ 0.02
    </footer>
  </div>

<script>
/* =========================================
   Helpers
========================================= */
const toFarsi = (n) => (n ?? '')?.toString().replace(/\d/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]) || '-';
const clamp = (x, a, b) => Math.max(a, Math.min(b, x));

/* unified scroll polish */
(function headerScrollPolish(){
  const h = document.querySelector('header');
  if(!h) return;
  const onScroll = () => h.classList.toggle('scrolled', window.scrollY > 8);
  onScroll();
  window.addEventListener('scroll', onScroll, { passive:true });
})();

/* Chart.js defaults */
let chartMain = null;
let chartUV = null;
let chartMode = 'weekly';
let isLight = false;

if (typeof Chart !== 'undefined') {
  Chart.defaults.font.family = 'Vazirmatn';
  Chart.defaults.color = '#94a3b8';
  Chart.defaults.plugins.legend.display = false;
  Chart.defaults.animation.duration = 650;
}

/* =========================================
   Theme
========================================= */
function toggleTheme() {
  isLight = !isLight;
  document.body.classList.toggle('light-mode');
  const icon = document.getElementById('theme-icon');
  if (isLight) {
    icon.innerHTML = '<circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>';
  } else {
    icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
  }
  refreshChartsTheme();
}

function refreshChartsTheme(){
  const grid = isLight ? 'rgba(15,23,42,0.08)' : 'rgba(255,255,255,0.07)';
  const tick = isLight ? 'rgba(15,23,42,0.65)' : 'rgba(148,163,184,1)';
  if(chartMain){
    if(chartMain.options.scales?.y?.grid) chartMain.options.scales.y.grid.color = grid;
    if(chartMain.options.scales?.y1?.grid) chartMain.options.scales.y1.grid.color = grid;
    if(chartMain.options.scales?.y2?.grid) chartMain.options.scales.y2.grid.color = grid;
    if(chartMain.options.scales?.x?.ticks) chartMain.options.scales.x.ticks.color = tick;
    chartMain.update();
  }
  if(chartUV){
    if(chartUV.options.scales?.y?.grid) chartUV.options.scales.y.grid.color = grid;
    if(chartUV.options.scales?.x?.ticks) chartUV.options.scales.x.ticks.color = tick;
    chartUV.update();
  }
}

/* =========================================
   Weather SVG Icons
========================================= */
function getWeatherSVG(code, isDay) {
  const sunColor = "#facc15";
  const cloudColor = isLight ? "#64748b" : "#cbd5e1";
  const cloudFilter = "filter: drop-shadow(0 12px 18px rgba(0,0,0,0.20));";

  if (code <= 1) return isDay ?
    `<svg viewBox="0 0 100 100" overflow="visible">
      <defs><filter id="glow"><feGaussianBlur stdDeviation="5" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
      <circle cx="50" cy="50" r="23" fill="${sunColor}" filter="url(#glow)">
        <animate attributeName="r" values="23;26;23" dur="6s" repeatCount="indefinite"/>
      </circle>
      <g class="anim-sun" stroke="${sunColor}" stroke-width="4" stroke-linecap="round" opacity="0.95">
        <line x1="50" y1="10" x2="50" y2="-5"/><line x1="50" y1="90" x2="50" y2="105"/>
        <line x1="10" y1="50" x2="-5" y2="50"/><line x1="90" y1="50" x2="105" y2="50"/>
        <line x1="22" y1="22" x2="12" y2="12"/><line x1="78" y1="78" x2="88" y2="88"/>
        <line x1="22" y1="78" x2="12" y2="88"/><line x1="78" y1="22" x2="88" y2="12"/>
      </g>
    </svg>` :
    `<svg viewBox="0 0 100 100">
      <path d="M40 20 A30 30 0 1 0 80 70 A20 20 0 1 1 40 20" fill="#f1f5f9" filter="drop-shadow(0 0 16px rgba(255,255,255,0.35))"/>
      <circle cx="65" cy="45" r="3" fill="#94a3b8" opacity="0.6"/><circle cx="50" cy="65" r="4" fill="#94a3b8" opacity="0.4"/>
    </svg>`;

  if (code <= 3) return `<svg viewBox="0 0 100 100" overflow="visible">
    <path class="anim-cloud" d="M25,60 a20,20 0 0,1 0,-40 a20,20 0 0,1 40,0 a20,20 0 0,1 0,40 z"
      fill="${cloudColor}" stroke="rgba(255,255,255,0.25)" stroke-width="1.2" style="${cloudFilter}"/>
  </svg>`;

  if (code <= 67 || (code >= 80 && code <= 82)) return `<svg viewBox="0 0 100 100" overflow="visible">
    <path class="anim-cloud" d="M25,60 a20,20 0 0,1 0,-40 a20,20 0 0,1 40,0 a20,20 0 0,1 0,40 z" fill="${cloudColor}" style="${cloudFilter}"/>
    <g class="anim-rain" opacity="0.9">
      <line x1="35" y1="65" x2="30" y2="85" stroke="#60a5fa" stroke-width="4" stroke-linecap="round"/>
      <line x1="50" y1="65" x2="45" y2="90" stroke="#60a5fa" stroke-width="4" stroke-linecap="round"/>
      <line x1="65" y1="65" x2="60" y2="85" stroke="#60a5fa" stroke-width="4" stroke-linecap="round"/>
    </g>
  </svg>`;

  if ((code >= 71 && code <= 77) || code >= 85) return `<svg viewBox="0 0 100 100" overflow="visible">
    <path class="anim-cloud" d="M25,60 a20,20 0 0,1 0,-40 a20,20 0 0,1 40,0 a20,20 0 0,1 0,40 z" fill="${cloudColor}" style="${cloudFilter}"/>
    <g class="anim-snow" opacity="0.9">
      <circle cx="35" cy="75" r="4.5" fill="white"/><circle cx="55" cy="85" r="4.5" fill="white"/><circle cx="70" cy="70" r="4.5" fill="white"/>
    </g>
  </svg>`;

  if (code >= 95) return `<svg viewBox="0 0 100 100" overflow="visible">
    <path class="anim-cloud" d="M25,60 a20,20 0 0,1 0,-40 a20,20 0 0,1 40,0 a20,20 0 0,1 0,40 z" fill="#475569" style="${cloudFilter}"/>
    <path class="anim-thunder" d="M45,60 L35,80 L50,80 L40,105" fill="none" stroke="#facc15" stroke-width="6" stroke-linejoin="round" filter="drop-shadow(0 0 14px #facc15)"/>
  </svg>`;

  return `<svg viewBox="0 0 100 100">
    <g stroke="${cloudColor}" stroke-width="4" stroke-linecap="round" opacity="0.9">
      <line x1="20" y1="40" x2="80" y2="40"/><line x1="10" y1="60" x2="90" y2="60" opacity="0.7"/><line x1="30" y1="80" x2="70" y2="80" opacity="0.4"/>
    </g>
  </svg>`;
}

function getSmallIcon(code) {
  if (code <= 1) return 'â˜€ï¸';
  if (code <= 3) return 'â˜ï¸';
  if (code <= 67) return 'ğŸŒ§ï¸';
  if (code <= 77) return 'â„ï¸';
  if (code >= 95) return 'â›ˆï¸';
  return 'ğŸŒ¥ï¸';
}

/* =========================================
   Long friendly texts
========================================= */
function getFriendlyStatus(t, wCode, wind, hum, isDay) {
  const pick = (opts) => opts[Math.floor(Math.random() * opts.length)];
  const greeting = isDay ? pick([
      "Ø³Ù„Ø§Ù… Ø¯ÙˆØ³Øª Ø¹Ø²ÛŒØ²Ù…ØŒ Ø±ÙˆØ²Øª Ø³Ø±Ø´Ø§Ø± Ø§Ø² Ø±ÙˆØ´Ù†Ø§ÛŒÛŒ. â˜€ï¸ ",
      "Ø¯Ø±ÙˆØ¯ Ø¨Ø± ØªÙˆ! Ø§Ù…ÛŒØ¯ÙˆØ§Ø±Ù… Ù„Ø­Ø¸Ø§ØªØª Ù¾Ø± Ø§Ø² Ø¢Ø±Ø§Ù…Ø´ Ø¨Ø§Ø´Ù‡. ",
      "Ø³Ù„Ø§Ù…! Ú†Ù‡ ÙØ±ØµØª Ø®ÙˆØ¨ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¬Ø±Ø¨Ù‡ Ú©Ø±Ø¯Ù†Ù Ø§Ù…Ø±ÙˆØ²Ù‡. ",
      "ÙˆÙ‚Øª Ø¨Ø®ÛŒØ± Ù‡Ù…Ø±Ø§Ù‡ Ù…Ù†ØŒ Ø§Ù…ÛŒØ¯ÙˆØ§Ø±Ù… Ø­Ø§Ù„Øª Ø¹Ø§Ù„ÛŒ Ø¨Ø§Ø´Ù‡. ",
      "Ø³Ù„Ø§Ù…ÛŒ Ú¯Ø±Ù… Ø¯Ø± Ø§ÛŒÙ† Ø±ÙˆØ² Ø²ÛŒØ¨Ø§ ØªÙ‚Ø¯ÛŒÙ… ØªÙˆ. "
    ]) : pick([
      "Ø´Ø¨ Ø¨Ø®ÛŒØ± Ø¯ÙˆØ³Øª Ù…Ù†ØŒ Ø§Ù…ÛŒØ¯ÙˆØ§Ø±Ù… Ø®Ø³ØªÚ¯ÛŒ Ø±ÙˆØ² Ø±Ùˆ ÙØ±Ø§Ù…ÙˆØ´ Ú©Ù†ÛŒ. ğŸŒ™ ",
      "Ø¯Ø±ÙˆØ¯! Ø´Ø¨ Ø¢Ø±Ø§Ù… Ùˆ Ù¾Ø±Ø³ØªØ§Ø±Ù‡â€ŒØ§ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒ. âœ¨ ",
      "Ø³Ù„Ø§Ù…. Ø³Ú©ÙˆØª Ø´Ø¨ Ø¨Ù‡ØªØ±ÛŒÙ† Ø²Ù…Ø§Ù† Ø¨Ø±Ø§ÛŒ Ø¢Ø±Ø§Ù…Ø´ Ø°Ù‡Ù†Ù‡. ",
      "Ø´Ø¨ Ø®ÙˆØ´! Ø§Ù…ÛŒØ¯ÙˆØ§Ø±Ù… Ø±ÙˆÛŒØ§Ù‡Ø§ÛŒ Ø´ÛŒØ±ÛŒÙ†ÛŒ Ø¨Ø¨ÛŒÙ†ÛŒ. ğŸŒŒ ",
      "Ø³Ù„Ø§Ù…ÛŒ Ø§Ø² Ø¬Ù†Ø³ Ø¢Ø±Ø§Ù…Ø´ Ø´Ø¨Ø§Ù†Ù‡. "
    ]);

  let body = "";

  if (t < 0) {
    if ([71,73,75,77,85,86].includes(wCode)) {
      body = pick([
        `Ø´Ù‡Ø± Ø²ÛŒØ± Ù¾ÙˆØ´Ø´ÛŒ Ø§Ø² Ø­Ø±ÛŒØ± Ø³ÙÛŒØ¯ Ø¨Ù‡ Ø®ÙˆØ§Ø¨ Ø±ÙØªÙ‡ Ùˆ Ø¯Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø±Ù Ø¨Ø§ Ø¸Ø±Ø§ÙØªÛŒ Ø¨ÛŒâ€ŒÙ†Ø¸ÛŒØ± Ø¯Ø± Ù‡ÙˆØ§ Ù…ÛŒâ€ŒØ±Ù‚ØµÙ†Ø¯. â„ï¸
Ø§ÛŒÙ† Ù…Ù†Ø¸Ø±Ù‡ ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡â€ŒØ³ØªØŒ Ø§Ù…Ø§ Ø³Ø±Ù…Ø§ÛŒ Ø²ÛŒØ± ØµÙØ± Ø´ÙˆØ®ÛŒ Ù†Ø¯Ø§Ø±Ù‡.
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø§Ú¯Ø± Ø¨ÛŒØ±ÙˆÙ† Ù…ÛŒâ€ŒØ±ÛŒØŒ Ù„Ø§ÛŒÙ‡â€ŒÙ„Ø§ÛŒÙ‡ Ù„Ø¨Ø§Ø³ Ø¨Ù¾ÙˆØ´ Ùˆ Ø­ØªÙ…Ø§Ù‹ Ú©Ù„Ø§Ù‡/Ø´Ø§Ù„ Ù‡Ù…Ø±Ø§Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´. (Ø¨Ø§Ø¯: ${toFarsi(Math.round(wind))} km/h)`,
        `Ø²Ù…Ø³ØªØ§Ù† Ø¨Ø§ ÙˆÙ‚Ø§Ø± Ú©Ø§Ù…Ù„ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡. â˜ƒï¸ Ù†ÙØ³â€ŒÙ‡Ø§ ØªÙˆÛŒ Ù‡ÙˆØ§ Ø¯ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒØ´Ù† Ùˆ Ø²Ù…ÛŒÙ†â€ŒÙ‡Ø§ Ù…Ù…Ú©Ù†Ù‡ Ù„ØºØ²Ù†Ø¯Ù‡ Ø¨Ø§Ø´Ù†.
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ù‚Ø¯Ù…â€ŒÙ‡Ø§Øª Ø±Ùˆ Ø¢Ù‡Ø³ØªÙ‡â€ŒØªØ± Ø¨Ø±Ø¯Ø§Ø± Ùˆ Ú©ÙØ´ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ù¾ÙˆØ´. (Ø±Ø·ÙˆØ¨Øª: ${toFarsi(Math.round(hum))}Ùª)`
      ]);
    } else {
      body = pick([
        `Ù‡ÙˆØ§ Ø´ÙØ§Ù Ùˆ Ø¨Ù‡â€ŒØ´Ø¯Øª Ø³Ø±Ø¯ Ø§Ø³ØªØ› Ø³ÙˆØ² Ø³Ø±Ù…Ø§ Ù…Ø«Ù„ ØªÛŒØº Ù†Ø§Ù…Ø±Ø¦ÛŒ Ø±ÙˆÛŒ ØµÙˆØ±Øª Ù…ÛŒâ€ŒÙ†Ø´ÛŒÙ†Ø¯. ğŸ¥¶
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø¯Ø³ØªÚ©Ø´ Ùˆ Ø´Ø§Ù„ Ø±Ùˆ Ø¬Ø¯ÛŒ Ø¨Ú¯ÛŒØ±ØŒ Ù…Ø®ØµÙˆØµØ§Ù‹ Ø§Ú¯Ø± Ø¨Ø§Ø¯ Ù…ÛŒâ€ŒÙˆØ²Ù‡. (Ø¨Ø§Ø¯: ${toFarsi(Math.round(wind))} km/h)`,
        `Ø³Ú©ÙˆØª Ø²Ù…Ø³ØªØ§Ù†ÛŒ Ø±ÙˆÛŒ Ø´Ù‡Ø± Ù†Ø´Ø³ØªÙ‡. ğŸ§Š
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø§Ú¯Ø± Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ±ÙˆÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØŒ Ú©ÙˆØªØ§Ù‡ Ø§Ù…Ø§ ØªÙ†Ø¯ Ø¨Ø±Ùˆ ØªØ§ Ø¨Ø¯Ù†Øª Ú¯Ø±Ù… Ø¨Ù…ÙˆÙ†Ù‡.`
      ]);
    }
  } else if (t < 10) {
    if (wCode >= 51 || wCode === 3) {
      body = pick([
        `ØªØ±Ú©ÛŒØ¨ Ø³Ø±Ù…Ø§ Ùˆ Ø±Ø·ÙˆØ¨ØªØŒ ÙØ¶Ø§ Ø±Ùˆ Ø³ÛŒÙ†Ù…Ø§ÛŒÛŒ Ú©Ø±Ø¯Ù‡. ğŸŒ§ï¸
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ú†ØªØ± + Ú©ÙØ´ Ù…Ù†Ø§Ø³Ø¨. Ø§ÛŒÙ† Ù‡ÙˆØ§ Ø¢Ø¯Ù… Ø±Ùˆ ÛŒÙˆØ§Ø´â€ŒÛŒÙˆØ§Ø´ Ø®ÛŒØ³ Ù…ÛŒâ€ŒÚ©Ù†Ù‡.`,
        `Ø¢Ø³Ù…Ø§Ù† Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ùˆ Ù‡ÙˆØ§ÛŒ Ù†Ù…Ù†Ø§Ú©ØŒ Ø³Ø±Ù…Ø§ Ø±Ùˆ Ø¹Ù…ÛŒÙ‚â€ŒØªØ± Ù…ÛŒâ€ŒÚ©Ù†Ù‡. â˜”
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø§Ú¯Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨ÛŒØ±ÙˆÙ† Ø¯Ø§Ø±ÛŒØŒ Ú¯Ø±Ù… Ø¨Ù¾ÙˆØ´ Ùˆ Ø³Ø±ÛŒØ¹â€ŒØªØ± Ú©Ø§Ø±ØªÙˆ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡.`
      ]);
    } else if ([45,48].includes(wCode)) {
      body = pick([
        `Ø´Ù‡Ø± Ø¯Ø± Ù‡Ø§Ù„Ù‡â€ŒØ§ÛŒ Ø§Ø² Ù…Ù‡ ÙØ±Ùˆ Ø±ÙØªÙ‡ Ø§Ø³Øª. ğŸŒ«ï¸
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø±Ø§Ù†Ù†Ø¯Ú¯ÛŒ Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø·ØŒ Ú†Ø±Ø§Øºâ€ŒÙ‡Ø§ Ø±ÙˆØ´Ù† Ùˆ ÙØ§ØµÙ„Ù‡ Ø§Ù…Ù† Ø±Ùˆ Ø¨ÛŒØ´ØªØ± Ú©Ù†.`,
        `Ù…Ù‡ Ù‡Ù…Ù‡â€ŒÚ†ÛŒØ² Ø±Ùˆ Ù†Ø±Ù… Ùˆ Ø±ÙˆÛŒØ§Ú¯ÙˆÙ†Ù‡ Ú©Ø±Ø¯Ù‡. ğŸ‘»
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø§Ú¯Ø± Ø­Ø³Ø§Ø³ÛŒØª ØªÙ†ÙØ³ÛŒ Ø¯Ø§Ø±ÛŒØŒ Ø§Ù…Ø±ÙˆØ² Ù…Ø±Ø§Ù‚Ø¨â€ŒØªØ± Ø¨Ø§Ø´.`
      ]);
    } else {
      body = pick([
        `Ù‡ÙˆØ§ÛŒ Ø³Ø±Ø¯ Ø§Ù…Ø§ ØµØ§Ù. ğŸ§£
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: ÛŒÚ© Ù¾Ø§Ù„ØªÙˆ/Ú©Ø§Ù¾Ø´Ù† Ø³Ø¨Ú© Ú©Ø§ÙÛŒØ³Øªâ€”Ø§Ù…Ø§ Ú¯Ø±Ø¯Ù† Ùˆ Ø¯Ø³Øªâ€ŒÙ‡Ø§ Ø±Ùˆ Ú¯Ø±Ù… Ù†Ú¯Ù‡ Ø¯Ø§Ø±.`,
        `Ø³Ø±Ø¯ØŒ Ø®Ø´Ú© Ùˆ Ø´ÙØ§Ù. ğŸŒ¬ï¸
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ±ÙˆÛŒ Ú©ÙˆØªØ§Ù‡ØŒ Ø¹Ø§Ù„ÛŒÙ‡Ø› ÙÙ‚Ø· Ù„Ø¨Ø§Ø³ Ù…Ù†Ø§Ø³Ø¨ ÛŒØ§Ø¯Øª Ù†Ø±Ù‡.`
      ]);
    }
  } else if (t < 18) {
    if (wind > 15) {
      body = pick([
        `Ø¨Ø§Ø¯ Ø¯Ø± Ú©ÙˆÚ†Ù‡â€ŒÙ‡Ø§ Ù…ÛŒâ€ŒÙ¾ÛŒÚ†Ø¯ Ùˆ Ø¨Ø±Ú¯â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù‡ Ø±Ù‚Øµ Ø¯Ø¹ÙˆØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯. ğŸƒ
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø¨Ø§Ø¯Ú¯ÛŒØ±/Ù‡ÙˆØ¯ÛŒ Ø¨Ù‡ØªØ±ÛŒÙ† Ø§Ù†ØªØ®Ø§Ø¨Ù‡. (Ø¨Ø§Ø¯: ${toFarsi(Math.round(wind))} km/h)`,
        `Ù¾Ø§ÛŒÛŒØ² Ø¨Ø§ Ù†Ø³ÛŒÙ… Ø®Ù†Ú© Ùˆ Ø¬Ø§Ù†â€ŒØ¯Ø§Ø±Ø´ Ø§ÙˆÙ…Ø¯Ù‡. ğŸ‚
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: ÛŒÚ© Ù„Ø§ÛŒÙ‡ Ø³Ø¨Ú© Ú©Ø§ÙÛŒØ³ØªØ› ÙÙ‚Ø· Ú¯ÙˆØ´ Ùˆ Ú¯Ø±Ø¯Ù† Ø±Ùˆ Ù¾ÙˆØ´Ø´ Ø¨Ø¯Ù‡.`
      ]);
    } else if (wCode >= 51) {
      body = pick([
        `Ø¨Ø§Ø±Ø§Ù†ÛŒ Ø±ÛŒØ² Ùˆ Ù„Ø·ÛŒÙ Ù…ÛŒâ€ŒØ¨Ø§Ø±Ø¯ Ùˆ Ø¨ÙˆÛŒ Ø®Ø§Ú© Ø¨Ø§Ø±Ø§Ù†â€ŒØ®ÙˆØ±Ø¯Ù‡ ÙØ¶Ø§ Ø±Ùˆ Ù¾Ø± Ú©Ø±Ø¯Ù‡. ğŸŒ§ï¸
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø¨Ø§Ø±Ø§Ù†ÛŒ Ø³Ø¨Ú© Ùˆ ÛŒÚ© Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ±ÙˆÛŒ Ú©ÙˆØªØ§Ù‡ØŒ Ø®ÛŒÙ„ÛŒ Ù…ÛŒâ€ŒÚ†Ø³Ø¨Ù‡.`,
        `Ø¢Ø³Ù…Ø§Ù† Ø¢Ø±Ø§Ù… Ù…ÛŒâ€ŒÚ¯Ø±ÛŒØ¯ Ùˆ Ù‡ÙˆØ§ Ø³Ø¨Ú©â€ŒØªØ± Ø´Ø¯Ù‡. ğŸŒ¦ï¸
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ú†ØªØ± Ú©ÙˆÚ†ÛŒÚ© Ù‡Ù…Ø±Ø§Ù‡Øª Ø¨Ø§Ø´Ù‡ØŒ Ù‡Ù…ÛŒÙ†.`
      ]);
    } else {
      body = pick([
        `ØªØ¹Ø§Ø¯Ù„ Ø¯Ù„Ù¾Ø°ÛŒØ±! ğŸ§¥ Ù†Ù‡ Ú¯Ø±Ù…Ø§ØŒ Ù†Ù‡ Ø³Ø±Ù…Ø§.
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø§Ú¯Ø± Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ú©ÙˆØªØ§Ù‡ Ø±Ùˆ Ù¾ÛŒØ§Ø¯Ù‡ Ø¨Ø±ÙˆØ› Ø­Ø§Ù„ Ø¯Ù„Øª Ø¨Ù‡ØªØ± Ù…ÛŒâ€ŒØ´Ù‡.`,
        `Ø§Ø² Ø¢Ù† Ø±ÙˆØ²Ù‡Ø§ÛŒÛŒ Ø§Ø³Øª Ú©Ù‡ Ø¢Ø±Ø²Ùˆ Ù…ÛŒâ€ŒÚ©Ù†ÛŒ ØªÙ…Ø§Ù… Ù†Ø´ÙˆØ¯. ğŸŒ†
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: ØªØ§ÛŒÙ… Ú©ÙˆØªØ§Ù‡ÛŒ Ø¨ÛŒØ±ÙˆÙ† Ø¨Ø§Ø´â€”Ù‡ÙˆØ§ÛŒ ØªØ§Ø²Ù‡ Ø§Ø±Ø²Ø´Ø´ Ø±Ùˆ Ø¯Ø§Ø±Ù‡.`
      ]);
    }
  } else if (t < 27) {
    if (isDay) {
      body = pick([
        `Ø¨Ù‡Ø´Øª ÛŒØ¹Ù†ÛŒ Ù‡Ù…ÛŒÙ†! ğŸŒ¼ Ù‡ÙˆØ§ Ø¹Ø§Ù„ÛŒÙ‡â€”Ø¨ÛŒØ±ÙˆÙ† Ø¨ÙˆØ¯Ù† ÙˆØ§Ù‚Ø¹Ø§Ù‹ Ø­Ø§Ù„â€ŒØ®ÙˆØ¨â€ŒÚ©Ù†Ù‡.
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø¶Ø¯Ø¢ÙØªØ§Ø¨ Ù…Ù„Ø§ÛŒÙ… Ùˆ Ø¢Ø¨ Ù‡Ù…Ø±Ø§Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´.`,
        `Ø®ÙˆØ±Ø´ÛŒØ¯ Ù…ÛŒâ€ŒØ¯Ø±Ø®Ø´Ø¯ Ø§Ù…Ø§ Ù†Ù…ÛŒâ€ŒØ³ÙˆØ²Ø§Ù†Ø¯. ğŸ˜
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ±ÙˆÛŒ/ÙˆØ±Ø²Ø´ Ø³Ø¨Ú© Ø¨Ù‡ØªØ±ÛŒÙ† Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù…Ø±ÙˆØ² Ø§Ø³Øª.`
      ]);
    } else {
      body = pick([
        `Ú†Ù‡ Ø´Ø¨ÛŒ! ğŸŒ™ Ø¯Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ù‚Ø¯Ù… Ø²Ø¯Ù† Ø¹Ø§Ù„ÛŒÙ‡.
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ù¾Ù†Ø¬Ø±Ù‡ Ø±Ùˆ Ú©Ù…ÛŒ Ø¨Ø§Ø² Ø¨Ø°Ø§Ø± ØªØ§ Ù‡ÙˆØ§ÛŒ ØªØ§Ø²Ù‡ ÙˆØ§Ø±Ø¯ Ø¨Ø´Ù‡.`,
        `Ø´Ø¨ Ù…Ø®Ù…Ù„ÛŒ Ùˆ Ø¢Ø±Ø§Ù…. âœ¨
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: ÛŒÚ© Ú†Ø§ÛŒ Ø¯Ø± Ø¨Ø§Ù„Ú©Ù†/Ù¾Ù†Ø¬Ø±Ù‡ Ùˆ Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ Ù†ÙØ³ Ø¹Ù…ÛŒÙ‚.`
      ]);
    }
  } else if (t < 35) {
    if (hum > 60) {
      body = pick([
        `Ú¯Ø±Ù… Ùˆ Ø´Ø±Ø¬ÛŒ! ğŸ’§ Ù†ÙØ³ Ú©Ø´ÛŒØ¯Ù† Ú©Ù…ÛŒ Ø³Ù†Ú¯ÛŒÙ† Ù…ÛŒâ€ŒØ´Ù‡.
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ù„Ø¨Ø§Ø³ Ù†Ø®ÛŒ Ú¯Ø´Ø§Ø¯ + Ø¢Ø¨ Ø²ÛŒØ§Ø¯. ÙØ¹Ø§Ù„ÛŒØª Ø³Ù†Ú¯ÛŒÙ† Ø±Ùˆ Ú©Ù… Ú©Ù†.`,
        `Ø³ÙˆÙ†Ø§ÛŒ Ø¨Ø®Ø§Ø± Ø´Ù‡Ø±ÛŒ ğŸ¥µ
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø¨ÛŒØ±ÙˆÙ† Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ±ÛŒØŒ Ú©ÙˆØªØ§Ù‡ Ùˆ Ø¨Ø§ Ø¢Ø¨ Ù‡Ù…Ø±Ø§Ù‡.`
      ]);
    } else {
      body = pick([
        `ØªØ§Ø¨Ø³ØªØ§Ù† Ù‚Ø¯Ø±Øªâ€ŒÙ†Ù…Ø§ÛŒÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯! â˜€ï¸
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø¹ÛŒÙ†Ú© Ø¢ÙØªØ§Ø¨ÛŒ + Ø¶Ø¯Ø¢ÙØªØ§Ø¨ØŒ Ùˆ ØªØ±Ø¬ÛŒØ­Ø§Ù‹ ØªÙˆ Ø³Ø§ÛŒÙ‡ Ø­Ø±Ú©Øª Ú©Ù†.`,
        `Ú¯Ø±Ù…Ø§ÛŒ Ø®Ø´Ú© Ùˆ Ù…Ø³ØªÙ‚ÛŒÙ…. ğŸŒµ
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø¢Ø¨ + Ù…Ø±Ø·ÙˆØ¨â€ŒÚ©Ù†Ù†Ø¯Ù‡Ø› Ù¾ÙˆØ³Øª ØªÙˆ Ø§ÛŒÙ† Ù‡ÙˆØ§ Ø³Ø±ÛŒØ¹ Ø®Ø´Ú© Ù…ÛŒâ€ŒØ´Ù‡.`
      ]);
    }
  } else {
    body = pick([
      `ÙˆØ¶Ø¹ÛŒØª Ø­Ø±Ø§Ø±ØªÛŒ Ù‚Ø±Ù…Ø²! ğŸ”¥
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø§Ú¯Ø± Ú©Ø§Ø± Ø­ÛŒØ§ØªÛŒ Ù†Ø¯Ø§Ø±ÛŒ Ø¨ÛŒØ±ÙˆÙ† Ù†Ø±Ùˆ. Ø¢Ø¨ØŒ Ø³Ø§ÛŒÙ‡ Ùˆ Ø®Ù†Ú© Ù…ÙˆÙ†Ø¯Ù† Ø§ÙˆÙ„ÙˆÛŒØª Ø§ÙˆÙ„.`,
      `Ú¯Ø±Ù…Ø§ÛŒÛŒ Ú©Ù‡ Ù†ÙØ³ Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯! ğŸ¥µ
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ù…Ø±Ø§Ù‚Ø¨ Ú©ÙˆØ¯Ú©Ø§Ù† Ùˆ Ø³Ø§Ù„Ù…Ù†Ø¯Ø§Ù† Ø¨Ø§Ø´. Ø¨ÛŒØ±ÙˆÙ† Ø±ÙØªÙ† Ø±Ùˆ Ø­Ø¯Ø§Ù‚Ù„ Ú©Ù†.`
    ]);
  }

  if ([95,96,99].includes(wCode)) {
    body = pick([
      `Ø¢Ø³Ù…Ø§Ù† Ù†Ù…Ø§ÛŒØ´ Ø¯Ø±Ø§Ù…Ø§ØªÛŒÚ© Ø¨Ù‡ Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø®ØªÙ‡! âš¡
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø²ÛŒØ± Ø¯Ø±Ø®Øª Ùˆ Ø³Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ù„Ù†Ø¯ Ù†Ø±Ùˆ. Ø§Ø² Ù¾Ù†Ø¬Ø±Ù‡ ØªÙ…Ø§Ø´Ø§ Ú©Ù†.`,
      `Ø·ÙˆÙØ§Ù† ØªÙ†Ø¯Ø±ÛŒ Ø¯Ø± Ø¬Ø±ÛŒØ§Ù† Ø§Ø³Øª. â›ˆï¸
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø¨ÛŒØ±ÙˆÙ† Ø±ÙØªÙ† Ø±ÛŒØ³Ú© Ø¯Ø§Ø±Ø¯Ø› Ø§ÛŒÙ…Ù†ÛŒ Ø§ÙˆÙ„ÙˆÛŒØª Ø§Ø³Øª.`
    ]);
  }

  return greeting + body;
}

function getAirQualityMessage(aqi) {
  const pick = (options) => options[Math.floor(Math.random() * options.length)];
  if (aqi <= 50) return pick([
    { text: "ÙˆØ¶Ø¹ÛŒØª Ø³Ø¨Ø² ğŸ’š Ù‡ÙˆØ§ Ø¹Ø§Ù„ÛŒÙ‡ Ùˆ Ù†ÙØ³ Ú©Ø´ÛŒØ¯Ù† ÙˆØ§Ù‚Ø¹Ø§Ù‹ Ù„Ø°Øªâ€ŒØ¨Ø®Ø´Ù‡.\nØªÙˆØµÛŒÙ‡: Ù¾Ù†Ø¬Ø±Ù‡â€ŒÙ‡Ø§ Ø±Ùˆ Ø¨Ø§Ø² Ú©Ù† Ùˆ Ø§Ú¯Ø± ÙØ±ØµØª Ø¯Ø§Ø±ÛŒ ÛŒÚ© Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ±ÙˆÛŒ Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ùˆ." },
    { text: "Ø§Ú©Ø³ÛŒÚ˜Ù†â€ŒØªØ±Ø§Ù¾ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù† ğŸ§˜â€â™‚ï¸ Ø§Ù…Ø±ÙˆØ² Ù‡ÙˆØ§ Ø®ÛŒÙ„ÛŒ Ù¾Ø§Ú©Ù‡.\nØªÙˆØµÛŒÙ‡: ÙˆØ±Ø²Ø´ Ø³Ø¨Ú© Ø¯Ø± ÙØ¶Ø§ÛŒ Ø¨Ø§Ø² Ø¹Ø§Ù„ÛŒÙ‡." }
  ]);
  if (aqi <= 100) return pick([
    { text: "ÙˆØ¶Ø¹ÛŒØª Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„ ğŸ™‚\nØªÙˆØµÛŒÙ‡: Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø±ÙˆØ²Ù…Ø±Ù‡ Ø§ÙˆÚ©ÛŒÙ‡. Ø§Ú¯Ø± Ø­Ø³Ø§Ø³ÛŒØª Ø´Ø¯ÛŒØ¯ Ø¯Ø§Ø±ÛŒØŒ Ú©Ù…ÛŒ Ø§Ø­ØªÛŒØ§Ø· Ú©Ù†." },
    { text: "Ù†Ù‡ Ø¹Ø§Ù„ÛŒØŒ Ù†Ù‡ Ø¨Ø¯ ğŸ‘Œ\nØªÙˆØµÛŒÙ‡: ÙˆØ±Ø²Ø´ Ø³Ù†Ú¯ÛŒÙ† Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø±Ùˆ Ú©Ù…ØªØ± Ú©Ù†ØŒ Ø§Ù…Ø§ Ø¹Ø§Ø¯ÛŒ Ù…Ø´Ú©Ù„ÛŒ Ù†ÛŒØ³Øª." }
  ]);
  if (aqi <= 150) return pick([
    { text: "Ù†Ø§Ø³Ø§Ù„Ù… Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø³ ğŸ˜·\nØªÙˆØµÛŒÙ‡: Ø§Ú¯Ø± Ø¢Ø³Ù…/Ø¢Ù„Ø±Ú˜ÛŒ/Ø³Ø§Ù„Ù…Ù†Ø¯/Ú©ÙˆØ¯Ú© Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø¨ÛŒØ±ÙˆÙ† Ú©Ù…ØªØ± Ø¨Ø§Ø´ÛŒØ¯." },
    { text: "Ù‡Ø´Ø¯Ø§Ø± Ù†Ø§Ø±Ù†Ø¬ÛŒ ğŸŸ \nØªÙˆØµÛŒÙ‡: ÙØ¹Ø§Ù„ÛŒØª Ø³Ù†Ú¯ÛŒÙ† Ø¨ÛŒØ±ÙˆÙ† Ø±Ùˆ Ù…Ø­Ø¯ÙˆØ¯ Ú©Ù†. Ù¾Ù†Ø¬Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ø±Ùˆ Ø¨Ù‡ Ø®ÛŒØ§Ø¨ÙˆÙ† Ø±Ùˆ Ø¨Ø¨Ù†Ø¯." }
  ]);
  if (aqi <= 200) return pick([
    { text: "Ù†Ø§Ø³Ø§Ù„Ù… Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ â›”\nØªÙˆØµÛŒÙ‡: Ø¨ÛŒØ±ÙˆÙ† Ø±ÙØªÙ† Ø±Ùˆ Ø­Ø¯Ø§Ù‚Ù„ Ú©Ù†. Ø§Ú¯Ø± Ù…Ø¬Ø¨ÙˆØ± Ø´Ø¯ÛŒØŒ Ù…Ø§Ø³Ú© ÙÛŒÙ„ØªØ±Ø¯Ø§Ø± Ø¨Ù‡ØªØ±Ù‡." },
    { text: "Ù‡Ø´Ø¯Ø§Ø± Ù‚Ø±Ù…Ø² ğŸš‘\nØªÙˆØµÛŒÙ‡: ÙˆØ±Ø²Ø´ Ø¨ÛŒØ±ÙˆÙ† Ù…Ù…Ù†ÙˆØ¹. Ø¯Ø± Ùˆ Ù¾Ù†Ø¬Ø±Ù‡ Ø±Ùˆ Ø¨Ø³ØªÙ‡ Ù†Ú¯Ù‡ Ø¯Ø§Ø±." }
  ]);
  return pick([
    { text: "Ø¨Ø³ÛŒØ§Ø± Ø®Ø·Ø±Ù†Ø§Ú© â˜ ï¸\nØªÙˆØµÛŒÙ‡: Ø¨ÛŒØ±ÙˆÙ† Ù†Ø±Ùˆ. Ø¯Ø±Ø²Ù‡Ø§ Ø±Ùˆ Ø¨Ø¨Ù†Ø¯ Ùˆ Ø§Ú¯Ø± Ø¯Ø§Ø±ÛŒ ØªØµÙÛŒÙ‡â€ŒÙ‡ÙˆØ§ Ø±Ùˆ Ø±ÙˆØ´Ù† Ú©Ù†." },
    { text: "Ø§Ø¶Ø·Ø±Ø§Ø± ğŸŸ£ Ù‡ÙˆØ§ ÙˆØ§Ù‚Ø¹Ø§Ù‹ Ø³Ù…Ù‡.\nØªÙˆØµÛŒÙ‡: Ø­Ø¶ÙˆØ± Ø¨ÛŒØ±ÙˆÙ† = Ø¢Ø³ÛŒØ¨ Ø¬Ø¯ÛŒ. ÙÙ‚Ø· Ø¶Ø±ÙˆØ±ÛŒ." }
  ]);
}

/* Long story */
function getDetailedQuote(temp, weatherCode, windSpeed, aqi, isNight) {
  if (aqi > 200) return {
    title: "Ù…ÙˆØ¯: Ø¢Ø®Ø±Ø§Ù„Ø²Ù…Ø§Ù† Ø´Ù‡Ø±ÛŒ",
    icon: "â˜¢ï¸",
    text: "Ø´Ø§Ø®Øµ Ø¢Ù„ÙˆØ¯Ú¯ÛŒ Ø¨Ø§Ù„Ø§Ø³Øª Ùˆ Ù‡ÙˆØ§ Ø³Ù†Ú¯ÛŒÙ† Ùˆ Ø®ÙÙ‡â€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø´Ø¯Ù‡. Ø§Ù…Ø±ÙˆØ² Ø¨ÛŒØ±ÙˆÙ† Ø±ÙØªÙ† Ø§Ø±Ø²Ø´ Ø±ÛŒØ³Ú© Ù†Ø¯Ø§Ø±Ù‡. Ø§Ú¯Ø± Ù…Ø¬Ø¨ÙˆØ± Ø´Ø¯ÛŒØŒ Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ùˆ Ùˆ Ø¨Ø±Ú¯Ø±Ø¯ Ùˆ ØªØ±Ø¬ÛŒØ­Ø§Ù‹ Ù…Ø§Ø³Ú© ÙÛŒÙ„ØªØ±Ø¯Ø§Ø± Ø¨Ø²Ù†. Ø¯Ø§Ø®Ù„ Ø®ÙˆÙ†Ù‡ Ù‡Ù… Ø¨Ù‡ØªØ±Ù‡ Ø«Ø§Ø¨Øª Ùˆ Ø¢Ø±ÙˆÙ… Ø¨Ù…Ø§Ù†ÛŒØ› Ù¾Ù†Ø¬Ø±Ù‡â€ŒÙ‡Ø§ Ø¨Ø³ØªÙ‡ Ùˆ Ø§Ú¯Ø± Ø¯Ø³ØªÚ¯Ø§Ù‡ ØªØµÙÛŒÙ‡ Ù‡ÙˆØ§ Ø¯Ø§Ø±ÛŒØŒ Ø±ÙˆØ´Ù†. Ø§ÛŒÙ† ÛŒÚ©ÛŒ Ø§Ø² Ø§ÙˆÙ† Ø±ÙˆØ²Ù‡Ø§Ø³Øª Ú©Ù‡ Â«Ø­ÙØ¸ Ø§Ù†Ø±Ú˜ÛŒÂ» Ø®ÙˆØ¯Ø´ ÛŒÙ‡ ØªØµÙ…ÛŒÙ… Ù‡ÙˆØ´Ù…Ù†Ø¯Ø§Ù†Ù‡â€ŒØ³Øª."
  };
  if (aqi > 150) return {
    title: "ÙÛŒÙ„ØªØ± Ø¯ÙˆØ¯ÛŒ Ø±ÙˆÛŒ Ø´Ù‡Ø±",
    icon: "ğŸ˜·",
    text: "Ù‡ÙˆØ§ ØªÙ…ÛŒØ² Ù†ÛŒØ³ØªØ› ÛŒÚ© Ù‡Ø§Ù„Ù‡â€ŒÛŒ ØºØ¨Ø§Ø± Ùˆ Ø¯ÙˆØ¯ Ø¯Ø± Ø§ÙÙ‚ Ø¯ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø¨Ø±Ø§ÛŒ Ø§ÙØ±Ø§Ø¯ Ø­Ø³Ø§Ø³ Ø´Ø±Ø§ÛŒØ· Ù…Ù†Ø§Ø³Ø¨ Ù†ÛŒØ³Øª Ùˆ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ù‡Ù… Ø¨Ù‡ØªØ±Ù‡ ÙØ¹Ø§Ù„ÛŒØª Ø³Ù†Ú¯ÛŒÙ† Ø¨ÛŒØ±ÙˆÙ† Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ù‡. Ø§Ú¯Ø± Ù…Ø³ÛŒØ± Ú©ÙˆØªØ§Ù‡ÛŒ Ø¯Ø§Ø±ÛŒØŒ Ø§Ù†Ø¬Ø§Ù…Ø´ Ø¨Ø¯Ù‡ØŒ Ø§Ù…Ø§ Ø¯ÙˆÛŒØ¯Ù†/ÙˆØ±Ø²Ø´ Ø¬Ø¯ÛŒ Ø±Ùˆ Ø¨Ø°Ø§Ø± Ø¨Ø±Ø§ÛŒ ÙˆÙ‚Øª Ø¨Ù‡ØªØ±. Ø¨Ø¯Ù†Øª Ø§Ù…Ø±ÙˆØ² Ø¨Ø§ Ù†ÙØ³â€ŒÙ‡Ø§ÛŒ Ø¢Ø±Ø§Ù… Ùˆ Ø¢Ø¨ Ú©Ø§ÙÛŒØŒ Ø®ÛŒÙ„ÛŒ Ø¨ÛŒØ´ØªØ± Ù‡Ù…Ø±Ø§Ù‡ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù‡."
  };
  if ([96,99].includes(weatherCode)) return {
    title: "Ú©Ù†Ø³Ø±Øª Ù…ØªØ§Ù„Ù Ø¢Ø³Ù…Ø§Ù†",
    icon: "â›ˆï¸",
    text: "Ø±Ø¹Ø¯ Ùˆ Ø¨Ø±Ù‚ Ùˆ Ø¨Ø§Ø±Ø´ Ø´Ø¯ÛŒØ¯ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø·Ø±Ù†Ø§Ú© Ø¨Ø§Ø´Ø¯. Ø§ÛŒÙ…Ù†ÛŒ Ø±Ø§ Ø§ÙˆÙ„ÙˆÛŒØª Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡: Ø²ÛŒØ± Ø¯Ø±Ø®Øªâ€ŒÙ‡Ø§ Ùˆ ØªÛŒØ±Ù‡Ø§ Ù†Ø§ÛŒØ³ØªØŒ Ø§Ø² Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø² ÙØ§ØµÙ„Ù‡ Ø¨Ú¯ÛŒØ±ØŒ Ùˆ Ø§Ú¯Ø± Ø±Ø§Ù†Ù†Ø¯Ú¯ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒ Ø¢Ø±Ø§Ù…â€ŒØªØ± Ùˆ Ø¨Ø§ ÙØ§ØµÙ„Ù‡â€ŒÛŒ Ø¨ÛŒØ´ØªØ± Ø­Ø±Ú©Øª Ú©Ù†. Ø§ÛŒÙ† Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§Ø´Ú©ÙˆÙ‡ Ø·Ø¨ÛŒØ¹ØªØŒ Ø¨Ù‡ØªØ±ÛŒÙ† ØªÙ…Ø§Ø´Ø§ Ø±Ø§ Ø§Ø² Ù¾Ø´Øª Ù¾Ù†Ø¬Ø±Ù‡ Ø¯Ø§Ø±Ø¯."
  };
  if (windSpeed > 60) return {
    title: "Ø¨Ø§Ø¯Ù Ø¨ÛŒâ€ŒÙ‚Ø±Ø§Ø±",
    icon: "ğŸŒªï¸",
    text: "Ø¨Ø§Ø¯ Ø§Ù…Ø±ÙˆØ² Ø´Ø¯ÛŒØ¯ØªØ± Ø§Ø² Ù…Ø¹Ù…ÙˆÙ„ Ø§Ø³Øª. Ø§Ø­ØªÙ…Ø§Ù„ Ø³Ù‚ÙˆØ· Ø§Ø´ÛŒØ§Ø¡ Ø³Ø¨Ú© Ùˆ ØªÙ„Ø§Ø·Ù… Ø¯Ø± ÙØ¶Ø§ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯. Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ù¾Ø± Ø¯Ø±Ø®Øª ÛŒØ§ Ú©Ù†Ø§Ø± Ø³Ø§Ø®ØªÙ…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù†ÛŒÙ…Ù‡â€ŒÚ©Ø§Ø±Ù‡ Ø±Ø§ Ú©Ù…ØªØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†. Ø§Ú¯Ø± Ø¨ÛŒØ±ÙˆÙ† Ù…ÛŒâ€ŒØ±ÙˆÛŒØŒ Ø¹ÛŒÙ†Ú© Ùˆ Ù¾ÙˆØ´Ø´ Ù…Ù†Ø§Ø³Ø¨ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ø¨Ù‡ØªØ± Ø§Ø³Øª ÙˆØ³Ø§ÛŒÙ„ Ø³Ø¨Ú© Ø±Ø§ Ù…Ø­Ú©Ù… Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒ."
  };
  if ([73,75,85,86].includes(weatherCode)) return {
    title: "Ø´Ù‡Ø±Ù Ø³ÙÛŒØ¯",
    icon: "â˜ƒï¸",
    text: "Ø¨Ø±Ù Ù…ÛŒâ€ŒØ¨Ø§Ø±Ø¯ Ùˆ Ø´Ù‡Ø± Ø­Ø§Ù„Øª Ú©Ø§Ø±Øªâ€ŒÙ¾Ø³ØªØ§Ù„ÛŒ Ú¯Ø±ÙØªÙ‡Ø› Ø§Ù…Ø§ Ø²Ù…ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù„ØºØ²Ù†Ø¯Ù‡ Ø¨Ø§Ø´Ø¯. Ø§Ú¯Ø± Ø¨ÛŒØ±ÙˆÙ† Ù…ÛŒâ€ŒØ±ÙˆÛŒØŒ Ú©ÙØ´ Ù…Ù†Ø§Ø³Ø¨ Ùˆ Ù‚Ø¯Ù…â€ŒÙ‡Ø§ÛŒ Ø¢Ù‡Ø³ØªÙ‡â€ŒØªØ± Ø®ÛŒÙ„ÛŒ Ù…Ù‡Ù…â€ŒØ§Ù†Ø¯. Ø§ÛŒÙ† Ù‡ÙˆØ§ Ø¨Ø±Ø§ÛŒ Ø¹Ú©Ø³ Ú¯Ø±ÙØªÙ† Ø¹Ø§Ù„ÛŒÙ‡ØŒ Ø¨Ù‡ Ø´Ø±Ø·ÛŒ Ú©Ù‡ Ú¯Ø±Ù… Ø¨Ù¾ÙˆØ´ÛŒ Ùˆ Ù…Ø±Ø§Ù‚Ø¨ ÛŒØ®â€ŒØ²Ø¯Ú¯ÛŒ Ø¨Ø§Ø´ÛŒ."
  };
  if ([63,65,81,82].includes(weatherCode)) return {
    title: "Ø¢Ø³Ù…Ø§Ù† Ø³ÙˆØ±Ø§Ø® Ø´Ø¯Ù‡",
    icon: "â˜”",
    text: "Ø¨Ø§Ø±Ø´ Ø¬Ø¯ÛŒ Ø¯Ø± Ø¬Ø±ÛŒØ§Ù† Ø§Ø³Øª. Ú†ØªØ± Ù…Ø¹Ù…ÙˆÙ„ÛŒ Ø´Ø§ÛŒØ¯ Ú©Ø§ÙÛŒ Ù†Ø¨Ø§Ø´Ø¯Ø› Ø¨Ø§Ø±Ø§Ù†ÛŒ Ùˆ Ú©ÙØ´ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ù‡ØªØ± Ø¬ÙˆØ§Ø¨ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. Ø®ÛŒØ§Ø¨Ø§Ù†â€ŒÙ‡Ø§ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¢Ø¨â€ŒÚ¯Ø±ÙØªÚ¯ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù†Ø¯ØŒ Ù¾Ø³ Ù…Ø³ÛŒØ± Ø±Ø§ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†. Ø§Ú¯Ø± Ø§Ù…Ú©Ø§Ù†Ø´ Ù‡Ø³ØªØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¨ÛŒØ±ÙˆÙ† Ø±Ø§ Ú©ÙˆØªØ§Ù‡â€ŒØªØ± Ú©Ù† Ùˆ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ Ø¨Ø±Ú¯Ø±Ø¯."
  };
  if ([45,48].includes(weatherCode)) return {
    title: "Ù…Ù‡Ù Ù†Ø±Ù…",
    icon: "ğŸŒ«ï¸",
    text: "Ù…Ù‡ Ø¯ÛŒØ¯ Ø±Ø§ Ú©Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ ÙØ§ØµÙ„Ù‡â€ŒÙ‡Ø§ ÙØ±ÛŒØ¨Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ø±Ø§Ù†Ù†Ø¯Ú¯ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ù‡ÙˆØ§ Ù†ÛŒØ§Ø² Ø¨Ù‡ ØµØ¨Ø± Ùˆ ØªÙ…Ø±Ú©Ø² Ø¯Ø§Ø±Ø¯. Ø§Ú¯Ø± Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ§ÛŒØŒ Ø§ÛŒÙ† Ù‡ÙˆØ§ Ø­Ø³ Ù‡Ù†Ø±ÛŒ Ùˆ Ø¢Ø±Ø§Ù… Ø¯Ø§Ø±Ø¯Ø› ÙÙ‚Ø· Ù„Ø¨Ø§Ø³ Ú¯Ø±Ù…â€ŒØªØ± Ùˆ Ø´Ø§ÛŒØ¯ Ù…Ø§Ø³Ú© Ø³Ø¨Ú© Ø¨Ø±Ø§ÛŒ Ø§ÙØ±Ø§Ø¯ Ø­Ø³Ø§Ø³ Ø¨Ø¯ Ù†ÛŒØ³Øª."
  };
  if (temp > 40) return {
    title: "Ú¯Ø±Ù…Ø§ÛŒ Ø¬Ø¯ÛŒ",
    icon: "ğŸ”¥",
    text: "Ú¯Ø±Ù…Ø§ Ø¨Ø§Ù„Ø§Ø³Øª Ùˆ Ø¨Ø¯Ù† Ø³Ø±ÛŒØ¹â€ŒØªØ± Ø¢Ø¨ Ø§Ø² Ø¯Ø³Øª Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. Ø¨ÛŒØ±ÙˆÙ† Ø±ÙØªÙ† Ø¯Ø± Ø³Ø§Ø¹Ø§Øª Ø§ÙˆØ¬ Ø¢ÙØªØ§Ø¨ Ø±Ø§ Ù…Ø­Ø¯ÙˆØ¯ Ú©Ù†. Ø¢Ø¨ Ú©Ø§ÙÛŒØŒ Ù„Ø¨Ø§Ø³ Ø±ÙˆØ´Ù† Ùˆ Ø³Ø§ÛŒÙ‡â€ŒØ¯ÙˆØ³ØªÛŒ Ø§Ù…Ø±ÙˆØ² Ù†Ø³Ø®Ù‡â€ŒÛŒ Ù†Ø¬Ø§Øª Ø§Ø³Øª. Ø§Ú¯Ø± Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¨ÛŒØ±ÙˆÙ† Ø±Ùˆ Ø¨Ù‡ Ø¹ØµØ± Ù…ÙˆÚ©ÙˆÙ„ Ú©Ù†."
  };
  if (temp < -10) return {
    title: "Ø§Ù†Ø¬Ù…Ø§Ø¯ Ø¬Ø¯ÛŒ",
    icon: "ğŸ¥¶",
    text: "Ø³Ø±Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ Ø³Ø±Ø¹Øª Ø¢Ø²Ø§Ø±Ø¯Ù‡Ù†Ø¯Ù‡ Ø´ÙˆØ¯. Ù¾ÙˆØ´Ø´ Ú†Ù†Ø¯Ù„Ø§ÛŒÙ‡ØŒ Ú©Ù„Ø§Ù‡ØŒ Ø´Ø§Ù„ Ùˆ Ø¯Ø³ØªÚ©Ø´ Ø¶Ø±ÙˆØ±ÛŒ Ø§Ø³Øª. Ø²Ù…Ø§Ù† Ø­Ø¶ÙˆØ± Ø¨ÛŒØ±ÙˆÙ† Ø±Ø§ Ú©ÙˆØªØ§Ù‡â€ŒØªØ± Ú©Ù† Ùˆ Ù…Ø±Ø§Ù‚Ø¨ Ù„ØºØ²Ù†Ø¯Ú¯ÛŒ Ùˆ ÛŒØ®â€ŒØ²Ø¯Ú¯ÛŒ Ø¨Ø§Ø´."
  };
  if (temp >= 20 && temp <= 25 && !isNight && weatherCode <= 3) return {
    title: "Ù‡ÙˆØ§ÛŒÛŒ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ø³ØªØ§ÛŒØ´ Ú©Ø±Ø¯",
    icon: "ğŸ€",
    text: "Ø§ÛŒÙ† ÛŒÚ©ÛŒ Ø§Ø² Ø§ÙˆÙ† Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù†Ø§ÛŒØ§Ø¨Ù‡: Ø¯Ù…Ø§ Ù…Ø¹ØªØ¯Ù„ØŒ Ø¢Ø³Ù…Ø§Ù† Ø±ÙˆØ´Ù† Ùˆ Ù‡ÙˆØ§ Ø¯ÙˆØ³Øªâ€ŒØ¯Ø§Ø´ØªÙ†ÛŒ. Ø¨ÛŒØ±ÙˆÙ† Ø±ÙØªÙ† Ø­Ø³ Ø²Ù†Ø¯Ú¯ÛŒ Ù…ÛŒâ€ŒØ¯Ù‡. ÛŒÚ© Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ±ÙˆÛŒ Ú©ÙˆØªØ§Ù‡ØŒ ÛŒÚ© Ú©Ø§Ø± Ø¹Ù‚Ø¨â€ŒØ§ÙØªØ§Ø¯Ù‡ØŒ ÛŒØ§ Ø­ØªÛŒ ÙÙ‚Ø· Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ Ù†ÙØ³ Ø¹Ù…ÛŒÙ‚Ø› Ø§Ù…Ø±ÙˆØ² ÙˆØ§Ù‚Ø¹Ø§Ù‹ Ù…ÛŒâ€ŒÚ†Ø³Ø¨Ù‡."
  };
  return {
    title: "Ø¢Ø³Ù…Ø§Ù†Ù Ù¾Ø± Ø§Ø² Ø±Ø§Ø²",
    icon: "ğŸ”®",
    text: "Ø´Ø±Ø§ÛŒØ· Ø¬ÙˆÛŒ ØªØ±Ú©ÛŒØ¨ÛŒÙ‡ Ùˆ Ù…Ù…Ú©Ù†Ù‡ Ø¯Ø± Ø·ÙˆÙ„ Ø±ÙˆØ² Ú©Ù…ÛŒ ØªØºÛŒÛŒØ± Ú©Ù†Ù‡. Ø¨Ù‡ØªØ±ÛŒÙ† Ú©Ø§Ø± Ø§ÛŒÙ†Ù‡ Ú©Ù‡ Ø³Ø¨Ú© Ùˆ Ù„Ø§ÛŒÙ‡â€ŒØ§ÛŒ Ù„Ø¨Ø§Ø³ Ø¨Ù¾ÙˆØ´ÛŒ ØªØ§ Ø¨Ø§ ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ù…Ø§ Ø±Ø§Ø­Øª Ø¨Ø§Ø´ÛŒ. Ø§Ú¯Ø± Ø¨ÛŒØ±ÙˆÙ† Ù…ÛŒâ€ŒØ±ÙˆÛŒØŒ Ø¢Ø¨ Ù‡Ù…Ø±Ø§Ù‡Øª Ø¨Ø§Ø´ Ùˆ Ø­ÙˆØ§Ø³Øª Ø¨Ù‡ Ø¨Ø§Ø¯ Ùˆ ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø¨Ø±ÛŒ/Ø¨Ø§Ø±Ø´ÛŒ Ø¨Ø§Ø´Ù‡."
  };
}

/* Rain summary */
function getRainMessage(probs) {
  const maxProb = Math.max(...probs);
  if (maxProb < 10) return { t: "Ø¢Ø³Ù…Ø§Ù†ÛŒ Ø®Ø´Ú© Ùˆ Ù…Ø·Ù…Ø¦Ù†", d: "Ø¯Ø± Û²Û´ Ø³Ø§Ø¹Øª Ø¢ÛŒÙ†Ø¯Ù‡ Ø§Ø­ØªÙ…Ø§Ù„ Ø¨Ø§Ø±Ø´ Ø¨Ø³ÛŒØ§Ø± Ù¾Ø§ÛŒÛŒÙ† Ø§Ø³Øª. Ø¨Ø§ Ø®ÛŒØ§Ù„ Ø±Ø§Ø­Øª Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¶Ø§ÛŒ Ø¨Ø§Ø² Ø¨Ú†ÛŒÙ†." };
  if (maxProb < 40) return { t: "Ø´Ø§ÛŒØ¯ Ú†Ù†Ø¯ Ù‚Ø·Ø±Ù‡", d: "Ø§Ø­ØªÙ…Ø§Ù„ Ø¨Ø§Ø±Ø´ Ú©Ù… Ø§Ø³ØªØ› Ø´Ø§ÛŒØ¯ Ø§Ø¨Ø±Ù‡Ø§ÛŒ Ú¯Ø°Ø±Ø§ Ú†Ù†Ø¯ Ù‚Ø·Ø±Ù‡â€ŒØ§ÛŒ Ø¨Ø¨Ø§Ø±Ù†Ø¯. Ú†ØªØ± Ú©ÙˆÚ†Ú© Ø¨Ø¯ Ù†ÛŒØ³Øª." };
  if (maxProb < 75) return { t: "Ú†ØªØ±Ù‡Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø§Ø´Ù†Ø¯", d: "Ø§Ø­ØªÙ…Ø§Ù„ Ø¨Ø§Ø±Ø´ Ù‚Ø§Ø¨Ù„ ØªÙˆØ¬Ù‡ Ø§Ø³Øª. Ø¯Ø± Ø³Ø§Ø¹Ø§ØªÛŒ Ø§Ø² Ø±ÙˆØ² Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø§Ø±Ø´ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒÙ…Ø› Ù‡Ù…Ø±Ø§Ù‡ Ø¯Ø§Ø´ØªÙ† Ú†ØªØ± Ø¹Ø§Ù‚Ù„Ø§Ù†Ù‡ Ø§Ø³Øª." };
  return { t: "Ø¨Ø§Ø±Ø´ Ù‚Ø·Ø¹ÛŒ Ùˆ ÙØ±Ø§Ú¯ÛŒØ±", d: "Ø§Ø­ØªÙ…Ø§Ù„ Ø¨Ø§Ø±Ø´ Ø¨Ø³ÛŒØ§Ø± Ø¨Ø§Ù„Ø§Ø³Øª. ØªØ¬Ù‡ÛŒØ²Ø§Øª Ù…Ù†Ø§Ø³Ø¨ (Ú†ØªØ±/Ø¨Ø§Ø±Ø§Ù†ÛŒ) Ù‡Ù…Ø±Ø§Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ Ùˆ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø±Ø§ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†." };
}

/* =========================================
   Moon Phase (days to full + new)
========================================= */
function renderMoonPhase() {
  const date = new Date();
  const synodicCycle = 29.53059;
  const knownNewMoon = new Date('2023-01-21T20:53:00Z');
  const diffDays = (date.getTime() - knownNewMoon.getTime()) / (1000*60*60*24);
  const moonAge = ((diffDays % synodicCycle) + synodicCycle) % synodicCycle;

  const illumination = Math.round(((1 - Math.cos((moonAge * 2 * Math.PI) / synodicCycle)) / 2) * 100);
  const fullMoonAge = 14.765;
  const daysToFull = moonAge <= fullMoonAge ? (fullMoonAge - moonAge) : (synodicCycle - moonAge + fullMoonAge);
  const daysToNew = (synodicCycle - moonAge);
  const daysToFullR = Math.max(0, Math.round(daysToFull));
  const daysToNewR = Math.max(0, Math.round(daysToNew));

  const anomalisticCycle = 27.55455;
  const knownPerigee = new Date('2023-01-21T20:58:00Z');
  const diffPerigee = (date.getTime() - knownPerigee.getTime()) / (1000*60*60*24);
  const anomaly = ((diffPerigee % anomalisticCycle) / anomalisticCycle) * 2*Math.PI;
  const distance = Math.round(384400 - 21000 * Math.cos(anomaly));

  let gravityText = "", distanceTag="";
  if (distance < 365000){ gravityText="Ú¯Ø±Ø§Ù†Ø´ Ø¯Ø± Ø­Ø§Ù„Øª Â«Ù…Ø§Ú©Ø³ÛŒÙ…Ù…Â» (Supermoon Vibes). Ù…Ù…Ú©Ù†Ù‡ Ø§Ø­Ø³Ø§Ø³Ø§Øª Ø´Ø¯ÛŒØ¯ØªØ± Ø¨Ø§Ø´Ù‡ Ùˆ Ø®ÙˆØ§Ø¨ Ø³Ø¨Ú©â€ŒØªØ±."; distanceTag="Ø®ÛŒÙ„ÛŒ Ù†Ø²Ø¯ÛŒÚ© (Super)"; }
  else if (distance > 400000){ gravityText="Ú¯Ø±Ø§Ù†Ø´ Ø¯Ø± Ø­Ø§Ù„Øª Â«Ù…ÛŒÙ†ÛŒÙ…Ù…Â» (Micromoon). Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø­Ø³ Ø³Ø¨Ú©â€ŒØªØ±ÛŒ Ø¯Ø§Ø±ÛŒ."; distanceTag="Ø¯ÙˆØ± (Chill)"; }
  else { gravityText="Ú¯Ø±Ø§Ù†Ø´ Ø¯Ø± ÙˆØ¶Ø¹ÛŒØª Ù…ØªØ¹Ø§Ø¯Ù„ Ø§Ø³Øª. Ù‡Ù…Ù‡â€ŒÚ†ÛŒØ² Ù†Ø±Ù…Ø§Ù„ Ùˆ ØªØ­Øª Ú©Ù†ØªØ±Ù„Ù‡."; distanceTag="Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯"; }

  const distStr = toFarsi(distance.toLocaleString());
  const illuStr = toFarsi(illumination) + "Ùª";

  let phaseName = "", phaseDesc = "";
  if (moonAge < 1.5) { phaseName="ğŸŒ‘ Ù…Ø§Ù‡ Ù†Ùˆ"; phaseDesc="Ù…Ø§Ù‡ Ø¯Ú©Ù…Ù‡ Ø±ÛŒØ³Øª Ø±Ø§ Ø²Ø¯Ù‡. ÙˆÙ‚Øª Ø´Ø±ÙˆØ¹ Ù‡Ø¯Ùâ€ŒÙ‡Ø§ÛŒ ØªØ§Ø²Ù‡ Ùˆ Ù†Ùˆ Ú©Ø±Ø¯Ù† Ù†ÛŒØªâ€ŒÙ‡Ø§Ø³Øª."; }
  else if (moonAge < 7) { phaseName="ğŸŒ’ Ù‡Ù„Ø§Ù„ Ø§ÙØ²Ø§ÛŒÙ†Ø¯Ù‡"; phaseDesc="Ø§Ù†Ø±Ú˜ÛŒ Ø¢Ø±Ø§Ù…â€ŒØ¢Ø±Ø§Ù… Ø¨Ø§Ù„Ø§ Ù…ÛŒâ€ŒØ±ÙˆØ¯. Ø¨Ù‡ØªØ±ÛŒÙ† ÙˆÙ‚Øª Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯."; }
  else if (moonAge < 8) { phaseName="ğŸŒ“ ØªØ±Ø¨ÛŒØ¹ Ø§ÙˆÙ„"; phaseDesc="Ù†ÛŒÙ…Ù‡â€ŒØ±Ø§Ù‡Ø› ÙˆÙ‚Øª ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ Ùˆ Ø¹Ø¨ÙˆØ± Ø§Ø² ØªØ±Ø¯ÛŒØ¯Ù‡Ø§ÛŒ Ú©ÙˆÚ†Ú©."; }
  else if (moonAge < 14) { phaseName="ğŸŒ” ØªØ­Ø¯Ø¨ Ø§ÙØ²Ø§ÛŒÙ†Ø¯Ù‡"; phaseDesc="Ù…Ø§Ù‡ Ù†Ø²Ø¯ÛŒÚ© Ø¨Ù‡ Ú©Ø§Ù…Ù„ Ø§Ø³ØªØ› Ø²Ù…Ø§Ù† Ø¬Ù…Ø¹â€ŒØ¨Ù†Ø¯ÛŒ Ùˆ ØªÚ©Ù…ÛŒÙ„ Ø¬Ø²Ø¦ÛŒØ§Øª."; }
  else if (moonAge < 16) { phaseName="ğŸŒ• Ù…Ø§Ù‡ Ú©Ø§Ù…Ù„"; phaseDesc="Ù†ÙˆØ± Ø¯Ø± Ø§ÙˆØ¬Ø› Ø§Ø­Ø³Ø§Ø³Ø§Øª Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù¾Ø±Ø±Ù†Ú¯â€ŒØªØ± Ø´ÙˆÙ†Ø¯. Ø´ÙØ§Ùâ€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø±Ù‡Ø§Ø³Ø§Ø²ÛŒ Ø¹Ø§Ù„ÛŒ Ø§Ø³Øª."; }
  else if (moonAge < 22) { phaseName="ğŸŒ– ØªØ­Ø¯Ø¨ Ú©Ø§Ù‡Ù†Ø¯Ù‡"; phaseDesc="Ø¨Ø¹Ø¯ Ø§Ø² Ø§ÙˆØ¬ØŒ Ø²Ù…Ø§Ù† Ø¢Ø±Ø§Ù…Ø´ Ùˆ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ùˆ Ø´Ú©Ø±Ú¯Ø²Ø§Ø±ÛŒ."; }
  else if (moonAge < 23) { phaseName="ğŸŒ— ØªØ±Ø¨ÛŒØ¹ Ø¢Ø®Ø±"; phaseDesc="ÙˆÙ‚Øª Ø³Ø¨Ú© Ø´Ø¯Ù†Ø› Ú†ÛŒØ²Ù‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ Ø°Ù‡Ù† Ùˆ Ø²Ù†Ø¯Ú¯ÛŒ Ø±Ø§ Ú©Ù… Ú©Ù†."; }
  else { phaseName="ğŸŒ˜ Ù‡Ù„Ø§Ù„ Ú©Ø§Ù‡Ù†Ø¯Ù‡"; phaseDesc="Ù¾Ø§ÛŒØ§Ù† Ú†Ø±Ø®Ù‡ Ù†Ø²Ø¯ÛŒÚ© Ø§Ø³ØªØ› Ø§Ø³ØªØ±Ø§Ø­ØªØŒ Ø±ÛŒÚ©Ø§ÙˆØ±ÛŒ Ùˆ Ø¬Ù…Ø¹â€ŒØ¨Ù†Ø¯ÛŒ." }

  document.getElementById('moon-phase-name').innerText = phaseName;
  document.getElementById('moon-countdown').innerText =
    `ØªØ§ Ù…Ø§Ù‡ Ú©Ø§Ù…Ù„: ${toFarsi(daysToFullR)} Ø±ÙˆØ² â€¢ ØªØ§ Ù…Ø§Ù‡ Ù†Ùˆ: ${toFarsi(daysToNewR)} Ø±ÙˆØ²`;

  const infoBar = `
    <div style="display:flex;justify-content:space-between;gap:10px;margin-bottom:10px;font-size:var(--text-sm);color:var(--text-secondary);border-bottom:1px solid rgba(255,255,255,0.10);padding-bottom:10px;">
      <span>ğŸ’¡ Ø±ÙˆØ´Ù†Ø§ÛŒÛŒ: <b style="color:var(--accent-color)">${illuStr}</b></span>
      <span>ğŸ“ ÙØ§ØµÙ„Ù‡: <b>${distStr}</b> km (${distanceTag})</span>
    </div>
  `;

  document.getElementById('moon-desc').innerHTML =
    infoBar +
    `<div style="line-height:1.95;">
      ${phaseDesc}<br><br>
      <span style="font-size:var(--text-sm);color:var(--text-secondary);">ğŸ§² ${gravityText}</span>
    </div>`;

  let svg = '';
  if(moonAge < 15){
    svg = `<svg width="100%" height="100%" viewBox="0 0 100 100">
      <defs><filter id="glow"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
      <circle cx="50" cy="50" r="48" fill="rgba(15,23,42,0.92)" stroke="rgba(255,255,255,0.10)" stroke-width="1"/>
      <path d="M50 2 a48 48 0 0 1 0 96 a${Math.abs(48 - 3.2 * moonAge)} 48 0 0 ${moonAge < 7.5 ? 0 : 1} 0 -96"
        fill="#f8fafc" filter="url(#glow)" opacity="0.96"/>
    </svg>`;
  } else {
    const age = moonAge - 15;
    svg = `<svg width="100%" height="100%" viewBox="0 0 100 100">
      <defs><filter id="glow"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
      <circle cx="50" cy="50" r="48" fill="rgba(15,23,42,0.92)" stroke="rgba(255,255,255,0.10)" stroke-width="1"/>
      <path d="M50 2 a48 48 0 0 0 0 96 a${Math.abs(48 - 3.2 * age)} 48 0 0 ${age > 7.5 ? 0 : 1} 0 -96"
        fill="#f8fafc" filter="url(#glow)" opacity="0.96"/>
    </svg>`;
  }
  document.getElementById('moon-render').innerHTML = svg;
}

/* =========================================
   Jalali conversion (compact)
========================================= */
function div(a,b){ return ~~(a/b); }
function jalCal(jy){
  const breaks=[-61,9,38,199,426,686,756,818,1111,1181,1210,1635,2060,2097,2192,2262,2324,2394,2456,3178];
  let bl=breaks.length, gy=jy+621, leapJ=-14, jp=breaks[0], jm, jump, leap, leapG, march, n, i;
  if(jy<jp || jy>=breaks[bl-1]) return {leap:0,gy:gy,march:0};
  for(i=1;i<bl;i++){ jm=breaks[i]; jump=jm-jp; if(jy<jm) break; leapJ += div(jump,33)*8 + div(jump%33,4); jp=jm; }
  n=jy-jp;
  leapJ += div(n,33)*8 + div((n%33)+3,4);
  if(jump%33==4 && jump-n==4) leapJ++;
  leapG = div(gy,4) - div((div(gy,100)+1)*3,4) - 150;
  march = 20 + leapJ - leapG;
  if(jump-n<6) n = n - jump + div(jump+4,33)*33;
  leap = ((n+1)%33-1)%4; if(leap==-1) leap=4;
  return {leap:leap,gy:gy,march:march};
}
function isLeapJalaaliYear(jy){ return jalCal(jy).leap===0; }
function g2d(gy,gm,gd){
  let d = div((gy + div(gm-8,6) + 100100)*1461,4)
      + div(153*((gm+9)%12)+2,5) + gd - 34840408;
  d = d - div(div(gy + 100100 + div(gm-8,6),100)*3,4) + 752;
  return d;
}
function d2g(jdn){
  let j = 4*jdn + 139361631;
  j = j + div(div(4*jdn + 183187720,146097)*3,4)*4 - 3908;
  let i = div((j%1461),4)*5 + 308;
  let gd = div((i%153),5) + 1;
  let gm = div(i,153)%12 + 1;
  let gy = div(j,1461) - 100100 + div(8-gm,6);
  return {gy,gm,gd};
}
function j2d(jy,jm,jd){
  let r = jalCal(jy);
  return g2d(r.gy,3,r.march) + (jm-1)*31 - div(jm,7)*(jm-7) + jd - 1;
}
function d2j(jdn){
  let g = d2g(jdn);
  let jy = g.gy - 621;
  let r = jalCal(jy);
  let jdn1f = g2d(g.gy,3,r.march);
  let k = jdn - jdn1f;
  let jm, jd;
  if(k >= 0){
    if(k <= 185){ jm = 1 + div(k,31); jd = (k%31)+1; return {jy,jm,jd}; }
    else { k -= 186; }
  } else {
    jy -= 1;
    k += 179;
    if(r.leap === 1) k += 1;
  }
  jm = 7 + div(k,30);
  jd = (k%30)+1;
  return {jy,jm,jd};
}
function toJalaali(gy,gm,gd){ return d2j(g2d(gy,gm,gd)); }
const J_MONTHS = ["ÙØ±ÙˆØ±Ø¯ÛŒÙ†","Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª","Ø®Ø±Ø¯Ø§Ø¯","ØªÛŒØ±","Ù…Ø±Ø¯Ø§Ø¯","Ø´Ù‡Ø±ÛŒÙˆØ±","Ù…Ù‡Ø±","Ø¢Ø¨Ø§Ù†","Ø¢Ø°Ø±","Ø¯ÛŒ","Ø¨Ù‡Ù…Ù†","Ø§Ø³ÙÙ†Ø¯"];

/* =========================================
   Calendar (Shamsi + Gregorian + Hijri + progress)
========================================= */
function renderCalendarNow(){
  const now = new Date();
  const weekdayFa = now.toLocaleDateString('fa-IR', { weekday:'long' });
  document.getElementById('weekday-fa').innerText = weekdayFa;

  const greg = now.toLocaleDateString('en-GB', { year:'numeric', month:'long', day:'2-digit' });
  document.getElementById('date-greg').innerText = greg;

  const utc = new Date().toISOString().replace('T',' ').slice(0,16) + 'Z';
  document.getElementById('utc-time').innerText = utc;

  const gy = now.getFullYear(), gm = now.getMonth()+1, gd = now.getDate();
  const j = toJalaali(gy, gm, gd);
  const jalStr = `${toFarsi(j.jd)} ${J_MONTHS[j.jm-1]} ${toFarsi(j.jy)}`;
  document.getElementById('date-jalali').innerText = jalStr;

  let hijriStr = "--";
  try{
    const fmt = new Intl.DateTimeFormat('fa-IR-u-ca-islamic', { year:'numeric', month:'long', day:'numeric' });
    hijriStr = fmt.format(now);
  }catch(e){
    try{
      const fmt2 = new Intl.DateTimeFormat('fa-IR-u-ca-islamic-umalqura', { year:'numeric', month:'long', day:'numeric' });
      hijriStr = fmt2.format(now);
    }catch(e2){}
  }
  document.getElementById('date-hijri').innerText = hijriStr;
  document.getElementById('hijri-note').innerText = "Ù‚Ù…Ø±ÛŒ (Ù…Ø±ÙˆØ±Ú¯Ø±)";

  const gStart = new Date(now.getFullYear(),0,1);
  const gEnd = new Date(now.getFullYear()+1,0,1);
  const gTotal = Math.round((gEnd - gStart)/(1000*60*60*24));
  const gPassed = Math.floor((now - gStart)/(1000*60*60*24)) + 1;
  const gLeft = gTotal - gPassed;

  document.getElementById('g-pass').innerText = toFarsi(gPassed);
  document.getElementById('g-left').innerText = toFarsi(gLeft);
  document.getElementById('g-fill').style.width = `${clamp((gPassed/gTotal)*100,0,100)}%`;

  const jYear = j.jy;
  const jIsLeap = isLeapJalaaliYear(jYear);
  const jTotal = jIsLeap ? 366 : 365;

  const jMonthLen = (m) => (m<=6 ? 31 : (m<=11 ? 30 : (jIsLeap ? 30 : 29)));
  let jDayOfYear = 0;
  for(let m=1;m<j.jm;m++) jDayOfYear += jMonthLen(m);
  jDayOfYear += j.jd;
  const jLeft = jTotal - jDayOfYear;

  document.getElementById('j-pass').innerText = toFarsi(jDayOfYear);
  document.getElementById('j-left').innerText = toFarsi(jLeft);
  document.getElementById('j-fill').style.width = `${clamp((jDayOfYear/jTotal)*100,0,100)}%`;

  hijriYearProgress(now);
}

function hijriParts(date){
  const fmt = new Intl.DateTimeFormat('en-u-ca-islamic', { year:'numeric', month:'numeric', day:'numeric' });
  const parts = fmt.formatToParts(date).reduce((acc,p)=>{ acc[p.type]=p.value; return acc; },{});
  return { y: parseInt(parts.year,10), m: parseInt(parts.month,10), d: parseInt(parts.day,10) };
}

function hijriYearProgress(now){
  let cur = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
  let p = hijriParts(cur);
  const hy = p.y;

  let start = new Date(cur);
  for(let i=0;i<370;i++){
    const pp = hijriParts(start);
    if(pp.y===hy && pp.m===1 && pp.d===1) break;
    start.setUTCDate(start.getUTCDate()-1);
  }

  let next = new Date(start);
  next.setUTCDate(next.getUTCDate()+340);
  for(let i=0;i<420;i++){
    const pp = hijriParts(next);
    if(pp.y===hy+1 && pp.m===1 && pp.d===1) break;
    next.setUTCDate(next.getUTCDate()+1);
  }

  const total = Math.round((next - start)/(1000*60*60*24));
  const passed = Math.floor((cur - start)/(1000*60*60*24)) + 1;
  const left = total - passed;

  document.getElementById('h-pass').innerText = toFarsi(passed);
  document.getElementById('h-left').innerText = toFarsi(left);
  document.getElementById('h-fill').style.width = `${clamp((passed/total)*100,0,100)}%`;
  document.getElementById('hijri-note').innerText = `Ø³Ø§Ù„ Ù‚Ù…Ø±ÛŒ ${total} Ø±ÙˆØ²Ù‡`;
}

/* =========================================
   UV (smart colors + chart)
========================================= */
function uvLevel(u){
  const v = Number(u);
  if (v < 3) return { level:"Ú©Ù…", color:"var(--uv-green)", advice:"Ø¢Ø±Ø§Ù… Ùˆ Ø§Ù…Ù† ğŸ˜Œ Ø§Ú¯Ø± Ø¨ÛŒØ±ÙˆÙ† Ù…ÛŒâ€ŒØ±ÛŒØŒ Ø¹Ø§Ø¯ÛŒÙ‡. Ø¹ÛŒÙ†Ú© Ø¢ÙØªØ§Ø¨ÛŒ Ø³Ø¨Ú© Ù‡Ù… Ù‡Ù…ÛŒØ´Ù‡ Ø®ÙˆØ¨Ù‡." };
  if (v < 6) return { level:"Ù…ØªÙˆØ³Ø·", color:"var(--uv-yellow)", advice:"Ù…ØªÙˆØ³Ø· ğŸ™‚ Ø§Ú¯Ø± Ù…Ø¯Øª Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¨ÛŒØ±ÙˆÙ† Ù‡Ø³ØªÛŒØŒ Ø¶Ø¯Ø¢ÙØªØ§Ø¨ SPF Û³Û° Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù‡." };
  if (v < 8) return { level:"Ø²ÛŒØ§Ø¯", color:"var(--uv-orange)", advice:"Ø¨Ø§Ù„Ø§Ø³Øª ğŸ˜ Ø¶Ø¯Ø¢ÙØªØ§Ø¨ + Ú©Ù„Ø§Ù‡/Ø¹ÛŒÙ†Ú© Ø¢ÙØªØ§Ø¨ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒØ´Ù‡. ØªÙˆ Ø³Ø§Ø¹Ø§Øª Ø§ÙˆØ¬ Ú©Ù…ØªØ± Ø²ÛŒØ± Ø¢ÙØªØ§Ø¨ Ù…Ø³ØªÙ‚ÛŒÙ…." };
  if (v < 11) return { level:"Ø®ÛŒÙ„ÛŒ Ø²ÛŒØ§Ø¯", color:"var(--uv-red)", advice:"Ø®ÛŒÙ„ÛŒ Ø¨Ø§Ù„Ø§Ø³Øª ğŸ”¥ Ø¶Ø¯Ø¢ÙØªØ§Ø¨ Ø¬Ø¯ÛŒ + Ø³Ø§ÛŒÙ‡â€ŒØ¯ÙˆØ³ØªÛŒ. Ø§Ú¯Ø± Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ú©Ø§Ø±Ù‡Ø§ Ø±Ùˆ Ø¨Ù‡ Ø¹ØµØ± Ù…ÙˆÚ©ÙˆÙ„ Ú©Ù†." };
  return { level:"Ø´Ø¯ÛŒØ¯", color:"var(--uv-purple)", advice:"Ø´Ø¯ÛŒØ¯ Ùˆ Ø®Ø·Ø±Ù†Ø§Ú© âš ï¸ Ø¨ÛŒØ±ÙˆÙ† ÙÙ‚Ø· Ø¶Ø±ÙˆØ±ÛŒ. Ù¾ÙˆØ´Ø´ Ú©Ø§Ù…Ù„ØŒ Ø¶Ø¯Ø¢ÙØªØ§Ø¨ Ù‚ÙˆÛŒ Ùˆ Ø³Ø§ÛŒÙ‡." };
}

function renderUV(hourly, nowIndex, timezone){
  const uvNow = hourly.uv_index?.[nowIndex];
  const uvMaxToday = Math.max(...hourly.uv_index?.slice(nowIndex, nowIndex+24).filter(x=>x!=null) ?? [0]);
  const lvl = uvLevel(uvNow ?? 0);

  document.getElementById('uv-now').innerText = (uvNow==null ? "--" : (uvNow.toFixed(1)));
  document.getElementById('uv-max').innerText = (isFinite(uvMaxToday) ? uvMaxToday.toFixed(1) : "--");
  document.getElementById('uv-meta').innerText = timezone || "";

  const dot = document.getElementById('uv-dot');
  dot.style.background = lvl.color;
  document.getElementById('uv-pill').style.borderColor = lvl.color;

  document.getElementById('uv-desc').innerText = `Ø³Ø·Ø­ UV Ø§Ù„Ø§Ù†: Â«${lvl.level}Â» â€” ${lvl.advice}`;
  document.getElementById('uv-mini').innerText =
    `Ù†Ú©ØªÙ‡: UV Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø¨ÛŒÙ† Ø³Ø§Ø¹Øª Û±Û± ØªØ§ Û±Ûµ Ø¨Ù‡ Ø§ÙˆØ¬ Ù…ÛŒâ€ŒØ±Ø³Ù‡. Ø§Ú¯Ø± Ù¾ÙˆØ³Øª Ø­Ø³Ø§Ø³ÛŒ Ø¯Ø§Ø±ÛŒØŒ Ø­ØªÛŒ Ø¯Ø± ÙˆØ¶Ø¹ÛŒØª Ù…ØªÙˆØ³Ø· Ù‡Ù… Ù…Ø­Ø§ÙØ¸Øª Ø¨Ù‡ØªØ±Ù‡.`;

  const times = hourly.time.slice(nowIndex, nowIndex+24);
  const uvVals = hourly.uv_index.slice(nowIndex, nowIndex+24).map(v => v==null ? 0 : Number(v));
  renderUVChart(times, uvVals);
}

function renderUVChart(times, uvVals){
  if (typeof Chart === 'undefined') return;
  const ctx = document.getElementById('uvChart').getContext('2d');

  const labels = times.map(t => {
    const d = new Date(t);
    return d.toLocaleTimeString('fa-IR', { hour:'2-digit', minute:'2-digit' });
  });

  const colors = uvVals.map(v => {
    if (v < 3) return '#22c55e';
    if (v < 6) return '#facc15';
    if (v < 8) return '#fb923c';
    if (v < 11) return '#f87171';
    return '#a78bfa';
  });

  if(chartUV) chartUV.destroy();

  chartUV = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'UV',
        data: uvVals,
        backgroundColor: colors,
        borderRadius: 8,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode:'index', intersect:false },
      plugins: {
        tooltip: {
          backgroundColor: isLight ? 'rgba(248,250,252,0.95)' : 'rgba(2,6,23,0.92)',
          titleColor: isLight ? '#0f172a' : '#f8fafc',
          bodyColor: isLight ? '#0f172a' : '#f8fafc',
          padding: 12,
          cornerRadius: 12,
          rtl: true,
          callbacks:{
            label: (ctx)=> `UV: ${Number(ctx.parsed.y).toFixed(1)}`
          }
        }
      },
      scales: {
        x: { grid: { display:false }, ticks: { color: isLight ? 'rgba(15,23,42,0.65)' : '#94a3b8', font: { size: 11 } } },
        y: { grid: { color: isLight ? 'rgba(15,23,42,0.08)' : 'rgba(255,255,255,0.07)' }, border: { display:false }, ticks: { display:true } }
      }
    }
  });
}

/* =========================================
   Charts: weekly/hourly switch
========================================= */
function setChartMode(mode){
  chartMode = mode;
  document.getElementById('btn-weekly').classList.toggle('active', mode==='weekly');
  document.getElementById('btn-hourly').classList.toggle('active', mode==='hourly');
  if(window.__latestData) renderMainChart(window.__latestData);
}

function renderMainChart(payload){
  const { weather } = payload;
  if (typeof Chart === 'undefined') return;

  const ctx = document.getElementById('mainChart').getContext('2d');
  if(chartMain) chartMain.destroy();

  const grid = isLight ? 'rgba(15,23,42,0.08)' : 'rgba(255,255,255,0.07)';
  const tick = isLight ? 'rgba(15,23,42,0.65)' : '#94a3b8';

  if(chartMode === 'weekly'){
    const daily = weather.daily;
    const labels = daily.time.map(d => {
      const date = new Date(d);
      return date.toLocaleDateString('fa-IR', { weekday: 'short' });
    });
    const maxTemps = daily.temperature_2m_max.map(v=>Math.round(v));
    const minTemps = daily.temperature_2m_min.map(v=>Math.round(v));

    chartMain = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Ø­Ø¯Ø§Ú©Ø«Ø± Ø¯Ù…Ø§', data: maxTemps, borderWidth: 3, tension: 0.35, pointRadius: 3, fill: true },
          { label: 'Ø­Ø¯Ø§Ù‚Ù„ Ø¯Ù…Ø§', data: minTemps, borderWidth: 2, tension: 0.35, pointRadius: 0, borderDash: [6,6], fill: false }
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        interaction:{ mode:'index', intersect:false },
        plugins:{
          tooltip:{
            backgroundColor: isLight ? 'rgba(248,250,252,0.95)' : 'rgba(2,6,23,0.92)',
            titleColor: isLight ? '#0f172a' : '#f8fafc',
            bodyColor: isLight ? '#0f172a' : '#f8fafc',
            padding: 12,
            cornerRadius: 12,
            rtl:true
          }
        },
        scales:{
          x:{ grid:{ display:false }, ticks:{ color: tick, font:{ size: 11 } } },
          y:{ grid:{ color: grid }, border:{ display:false }, ticks:{ display:true } }
        }
      }
    });

    chartMain.data.datasets[0].borderColor = '#34d399';
    chartMain.data.datasets[0].backgroundColor = 'rgba(52, 211, 153, 0.18)';
    chartMain.data.datasets[0].pointBackgroundColor = '#ffffff';
    chartMain.data.datasets[0].pointBorderColor = '#34d399';

    chartMain.data.datasets[1].borderColor = '#60a5fa';
    chartMain.update();
  } else {
    const hourly = weather.hourly;
    const now = new Date();
    const nowISO = now.toISOString().slice(0,13);
    let idx = hourly.time.findIndex(t => t.slice(0,13) === nowISO);
    if(idx < 0) idx = 0;

    const sliceN = 24;
    const times = hourly.time.slice(idx, idx+sliceN);
    const labels = times.map(t => {
      const d = new Date(t);
      return d.toLocaleTimeString('fa-IR', { hour:'2-digit', minute:'2-digit' });
    });

    const temp = hourly.temperature_2m.slice(idx, idx+sliceN).map(v => Math.round(v));
    const pop  = hourly.precipitation_probability.slice(idx, idx+sliceN).map(v => v==null ? 0 : Math.round(v));
    const wind = hourly.wind_speed_10m.slice(idx, idx+sliceN).map(v => Math.round(v));

    chartMain = new Chart(ctx, {
      data: {
        labels,
        datasets: [
          { type:'line', label:'Ø¯Ù…Ø§ (Â°C)', data: temp, yAxisID:'y', borderWidth: 3, tension:0.35, pointRadius: 2.5 },
          { type:'bar',  label:'Ø§Ø­ØªÙ…Ø§Ù„ Ø¨Ø§Ø±Ø´ (%)', data: pop, yAxisID:'y1', borderRadius: 8, borderSkipped:false },
          { type:'line', label:'Ø¨Ø§Ø¯ (km/h)', data: wind, yAxisID:'y2', borderWidth: 2, tension:0.35, pointRadius: 0, borderDash:[6,6] }
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        interaction:{ mode:'index', intersect:false },
        plugins:{
          tooltip:{
            backgroundColor: isLight ? 'rgba(248,250,252,0.95)' : 'rgba(2,6,23,0.92)',
            titleColor: isLight ? '#0f172a' : '#f8fafc',
            bodyColor: isLight ? '#0f172a' : '#f8fafc',
            padding: 12,
            cornerRadius: 12,
            rtl:true
          }
        },
        scales:{
          x:{ grid:{ display:false }, ticks:{ color: tick, font:{ size: 10 } } },
          y:{ position:'left', grid:{ color: grid }, border:{ display:false }, ticks:{ display:true } },
          y1:{ position:'right', grid:{ drawOnChartArea:false }, border:{ display:false }, min:0, max:100, ticks:{ display:true } },
          y2:{ position:'right', offset:true, grid:{ drawOnChartArea:false }, border:{ display:false }, ticks:{ display:true } }
        }
      }
    });

    chartMain.data.datasets[0].borderColor = '#34d399';
    chartMain.data.datasets[0].backgroundColor = 'rgba(52, 211, 153, 0.10)';
    chartMain.data.datasets[0].pointBackgroundColor = '#ffffff';
    chartMain.data.datasets[0].pointBorderColor = '#34d399';

    chartMain.data.datasets[1].backgroundColor = 'rgba(96, 165, 250, 0.38)';
    chartMain.data.datasets[2].borderColor = '#a78bfa';

    chartMain.update();
  }
}

/* =========================================
   Forecast list
========================================= */
function renderForecastList(daily) {
  const listEl = document.getElementById('forecast-list');
  listEl.innerHTML = '';

  for(let i=1; i<7; i++) {
    const date = new Date(daily.time[i]);
    const dayName = date.toLocaleDateString('fa-IR', { weekday: 'long' });
    const code = daily.weather_code[i];
    const maxT = Math.round(daily.temperature_2m_max[i]);
    const minT = Math.round(daily.temperature_2m_min[i]);

    let shortDesc = "";
    if (code <= 1) shortDesc = "Ø¢Ø³Ù…Ø§Ù†ÛŒ ØµØ§Ù Ùˆ Ø¯Ø±Ø®Ø´Ø§Ù†Ø› ÙØ±ØµØª Ø¹Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¨ÛŒØ±ÙˆÙ† Ùˆ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ±ÙˆÛŒ.";
    else if (code <= 3) shortDesc = "Ù†ÛŒÙ…Ù‡â€ŒØ§Ø¨Ø±ÛŒ Ùˆ Ù…Ù„Ø§ÛŒÙ…Ø› Ù‡ÙˆØ§ÛŒ Ù…ØªØ¹Ø§Ø¯Ù„ Ùˆ Ø®ÙˆØ´â€ŒØ­Ø§Ù„â€ŒÚ©Ù†Ù†Ø¯Ù‡.";
    else if (code <= 48) shortDesc = "Ù…Ù‡â€ŒØ¢Ù„ÙˆØ¯ Ùˆ Ú©Ù…â€ŒØ¯ÛŒØ¯Ø› Ø¯Ø± Ø±Ø§Ù†Ù†Ø¯Ú¯ÛŒ Ø§Ø­ØªÛŒØ§Ø· Ú©Ù† Ùˆ Ú†Ø±Ø§Øºâ€ŒÙ‡Ø§ Ø±ÙˆØ´Ù†.";
    else if (code <= 67) shortDesc = "Ø¨Ø§Ø±Ø§Ù†ÛŒØ› Ú†ØªØ± Ùˆ Ú©ÙØ´ Ù…Ù†Ø§Ø³Ø¨ ÙØ±Ø§Ù…ÙˆØ´ Ù†Ø´Ù‡.";
    else if (code <= 77) shortDesc = "Ø¨Ø±Ù/Ø³Ø±Ù…Ø§Ø› Ù¾ÙˆØ´Ø´ Ú¯Ø±Ù… Ùˆ Ù…Ø±Ø§Ù‚Ø¨Øª Ø§Ø² Ù„ØºØ²Ù†Ø¯Ú¯ÛŒ.";
    else if (code >= 95) shortDesc = "Ø§Ø­ØªÙ…Ø§Ù„ Ø±Ø¹Ø¯ Ùˆ Ø¨Ø±Ù‚Ø› Ø¨Ù‡ØªØ±Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨ÛŒØ±ÙˆÙ† Ø±Ùˆ Ø³Ø¨Ú©â€ŒØªØ± Ú©Ù†ÛŒ.";
    else shortDesc = "Ù‡ÙˆØ§ÛŒ Ù…ØªØºÛŒØ±Ø› Ø¢Ù…Ø§Ø¯Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ø³Ø±ÛŒØ¹ Ø¨Ø§Ø´.";

    const div = document.createElement('div');
    div.className = 'forecast-item';
    div.innerHTML = `
      <div class="f-top-row">
        <div class="f-day-group">
          <div class="f-icon">${getSmallIcon(code)}</div>
          <div class="f-day">${dayName}</div>
        </div>
        <div class="f-temp">
          ${toFarsi(maxT)}Â°
          <span style="font-size:13px;opacity:0.55;color:var(--text-primary);margin-left:6px;">${toFarsi(minT)}Â°</span>
        </div>
      </div>
      <div class="f-bot-row">${shortDesc}</div>
    `;
    listEl.appendChild(div);
  }
}

/* =========================================
   Elevation
========================================= */
function renderElevation(meters) {
  document.getElementById('elev-val').innerText = toFarsi(Math.round(meters)) + ' Ù…ØªØ±';
  let desc = "";
  const milad = 435;
  const khalifa = 828;
  const azadi = 45;

  if (meters < azadi) desc = `Ø§Ø±ØªÙØ§Ø¹ Ø´Ù…Ø§ Ù¾Ø§ÛŒÛŒÙ† Ø§Ø³ØªØŒ Ù†Ø²Ø¯ÛŒÚ© Ø³Ø·Ø­ Ø´Ù‡Ø±. ÙØ´Ø§Ø± Ù‡ÙˆØ§ Ø¨Ø§Ù„Ø§ØªØ± Ùˆ Ø§Ú©Ø³ÛŒÚ˜Ù† Ú©Ù…ÛŒ Ø¨ÛŒØ´ØªØ± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª.`;
  else if (meters < milad) desc = `Ø§Ø±ØªÙØ§Ø¹ Ø´Ù…Ø§ Ø­Ø¯ÙˆØ¯Ø§Ù‹ ${toFarsi((meters / azadi).toFixed(1))} Ø¨Ø±Ø§Ø¨Ø± Ø¨Ø±Ø¬ Ø¢Ø²Ø§Ø¯ÛŒ Ø§Ø³Øª. Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ù‡ÙˆØ§ Ú©Ù…ÛŒ Ø®Ù†Ú©â€ŒØªØ± Ùˆ Ø´ÙØ§Ùâ€ŒØªØ± Ø­Ø³ Ù…ÛŒâ€ŒØ´ÙˆØ¯.`;
  else if (meters < khalifa) desc = `Ø§Ø±ØªÙØ§Ø¹ Ø´Ù…Ø§ Ù…Ø¹Ø§Ø¯Ù„ ${toFarsi((meters / milad).toFixed(1))} Ø¨Ø±Ø§Ø¨Ø± Ø¨Ø±Ø¬ Ù…ÛŒÙ„Ø§Ø¯ Ø§Ø³Øª! Ù‡ÙˆØ§ Ú©Ù…ÛŒ Ø±Ù‚ÛŒÙ‚â€ŒØªØ± Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø´Ø¨â€ŒÙ‡Ø§ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø®Ù†Ú©â€ŒØªØ± Ø¨Ø§Ø´Ø¯.`;
  else if (meters < 2000) desc = `Ø§Ø±ØªÙØ§Ø¹ Ù‚Ø§Ø¨Ù„ ØªÙˆØ¬Ù‡ÛŒ Ø¯Ø§Ø±ÛŒØ¯Ø› Ø­Ø³ Ú©ÙˆÙ‡Ù¾Ø§ÛŒÙ‡â€ŒØ§ÛŒ. Ø´Ø¨â€ŒÙ‡Ø§ Ø®Ù†Ú©ÛŒ Ø¨ÛŒØ´ØªØ± Ùˆ Ø¢Ø³Ù…Ø§Ù† Ø´ÙØ§Ùâ€ŒØªØ± Ø§Ø³Øª.`;
  else desc = `Ø§Ø±ØªÙØ§Ø¹Ø§Øª Ú©ÙˆÙ‡Ø³ØªØ§Ù†ÛŒ! Ù‡ÙˆØ§ Ø±Ù‚ÛŒÙ‚â€ŒØªØ± Ø§Ø³ØªØ› Ù†ÙˆØ´ÛŒØ¯Ù† Ø¢Ø¨ Ú©Ø§ÙÛŒ Ùˆ Ø¢Ø±Ø§Ù…â€ŒØªØ± Ø­Ø±Ú©Øª Ú©Ø±Ø¯Ù† Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯.`;

  document.getElementById('elev-desc').innerText = desc;
}

/* Day/Night by sunrise/sunset */
function isNightBySun(sunriseISO, sunsetISO){
  try{
    const now = new Date();
    const sunrise = new Date(sunriseISO);
    const sunset  = new Date(sunsetISO);
    return now < sunrise || now >= sunset;
  }catch(e){
    const h = new Date().getHours();
    return (h < 7 || h >= 17);
  }
}

/* smooth AQI number */
function animateValue(id, start, end, duration) {
  if (start === end) return;
  const range = end - start;
  let current = start;
  const increment = end > start ? 1 : -1;
  const stepTime = Math.abs(Math.floor(duration / Math.max(1, Math.abs(range))));
  const obj = document.getElementById(id);
  const timer = setInterval(function() {
    current += increment;
    obj.innerHTML = toFarsi(current);
    if (current == end) { clearInterval(timer); }
  }, Math.max(stepTime, 22));
}

/* =========================================
   UI update
========================================= */
function updateUI(data, city) {
  window.__latestData = data;

  const aqi = data.aqi.current.us_aqi;
  const current = data.weather.current;
  const daily = data.weather.daily;
  const hourly = data.weather.hourly;
  const elevation = data.weather.elevation;

  const sunriseToday = daily.sunrise?.[0];
  const sunsetToday  = daily.sunset?.[0];
  const isNight = isNightBySun(sunriseToday, sunsetToday);
  const isDay = !isNight;
  const wCode = current.weather_code;

  document.getElementById('day-night-tag').innerText = isDay ? "Day" : "Night";

  let accent = '#34d399';
  let status = 'Ù¾Ø§Ú© Ùˆ Ø¹Ø§Ù„ÛŒ';
  document.body.classList.remove('weather-rain', 'weather-snow');

  if(aqi > 50) { accent = '#facc15'; status = 'Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„'; }
  if(aqi > 100) { accent = '#fb923c'; status = 'Ù†Ø§Ø³Ø§Ù„Ù… Ø¨Ø±Ø§ÛŒ Ø­Ø³Ø§Ø³â€ŒÙ‡Ø§'; }
  if(aqi > 150) { accent = '#f87171'; status = 'Ù†Ø§Ø³Ø§Ù„Ù… Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡'; }
  if(aqi > 200) { accent = '#c084fc'; status = 'Ø¨Ø³ÛŒØ§Ø± Ø®Ø·Ø±Ù†Ø§Ú©'; }
  if(aqi > 300) { accent = '#7e22ce'; status = 'Ù…Ø±Ú¯Ø¨Ø§Ø±'; }

  if(wCode >= 95) document.body.classList.add('weather-rain');
  else if((wCode >= 51 && wCode <= 67) || (wCode >= 80 && wCode <= 82)) document.body.classList.add('weather-rain');
  else if(wCode >= 71) document.body.classList.add('weather-snow');

  document.documentElement.style.setProperty('--accent-color', accent);
  document.documentElement.style.setProperty('--liquid-1', accent);

  document.getElementById('loc-name').innerText = city;

  animateValue("aqi-val", 0, aqi, 1200);
  document.getElementById('aqi-text').innerText = status;
  document.getElementById('aqi-text').style.backgroundColor = accent;

  const offset = 660 - (Math.min(aqi, 400) / 400) * 660;
  document.getElementById('aqi-ring').style.strokeDashoffset = offset;
  document.getElementById('aqi-ring').style.stroke = accent;

  document.getElementById('visual-temp').innerText = toFarsi(Math.round(current.temperature_2m)) + 'Â°';
  const quote = getDetailedQuote(current.temperature_2m, wCode, current.wind_speed_10m, aqi, isNight);
  document.getElementById('visual-desc').innerText = quote.title;
  document.getElementById('weather-icon-container').innerHTML = getWeatherSVG(wCode, isDay);

  document.getElementById('hum-val').innerText = toFarsi(current.relative_humidity_2m) + '%';
  document.getElementById('wind-val').innerText = toFarsi(Math.round(current.wind_speed_10m));

  document.getElementById('friendly-text').innerText =
    getFriendlyStatus(current.temperature_2m, wCode, current.wind_speed_10m, current.relative_humidity_2m, isDay);

  try{
    const tz = data.weather.timezone || "local";
    document.getElementById('last-update').innerText =
      new Date().toLocaleString('en-GB', { hour:'2-digit', minute:'2-digit' }) + " â€¢ " + tz;
  }catch(e){}

  const aqiMsg = getAirQualityMessage(aqi);
  document.getElementById('aqi-reco-head').innerText = "ÙˆØ¶Ø¹ÛŒØª ØªÙ†ÙØ³ Ø´Ù…Ø§";
  document.getElementById('aqi-reco-body').innerText = aqiMsg.text;

  document.getElementById('story-head').innerText = quote.title;
  document.getElementById('story-icon-box').innerText = quote.icon;
  document.getElementById('story-body').innerText = quote.text;

  const now = new Date();
  const nowISO = now.toISOString().slice(0,13);
  let hourIndex = hourly.time.findIndex(t => t.slice(0,13) === nowISO);
  if(hourIndex < 0) hourIndex = 0;

  const rainProbs = hourly.precipitation_probability.slice(hourIndex, hourIndex+24).map(v=>v ?? 0);
  const rainInfo = getRainMessage(rainProbs);
  document.getElementById('rain-title').innerText = rainInfo.t;
  document.getElementById('rain-desc').innerText = rainInfo.d;

  document.getElementById('pm25-val').innerText = toFarsi(Math.round(data.aqi.current.pm2_5));
  document.getElementById('no2-val').innerText = toFarsi(Math.round(data.aqi.current.nitrogen_dioxide));

  renderCalendarNow();
  renderMoonPhase();
  renderMainChart(data);
  renderForecastList(daily);
  renderElevation(elevation);
  renderUV(hourly, hourIndex, data.weather.timezone);

  refreshChartsTheme();

  document.getElementById('loader').style.opacity = '0';
  setTimeout(() => document.getElementById('loader').style.display = 'none', 520);

  if (Notification && Notification.permission === 'granted') {
    smartNotify(data);
  }
}

/* =========================================
   Fetch data (Open-Meteo)
========================================= */
async function fetchData(lat, lon, name) {
  document.getElementById('loader').style.display = 'flex';
  setTimeout(() => document.getElementById('loader').style.opacity = '1', 10);

  try {
    const aqiURL = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=us_aqi,pm2_5,nitrogen_dioxide&timezone=auto`;

    const weatherURL = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
      `&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code` +
      `&hourly=temperature_2m,precipitation_probability,wind_speed_10m,uv_index` +
      `&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset` +
      `&timezone=auto`;

    const [aqiRes, weatherRes] = await Promise.all([ fetch(aqiURL), fetch(weatherURL) ]);
    if(!aqiRes.ok || !weatherRes.ok) throw new Error("API Error");

    localStorage.setItem('last_lat', lat);
    localStorage.setItem('last_lon', lon);
    localStorage.setItem('last_name', name);

    const payload = { aqi: await aqiRes.json(), weather: await weatherRes.json() };
    updateUI(payload, name);
  } catch (e) {
    console.error(e);
    alert("Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯Ù‡.");
    document.getElementById('loader').style.opacity = '0';
    setTimeout(() => document.getElementById('loader').style.display = 'none', 520);
  }
}

/* =========================================
   Search modal
========================================= */
function toggleSearch(show) {
  const modal = document.getElementById('search-modal');
  if(show){
    modal.classList.add('open');
    setTimeout(() => document.getElementById('city-input').focus(), 80);
  } else {
    modal.classList.remove('open');
  }
}

let debounce;
document.getElementById('city-input').addEventListener('input', (e) => {
  clearTimeout(debounce);
  if(e.target.value.length < 2) return;
  debounce = setTimeout(async () => {
    try {
      const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(e.target.value)}&count=6&language=en&format=json`);
      const data = await res.json();
      const list = document.getElementById('search-list');
      list.innerHTML = '';
      if(!data.results) {
        list.innerHTML = '<div style="text-align:center;padding:18px;opacity:0.7;color:var(--text-secondary);">Ø´Ù‡Ø±ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯</div>';
        return;
      }
      data.results.forEach(c => {
        const div = document.createElement('div');
        div.className = 'search-item';
        div.innerText = `${c.name} (${c.country_code})`;
        div.onclick = () => { fetchData(c.latitude, c.longitude, c.name); toggleSearch(false); };
        list.appendChild(div);
      });
    } catch(e) {}
  }, 520);
});

/* =========================================
   Welcome + Location
========================================= */
function handleWelcomeGPS() {
  if(navigator.geolocation) {
    document.getElementById('welcome-modal').classList.remove('active');
    document.getElementById('loader').style.display = 'flex';
    document.getElementById('loader').style.opacity = '1';
    navigator.geolocation.getCurrentPosition(
      p => fetchData(p.coords.latitude, p.coords.longitude, "Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†"),
      () => {
        alert("Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯.");
        document.getElementById('welcome-modal').classList.add('active');
        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => document.getElementById('loader').style.display = 'none', 520);
      },
      { enableHighAccuracy: true, timeout: 12000, maximumAge: 60000 }
    );
  } else alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.");
}
function handleWelcomeManual() {
  document.getElementById('welcome-modal').classList.remove('active');
  toggleSearch(true);
}
function getLocation(){ handleWelcomeGPS(); }

/* =========================================
   Notifications modal (ONLY modal, no cards)
========================================= */
function toggleNotifModal(show){
  const m = document.getElementById('notif-modal');
  if(show) m.classList.add('active');
  else m.classList.remove('active');
}

async function enableNotifications(){
  try{
    if(!('Notification' in window)){
      alert("Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø² Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.");
      return;
    }
    const perm = await Notification.requestPermission();
    if(perm !== 'granted'){
      alert("Ø§Ø¬Ø§Ø²Ù‡ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯.");
      return;
    }
    if('serviceWorker' in navigator){
      try{ await navigator.serviceWorker.register('./sw.js'); } catch(e){}
    }
    localStorage.setItem('notif_enabled', '1');
    toggleNotifModal(false);
    alert("Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† ÙØ¹Ø§Ù„ Ø´Ø¯ âœ…");
    if(window.__latestData) smartNotify(window.__latestData);
  }catch(e){
    alert("Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯.");
  }
}

/* smart notify (local checks) */
function smartNotify(payload){
  try{
    const aqi = payload.aqi.current.us_aqi;
    const hourly = payload.weather.hourly;
    const now = new Date();
    const nowISO = now.toISOString().slice(0,13);
    let idx = hourly.time.findIndex(t => t.slice(0,13) === nowISO);
    if(idx < 0) idx = 0;
    const next6 = hourly.precipitation_probability.slice(idx, idx+6).map(v=>v ?? 0);
    const max6 = Math.max(...next6);

    const aqiBad = aqi >= 150;
    const rainSoon = max6 >= 65;

    const last = Number(localStorage.getItem('last_notif_ts') || 0);
    const nowTs = Date.now();
    if(nowTs - last < 1000*60*30) return;

    if(aqiBad){
      new Notification("Ù‡Ø´Ø¯Ø§Ø± Ú©ÛŒÙÛŒØª Ù‡ÙˆØ§ ğŸ˜·", {
        body: `AQI Ø§Ù„Ø§Ù† ${aqi} Ø§Ø³Øª. Ø¨Ù‡ØªØ±Ù‡ ÙØ¹Ø§Ù„ÛŒØª Ø¨ÛŒØ±ÙˆÙ† Ø±Ùˆ Ù…Ø­Ø¯ÙˆØ¯ Ú©Ù†ÛŒ.`,
        icon: "https://8upload.com/image/171db5bf84cf07d4/AppIcon_2x.png"
      });
      localStorage.setItem('last_notif_ts', String(nowTs));
      return;
    }
    if(rainSoon){
      new Notification("Ø¨Ø§Ø±Ø´ Ù†Ø²Ø¯ÛŒÚ©Ù‡ ğŸŒ§ï¸", {
        body: `Ø¯Ø± Ú†Ù†Ø¯ Ø³Ø§Ø¹Øª Ø¢ÛŒÙ†Ø¯Ù‡ Ø§Ø­ØªÙ…Ø§Ù„ Ø¨Ø§Ø±Ø´ ØªØ§ ${max6}% Ù…ÛŒâ€ŒØ±Ø³Ù‡. Ú†ØªØ± ÛŒØ§Ø¯Øª Ù†Ø±Ù‡!`,
        icon: "https://8upload.com/image/171db5bf84cf07d4/AppIcon_2x.png"
      });
      localStorage.setItem('last_notif_ts', String(nowTs));
      return;
    }
  }catch(e){}
}

/* periodic checks when app is open */
setInterval(()=>{
  if(localStorage.getItem('notif_enabled')==='1' && Notification && Notification.permission==='granted' && window.__latestData){
    smartNotify(window.__latestData);
  }
}, 1000*60*12);

/* =========================================
   App init
========================================= */
function initApp(){
  const savedLat = localStorage.getItem('last_lat');
  const savedLon = localStorage.getItem('last_lon');
  const savedName = localStorage.getItem('last_name');

  if (savedLat && savedLon && savedName) {
    fetchData(savedLat, savedLon, savedName);
  } else {
    setTimeout(() => {
      document.getElementById('welcome-modal').classList.add('active');
      document.getElementById('loader').style.display = 'none';
    }, 120);
  }
}
initApp();
</script>
</body>
</html>
