<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Ù‡ÙˆØ§ÛŒ Ù¾Ø§Ú© Ù¾Ù„Ø§Ø³ | Ù†Ø³Ø®Ù‡ Ø§ÙˆÙ„ØªØ±Ø§</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@200..900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ù„ÛŒ Ùˆ Ù…ØªØºÛŒØ±Ù‡Ø§ --- */
        :root {
            --bg-color: #020617;
            --bg-gradient: linear-gradient(180deg, #020617 0%, #0f172a 100%);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --glass-bg: rgba(15, 23, 42, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.03);
            --glass-blur: 40px;
            --card-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.7);
            --inner-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.15);
            --accent-color: #34d399;
            --liquid-1: #4f46e5;
            --liquid-2: #db2777;
        }
        body.light-mode {
            --bg-color: #f8fafc;
            --bg-gradient: linear-gradient(180deg, #f1f5f9 0%, #e2e8f0 100%);
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.9);
            --glass-highlight: rgba(255, 255, 255, 0.8);
            --glass-blur: 30px;
            --card-shadow: 0 15px 35px -5px rgba(148, 163, 184, 0.35);
            --inner-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.9);
            --liquid-1: #60a5fa;
            --liquid-2: #f472b6;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; margin: 0; padding: 0; }
        body {
            background-color: var(--bg-color);
            background-image: var(--bg-gradient);
            color: var(--text-primary);
            font-family: 'Vazirmatn', -apple-system, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.5s ease, color 0.5s ease;
            position: relative;
        }

        /* --- Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ù…Ø§ÛŒØ¹ --- */
        .liquid-blob { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 0; pointer-events: none; }
        .blob { position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.5; animation: floatBlob 15s infinite alternate cubic-bezier(0.4, 0, 0.2, 1); mix-blend-mode: screen; }
        body.light-mode .blob { mix-blend-mode: multiply; opacity: 0.3; }
        .blob-1 { top: -20%; left: -20%; width: 60vw; height: 60vw; background: var(--liquid-1); }
        .blob-2 { bottom: -20%; right: -20%; width: 70vw; height: 70vw; background: var(--liquid-2); animation-delay: -7s; }
        @keyframes floatBlob { 0% { transform: translate(0, 0) scale(1) rotate(0deg); } 100% { transform: translate(40px, 60px) scale(1.1) rotate(10deg); } }

        /* --- Ø°Ø±Ø§Øª Ù…Ø¹Ù„Ù‚ --- */
        #particles { position: fixed; inset: 0; pointer-events: none; z-index: 5; background-image: none; background-size: 0 0; transition: opacity 0.5s; }
        body.weather-rain #particles { background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10 0 L10 10' stroke='rgba(120,120,255,0.6)' stroke-width='1'/%3E%3C/svg%3E"); animation: rainFall 0.6s linear infinite; }
        body.weather-snow #particles { background-image: radial-gradient(white 30%, transparent 30%); background-size: 10px 10px; animation: snowFall 4s linear infinite; }
        @keyframes rainFall { from { background-position: 0 0; } to { background-position: -10px 400px; } }
        @keyframes snowFall { from { background-position: 0 0; } to { background-position: 30px 200px; } }

        #app {
            position: relative; z-index: 10;
            padding: max(20px, env(safe-area-inset-top)) 24px 40px 24px;
            max-width: 550px; margin: 0 auto; width: 100%;
            display: flex; flex-direction: column; gap: 24px;
            padding-bottom: 100px;
        }

        .fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(30px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

        /* --- Ù‡Ø¯Ø± Ùˆ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ --- */
        header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .location-pill {
            display: flex; align-items: center; gap: 12px;
            background: var(--glass-bg); border: 1px solid var(--glass-border); border-top: 1px solid var(--glass-highlight);
            padding: 12px 24px; border-radius: 50px; font-size: 16px; font-weight: 800; cursor: pointer;
            backdrop-filter: blur(var(--glass-blur)); box-shadow: var(--card-shadow), var(--inner-shadow);
            transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); color: var(--text-primary);
            max-width: 60%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .header-actions { display: flex; gap: 12px; align-items: center; flex-direction: row; }
        .btn-circle {
            width: 50px; height: 50px; border-radius: 50%;
            background: var(--glass-bg); border: 1px solid var(--glass-border); border-top: 1px solid var(--glass-highlight);
            display: flex; align-items: center; justify-content: center; color: var(--text-primary); cursor: pointer;
            backdrop-filter: blur(var(--glass-blur)); box-shadow: var(--card-shadow), var(--inner-shadow);
            transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); flex-shrink: 0;
        }
        .btn-circle:hover, .location-pill:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.3), var(--inner-shadow); }
        .btn-circle:active, .location-pill:active { transform: scale(0.95); }

        /* --- Ø¨Ø®Ø´ Ø§ØµÙ„ÛŒ Ú¯ÛŒØ¬ --- */
        .hero-section { display: flex; flex-direction: column; align-items: center; position: relative; margin-top: 20px; }
        .gauge-wrapper { width: 300px; height: 300px; position: relative; filter: drop-shadow(0 20px 40px rgba(0,0,0,0.3)); }
        .gauge-svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .track { fill: none; stroke: var(--glass-border); stroke-width: 16; stroke-linecap: round; }
        .progress {
            fill: none; stroke: var(--accent-color); stroke-width: 16; stroke-linecap: round;
            stroke-dasharray: 660; stroke-dashoffset: 660; transition: stroke-dashoffset 2s cubic-bezier(0.2, 0.8, 0.2, 1), stroke 1s;
            filter: drop-shadow(0 0 10px var(--accent-color));
        }
        .hero-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: flex; flex-direction: column; align-items: center; }
        .hero-val { font-size: 90px; font-weight: 900; line-height: 0.9; letter-spacing: -3px; text-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .hero-label {
            font-size: 18px; font-weight: 800; color: #fff; margin-top: 15px;
            background: var(--accent-color); padding: 8px 20px; border-radius: 30px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* --- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ --- */
        .glass-card {
            background: var(--glass-bg); border: 1px solid var(--glass-border); border-top: 1px solid var(--glass-highlight);
            border-radius: 32px; padding: 28px; backdrop-filter: blur(var(--glass-blur));
            box-shadow: var(--card-shadow), var(--inner-shadow); position: relative; overflow: hidden;
            transition: transform 0.4s ease, box-shadow 0.4s ease;
        }
        .glass-card:hover { transform: translateY(-4px); box-shadow: 0 25px 50px -5px rgba(0, 0, 0, 0.6), var(--inner-shadow); }
        
        .friendly-card { text-align: right; border-right: 8px solid #fbbf24; background: linear-gradient(90deg, var(--glass-bg) 0%, rgba(0,0,0,0) 100%); }
        .friendly-title { font-size: 20px; font-weight: 900; margin-bottom: 12px; color: #fbbf24; display: flex; align-items: center; gap: 10px; }
        .friendly-text { font-size: 16px; line-height: 1.8; font-weight: 500; text-align: justify; color: var(--text-primary); opacity: 0.95; }

        .weather-visual-card { display: flex; flex-direction: column; align-items: center; text-align: center; background: linear-gradient(160deg, var(--glass-bg) 0%, rgba(255,255,255,0.01) 100%); padding-top: 40px; }
        .weather-anim-container { width: 160px; height: 160px; margin-bottom: 10px; position: relative; z-index: 2; filter: drop-shadow(0 20px 40px rgba(0,0,0,0.25)); }
        .visual-temp { font-size: 70px; font-weight: 900; line-height: 1; margin-bottom: 8px; background: linear-gradient(to bottom, var(--text-primary), var(--text-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .visual-desc { font-size: 20px; opacity: 1; margin-bottom: 25px; font-weight: 700; color: var(--accent-color); }
        .visual-grid { display: flex; gap: 20px; width: 100%; justify-content: center; margin-top: 15px; padding-top: 20px; border-top: 1px solid var(--glass-border); }
        .v-item { display: flex; flex-direction: column; align-items: center; gap: 6px; flex: 1; }
        .v-val { font-size: 18px; font-weight: 800; }

        /* --- Ù„ÛŒØ³Øª Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Û· Ø±ÙˆØ²Ù‡ --- */
        .forecast-list { display: flex; flex-direction: column; gap: 15px; }
        .forecast-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; border-bottom: 1px solid var(--glass-border);
        }
        .forecast-item:last-child { border-bottom: none; }
        .f-day { font-weight: 900; width: 60px; font-size: 15px; }
        .f-icon { width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; }
        .f-desc { font-size: 12px; opacity: 0.7; flex: 1; padding: 0 10px; text-align: right; }
        .f-temp { font-weight: 800; font-size: 16px; width: 80px; text-align: left; direction: ltr; }

        /* --- Ù†Ù…ÙˆØ¯Ø§Ø± --- */
        .chart-container { position: relative; height: 200px; width: 100%; margin-top: 10px; }

        /* --- ÙØ§Ø² Ù…Ø§Ù‡ --- */
        .moon-card { border-right: 8px solid #a78bfa; background: linear-gradient(135deg, rgba(20,20,40,0.8), rgba(0,0,0,0.2)); }
        .moon-content { display: flex; align-items: center; gap: 20px; }
        .moon-visual { width: 80px; height: 80px; position: relative; border-radius: 50%; box-shadow: 0 0 30px rgba(255,255,255,0.1); flex-shrink: 0; background-color: #0f172a; overflow: hidden; }
        .moon-text-col { flex: 1; }
        .moon-phase-name { font-size: 18px; font-weight: 900; color: #a78bfa; margin-bottom: 5px; }
        .moon-desc { font-size: 13px; line-height: 1.8; opacity: 0.85; text-align: justify; }

        /* --- Ø§Ø±ØªÙØ§Ø¹ --- */
        .elevation-card { text-align: center; border-bottom: 8px solid var(--accent-color); }
        .elev-icon { font-size: 40px; margin-bottom: 10px; display: block; }
        .elev-val { font-size: 32px; font-weight: 900; color: var(--accent-color); margin: 5px 0; }
        .elev-desc { font-size: 14px; opacity: 0.7; font-weight: 500; }

        /* --- Ø§Ù†ÛŒÙ…ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ SVG --- */
        .anim-sun { animation: spin 20s linear infinite; transform-origin: center; }
        .anim-cloud { animation: float 6s ease-in-out infinite; }
        .anim-rain { animation: rainDrop 0.8s linear infinite; }
        .anim-snow { animation: snowDrop 3s linear infinite; }
        .anim-thunder { animation: flash 5s infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes rainDrop { 0% { transform: translateY(0); opacity:1; } 100% { transform: translateY(30px); opacity:0; } }
        @keyframes flash { 0%, 90%, 100% { opacity: 0; } 92%, 96% { opacity: 1; filter: drop-shadow(0 0 20px #facc15); } }

        /* --- Ù…ÙˆØ¯Ø§Ù„ ÙˆÙ„Ú©Ø§Ù… (Ø¬Ø¯ÛŒØ¯) --- */
        .welcome-modal {
            position: fixed; inset: 0; z-index: 300;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(20px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.5s;
        }
        .welcome-modal.active { opacity: 1; pointer-events: auto; }
        .welcome-card {
            width: 90%; max-width: 400px; background: var(--bg-color);
            border: 1px solid var(--glass-border); border-radius: 40px; padding: 40px;
            text-align: center; box-shadow: 0 40px 80px rgba(0,0,0,0.6);
            transform: scale(0.9); transition: 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .welcome-modal.active .welcome-card { transform: scale(1); }
        .welcome-icon { font-size: 60px; margin-bottom: 20px; animation: float 4s ease-in-out infinite; }
        .welcome-btn {
            width: 100%; padding: 16px; border-radius: 20px; border: none; font-family: inherit;
            font-size: 16px; font-weight: 800; margin-top: 15px; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-primary { background: var(--accent-color); color: #000; box-shadow: 0 10px 20px rgba(52, 211, 153, 0.3); }
        .btn-secondary { background: var(--glass-bg); color: var(--text-primary); border: 1px solid var(--glass-border); }
        .btn-primary:active, .btn-secondary:active { transform: scale(0.96); }

        /* --- Ù„ÙˆØ¯Ø± Ùˆ Ø³Ø±Ú† --- */
        #loader { position: fixed; inset: 0; background: var(--bg-color); z-index: 200; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.6s; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; backdrop-filter: blur(25px); display: flex; justify-content: center; align-items: flex-end; opacity: 0; pointer-events: none; transition: 0.4s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-sheet { width: 100%; max-width: 550px; background: var(--bg-color); border-top-left-radius: 40px; border-top-right-radius: 40px; padding: 36px; transform: translateY(100%); transition: 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); border-top: 1px solid var(--glass-border); }
        .modal-overlay.open .modal-sheet { transform: translateY(0); }
        .search-input { background: var(--glass-bg); border: 1px solid var(--glass-border); padding: 20px; border-radius: 24px; color: var(--text-primary); font-family: inherit; font-weight: 700; font-size: 18px; width: 100%; margin-top: 24px; text-align: center; }
        .search-item { padding: 20px; border-bottom: 1px solid var(--glass-border); cursor: pointer; text-align: center; color: var(--text-primary); font-weight: 500; transition: 0.2s; }

    </style>
</head>
<body>

    <div class="liquid-blob">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>
    <div id="particles"></div>

    <div id="loader">
        <svg width="80" height="80" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <defs><linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:var(--accent-color);stop-opacity:1" /><stop offset="100%" style="stop-color:var(--liquid-1);stop-opacity:1" /></linearGradient></defs>
            <circle cx="12" cy="12" r="10" fill="none" stroke-dasharray="32" stroke-dashoffset="32" stroke="url(#grad1)">
                <animate attributeName="stroke-dashoffset" from="64" to="0" dur="1.2s" repeatCount="indefinite"/>
                <animate attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="2s" repeatCount="indefinite"/>
            </circle>
        </svg>
        <div style="margin-top: 25px; font-size: 18px; font-weight: 700; opacity: 0.9;">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§...</div>
    </div>

    <div class="welcome-modal" id="welcome-modal">
        <div class="welcome-card">
            <div class="welcome-icon">ğŸŒ</div>
            <h2 style="font-size: 24px; margin-bottom: 10px;">Ø³Ù„Ø§Ù…! Ø¨Ù‡ Ù‡ÙˆØ§ÛŒ Ù¾Ø§Ú© Ù¾Ù„Ø§Ø³ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
            <p style="opacity: 0.8; margin-bottom: 30px; line-height: 1.6;">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ùˆ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ±ÛŒÙ† Ú¯Ø²Ø§Ø±Ø´ Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§ØŒ Ù„Ø·ÙØ§Ù‹ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯.</p>
            <button class="welcome-btn btn-primary" onclick="handleWelcomeGPS()">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 2v20M2 12h20"/><circle cx="12" cy="12" r="6"/></svg>
                ÛŒØ§ÙØªÙ† Ø®ÙˆØ¯Ú©Ø§Ø± Ù…ÙˆÙ‚Ø¹ÛŒØª
            </button>
            <button class="welcome-btn btn-secondary" onclick="handleWelcomeManual()">Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¯Ø³ØªÛŒ Ø´Ù‡Ø±</button>
        </div>
    </div>

    <div class="modal-overlay" id="search-modal">
        <div class="modal-sheet">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:22px; font-weight:900;">Ú©Ø¬Ø§ Ù‡Ø³ØªÛŒØ¯ØŸ</span>
                <button onclick="toggleSearch(false)" style="background:none; border:none; color:var(--text-primary); font-size:28px; cursor:pointer;">âœ•</button>
            </div>
            <input type="text" class="search-input" id="city-input" placeholder="Ù†Ø§Ù… Ø´Ù‡Ø± Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ (Ù…Ø«Ù„Ø§Ù‹: Tehran)" dir="rtl">
            <div id="search-list" style="margin-top:20px; max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>

    <div id="app">
        <header class="fade-in-up" style="animation-delay: 0.1s;">
            <div class="location-pill" onclick="toggleSearch(true)">
                <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                <span id="loc-name">ØªÙ‡Ø±Ø§Ù†</span>
            </div>
            <div class="header-actions">
                <div class="btn-circle" onclick="toggleTheme()" title="ØªØºÛŒÛŒØ± ØªÙ…">
                    <svg id="theme-icon" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                </div>
            </div>
        </header>

        <div class="hero-section fade-in-up" style="animation-delay: 0.2s;">
            <div class="gauge-wrapper">
                <svg class="gauge-svg" viewBox="0 0 240 240">
                    <circle class="track" cx="120" cy="120" r="110"></circle>
                    <circle id="aqi-ring" class="progress" cx="120" cy="120" r="110"></circle>
                </svg>
                <div class="hero-center">
                    <div class="hero-val" id="aqi-val">--</div>
                    <div class="hero-label" id="aqi-text">...</div>
                </div>
            </div>
        </div>

        <div class="glass-card friendly-card fade-in-up" style="animation-delay: 0.3s;">
            <div class="friendly-title"><span>ğŸ‘‹</span><span>Ú¯Ø²Ø§Ø±Ø´ Ù…ÙˆØ¯ Ø´Ù…Ø§</span></div>
            <div class="friendly-text" id="friendly-text">...</div>
        </div>

        <div class="glass-card weather-visual-card fade-in-up" style="animation-delay: 0.4s;">
            <div class="weather-anim-container" id="weather-icon-container"></div>
            <div class="visual-temp" id="visual-temp">--Â°</div>
            <div class="visual-desc" id="visual-desc">--</div>
            <div class="visual-grid">
                <div class="v-item"><span class="v-val" id="hum-val">--%</span><span style="font-size:12px;opacity:0.7">Ø±Ø·ÙˆØ¨Øª</span></div>
                <div class="v-item"><span class="v-val" id="wind-val">--</span><span style="font-size:12px;opacity:0.7">Ø¨Ø§Ø¯ (km/h)</span></div>
            </div>
        </div>

        <div class="glass-card moon-card fade-in-up" style="animation-delay: 0.45s;">
            <div class="moon-content">
                <div class="moon-visual" id="moon-render">
                    </div>
                <div class="moon-text-col">
                    <div class="moon-phase-name" id="moon-phase-name">--</div>
                    <div class="moon-desc" id="moon-desc">--</div>
                </div>
            </div>
        </div>

        <div class="glass-card fade-in-up" style="animation-delay: 0.5s;">
            <div style="font-size:18px; font-weight:900; margin-bottom:15px; display:flex; gap:10px; align-items:center;">
                <span style="color:var(--accent-color)">ğŸ“ˆ</span>
                Ø±ÙˆÙ†Ø¯ Ø¯Ù…Ø§ÛŒÛŒ Ù‡ÙØªÙ‡
            </div>
            <div class="chart-container">
                <canvas id="forecastChart"></canvas>
            </div>
        </div>

        <div class="glass-card fade-in-up" style="animation-delay: 0.6s;">
            <div style="font-size:18px; font-weight:900; margin-bottom:20px; display:flex; gap:10px; align-items:center;">
                <span>ğŸ—“ï¸</span>
                Ú†Ø´Ù…â€ŒØ§Ù†Ø¯Ø§Ø² Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø¢ÛŒÙ†Ø¯Ù‡
            </div>
            <div class="forecast-list" id="forecast-list">
                </div>
        </div>

        <div class="glass-card elevation-card fade-in-up" style="animation-delay: 0.7s;">
            <span class="elev-icon">ğŸ”ï¸</span>
            <div style="font-size:16px; font-weight:700;">Ø§Ø±ØªÙØ§Ø¹ Ø´Ù…Ø§ Ø§Ø² Ø³Ø·Ø­ Ø¯Ø±ÛŒØ§</div>
            <div class="elev-val" id="elev-val">--</div>
            <div class="elev-desc" id="elev-desc">--</div>
        </div>

        <footer class="fade-in-up" style="animation-delay: 0.9s; text-align:center; font-size:13px; opacity:0.4; margin-top:20px;">
            Ù†Ø³Ø®Ù‡ Ø§ÙˆÙ„ØªØ±Ø§ | Ø·Ø±Ø§Ø­ÛŒ Ø¨Ø§ â¤ï¸
        </footer>
    </div>

<script>
    const toFarsi = (n) => n?.toString().replace(/\d/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]) || '-';
    let isLight = false;
    let chartInstance = null;

    // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Chart.js ---
    Chart.defaults.font.family = 'Vazirmatn';
    Chart.defaults.color = '#94a3b8';

    // --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ---
    function toggleTheme() {
        isLight = !isLight;
        document.body.classList.toggle('light-mode');
        const icon = document.getElementById('theme-icon');
        icon.innerHTML = isLight 
            ? '<circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>'
            : '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
        
        // Ø¢Ù¾Ø¯ÛŒØª Ø±Ù†Ú¯ Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ø± ØªØºÛŒÛŒØ± ØªÙ…
        if(chartInstance) {
            chartInstance.options.scales.y.grid.color = isLight ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.05)';
            chartInstance.update();
        }
    }

    function getDayName(dateStr) {
        const date = new Date(dateStr);
        const days = ['ÛŒÚ©Ø´Ù†Ø¨Ù‡', 'Ø¯ÙˆØ´Ù†Ø¨Ù‡', 'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡', 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡', 'Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡', 'Ø¬Ù…Ø¹Ù‡', 'Ø´Ù†Ø¨Ù‡'];
        return days[date.getDay()];
    }

    // --- Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ÛŒ SVG (Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ³Øª) ---
    function getSmallIcon(code) {
        if (code <= 1) return 'â˜€ï¸';
        if (code <= 3) return 'â˜ï¸';
        if (code <= 67) return 'ğŸŒ§ï¸';
        if (code <= 77) return 'â„ï¸';
        if (code >= 95) return 'â›ˆï¸';
        return 'ğŸŒ¥ï¸';
    }

    function getWeatherSVG(code, isDay) {
        // Ù‡Ù…Ø§Ù† ØªØ§Ø¨Ø¹ Ù‚Ø¨Ù„ÛŒ SVG Ù‡Ø§ (Ø®Ù„Ø§ØµÙ‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªÚ©Ø±Ø§Ø± Ú©Ø¯ Ø·ÙˆÙ„Ø§Ù†ÛŒ)
        const sunColor = "#facc15";
        const cloudColor = isLight ? "#94a3b8" : "#cbd5e1";
        if (code <= 1) return isDay ? `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="25" fill="${sunColor}"/><g stroke="${sunColor}" stroke-width="4"><line x1="50" y1="10" x2="50" y2="0"/><line x1="50" y1="90" x2="50" y2="100"/><line x1="10" y1="50" x2="0" y2="50"/><line x1="90" y1="50" x2="100" y2="50"/></g></svg>` : `<svg viewBox="0 0 100 100"><path d="M40 20 A30 30 0 1 0 80 70 A20 20 0 1 1 40 20" fill="#f1f5f9"/></svg>`;
        if (code <= 3) return `<svg viewBox="0 0 100 100"><path class="anim-cloud" d="M25,60 a20,20 0 0,1 0,-40 a20,20 0 0,1 40,0 a20,20 0 0,1 0,40 z" fill="${cloudColor}"/></svg>`;
        if (code >= 95) return `<svg viewBox="0 0 100 100"><path class="anim-cloud" d="M25,60 a20,20 0 0,1 0,-40 a20,20 0 0,1 40,0 a20,20 0 0,1 0,40 z" fill="${cloudColor}"/><path class="anim-thunder" d="M45,60 L35,80 L50,80 L40,105" stroke="#facc15" stroke-width="4" fill="none"/></svg>`;
        return `<svg viewBox="0 0 100 100"><path class="anim-cloud" d="M25,60 a20,20 0 0,1 0,-40 a20,20 0 0,1 40,0 a20,20 0 0,1 0,40 z" fill="${cloudColor}"/><line x1="35" y1="65" x2="30" y2="85" stroke="#60a5fa" stroke-width="3"/></svg>`;
    }

    // --- Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§Ø² Ù…Ø§Ù‡ Ùˆ Ø±Ù†Ø¯Ø± ---
    function renderMoonPhase() {
        const date = new Date();
        const cycle = 29.53;
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø³Ù† Ù…Ø§Ù‡ Ø§Ø² ÛŒÚ© ØªØ§Ø±ÛŒØ® Ù…Ø±Ø¬Ø¹ (Ù…Ø«Ù„Ø§Ù‹ 6 Ú˜Ø§Ù†ÙˆÛŒÙ‡ 2000 Ù…Ø§Ù‡ Ù†Ùˆ Ø¨ÙˆØ¯)
        const knownNewMoon = new Date('2000-01-06T18:14:00');
        const diffTime = date - knownNewMoon;
        const diffDays = diffTime / (1000 * 60 * 60 * 24);
        const moonAge = diffDays % cycle;
        
        let phaseName = "";
        let phaseDesc = "";
        let illumination = 0;
        
        // ØªØ¹ÛŒÛŒÙ† Ù…ØªÙ†
        if (moonAge < 1.5) { phaseName = "Ù…Ø§Ù‡ Ù†Ùˆ (New Moon)"; phaseDesc = "Ø¢ØºØ§Ø² Ú†Ø±Ø®Ù‡â€ŒØ§ÛŒ ØªØ§Ø²Ù‡. Ø²Ù…Ø§Ù†ÛŒ Ø¹Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø´ØªÙ† Ø¨Ø°Ø± Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ùˆ Ø´Ø±ÙˆØ¹ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø±Ø´Ø¯ Ø¯Ø§Ø±Ù†Ø¯. Ø¢Ø³Ù…Ø§Ù† ØªØ§Ø±ÛŒÚ© Ø§Ø³Øª Ùˆ Ø³ØªØ§Ø±Ú¯Ø§Ù† Ù…ÛŒâ€ŒØ¯Ø±Ø®Ø´Ù†Ø¯."; illumination = 0; }
        else if (moonAge < 7) { phaseName = "Ù‡Ù„Ø§Ù„ Ø§ÙØ²Ø§ÛŒÙ†Ø¯Ù‡"; phaseDesc = "Ø§Ù†Ø±Ú˜ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§ÙØ²Ø§ÛŒØ´ Ø§Ø³Øª. Ø²Ù…Ø§Ù† Ø§Ù‚Ø¯Ø§Ù… Ùˆ Ø­Ø±Ú©Øª Ø¨Ù‡ Ø³Ù…Øª Ø§Ù‡Ø¯Ø§Ù. Ù…Ø§Ù‡ Ø¨Ù‡ Ø´Ú©Ù„ Ø¯Ø§Ø³ÛŒ Ø¨Ø§Ø±ÛŒÚ© Ùˆ Ø²ÛŒØ¨Ø§ Ø¯Ø± Ø¢Ø³Ù…Ø§Ù† ØºØ±ÙˆØ¨ Ø®ÙˆØ¯Ù†Ù…Ø§ÛŒÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."; illumination = 0.25; }
        else if (moonAge < 8) { phaseName = "ØªØ±Ø¨ÛŒØ¹ Ø§ÙˆÙ„"; phaseDesc = "Ù…Ø§Ù‡ Ù†ÛŒÙ…ÛŒ Ø§Ø² Ú†Ù‡Ø±Ù‡â€ŒØ§Ø´ Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. Ø²Ù…Ø§Ù† ØºÙ„Ø¨Ù‡ Ø¨Ø± Ù…ÙˆØ§Ù†Ø¹ Ùˆ ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒ. ØªØ¹Ø§Ø¯Ù„ Ø¨ÛŒÙ† Ù†ÙˆØ± Ùˆ ØªØ§Ø±ÛŒÚ©ÛŒ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø§Ø³Øª."; illumination = 0.5; }
        else if (moonAge < 14) { phaseName = "ØªØ­Ø¯Ø¨ Ø§ÙØ²Ø§ÛŒÙ†Ø¯Ù‡"; phaseDesc = "Ù†Ø²Ø¯ÛŒÚ© Ø¨Ù‡ Ú©Ù…Ø§Ù„. Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ù‚ÛŒÙ‚ Ú©Ù†ÛŒØ¯. Ø§Ù†Ø±Ú˜ÛŒ Ú©ÛŒÙ‡Ø§Ù†ÛŒ Ø¨Ø§Ù„Ø§Ø³Øª Ùˆ Ø§Ø­Ø³Ø§Ø³Ø§Øª Ø´Ø¯Øª Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù†Ø¯."; illumination = 0.75; }
        else if (moonAge < 16) { phaseName = "Ù…Ø§Ù‡ Ú©Ø§Ù…Ù„ (Full Moon)"; phaseDesc = "Ø§ÙˆØ¬ Ø¯Ø±Ø®Ø´Ø´ Ùˆ Ø§Ù†Ø±Ú˜ÛŒ. Ù…Ø§Ù‡ Ú†ÙˆÙ† Ù…Ø±ÙˆØ§Ø±ÛŒØ¯ÛŒ Ø¯Ø± Ø´Ø¨ Ù…ÛŒâ€ŒØ¯Ø±Ø®Ø´Ø¯. Ø²Ù…Ø§Ù† Ø¨Ø±Ø¯Ø§Ø´Øª Ù†ØªÛŒØ¬Ù‡ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ Ùˆ Ø§Ù„Ø¨ØªÙ‡ Ú©Ù†ØªØ±Ù„ Ø§Ø­Ø³Ø§Ø³Ø§Øª Ù‡ÛŒØ¬Ø§Ù†ÛŒ."; illumination = 1; }
        else if (moonAge < 22) { phaseName = "ØªØ­Ø¯Ø¨ Ú©Ø§Ù‡Ù†Ø¯Ù‡"; phaseDesc = "Ø²Ù…Ø§Ù† Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ù†Ø´ Ùˆ ØªØ¬Ø±Ø¨Ù‡ Ø¨Ø§ Ø¯ÛŒÚ¯Ø±Ø§Ù†. Ù…Ø§Ù‡ Ø§Ù†Ø¯Ú© Ø§Ù†Ø¯Ú© Ø±Ùˆ Ø¨Ù‡ Ø®Ø§Ù…ÙˆØ´ÛŒ Ù…ÛŒâ€ŒØ±ÙˆØ¯ ØªØ§ Ø§Ø³ØªØ±Ø§Ø­Øª Ú©Ù†Ø¯."; illumination = 0.75; }
        else if (moonAge < 23) { phaseName = "ØªØ±Ø¨ÛŒØ¹ Ø¢Ø®Ø±"; phaseDesc = "Ø²Ù…Ø§Ù† Ø±Ù‡Ø§ Ú©Ø±Ø¯Ù† Ú†ÛŒØ²Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¯ÛŒÚ¯Ø± Ø¨Ù‡ Ø¯Ø±Ø¯ØªØ§Ù† Ù†Ù…ÛŒâ€ŒØ®ÙˆØ±Ø¯. Ø®Ø§Ù†Ù‡ ØªÚ©Ø§Ù†ÛŒ Ø°Ù‡Ù†ÛŒ Ùˆ ÙÛŒØ²ÛŒÚ©ÛŒ Ø¯Ø± Ø§ÛŒÙ† ÙØ§Ø² Ø¹Ø§Ù„ÛŒ Ø§Ø³Øª."; illumination = 0.5; }
        else { phaseName = "Ù‡Ù„Ø§Ù„ Ú©Ø§Ù‡Ù†Ø¯Ù‡"; phaseDesc = "Ù¾Ø§ÛŒØ§Ù† Ú†Ø±Ø®Ù‡. Ø²Ù…Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ±Ø§Ø­ØªØŒ ØªÙÚ©Ø± Ùˆ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù† Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡. Ø³Ø­Ø±Ø®ÛŒØ²Ù‡Ø§ Ø§ÛŒÙ† Ù‡Ù„Ø§Ù„ Ø²ÛŒØ¨Ø§ Ø±Ø§ Ø¯Ø± ØµØ¨Ø­ Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ù†Ø¯."; illumination = 0.1; }

        document.getElementById('moon-phase-name').innerText = phaseName;
        document.getElementById('moon-desc').innerText = phaseDesc;

        // Ø±Ù†Ø¯Ø± Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ Ù…Ø§Ù‡ (Ø³Ø§ÛŒÙ‡ Ø±ÙˆÛŒ Ø¯Ø§ÛŒØ±Ù‡)
        // Ø³Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² CSS Mask ÛŒØ§ SVG Path Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙØ§Ø²
        // Ø§ÛŒÙ†Ø¬Ø§ ÛŒÚ© SVG Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ…
        let path = "";
        // Ù…Ù†Ø·Ù‚ Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù… Ø³Ø§ÛŒÙ‡:
        const cx = 40, cy = 40, r = 38;
        // Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø¯Ù…Ùˆ ÛŒÚ© Ù…Ø§Ù‡ Ú©Ø§Ù…Ù„ Ø¨Ø§ Ù…Ø§Ø³Ú© Ø³Ø§ÛŒÙ‡ Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ…
        const shadowX = moonAge < 15 ? (moonAge/14.7) * 80 - 40 : ((moonAge-14.7)/14.7) * 80; 
        
        let svg = `<svg width="100%" height="100%" viewBox="0 0 80 80">
            <defs>
                <radialGradient id="moonGrad" cx="50%" cy="50%" r="50%" fx="20%" fy="20%">
                    <stop offset="0%" style="stop-color:#f1f5f9;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#94a3b8;stop-opacity:1" />
                </radialGradient>
                <filter id="glow"><feGaussianBlur stdDeviation="2.5" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
            </defs>
            <circle cx="40" cy="40" r="36" fill="url(#moonGrad)" filter="url(#glow)" />
            <circle cx="40" cy="40" r="36" fill="rgba(2, 6, 23, 0.85)" transform="translate(${moonAge < 15 ? -40 + (moonAge * 2.7) : 40 - ((moonAge-15)*2.7)}, 0)" style="mix-blend-mode: multiply; filter:blur(4px)" />
        </svg>`;
        
        // Ø¨Ø±Ø§ÛŒ Ø¯Ù‚Øª Ø¨Ø§Ù„Ø§ Ø¯Ø± ÛŒÚ© ÙØ§ÛŒÙ„ ØªÚ©ØŒ Ø§Ø² ÛŒÚ© ØªØµÙˆÛŒØ± Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú†ÙˆÙ† Ø±Ø³Ù… Ø¯Ù‚ÛŒÙ‚ Ø±ÛŒØ§Ø¶ÛŒØ§ØªÛŒ path Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø§Ø³Øª
        // Ø§Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÛŒÚ© Ø¯Ø§ÛŒØ±Ù‡ Ø³Ø§Ø¯Ù‡ Ø¨Ø§ Ú¯Ø±Ø§Ø¯ÛŒÙ†Øª Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±ÛŒÙ… Ú©Ù‡ Ù†Ù…Ø§Ø¯ÛŒÙ† Ø¨Ø§Ø´Ø¯
        const moonColor = "#e2e8f0";
        let maskX = 0;
        if(moonAge < 15) { // Waxing
             // Ø³Ø§ÛŒÙ‡ Ø§Ø² Ø±Ø§Ø³Øª Ù…ÛŒØ±Ù‡
             svg = `<svg width="80" height="80" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#334155"/><path d="M50 5 a45 45 0 0 1 0 90 a${Math.abs(45 - 3 * moonAge)} 45 0 0 ${moonAge < 7.5 ? 0 : 1} 0 -90" fill="#f8fafc" filter="drop-shadow(0 0 5px white)"/></svg>`;
        } else { // Waning
             const age = moonAge - 15;
             svg = `<svg width="80" height="80" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#334155"/><path d="M50 5 a45 45 0 0 0 0 90 a${Math.abs(45 - 3 * age)} 45 0 0 ${age > 7.5 ? 0 : 1} 0 -90" fill="#f8fafc" filter="drop-shadow(0 0 5px white)"/></svg>`;
        }
        
        document.getElementById('moon-render').innerHTML = svg;
    }

    // --- Ø±Ù†Ø¯Ø± Ù†Ù…ÙˆØ¯Ø§Ø± ---
    function renderChart(dates, maxTemps, minTemps) {
        const ctx = document.getElementById('forecastChart').getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 200);
        gradient.addColorStop(0, 'rgba(52, 211, 153, 0.5)');
        gradient.addColorStop(1, 'rgba(52, 211, 153, 0)');

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates.map(d => getDayName(d)),
                datasets: [
                    {
                        label: 'Ø­Ø¯Ø§Ú©Ø«Ø± Ø¯Ù…Ø§',
                        data: maxTemps,
                        borderColor: '#34d399',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#34d399',
                        pointRadius: 4,
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Ø­Ø¯Ø§Ù‚Ù„ Ø¯Ù…Ø§',
                        data: minTemps,
                        borderColor: '#60a5fa',
                        borderWidth: 2,
                        pointRadius: 0,
                        borderDash: [5, 5],
                        tension: 0.4,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        titleFont: { family: 'Vazirmatn' },
                        bodyFont: { family: 'Vazirmatn' },
                        padding: 10,
                        cornerRadius: 10,
                        displayColors: false
                    }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { font: { family: 'Vazirmatn', size: 10 } } },
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, border: { display: false }, ticks: { display: false } }
                }
            }
        });
    }

    // --- ØªÙˆØ§Ø¨Ø¹ Ø¯ÛŒØªØ§ ---
    async function fetchData(lat, lon, name) {
        document.getElementById('loader').style.display = 'flex';
        document.getElementById('loader').style.opacity = '1';

        try {
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ daily Ùˆ elevation
            const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code,is_day&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset&hourly=precipitation_probability&timezone=auto`;
            const aqiUrl = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=us_aqi,pm2_5,nitrogen_dioxide&timezone=auto`;
            
            const [wRes, aRes] = await Promise.all([fetch(weatherUrl), fetch(aqiUrl)]);
            const weatherData = await wRes.json();
            const aqiData = await aRes.json();

            localStorage.setItem('last_lat', lat);
            localStorage.setItem('last_lon', lon);
            localStorage.setItem('last_name', name);

            updateUI(weatherData, aqiData, name);

        } catch (e) {
            console.error(e);
            alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª. Ù„Ø·ÙØ§ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.");
        } finally {
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').style.display = 'none', 600);
        }
    }

    function updateUI(wData, aData, city) {
        const current = wData.current;
        const daily = wData.daily;
        const aqi = aData.current.us_aqi;
        const ele = wData.elevation;

        // Ø¢Ù¾Ø¯ÛŒØª Ù…ØªÙ†â€ŒÙ‡Ø§ Ùˆ Ø±Ù†Ú¯â€ŒÙ‡Ø§ (Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ)
        let accent = '#34d399';
        let status = 'Ù¾Ø§Ú©';
        if(aqi > 50) { accent = '#facc15'; status = 'Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„'; }
        if(aqi > 100) { accent = '#fb923c'; status = 'Ù†Ø§Ø³Ø§Ù„Ù… Ø­Ø³Ø§Ø³'; }
        if(aqi > 150) { accent = '#f87171'; status = 'Ù†Ø§Ø³Ø§Ù„Ù…'; }
        
        document.documentElement.style.setProperty('--accent-color', accent);
        document.getElementById('loc-name').innerText = city;
        
        // Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¹Ø¯Ø¯ AQI
        document.getElementById('aqi-val').innerText = toFarsi(aqi);
        document.getElementById('aqi-text').innerText = status;
        document.getElementById('aqi-text').style.backgroundColor = accent;
        const offset = 660 - (Math.min(aqi, 400) / 400) * 660;
        document.getElementById('aqi-ring').style.strokeDashoffset = offset;
        document.getElementById('aqi-ring').style.stroke = accent;

        // Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§ Ø§ØµÙ„ÛŒ
        document.getElementById('visual-temp').innerText = toFarsi(Math.round(current.temperature_2m)) + 'Â°';
        document.getElementById('hum-val').innerText = toFarsi(current.relative_humidity_2m) + '%';
        document.getElementById('wind-val').innerText = toFarsi(current.wind_speed_10m);
        document.getElementById('weather-icon-container').innerHTML = getWeatherSVG(current.weather_code, current.is_day);
        
        // Ù…ØªÙ† ØªÙˆØµÛŒÙÛŒ
        const descText = getFriendlyText(current.temperature_2m, current.weather_code);
        document.getElementById('friendly-text').innerText = descText;
        document.getElementById('visual-desc').innerText = getWeatherLabel(current.weather_code);

        // --- 1. Ù†Ù…ÙˆØ¯Ø§Ø± ---
        renderChart(daily.time, daily.temperature_2m_max, daily.temperature_2m_min);

        // --- 2. Ù„ÛŒØ³Øª Û· Ø±ÙˆØ²Ù‡ ---
        const listEl = document.getElementById('forecast-list');
        listEl.innerHTML = '';
        for(let i=1; i<7; i++) { // Ø§Ø² ÙØ±Ø¯Ø§ Ø´Ø±ÙˆØ¹ Ù…ÛŒÚ©Ù†ÛŒÙ…
            const dayCode = daily.weather_code[i];
            const tMax = Math.round(daily.temperature_2m_max[i]);
            const tMin = Math.round(daily.temperature_2m_min[i]);
            const dayName = getDayName(daily.time[i]);
            const shortDesc = getShortDailyDesc(dayCode, tMax);
            
            const div = document.createElement('div');
            div.className = 'forecast-item';
            div.innerHTML = `
                <div class="f-day">${dayName}</div>
                <div class="f-icon" style="font-size:24px">${getSmallIcon(dayCode)}</div>
                <div class="f-desc">${shortDesc}</div>
                <div class="f-temp">${toFarsi(tMax)}Â° / <span style="opacity:0.6">${toFarsi(tMin)}Â°</span></div>
            `;
            listEl.appendChild(div);
        }

        // --- 3. Ù…Ø§Ù‡ ---
        renderMoonPhase();

        // --- 4. Ø§Ø±ØªÙØ§Ø¹ ---
        renderElevation(ele);
    }

    function renderElevation(meters) {
        document.getElementById('elev-val').innerText = toFarsi(meters) + ' Ù…ØªØ±';
        let desc = "";
        
        // Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¨Ø§ Ø¨Ø±Ø¬â€ŒÙ‡Ø§
        const milad = 435;
        const khalifa = 828;
        const azadi = 45;

        if (meters < azadi) {
            desc = `ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ Ù‡Ù…â€ŒØ³Ø·Ø­ Ù…ÛŒØ¯Ø§Ù† Ø¢Ø²Ø§Ø¯ÛŒØŒ Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ±ÛŒÙ† Ù†Ù‚Ø§Ø· Ø´Ù‡Ø±.`;
        } else if (meters < milad) {
            const ratio = (meters / azadi).toFixed(1);
            desc = `Ø´Ù…Ø§ Ø¯Ø± Ø§Ø±ØªÙØ§Ø¹ÛŒ Ù…Ø¹Ø§Ø¯Ù„ ${toFarsi(ratio)} Ø¨Ø±Ø§Ø¨Ø± Ø¨Ø±Ø¬ Ø¢Ø²Ø§Ø¯ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±ÛŒØ¯.`;
        } else if (meters < khalifa) {
            const ratio = (meters / milad).toFixed(1);
            desc = `Ø§Ø±ØªÙØ§Ø¹ Ø´Ù…Ø§ Ø­Ø¯ÙˆØ¯Ø§Ù‹ ${toFarsi(ratio)} Ø¨Ø±Ø§Ø¨Ø± Ø¨Ø±Ø¬ Ù…ÛŒÙ„Ø§Ø¯ ØªÙ‡Ø±Ø§Ù† Ø§Ø³Øª.`;
        } else {
            const ratio = (meters / khalifa).toFixed(1);
            desc = `Ø´Ú¯ÙØªâ€ŒØ§Ù†Ú¯ÛŒØ²! Ø´Ù…Ø§ ${toFarsi(ratio)} Ø¨Ø±Ø§Ø¨Ø± Ø¨Ù„Ù†Ø¯ØªØ± Ø§Ø² Ø¨Ù„Ù†Ø¯ØªØ±ÛŒÙ† Ø¨Ø±Ø¬ Ø¬Ù‡Ø§Ù† (Ø®Ù„ÛŒÙÙ‡) Ø§ÛŒØ³ØªØ§Ø¯Ù‡â€ŒØ§ÛŒØ¯.`;
        }
        document.getElementById('elev-desc').innerText = desc;
    }

    // --- Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ ---
    function getWeatherLabel(code) {
        if(code===0) return "ØµØ§Ù Ùˆ Ø¢ÙØªØ§Ø¨ÛŒ";
        if(code<=3) return "Ú©Ù…ÛŒ Ø§Ø¨Ø±ÛŒ";
        if(code<=48) return "Ù…Ù‡â€ŒØ¢Ù„ÙˆØ¯";
        if(code<=67) return "Ø¨Ø§Ø±Ø§Ù†ÛŒ";
        if(code<=77) return "Ø¨Ø±ÙÛŒ";
        return "Ø·ÙˆÙØ§Ù†ÛŒ";
    }

    function getShortDailyDesc(code, maxTemp) {
        if(code >= 95) return "Ù…Ø±Ø§Ù‚Ø¨ Ø±Ø¹Ø¯ Ùˆ Ø¨Ø±Ù‚ Ø¨Ø§Ø´ÛŒØ¯";
        if(code >= 71) return "Ù„Ø¨Ø§Ø³ Ú¯Ø±Ù… Ùˆ Ù¾Ø´Ù…ÛŒ Ø¨Ù¾ÙˆØ´ÛŒØ¯";
        if(code >= 51) return "Ú†ØªØ±ØªØ§Ù† Ø±Ø§ ÙØ±Ø§Ù…ÙˆØ´ Ù†Ú©Ù†ÛŒØ¯";
        if(maxTemp > 35) return "Ø±ÙˆØ² Ø¯Ø§ØºÛŒ Ø¯Ø± Ù¾ÛŒØ´ Ø§Ø³Øª";
        if(maxTemp < 5) return "ÛŒØ®Ø¨Ù†Ø¯Ø§Ù† Ø§Ø­ØªÙ…Ø§Ù„ÛŒ";
        if(code <= 1) return "Ø¹Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ±ÙˆÛŒ";
        return "Ù‡ÙˆØ§ÛŒÛŒ Ù…Ù„Ø§ÛŒÙ… Ùˆ Ù…Ø¹Ù…ÙˆÙ„ÛŒ";
    }
    
    function getFriendlyText(temp, code) {
        if(code > 50) return "Ø§Ù…Ø±ÙˆØ² Ø¢Ø³Ù…Ø§Ù† Ú©Ù…ÛŒ Ø¯Ù„Ú¯ÛŒØ± Ø§Ø³Øª Ùˆ Ù…ÛŒâ€ŒØ¨Ø§Ø±Ø¯. ØµØ¯Ø§ÛŒ Ø¨Ø§Ø±Ø§Ù† Ø¨Ù‡ØªØ±ÛŒÙ† Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ø¨Ø±Ø§ÛŒ Ø¢Ø±Ø§Ù…Ø´ Ø§Ø³Øª.";
        if(temp > 30) return "Ù‡ÙˆØ§ Ø­Ø³Ø§Ø¨ÛŒ Ú¯Ø±Ù… Ø´Ø¯Ù‡! Ø­ØªÙ…Ø§ Ø¢Ø¨ Ø²ÛŒØ§Ø¯ Ø¨Ù†ÙˆØ´ÛŒØ¯ Ùˆ Ø§Ø² Ø³Ø§ÛŒÙ‡ Ø­Ø±Ú©Øª Ú©Ù†ÛŒØ¯.";
        if(temp < 5) return "Ø³ÙˆØ² Ø³Ø±Ù…Ø§ Ø­Ø³ Ù…ÛŒâ€ŒØ´ÙˆØ¯. ÛŒÚ© Ù†ÙˆØ´ÛŒØ¯Ù†ÛŒ Ø¯Ø§Øº Ùˆ Ù„Ø¨Ø§Ø³ Ú¯Ø±Ù… Ø§Ù…Ø±ÙˆØ² Ù…Ø¹Ø¬Ø²Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.";
        return "Ù‡Ù…Ù‡ Ú†ÛŒØ² Ù…ØªØ¹Ø§Ø¯Ù„ Ø§Ø³Øª. Ù†Ù‡ Ø¢Ù†Ù‚Ø¯Ø± Ø³Ø±Ø¯ Ú©Ù‡ Ø¨Ù„Ø±Ø²ÛŒØ¯ØŒ Ù†Ù‡ Ø¢Ù†Ù‚Ø¯Ø± Ú¯Ø±Ù… Ú©Ù‡ Ú©Ù„Ø§ÙÙ‡ Ø´ÙˆÛŒØ¯.";
    }

    // --- Ù‡Ù†Ø¯Ù„ Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ø´Ø±ÙˆØ¹ (Welcome) ---
    function handleWelcomeGPS() {
        if(navigator.geolocation) {
            document.getElementById('welcome-modal').classList.remove('active');
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('loader').style.opacity = '1';
            navigator.geolocation.getCurrentPosition(
                p => fetchData(p.coords.latitude, p.coords.longitude, "Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†"),
                () => { alert("Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø¯ Ø´Ø¯."); document.getElementById('welcome-modal').classList.add('active'); document.getElementById('loader').style.opacity='0'; }
            );
        } else alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯");
    }

    function handleWelcomeManual() {
        document.getElementById('welcome-modal').classList.remove('active');
        toggleSearch(true);
    }

    // --- Ø¬Ø³ØªØ¬Ùˆ ---
    let debounce;
    function toggleSearch(show) {
        const modal = document.getElementById('search-modal');
        if(show) { modal.classList.add('open'); setTimeout(() => document.getElementById('city-input').focus(), 100); }
        else modal.classList.remove('open');
    }
    document.getElementById('city-input').addEventListener('input', (e) => {
        clearTimeout(debounce);
        if(e.target.value.length < 2) return;
        debounce = setTimeout(async () => {
            try {
                const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${e.target.value}&count=5&language=en&format=json`);
                const data = await res.json();
                const list = document.getElementById('search-list');
                list.innerHTML = '';
                if(data.results) {
                    data.results.forEach(c => {
                        const div = document.createElement('div');
                        div.className = 'search-item';
                        div.innerText = `${c.name} (${c.country_code})`;
                        div.onclick = () => { fetchData(c.latitude, c.longitude, c.name); toggleSearch(false); };
                        list.appendChild(div);
                    });
                }
            } catch(e) {}
        }, 600);
    });

    // --- Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡ ---
    function init() {
        const hasData = localStorage.getItem('last_lat');
        if(!hasData) {
            setTimeout(() => document.getElementById('welcome-modal').classList.add('active'), 500);
            document.getElementById('loader').style.display = 'none';
        } else {
            fetchData(localStorage.getItem('last_lat'), localStorage.getItem('last_lon'), localStorage.getItem('last_name'));
        }
    }
    init();

</script>
</body>
</html>