<!DOCTYPE html>
<html lang="fa" dir="rtl" class="">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ø¹Ø§Ø¯Øª</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        body { font-family: 'Vazirmatn', sans-serif; }
        .sortable-ghost { opacity: 0.4; background-color: #cce7ff; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Animations for Goal Cards */
        .goal-anim-in { animation: goal-fade-in 0.4s ease-out forwards; }
        .goal-anim-out { animation: goal-fade-out 0.3s ease-in forwards; }
        @keyframes goal-fade-in {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes goal-fade-out {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        /* Animations for Swipe Gestures */
        .cell-swipe-up { animation: cell-pop 0.2s ease-out forwards; }
        .cell-swipe-down { animation: cell-shrink 0.2s ease-out forwards; }
        @keyframes cell-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); background-color: hsla(120, 73%, 75%, 0.5); }
            100% { transform: scale(1); }
        }
        @keyframes cell-shrink {
            0% { transform: scale(1); }
            50% { transform: scale(0.85); background-color: hsla(0, 100%, 80%, 0.5); }
            100% { transform: scale(1); }
        }
        /* Styles for Stats Modal */
        .stat-card {
            @apply bg-white dark:bg-slate-700/50 p-4 rounded-xl text-center shadow-sm transition-all hover:shadow-md hover:scale-105;
        }
        .stat-value {
            @apply text-2xl font-bold text-indigo-600 dark:text-indigo-400 mb-1;
        }
        .stat-label {
            @apply text-xs text-slate-500 dark:text-slate-400 font-semibold;
        }
        .stats-tab-btn {
            @apply flex-grow md:flex-grow-0 px-4 py-2.5 rounded-lg text-slate-600 dark:text-slate-300 transition-colors font-semibold flex items-center justify-center gap-2 bg-slate-200/60 dark:bg-slate-700/60 hover:bg-slate-300/70 dark:hover:bg-slate-600/80;
        }
        .stats-tab-btn.active {
            @apply bg-indigo-600 text-white shadow-lg shadow-indigo-500/30;
        }
        .heatmap-day {
             @apply aspect-square rounded-lg flex items-center justify-center text-sm transition-colors relative;
        }
        .heatmap-count {
            @apply absolute -top-1.5 -right-1.5 bg-sky-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center border-2 border-white dark:border-slate-800 shadow-lg;
        }
        /* Glassmorphism Modal Style */
        .glass-modal-content {
            @apply bg-slate-50/70 dark:bg-slate-900/70 backdrop-blur-xl border border-slate-200/50 dark:border-slate-700/50;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT: 'hsl(250, 85%, 60%)', dark: 'hsl(250, 90%, 70%)' },
                        accent: 'hsl(205, 90%, 55%)',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 antialiased">
    <div class="min-h-screen pt-[env(safe-area-inset-top)]">
        <header id="navbar" class="sticky top-0 z-50 bg-white/80 dark:bg-slate-900/80 backdrop-blur-lg flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700">
            <div class="flex items-center gap-2">
                 <button id="aboutBtn" aria-label="Ø¯Ø±Ø¨Ø§Ø±Ù‡" class="text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full p-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
                 <button id="backupBtn" aria-label="Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ú¯ÛŒØ±ÛŒ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ" class="text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full p-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M12 15l-3-3m0 0l3-3m-3 3h12" />
                    </svg>
                </button>
                 <button id="archiveToggleBtn" aria-label="Ù†Ù…Ø§ÛŒØ´ Ø¢Ø±Ø´ÛŒÙˆ" class="text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full p-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                </button>
            </div>
            <div class="flex items-center gap-2">
                <button id="nextWeekBtn" aria-label="Ù‡ÙØªÙ‡ Ø¨Ø¹Ø¯" class="text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full p-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
                <div id="weekTitle" class="text-base md:text-lg font-bold text-indigo-600 dark:text-indigo-400 w-40 text-center">Ù‡ÙØªÙ‡</div>
                <button id="prevWeekBtn" aria-label="Ù‡ÙØªÙ‡ Ù‚Ø¨Ù„" class="text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full p-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
            </div>
            <button id="darkModeBtn" aria-label="ØªØºÛŒÛŒØ± ØªÙ…" class="text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full p-2 transition-colors text-xl">ğŸŒ™</button>
        </header>

        <main id="mainContent" class="max-w-4xl mx-auto p-4 pb-32">
            <div id="currentDateDisplay" class="text-center text-sm text-slate-500 dark:text-slate-400 mb-6 font-semibold"></div>
            <div id="weekdayRow" class="grid grid-cols-7 gap-2 text-center mb-6"></div>
            <div id="categoryFilters" class="flex justify-center gap-2 mb-6 flex-wrap"></div>
            <div id="goalList" class="flex flex-col gap-4"></div>
            <div id="archivedGoalList" class="hidden">
                <h3 class="text-lg font-bold text-slate-500 dark:text-slate-400 my-4 p-2 border-b-2 border-slate-200 dark:border-slate-700">Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯Ù‡â€ŒÙ‡Ø§</h3>
                <div class="flex flex-col gap-4"></div>
            </div>
        </main>

        <footer id="totalsBar" class="fixed bottom-0 left-0 right-0 z-40 bg-white/80 dark:bg-slate-900/80 backdrop-blur-lg border-t border-slate-200 dark:border-slate-700 flex items-center justify-around pb-[calc(env(safe-area-inset-bottom)+0.5rem)] pt-3 text-center"></footer>

        <button id="fab" aria-label="Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø¯Ù" class="fixed right-6 bottom-[calc(env(safe-area-inset-bottom)+5rem)] z-50 w-16 h-16 bg-indigo-600 text-white rounded-full flex items-center justify-center text-3xl shadow-lg hover:bg-indigo-700 active:scale-90 transition-transform">ï¼‹</button>
    </div>

    <div id="modalArea"></div>
    <div id="contextMenu" class="fixed z-[1000] min-w-[180px] bg-white/80 dark:bg-slate-800/80 backdrop-blur-lg shadow-2xl rounded-xl border border-slate-200 dark:border-slate-700 p-2 text-base" style="display:none"></div>

<script>
    // --- CONSTANTS & CONFIG ---
    const EMOJIS = ['âœ…','ğŸ‰','ğŸ”¥','ğŸ’ª','ğŸ¯','ğŸ‘','ğŸ‘','âŒ','ğŸ¤”','ğŸ˜´','ğŸ”','ğŸ’»','ğŸ§˜','ğŸ“–'];
    const CATEGORIES = {
        'ÙˆØ±Ø²Ø´': 'bg-sky-100 text-sky-800 dark:bg-sky-900/50 dark:text-sky-300',
        'Ú©Ø§Ø±': 'bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300',
        'Ø´Ø®ØµÛŒ': 'bg-violet-100 text-violet-800 dark:bg-violet-900/50 dark:text-violet-300',
        'Ø³Ù„Ø§Ù…ØªÛŒ': 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300',
    };
    const STORAGE_KEY = 'goal_tracker_data_v12';
    const STORAGE_ORDER = 'goal_tracker_order_v12';
    const STORAGE_THEME = 'goal_tracker_theme_v4';
    const WEEKDAY_NAMES_SHORT = ['Ø´', 'ÛŒ', 'Ø¯', 'Ø³', 'Ú†', 'Ù¾', 'Ø¬'];

    // --- STATE MANAGEMENT ---
    let appState = {
        currentWeek: getStartOfWeek(new Date()),
        goals: [], order: [], theme: 'auto', editing: null, showArchived: false,
        activeCategory: 'all',
        contextMenuGoalId: null
    };

    // --- JALALI DATE UTILITIES ---
    function toJalali(gy, gm, gd) {
      let g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
      let jy = (gy <= 1600) ? 0 : 979;
      gy -= (gy <= 1600) ? 621 : 1600;
      let gy2 = (gm > 2) ? (gy + 1) : gy;
      let days = (365 * gy) + (parseInt((gy2 + 3) / 4)) - (parseInt((gy2 + 99) / 100)) + (parseInt((gy2 + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
      jy += 33 * (parseInt(days / 12053));
      days %= 12053;
      jy += 4 * (parseInt(days / 1461));
      days %= 1461;
      jy += parseInt((days - 1) / 365);
      if (days > 365) days = (days - 1) % 365;
      let jm = (days < 186) ? 1 + parseInt(days / 31) : 7 + parseInt((days - 186) / 30);
      let jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
      return [jy, jm, jd];
    }

    function toGregorian(jy, jm, jd) {
        let gy = (jy <= 979) ? 621 : 1600;
        jy -= (jy <= 979) ? 0 : 979;
        let days = (365 * jy) + (parseInt(jy / 33) * 8) + (parseInt(((jy % 33) + 3) / 4)) + 78 + jd + ((jm < 7) ? (jm - 1) * 31 : ((jm - 7) * 30) + 186);
        gy += 400 * (parseInt(days / 146097));
        days %= 146097;
        if (days > 36524) {
            gy += 100 * (parseInt(--days / 36524));
            days %= 36524;
            if (days >= 365) days++;
        }
        gy += 4 * (parseInt(days / 1461));
        days %= 1461;
        gy += parseInt((days - 1) / 365);
        if (days > 365) days = (days - 1) % 365;
        let gd = days + 1;
        let sal_a = [0, 31, ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        let gm
        for (gm = 0; gm < 13 && gd > sal_a[gm]; gm++) gd -= sal_a[gm];
        return new Date(gy, gm - 1, gd);
    }
    function isJalaliLeap(year) {
        return (((((year - 474) % 2820) + 512) * 682) % 2816) < 682;
    }
    function jalaliMonthLength(year, month) {
        if (month <= 6) return 31;
        if (month <= 11) return 30;
        if (isJalaliLeap(year)) return 30;
        return 29;
    }

    // --- UTILITY FUNCTIONS ---
    function toFa(num) { return (''+num).replace(/\d/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[+d]); }
    function getStartOfWeek(date) { const d = new Date(date); d.setHours(0, 0, 0, 0); d.setDate(d.getDate() - ((d.getDay() + 1) % 7)); return d; }
    function getWeekDates(base) { return Array.from({length: 7}, (_, i) => { const d = new Date(base); d.setDate(base.getDate() + i); return d; }); }
    function formatWeekRange(base) { const week = getWeekDates(base); const fmt = (d) => d.toLocaleDateString('fa-IR', { month: 'short', day: 'numeric' }); return `${fmt(week[6])} â€“ ${fmt(week[0])}`; }
    function isToday(date) { const now = new Date(); return date.toDateString() === now.toDateString(); }
    function weekIdForDate(date) { const d = getStartOfWeek(date); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }
    function escapeHtml(txt) { return (''+txt).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g, '&quot;'); }

    // --- DATA PERSISTENCE ---
    function getDefaultGoals() {
        const creationDate = new Date().toISOString();
        const goals = [
            { id: 'default_1', name: 'ÙˆØ±Ø²Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡', emoji: 'ğŸ’ª', days: [true, true, true, true, true, false, false], history: {}, type: 'binary', archived: false, category: 'ÙˆØ±Ø²Ø´', creationDate },
            { id: 'default_2', name: 'Ø®ÙˆØ§Ù†Ø¯Ù† Ú©ØªØ§Ø¨', emoji: 'ğŸ“–', days: [true, true, true, true, true, true, true], history: {}, type: 'binary', archived: false, category: 'Ø´Ø®ØµÛŒ', creationDate },
            { id: 'default_3', name: 'ØªÙ…Ø±ÛŒÙ† ÛŒÚ© Ù…Ù‡Ø§Ø±Øª', emoji: 'ğŸ’»', days: [false, true, false, true, false, true, false], history: {}, type: 'binary', archived: false, category: 'Ú©Ø§Ø±', creationDate }
        ];
        const order = goals.map(g => g.id);
        return { goals, order };
    }

    function loadStateFromStorage() {
        const data = localStorage.getItem(STORAGE_KEY);
        const order = localStorage.getItem(STORAGE_ORDER);
        const theme = localStorage.getItem(STORAGE_THEME) || 'auto';
        let goals, orderArr;

        if (data && order) {
            goals = JSON.parse(data);
            orderArr = JSON.parse(order);
        } else {
            const defaults = getDefaultGoals();
            goals = defaults.goals;
            orderArr = defaults.order;
        }

        goals.forEach(g => {
            g.type = g.type || 'binary';
            if (typeof g.archived === 'undefined') g.archived = false;
            if (typeof g.category === 'undefined') g.category = 'Ø´Ø®ØµÛŒ';
            if (typeof g.creationDate === 'undefined') g.creationDate = new Date().toISOString();
            if (g.history) {
                    Object.values(g.history).forEach(week => {
                        if (Array.isArray(week)) {
                            week.forEach((day, i) => {
                                if (day && typeof day !== 'object') {
                                    week[i] = { entries: [day === 1 ? 'âœ…' : 'âŒ'], note: '' };
                                } else if (day && !day.entries) {
                                    week[i] = { entries: [], note: ''};
                                }
                            });
                        }
                    });
            }
        });
        appState.goals = goals;
        appState.order = orderArr.filter(id => goals.some(g => g.id === id));
        appState.theme = theme;
    }

    function persistState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appState.goals));
        localStorage.setItem(STORAGE_ORDER, JSON.stringify(appState.order));
    }

    function setTheme(theme) {
        appState.theme = theme;
        localStorage.setItem(STORAGE_THEME, theme);
        applyTheme();
    }

    function applyTheme() {
        let themeToApply = appState.theme;
        if (themeToApply === 'auto') {
            themeToApply = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        document.documentElement.classList.toggle('dark', themeToApply === 'dark');
        document.getElementById('darkModeBtn').innerText = themeToApply === 'dark' ? 'ğŸŒ' : 'ğŸŒ™';
    }

    // --- RENDER FUNCTIONS ---
    function fullRender() {
        renderHeader();
        renderGoals();
        renderTotals();
        renderCategoryFilters();
        applyTheme();
        initSortable();
        setupCellListeners();
        if (appState.editing) {
            setTimeout(() => initEditInput(appState.editing), 30);
        }
    }

    function renderHeader() {
        document.getElementById('weekTitle').innerText = formatWeekRange(appState.currentWeek);
        const today = new Date();
        const formattedDate = today.toLocaleDateString('fa-IR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('currentDateDisplay').innerText = `Ø§Ù…Ø±ÙˆØ² ${formattedDate}`;
        const weekDates = getWeekDates(appState.currentWeek);
        document.getElementById('weekdayRow').innerHTML = weekDates.map((d, i) => {
            const dayNumber = toFa(new Date(d).toLocaleDateString('fa-IR-u-nu-latn', { day: 'numeric' }));
            const dayName = WEEKDAY_NAMES_SHORT[i];
            let classes = "flex flex-col items-center justify-center p-2 rounded-lg transition-colors text-slate-500 dark:text-slate-400";
            if (isToday(d)) {
                classes = "flex flex-col items-center justify-center p-2 rounded-lg transition-colors bg-indigo-600 text-white font-bold shadow-lg shadow-indigo-500/30";
            }
            return `<div class="${classes}" data-day="${i}"><span class="text-sm font-semibold">${dayName}</span><span class="text-xs mt-1">${dayNumber}</span></div>`;
        }).join('');
    }

    function renderCategoryFilters() {
        const filters = ['all', ...Object.keys(CATEGORIES)];
        let html = filters.map(cat => {
            const isActive = appState.activeCategory === cat;
            const activeClass = 'bg-indigo-600 text-white';
            const inactiveClass = 'bg-white dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600';
            return `<button data-category="${cat}" class="px-4 py-2 text-sm font-semibold rounded-full shadow-sm transition-colors ${isActive ? activeClass : inactiveClass}">${cat === 'all' ? 'Ù‡Ù…Ù‡' : cat}</button>`;
        }).join('');
        document.getElementById('categoryFilters').innerHTML = html;
    }

    function renderGoals() {
        const filteredGoals = appState.order
            .map(id => appState.goals.find(g => g.id === id))
            .filter(g => g && !g.archived && (appState.activeCategory === 'all' || g.category === appState.activeCategory));
        const archivedGoals = appState.goals.filter(g => g && g.archived);
        document.getElementById('goalList').innerHTML = filteredGoals.map(renderSingleGoalCard).join('');
        const archivedContainer = document.getElementById('archivedGoalList');
        if (appState.showArchived && archivedGoals.length > 0) {
            archivedContainer.classList.remove('hidden');
            archivedContainer.querySelector('.flex').innerHTML = archivedGoals.map(renderSingleGoalCard).join('');
        } else {
            archivedContainer.classList.add('hidden');
        }
    }

    function renderSingleGoalCard(goal) {
        const weekDates = getWeekDates(appState.currentWeek);
        const currentWeekId = weekIdForDate(appState.currentWeek);
        const { weekly } = calculateScores(goal);
        const categoryClasses = CATEGORIES[goal.category] || 'bg-slate-100 text-slate-800';

        const dayCellsHtml = weekDates.map((date, i) => {
            const isActive = !!goal.days[i];
            const dayData = goal.history?.[currentWeekId]?.[i] || { entries: [], note: '' };
            const baseClasses = "goal-day group aspect-square rounded-full flex items-center justify-center relative transition-colors cursor-pointer";
            const activeClasses = "active bg-slate-200 dark:bg-slate-700/50 hover:bg-slate-300 dark:hover:bg-slate-600";
            const disabledClasses = "bg-slate-100 dark:bg-slate-800/50 opacity-60 !cursor-not-allowed";
            const todayClasses = "border-2 border-sky-500 shadow-md shadow-sky-500/30";
            let classes = `${baseClasses} ${isActive ? activeClasses : disabledClasses}`;
            if (isActive && isToday(date)) classes += ` ${todayClasses}`;
            let cellContent = `<div class="flex flex-wrap items-center justify-center gap-px leading-none p-1">${dayData.entries.map(em => em ? `<span class="text-sm md:text-base">${escapeHtml(em)}</span>` : '').join('')}</div>`;
            return `<div class="${classes}" data-goal-id="${goal.id}" data-day-index="${i}" tabindex="0">${cellContent}${dayData.note ? `<div class="absolute top-0 right-0 w-2 h-2 bg-amber-400 rounded-full" title="${escapeHtml(dayData.note)}"></div>` : ''}</div>`;
        }).join('');

        return `
        <div class="goal-card bg-white dark:bg-slate-800 shadow-md rounded-2xl p-4 goal-anim-in ${goal.archived ? 'opacity-60' : ''}" data-id="${goal.id}">
            <div class="flex items-center gap-2 mb-4">
                <div class="text-3xl">${goal.emoji || 'ğŸ¯'}</div>
                <div class="flex-grow min-w-0">
                    <div class="flex items-center gap-2">
                        ${appState.editing === goal.id
                            ? `<input class="w-full bg-slate-100 dark:bg-slate-700 text-lg font-bold p-2 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" id="edit-${goal.id}" value="${escapeHtml(goal.name)}" />`
                            : `<h3 class="text-lg font-bold truncate cursor-pointer hover:text-indigo-600" onclick="showStatsModal('${goal.id}')">${escapeHtml(goal.name || 'Ø¨ÛŒâ€ŒÙ†Ø§Ù…')}</h3>`
                        }
                    </div>
                    <div class="flex items-center gap-2 flex-wrap text-sm text-slate-500 dark:text-slate-400 mt-1">
                        <span class="text-xs font-semibold px-3 py-1 rounded-full ${categoryClasses}">${goal.category}</span>
                        <span>|</span>
                        <span class="weekly-score">Ù‡ÙØªÙ‡: ${toFa(weekly)}</span>
                    </div>
                </div>
                <button onclick="showContextMenu(event, '${goal.id}')" class="text-slate-400 dark:text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full p-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg>
                </button>
                ${!goal.archived ? `<div class="goal-handle text-slate-400 dark:text-slate-500 cursor-grab p-2 text-xl">&#x2630;</div>`: ''}
            </div>
            <div class="grid grid-cols-7 gap-2">${dayCellsHtml}</div>
        </div>`;
    }

    function renderTotals() {
        const activeGoals = appState.goals.filter(g => !g.archived);
        let weeklyScore = 0, allTimeScore = 0;
        activeGoals.forEach(g => {
            const scores = calculateScores(g);
            weeklyScore += scores.weekly;
            allTimeScore += scores.allTime;
        });
        document.getElementById('totalsBar').innerHTML = `
            <div class="flex-1"><div class="font-bold text-lg text-indigo-600 dark:text-indigo-400">${toFa(weeklyScore)}</div><div class="text-xs text-slate-500">Ø§Ù…ØªÛŒØ§Ø² Ù‡ÙØªÙ‡</div></div>
            <div class="flex-1"><div class="font-bold text-lg text-indigo-600 dark:text-indigo-400">${toFa(allTimeScore)}</div><div class="text-xs text-slate-500">Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„</div></div>`;
    }

    // --- CALCULATIONS ---
    function isGoalAchievedOnDate(goal, date) {
        if (!date || !goal) return false;
        const localDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const dayOfWeek = (localDate.getDay() + 1) % 7;
        const weekId = weekIdForDate(localDate);
        const dayData = goal.history?.[weekId]?.[dayOfWeek];
        return !!(dayData?.entries?.length > 0);
    }
    function getEntryCountOnDate(goal, date) {
        if (!date || !goal) return 0;
        const localDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const dayOfWeek = (localDate.getDay() + 1) % 7;
        const weekId = weekIdForDate(localDate);
        const dayData = goal.history?.[weekId]?.[dayOfWeek];
        return dayData?.entries?.length || 0;
    }

    function calculateScores(goal) {
        let weekly = 0, allTime = 0;
        const currentWeekId = weekIdForDate(appState.currentWeek);
        if (goal.history) {
            for (const weekId in goal.history) {
                const weekData = goal.history[weekId];
                if (!weekData) continue;
                let scoreForWeek = 0;
                const weekStartDate = new Date(weekId.replace(/-/g, '/'));
                weekData.forEach((dayData, dayIndex) => {
                    if (!dayData) return;
                    if (goal.days[dayIndex]) {
                        scoreForWeek += (dayData.entries.length || 0);
                    }
                });
                if (weekId === currentWeekId) weekly = scoreForWeek;
                allTime += scoreForWeek;
            }
        }
        return { weekly, allTime };
    }

    // --- MODALS & MENUS ---
    function closeModal() {
        const modalArea = document.getElementById('modalArea');
        if (modalArea.firstChild) {
             modalArea.innerHTML = '';
        }
    }

    function closeContextMenu() {
        const menu = document.getElementById('contextMenu');
        menu.style.display = 'none';
        appState.contextMenuGoalId = null;
    }

    function showAboutModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/30 z-[100] flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="modal-content glass-modal-content rounded-2xl p-6 w-full max-w-sm text-center shadow-2xl">
                <div class="flex justify-center mb-4">
                    <div class="w-20 h-20 bg-indigo-500 rounded-2xl flex items-center justify-center text-white text-4xl font-bold">
                        <span>ğŸ¯</span>
                    </div>
                </div>
                <h2 class="text-xl font-bold mb-2">Ù…Ø¯ÛŒØ±ÛŒØª Ø¹Ø§Ø¯Øª</h2>
                <p class="text-sm text-slate-600 dark:text-slate-300 mb-4">Ù†Ø³Ø®Ù‡ Û±.Û°.Û°</p>
                <p class="text-sm text-slate-500 dark:text-slate-400 mb-1">Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ ØªÙˆØ³Ø·: [Ù†Ø§Ù… Ø´Ù…Ø§ ÛŒØ§ Ø´Ø±Ú©Øª]</p>
                <p class="text-xs text-slate-400 dark:text-slate-500 mb-6">Ú©Ù¾ÛŒ Ø±Ø§ÛŒØª Â© ${new Date().getFullYear()} - ØªÙ…Ø§Ù…ÛŒ Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª.</p>
                <button class="close-modal-btn w-full p-3 rounded-lg font-bold bg-indigo-600 text-white hover:bg-indigo-700 transition">Ø¨Ø³ØªÙ†</button>
            </div>
        `;
        document.getElementById('modalArea').appendChild(modal);
        modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };
    }

    function showBackupModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/30 z-[100] flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="modal-content glass-modal-content rounded-2xl p-6 w-full max-w-sm shadow-2xl">
                <h2 class="text-xl font-bold mb-5 text-center">Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ</h2>
                <p class="text-center text-sm text-slate-600 dark:text-slate-300 mb-6">Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®ÙˆØ¯ Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ‡ Ùˆ ÛŒØ§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‚Ø¨Ù„ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ú©Ù†ÛŒØ¯.</p>
                <div class="space-y-4">
                    <button id="exportBtn" class="w-full p-4 rounded-lg font-bold bg-green-600 text-white hover:bg-green-700 transition flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        <span>Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ† (JSON)</span>
                    </button>
                    <button id="importBtn" class="w-full p-4 rounded-lg font-bold bg-sky-600 text-white hover:bg-sky-700 transition flex items-center justify-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        <span>ÙˆØ±ÙˆØ¯ÛŒ Ú¯Ø±ÙØªÙ† (JSON)</span>
                    </button>
                </div>
                 <input type="file" id="importFile" class="hidden" accept=".json">
                 <button class="close-modal-btn w-full mt-8 p-3 rounded-lg font-semibold bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition">Ù„ØºÙˆ</button>
            </div>
        `;
        document.getElementById('modalArea').appendChild(modal);
        modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };
        modal.querySelector('#exportBtn').onclick = exportData;
        modal.querySelector('#importBtn').onclick = () => document.getElementById('importFile').click();
        modal.querySelector('#importFile').onchange = importData;
    }

    function exportData() {
        try {
            const dataToExport = {
                goals: appState.goals,
                order: appState.order
            };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            const today = new Date().toISOString().slice(0, 10);
            link.download = `habits-backup-${today}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
            closeModal();
        } catch (error) {
            console.error("Error exporting data:", error);
            alert("Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª.");
        }
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø¨Ø§ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¬Ø¯ÛŒØ¯ØŒ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ¹Ù„ÛŒ Ø´Ù…Ø§ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯. Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.")) {
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData && Array.isArray(importedData.goals) && Array.isArray(importedData.order)) {
                    appState.goals = importedData.goals;
                    appState.order = importedData.order;
                    persistState();
                    loadStateFromStorage(); // Reload and clean data
                    fullRender();
                    closeModal();
                    alert("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆØ§Ø±Ø¯ Ø´Ø¯.");
                } else {
                    throw new Error("Invalid file format.");
                }
            } catch (error) {
                console.error("Error importing data:", error);
                alert("Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª. ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.");
            }
        };
        reader.readAsText(file);
    }

    function renderMonthlyHeatmap(container, goal, jYear, jMonth) {
        const monthLength = jalaliMonthLength(jYear, jMonth);
        const firstGregorianDate = toGregorian(jYear, jMonth, 1);
        const startOffset = (firstGregorianDate.getDay() + 1) % 7;
        const displayDate = firstGregorianDate;

        let html = `
            <div class="flex items-center justify-between mb-3 px-1">
                <button data-action="prev" class="heatmap-nav-btn p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
                <span class="font-bold text-sm">${displayDate.toLocaleDateString('fa-IR', { month: 'long', year: 'numeric'})}</span>
                <button data-action="next" class="heatmap-nav-btn p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
            </div>
            <div class="grid grid-cols-7 gap-1 text-center text-xs text-slate-400 mb-2">
                ${WEEKDAY_NAMES_SHORT.map(d => `<div>${d}</div>`).join('')}
            </div>
            <div class="grid grid-cols-7 gap-1.5">`;

        for (let i = 0; i < startOffset; i++) {
            html += '<div></div>';
        }

        for (let jd = 1; jd <= monthLength; jd++) {
            const gDate = toGregorian(jYear, jMonth, jd);
            let colorClass = 'bg-slate-200/80 dark:bg-slate-700/80';
            const entryCount = getEntryCountOnDate(goal, gDate);

            if (entryCount > 0) {
                colorClass = 'bg-green-500 text-white font-bold';
            } else if (!goal.days[(gDate.getDay() + 1) % 7]) {
                colorClass = 'bg-slate-100 dark:bg-slate-800/60 opacity-70';
            }
            if(isToday(gDate)) colorClass += ' ring-2 ring-sky-500';

            html += `<div class="heatmap-day ${colorClass}" title="${gDate.toLocaleDateString('fa-IR')}">
                         <span class="text-xl font-semibold">${toFa(jd)}</span>
                         ${entryCount > 0 ? `<span class="heatmap-count">${toFa(entryCount)}</span>` : ''}
                       </div>`;
        }

        html += `</div>`;
        container.innerHTML = html;

        container.querySelectorAll('.heatmap-nav-btn').forEach(btn => {
            btn.onclick = () => {
                let newMonth = jMonth;
                let newYear = jYear;
                if (btn.dataset.action === 'next') {
                    newMonth++;
                    if (newMonth > 12) { newMonth = 1; newYear++; }
                } else {
                    newMonth--;
                    if (newMonth < 1) { newMonth = 12; newYear--; }
                }
                renderMonthlyHeatmap(container, goal, newYear, newMonth);
            }
        });
    }

    function showStatsModal(goalId) {
        const goal = appState.goals.find(g => g.id === goalId);
        if (!goal) return;

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="modal-content bg-slate-100 dark:bg-slate-800 rounded-2xl p-4 md:p-6 w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl no-scrollbar">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl md:text-2xl font-bold text-indigo-600 dark:text-indigo-400 flex items-center gap-3">
                        <span class="text-2xl">${goal.emoji}</span>
                        <span>${escapeHtml(goal.name)}</span>
                    </h2>
                    <button class="close-modal-btn text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full p-2 transition-colors">&times;</button>
                </div>
                <div>
                    <h3 class="font-bold mb-3 text-slate-700 dark:text-slate-300 text-center">ØªÙ‚ÙˆÛŒÙ… ÙØ¹Ø§Ù„ÛŒØª</h3>
                    <div id="heatmap-container" class="p-3 bg-white dark:bg-slate-700/50 rounded-xl shadow-inner"></div>
                </div>
            </div>`;
        document.getElementById('modalArea').appendChild(modal);

        const heatmapContainer = modal.querySelector('#heatmap-container');
        const today = new Date();
        const [jYear, jMonth] = toJalali(today.getFullYear(), today.getMonth() + 1, today.getDate());
        renderMonthlyHeatmap(heatmapContainer, goal, jYear, jMonth);
        modal.onclick = e => { if (e.target === modal || e.target.closest('.close-modal-btn')) closeModal(); };
    }

    // --- ACTIONS & LISTENERS ---
    window.editGoal = (goalId) => { const goal = appState.goals.find(g => g.id === goalId); if(goal) showGoalModal(goal); };
    window.startEdit = (goalId) => { appState.editing = goalId; fullRender(); };

    document.getElementById('navbar').onclick = e => {
        if (e.target.closest('#archiveToggleBtn')) {
            appState.showArchived = !appState.showArchived;
            document.getElementById('archiveToggleBtn').classList.toggle('text-indigo-500', appState.showArchived);
            fullRender();
        } else if (e.target.closest('#prevWeekBtn')) {
            appState.currentWeek.setDate(appState.currentWeek.getDate() - 7); fullRender();
        } else if (e.target.closest('#nextWeekBtn')) {
            appState.currentWeek.setDate(appState.currentWeek.getDate() + 7); fullRender();
        } else if (e.target.closest('#darkModeBtn')) {
            setTheme({ 'dark': 'light', 'light': 'auto', 'auto': 'dark' }[appState.theme]);
        } else if (e.target.closest('#aboutBtn')) {
            showAboutModal();
        } else if (e.target.closest('#backupBtn')) {
            showBackupModal();
        }
    };

    document.getElementById('fab').onclick = () => showGoalModal(null);
    document.getElementById('categoryFilters').onclick = (e) => {
        if(e.target.closest('button')) {
            appState.activeCategory = e.target.closest('button').dataset.category;
            renderGoals();
            renderCategoryFilters();
        }
    };
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);
    let sortable = null;
    loadStateFromStorage();
    fullRender();

    // --- Core Functions ---
    function initEditInput(goalId) {
        const el = document.getElementById('edit-' + goalId);
        if (!el) return;
        el.focus();
        el.select();
        const saveAndExit = () => {
            if (appState.editing !== goalId) return;
            const goal = appState.goals.find(g => g.id === goalId);
            if (goal) goal.name = el.value.trim() || 'Ø¨ÛŒâ€ŒÙ†Ø§Ù…';
            persistState();
            appState.editing = null;
            fullRender();
        };
        el.onblur = saveAndExit;
        el.onkeydown = (e) => { if (e.key === "Enter") el.blur(); if (e.key === "Escape") { appState.editing = null; fullRender(); } };
    }

    window.duplicateGoal = (goalId) => {
        const originalGoal = appState.goals.find(g => g.id === goalId);
        if (originalGoal) {
            const newGoal = JSON.parse(JSON.stringify(originalGoal));
            newGoal.id = '' + Date.now();
            newGoal.name = `${originalGoal.name} (Ú©Ù¾ÛŒ)`;
            newGoal.history = {};
            newGoal.archived = false;
            appState.goals.push(newGoal);
            const originalIndex = appState.order.indexOf(goalId);
            appState.order.splice(originalIndex + 1, 0, newGoal.id);
            persistState();
            fullRender();
        }
    };

    window.toggleArchiveGoal = (goalId) => {
        const goal = appState.goals.find(g => g.id === goalId);
        if (goal) { goal.archived = !goal.archived; persistState(); fullRender(); }
    };

    window.deleteGoal = (goalId) => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="modal-content bg-slate-50 dark:bg-slate-800 rounded-2xl p-5 w-full max-w-sm shadow-2xl text-center">
                <h3 class="font-bold text-lg mb-2">ØªØ§ÛŒÛŒØ¯ Ø­Ø°Ù</h3>
                <p class="text-sm text-slate-600 dark:text-slate-300 mb-6">Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù‡Ø¯Ù Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.</p>
                <div class="grid grid-cols-2 gap-4">
                    <button id="cancel-delete" class="p-3 rounded-lg font-bold bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition">Ù„ØºÙˆ</button>
                    <button id="confirm-delete" class="p-3 rounded-lg font-bold bg-red-500 text-white hover:bg-red-600 transition">Ø­Ø°Ù</button>
                </div>
            </div>`;
        document.getElementById('modalArea').appendChild(modal);
        modal.querySelector('#cancel-delete').onclick = closeModal;
        modal.querySelector('#confirm-delete').onclick = () => {
            closeModal();
            const card = document.querySelector(`.goal-card[data-id="${goalId}"]`);
            if (card) {
                card.classList.add('goal-anim-out');
                setTimeout(() => {
                    appState.goals = appState.goals.filter(g => g.id !== goalId);
                    appState.order = appState.order.filter(id => id !== goalId);
                    persistState();
                    fullRender();
                }, 300);
            } else {
                appState.goals = appState.goals.filter(g => g.id !== goalId);
                appState.order = appState.order.filter(id => id !== goalId);
                persistState();
                fullRender();
            }
        };
    };

    function addCheckmark(goalId, dayIndex, cellElement) {
        const goal = appState.goals.find(g => g.id === goalId);
        if (!goal || !goal.days[dayIndex]) return;
        const weekId = weekIdForDate(appState.currentWeek);
        if (!goal.history) goal.history = {};
        if (!goal.history[weekId]) goal.history[weekId] = Array(7).fill(null).map(() => ({ entries: [], note: '' }));
        if (!goal.history[weekId][dayIndex]) goal.history[weekId][dayIndex] = { entries: [], note: '' };
        goal.history[weekId][dayIndex].entries.push('âœ…');
        persistState();
        cellElement.classList.add('cell-swipe-up');
        cellElement.addEventListener('animationend', () => cellElement.classList.remove('cell-swipe-up'), { once: true });
        const dayData = goal.history[weekId][dayIndex];
        cellElement.querySelector('div').innerHTML = dayData.entries.map(em => em ? `<span class="text-sm md:text-base">${escapeHtml(em)}</span>` : '').join('');
        const card = cellElement.closest('.goal-card');
        if (card) {
            const weeklyScoreElement = card.querySelector('.weekly-score');
            if (weeklyScoreElement) {
                const newScores = calculateScores(goal);
                weeklyScoreElement.innerText = `Ù‡ÙØªÙ‡: ${toFa(newScores.weekly)}`;
            }
        }
        renderTotals();
    }

    function removeLastEmoji(goalId, dayIndex, cellElement) {
        const goal = appState.goals.find(g => g.id === goalId);
        if (!goal || !goal.days[dayIndex]) return;
        const weekId = weekIdForDate(appState.currentWeek);
        if (!goal.history?.[weekId]?.[dayIndex]?.entries.length > 0) return;
        goal.history[weekId][dayIndex].entries.pop();
        persistState();
        cellElement.classList.add('cell-swipe-down');
        cellElement.addEventListener('animationend', () => cellElement.classList.remove('cell-swipe-down'), { once: true });
        const dayData = goal.history[weekId][dayIndex];
        cellElement.querySelector('div').innerHTML = dayData.entries.map(em => em ? `<span class="text-sm md:text-base">${escapeHtml(em)}</span>` : '').join('');
        const card = cellElement.closest('.goal-card');
        if (card) {
            const weeklyScoreElement = card.querySelector('.weekly-score');
            if (weeklyScoreElement) {
                const newScores = calculateScores(goal);
                weeklyScoreElement.innerText = `Ù‡ÙØªÙ‡: ${toFa(newScores.weekly)}`;
            }
        }
        renderTotals();
    }

    function setupCellListeners() {
        document.querySelectorAll('.goal-day').forEach(cell => {
            let pressTimer = null;
            let longPressTriggered = false;
            let startY = 0, startX = 0;
            let isDragging = false;
            let swipeTriggered = false;
            let hasMoved = false;

            const handlePressStart = (e) => {
                if (cell.classList.contains('!cursor-not-allowed')) return;

                startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                isDragging = true;
                swipeTriggered = false;
                longPressTriggered = false;
                hasMoved = false;

                pressTimer = setTimeout(() => {
                    longPressTriggered = true;
                    isDragging = false;
                    const { goalId, dayIndex } = cell.dataset;
                    showDayDetailModal(goalId, parseInt(dayIndex));
                    cleanupListeners();
                }, 500);

                document.addEventListener('mousemove', handlePressMove);
                document.addEventListener('touchmove', handlePressMove, { passive: false }); // Explicitly not passive
                document.addEventListener('mouseup', handlePressEnd, { once: true });
                document.addEventListener('touchend', handlePressEnd, { once: true });
            };

            const handlePressMove = (e) => {
                if (!isDragging || longPressTriggered || swipeTriggered) return;

                const currentY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                const currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                const deltaY = currentY - startY;
                const deltaX = currentX - startX;
                const SWIPE_THRESHOLD = 30;
                if (Math.abs(deltaY) > 10 || Math.abs(deltaX) > 10) {
                    hasMoved = true;
                    clearTimeout(pressTimer);
                    // Only prevent default if vertical scroll is likely, to allow horizontal scroll
                    if (Math.abs(deltaY) > Math.abs(deltaX)) {
                         e.preventDefault();
                    }
                }

                if (Math.abs(deltaY) > SWIPE_THRESHOLD && Math.abs(deltaY) > Math.abs(deltaX)) {
                    swipeTriggered = true;
                    const { goalId, dayIndex } = cell.dataset;
                    if (deltaY < 0) { // Swipe Up
                        addCheckmark(goalId, parseInt(dayIndex), cell);
                    } else { // Swipe Down
                        removeLastEmoji(goalId, parseInt(dayIndex), cell);
                    }
                    cleanupListeners();
                }
            };

            const handlePressEnd = () => {
                clearTimeout(pressTimer);
                if (isDragging && !longPressTriggered && !swipeTriggered && !hasMoved) {
                    const { goalId, dayIndex } = cell.dataset;
                    showLogModal(goalId, parseInt(dayIndex));
                }
                cleanupListeners();
            };

            const cleanupListeners = () => {
                isDragging = false;
                clearTimeout(pressTimer);
                document.removeEventListener('mousemove', handlePressMove);
                document.removeEventListener('touchmove', handlePressMove);
                document.removeEventListener('mouseup', handlePressEnd);
                document.removeEventListener('touchend', handlePressEnd);
            }
            // Clean up old listeners before adding new ones to prevent duplicates
            cell.removeEventListener('mousedown', handlePressStart);
            cell.removeEventListener('touchstart', handlePressStart);

            // Add new listeners
            cell.addEventListener('mousedown', handlePressStart);
            cell.addEventListener('touchstart', handlePressStart, { passive: false }); // Crucial for calling preventDefault
        });
    }

    function initSortable() {
        if (sortable) sortable.destroy();
        const list = document.getElementById('goalList');
        if(!list) return;
        sortable = Sortable.create(list, {
            handle: '.goal-handle',
            animation: 200,
            ghostClass: 'sortable-ghost',
            onEnd: (evt) => {
                appState.order = Array.from(evt.to.children).map(card => card.dataset.id);
                persistState();
                // Re-attach all event listeners after sorting to fix interaction issues.
                setupCellListeners();
            }
        });
    }

    showGoalModal = (goal) => {
        const isEdit = !!goal;
        const draft = isEdit ? JSON.parse(JSON.stringify(goal)) : { id: '' + Date.now(), name: '', emoji: 'ğŸ¯', days: Array(7).fill(true), history: {}, type: 'binary', archived: false, category: 'Ø´Ø®ØµÛŒ', creationDate: new Date().toISOString() };
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm z-[100] flex items-end justify-center';
        modal.innerHTML = `
            <div class="modal-content bg-slate-50 dark:bg-slate-900 rounded-t-2xl p-4 w-full max-w-lg pb-[calc(env(safe-area-inset-bottom)+1rem)] shadow-2xl">
                <h2 class="text-xl font-bold text-center mb-6 text-indigo-600 dark:text-indigo-400">${isEdit ? 'ÙˆÛŒØ±Ø§ÛŒØ´ Ù‡Ø¯Ù' : 'Ù‡Ø¯Ù Ø¬Ø¯ÛŒØ¯'}</h2>
                <div class="space-y-4">
                    <div class="flex gap-4">
                        <div class="flex-grow"><label for="goalName" class="font-semibold mb-2 block text-sm">Ù†Ø§Ù… Ù‡Ø¯Ù</label><input type="text" id="goalName" value="${escapeHtml(draft.name)}" placeholder="Ù…Ø«Ù„Ø§: ÙˆØ±Ø²Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡" class="w-full p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none transition"></div>
                        <div><label for="goalEmoji" class="font-semibold mb-2 block text-sm">Ø§ÛŒÙ…ÙˆØ¬ÛŒ</label><input type="text" id="goalEmoji" value="${draft.emoji}" maxlength="2" class="w-20 text-center p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none transition"></div>
                    </div>
                    <div><label class="font-semibold mb-2 block text-sm">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label><select id="goalCategory" class="w-full p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none transition">${Object.keys(CATEGORIES).map(cat => `<option value="${cat}" ${draft.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}</select></div>
                    <div><label class="font-semibold mb-2 block text-sm">Ø±ÙˆØ²Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„</label><div class="grid grid-cols-7 gap-2 rounded-lg bg-slate-200 dark:bg-slate-800 p-1 weekday-toggle-row">${WEEKDAY_NAMES_SHORT.map((d, i) => `<div class="weekday-toggle text-center font-bold p-2 rounded-md cursor-pointer transition-colors ${draft.days[i] ? 'bg-indigo-500 text-white' : 'hover:bg-slate-300'}" data-day="${i}">${d}</div>`).join('')}</div></div>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-8">
                    <button class="action-btn-cancel w-full p-4 rounded-lg font-bold bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition">Ù„ØºÙˆ</button>
                    <button id="saveGoalBtn" class="w-full p-4 rounded-lg font-bold bg-indigo-600 text-white hover:bg-indigo-700 transition">${isEdit ? 'Ø°Ø®ÛŒØ±Ù‡' : 'Ø§ÙØ²ÙˆØ¯Ù†'}</button>
                </div>
            </div>`;
        document.getElementById('modalArea').appendChild(modal);
        document.getElementById('goalName').focus();
        modal.onclick = e => { if (e.target === modal) closeModal(); };
        modal.querySelector('.action-btn-cancel').onclick = closeModal;
        modal.querySelectorAll('.weekday-toggle').forEach(toggle => {
            toggle.onclick = () => { const day = parseInt(toggle.dataset.day); draft.days[day] = !draft.days[day]; toggle.classList.toggle('bg-indigo-500'); toggle.classList.toggle('text-white'); };
        });
        modal.querySelector('#saveGoalBtn').onclick = () => {
            draft.name = modal.querySelector('#goalName').value.trim();
            draft.emoji = modal.querySelector('#goalEmoji').value;
            draft.category = modal.querySelector('#goalCategory').value;
            draft.type = 'binary';
            if (isEdit) { const index = appState.goals.findIndex(g => g.id === goal.id); if (index > -1) appState.goals[index] = draft; } else { appState.goals.push(draft); appState.order.push(draft.id); }
            persistState(); closeModal(); fullRender();
        };
    };

    showLogModal = (goalId, dayIndex) => {
        const goal = appState.goals.find(g => g.id === goalId);
        if (!goal || !goal.days[dayIndex]) return;
        const weekId = weekIdForDate(appState.currentWeek);
        if (!goal.history) goal.history = {};
        if (!goal.history[weekId]) goal.history[weekId] = Array(7).fill(null).map(() => ({ entries: [], note: '' }));
        if (!goal.history[weekId][dayIndex]) goal.history[weekId][dayIndex] = { entries: [], note: '' };

        const dayData = goal.history[weekId][dayIndex];
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/30 backdrop-blur-sm z-[100] flex items-end justify-center';

        const renderEntries = (container) => {
            const listHtml = dayData.entries.map((entry, i) => `<div class="flex items-center gap-1 bg-slate-200 dark:bg-slate-700 rounded-full px-3 py-1 text-sm"><span>${entry}</span><button data-index="${i}" class="delete-entry-btn text-red-500 hover:text-red-700">&times;</button></div>`).join('');
            container.innerHTML = listHtml || '<span class="text-slate-400">Ù…ÙˆØ±Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</span>';
        };

        modal.innerHTML = `
            <div class="modal-content bg-slate-50 dark:bg-slate-900 rounded-t-2xl p-4 w-full max-w-lg pb-[calc(env(safe-area-inset-bottom)+1rem)] shadow-2xl">
                <h2 class="text-xl font-bold text-center mb-4 truncate">${goal.name}</h2>
                <div class="space-y-4">
                    <div><label class="font-semibold mb-2 block text-sm">Ù…ÙˆØ§Ø±Ø¯ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ù…Ø±ÙˆØ²</label><div id="entries-list" class="flex flex-wrap gap-2 min-h-[40px] bg-white dark:bg-slate-800 p-2 rounded-lg"></div></div>
                    <div><label class="font-semibold mb-2 block text-sm">Ø«Ø¨Øª Ø§ÛŒÙ…ÙˆØ¬ÛŒ</label><div class="emoji-grid grid grid-cols-7 gap-2 text-3xl">${EMOJIS.map(em => `<button class="emoji-btn text-center rounded-lg p-2 hover:bg-slate-200 dark:hover:bg-slate-700 transition-transform hover:scale-125">${em}</button>`).join('')}</div></div>
                    <div><label for="note-input" class="font-semibold mb-2 block text-sm">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label><textarea id="note-input" class="w-full p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none transition" rows="2" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø§Ù…Ø±ÙˆØ²...">${escapeHtml(dayData.note)}</textarea></div>
                </div>
                <div class="mt-8"><button class="action-btn-done w-full p-4 rounded-lg font-bold bg-indigo-600 text-white hover:bg-indigo-700 transition">Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯</button></div>
            </div>`;
        document.getElementById('modalArea').appendChild(modal);

        const entriesList = modal.querySelector('#entries-list');
        renderEntries(entriesList);

        const saveNote = () => {
             goal.history[weekId][dayIndex].note = modal.querySelector('#note-input').value;
             persistState();
             fullRender();
        };

        modal.onclick = e => { if (e.target === modal) { saveNote(); closeModal(); } };
        modal.querySelector('.action-btn-done').onclick = () => { saveNote(); closeModal(); };
        entriesList.addEventListener('click', e => {
            if (e.target.classList.contains('delete-entry-btn')) {
                 const index = parseInt(e.target.dataset.index);
                 dayData.entries.splice(index, 1);
                persistState();
                renderEntries(entriesList);
            }
        });

        modal.querySelectorAll('.emoji-btn').forEach(btn => {
            btn.onclick = () => {
                dayData.entries.push(btn.innerText);
                persistState();
                renderEntries(entriesList);
            };
        });
    }

    function showDayDetailModal(goalId, dayIndex) {
        const goal = appState.goals.find(g => g.id === goalId);
        if (!goal) return;

        const weekDates = getWeekDates(appState.currentWeek);
        const date = weekDates[dayIndex];
        const weekId = weekIdForDate(appState.currentWeek);
        const dayData = goal.history?.[weekId]?.[dayIndex] || { entries: [], note: '' };

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4';

        const formattedDate = date.toLocaleDateString('fa-IR', { weekday: 'long', month: 'long', day: 'numeric' });
        const entriesHtml = dayData.entries.length > 0
            ? dayData.entries.map(entry => `<span class="text-2xl">${escapeHtml(entry)}</span>`).join('')
            : '<span class="text-sm text-slate-400">Ù…ÙˆØ±Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</span>';
        const noteHtml = dayData.note
            ? `<p class="text-sm bg-amber-100 dark:bg-amber-900/50 p-3 rounded-lg">${escapeHtml(dayData.note)}</p>`
            : '<span class="text-sm text-slate-400">ÛŒØ§Ø¯Ø¯Ø§Ø´ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</span>';

        modal.innerHTML = `
            <div class="modal-content bg-slate-50 dark:bg-slate-800 rounded-2xl p-5 w-full max-w-sm shadow-2xl">
                <h3 class="font-bold text-lg text-indigo-600 dark:text-indigo-400 mb-2">${escapeHtml(goal.name)}</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 font-semibold mb-4">${formattedDate}</p>
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold text-sm mb-2">Ù…ÙˆØ§Ø±Ø¯ Ø«Ø¨Øª Ø´Ø¯Ù‡</h4>
                        <div class="flex flex-wrap gap-3 items-center min-h-[40px] bg-white dark:bg-slate-700/50 p-3 rounded-lg">${entriesHtml}</div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-sm mb-2">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</h4>
                        <div class="min-h-[40px]">${noteHtml}</div>
                    </div>
                </div>
                 <button class="close-modal-btn w-full mt-6 p-3 rounded-lg font-bold bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition">Ø¨Ø³ØªÙ†</button>
            </div>`;
        document.getElementById('modalArea').appendChild(modal);
        modal.onclick = e => { if (e.target === modal || e.target.classList.contains('close-modal-btn')) closeModal(); };
    }

    showContextMenu = (e, goalId) => {
        e.preventDefault(); e.stopPropagation();

        if (appState.contextMenuGoalId === goalId) {
            closeContextMenu();
            return;
        }

        closeContextMenu();
        const goal = appState.goals.find(g => g.id === goalId); if (!goal) return;
        const menu = document.getElementById('contextMenu');
        menu.innerHTML = `<button onclick="editGoal('${goalId}')" class="w-full text-right flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">âœï¸ <span>ÙˆÛŒØ±Ø§ÛŒØ´</span></button><button onclick="duplicateGoal('${goalId}')" class="w-full text-right flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">ğŸ—‚ï¸ <span>Ú©Ù¾ÛŒ</span></button><button onclick="toggleArchiveGoal('${goalId}')" class="w-full text-right flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">${goal.archived ? 'ğŸ“‚ <span>Ù„ØºÙˆ Ø¢Ø±Ø´ÛŒÙˆ</span>' : 'ğŸ—„ï¸ <span>Ø¢Ø±Ø´ÛŒÙˆ</span>'}</button><div class="my-1 h-px bg-slate-200 dark:bg-slate-700"></div><button onclick="deleteGoal('${goalId}')" class="w-full text-right flex items-center gap-3 p-3 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/40 rounded-lg">ğŸ—‘ï¸ <span>Ø­Ø°Ù</span></button>`;
        menu.style.display = 'block';
        const rect = menu.getBoundingClientRect();
        let left = e.clientX;
        let top = e.clientY;

        if (left + rect.width > window.innerWidth - 10) { left = window.innerWidth - rect.width - 10; }
        if (top + rect.height > window.innerHeight - 10) { top = window.innerHeight - rect.height - 10; }

        menu.style.left = `${left}px`;
        menu.style.top = `${top}px`;
        appState.contextMenuGoalId = goalId;
        setTimeout(() => document.addEventListener('click', closeContextMenu, { once: true }), 10);
    };
</script>
</body>
</html>