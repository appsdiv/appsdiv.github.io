<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano Banana Pro v7.0</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/misc/Farsi-digits/Vazirmatn-FD-font-face.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #050a14;
            --bg-card: #0f172a;
            --primary: #00f3ff;
            --secondary: #d946ef;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --glass: rgba(15, 23, 42, 0.7);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Typography for Farsi */
        .farsi-text {
            font-family: 'Vazirmatn FD', sans-serif;
            direction: rtl;
        }

        /* Header */
        header {
            padding: 20px;
            text-align: center;
            background: linear-gradient(180deg, rgba(0,243,255,0.05) 0%, transparent 100%);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .logo {
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--primary);
            text-transform: uppercase;
        }

        .version { font-size: 0.7rem; color: var(--secondary); opacity: 0.8; }

        /* Main Container */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Step 1: Upload */
        .upload-card {
            width: 100%;
            height: 400px;
            border: 2px dashed rgba(0, 243, 255, 0.3);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1rem;
            color: var(--text-muted);
            text-align: center;
        }

        input[type="file"] { display: none; }

        /* Step 2: Progress */
        .progress-container {
            width: 100%;
            text-align: center;
            display: none; /* Hidden by default */
        }

        .progress-bar-wrap {
            width: 100%;
            height: 6px;
            background: #1e293b;
            border-radius: 10px;
            margin-top: 20px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.4s ease;
            box-shadow: 0 0 10px var(--primary);
        }

        .status-text {
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--primary);
            animation: pulse 1.5s infinite;
        }

        /* Step 3: Result */
        .result-container {
            width: 100%;
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 15px;
        }

        /* The canvas wrapper simulates the edited image */
        #render-target {
            position: relative;
            width: 100%;
            background-color: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        #user-image {
            width: 100%;
            display: block;
            opacity: 0.6; /* Darken slightly for overlays */
            mix-blend-mode: luminosity; /* Stylistic choice for "Scan" look */
        }
        
        .overlay-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background: linear-gradient(180deg, rgba(5,10,20,0.2) 0%, rgba(5,10,20,0.9) 100%);
            z-index: 10;
        }

        /* AI Output Styling */
        .ai-overlay-content {
            font-size: 0.8rem;
            color: white;
            text-shadow: 0 1px 3px black;
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 100%;
        }

        .ai-box {
            background: rgba(0, 0, 0, 0.6);
            border-right: 3px solid var(--primary);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            backdrop-filter: blur(4px);
        }

        .ai-score {
            color: var(--primary);
            font-weight: bold;
            font-size: 1.1em;
        }

        .ai-tier {
            background: linear-gradient(90deg, var(--primary), transparent);
            color: #000;
            padding: 5px 10px;
            font-weight: 800;
            display: inline-block;
            margin-bottom: 5px;
            border-radius: 2px;
        }

        /* Buttons */
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .btn {
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active { transform: scale(0.98); }

        .btn-primary {
            background: var(--primary);
            color: #000;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.1);
        }

        footer {
            margin-top: auto;
            padding: 20px;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-muted);
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .footer-credit span { color: var(--primary); }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">Nano Banana <span style="color:white">Pro</span></div>
        <div class="version">v7.0 | AI BODY COMPOSITION ANALYZER</div>
    </header>

    <main>
        <div id="step-upload" class="upload-card" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
            </div>
            <div class="upload-text">
                <strong>Tap to Upload Photo</strong><br>
                <span style="font-size:0.8em; opacity:0.7">Supported: JPG, PNG, WEBP</span>
            </div>
            <input type="file" id="fileInput" accept="image/*" onchange="handleFileUpload(event)">
        </div>

        <div id="step-process" class="progress-container">
            <h3 style="color:white; margin-bottom:10px;">Nano AI Processing</h3>
            <div class="progress-bar-wrap">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="statusText" class="status-text">Initializing Neural Matrix...</div>
        </div>

        <div id="step-result" class="result-container">
            <div id="render-target">
                <img id="user-image" src="" alt="User Upload">
                
                <div class="overlay-layer">
                    <div style="text-align: right; margin-bottom: 10px;">
                        <span style="background:var(--secondary); color:white; padding:2px 6px; font-size:10px; border-radius:2px;">NANO v7.0 LIVE</span>
                    </div>
                    
                    <div id="ai-content" class="ai-overlay-content farsi-text">
                        </div>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="resetApp()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                    Start Again
                </button>
                <button class="btn btn-primary" onclick="downloadImage()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    Save Photo
                </button>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-credit">Created by <span>Peyman</span></div>
    </footer>

    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // *** CONFIGURATION ***
        const API_KEY = "AIzaSyD6GYtr65fA4KR6ixnMZZjudtl_0-BRu0g"; // Provided by user
        const genAI = new GoogleGenerativeAI(API_KEY);

        // Elements
        const stepUpload = document.getElementById('step-upload');
        const stepProcess = document.getElementById('step-process');
        const stepResult = document.getElementById('step-result');
        const progressBar = document.getElementById('progressBar');
        const statusText = document.getElementById('statusText');
        const userImgDisplay = document.getElementById('user-image');
        const aiContentDiv = document.getElementById('ai-content');

        let selectedFile = null;

        // Global function for file upload
        window.handleFileUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            selectedFile = file;

            // UI Transition
            stepUpload.style.display = 'none';
            stepProcess.style.display = 'block';

            // Preview Image
            const reader = new FileReader();
            reader.onload = (e) => {
                userImgDisplay.src = e.target.result;
            };
            reader.readAsDataURL(file);

            // Start Progress Animation
            simulateProgress();

            // Start Gemini Analysis
            try {
                await processImageWithGemini(file);
            } catch (error) {
                console.error(error);
                statusText.innerText = "Error: " + error.message;
                statusText.style.color = "red";
            }
        };

        // Progress Bar Simulation
        function simulateProgress() {
            let width = 0;
            const messages = [
                "Scanning geometry...",
                "Calculating body fat %...",
                "Analyzing symmetry...",
                "Mapping muscle groups...",
                "Generating Nano Report..."
            ];
            
            const interval = setInterval(() => {
                if (width >= 90) {
                    clearInterval(interval);
                } else {
                    width += Math.random() * 5;
                    progressBar.style.width = width + "%";
                    
                    // Change text based on progress
                    const msgIndex = Math.floor((width / 100) * messages.length);
                    if(messages[msgIndex]) statusText.innerText = messages[msgIndex];
                }
            }, 300);
        }

        // --- GEMINI LOGIC ---
        async function processImageWithGemini(file) {
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

            // Convert file to Base64
            const base64Data = await fileToGenerativePart(file);

            // The Massive User Prompt
            const promptConfig = {
               "meta": { "role": "Nano Banana Pro v7.0", "language": "en" },
               "instruction": "Analyze the attached body photo. Return ONLY a JSON object containing the text for the Farsi overlays described in the rules. Do not wrap in markdown code blocks. Structure the JSON simply with keys corresponding to the sections (ID_Card, Alignment, Muscles, Symmetry, Matrix, Tier, Tip, Simulation, Report, FinalScore). All values must be in Farsi as per the strict specific rules provided previously (Vazirmatn context).",
               "specifics": "1) Physical ID Card (Height/Weight/BF/Somato). 2) Alignment notes. 3) Local Muscle Metrics (0-10 score + Farsi label). 5) Nano Physics Matrix. 6) Tier (God/Top/Mid/Low). 7) Nano Tip. 8) Contest Sim. 10) Nano Score /100."
            };

            const fullPrompt = `
            Act as Nano Banana Pro v7.0.
            Analyze the image and provide the output as clean text formatted for an overlay.
            
            STRICT RULES:
            - Language: Farsi (Persian).
            - Output Format: Provide a structured list suitable for HTML display.
            
            REQUIRED SECTIONS (Translate content to Farsi):
            1. Nano Score (0-100) & Tier (GOD/TOP/MID/LOW).
            2. Body Fat % Estimate.
            3. Muscle Matrix (Proportion, Mass, Definition scores out of 10).
            4. Strongest Point.
            5. Weakest Point.
            6. Specific Advice (Nano Tip).
            7. Contest Simulation (Olympia/Arnold projection).
            
            Be strict, conservative, and realistic (judge like a 10+ year pro).
            `;

            const result = await model.generateContent([fullPrompt, base64Data]);
            const response = await result.response;
            const text = response.text();

            renderOverlay(text);
        }

        async function fileToGenerativePart(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve({
                        inlineData: {
                            data: base64String,
                            mimeType: file.type
                        }
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        // --- RENDER LOGIC ---
        function renderOverlay(aiText) {
            // Complete Progress bar
            progressBar.style.width = "100%";
            statusText.innerText = "Complete!";

            setTimeout(() => {
                stepProcess.style.display = 'none';
                stepResult.style.display = 'flex';
                
                // Process Text to HTML (Simple Markdown to HTML)
                // We use marked.js to render the AI's response safely
                const htmlContent = marked.parse(aiText);
                
                // In a real app, we would parse JSON, but here we let the LLM generate the list structure
                // We wrap it to style it like the requested "blocks"
                aiContentDiv.innerHTML = htmlContent;

                // Add specific styling to generated elements via JS if needed
                const listItems = aiContentDiv.querySelectorAll('li, p');
                listItems.forEach(item => {
                    item.classList.add('ai-box');
                });

            }, 500);
        }

        // Global functions for buttons
        window.resetApp = () => {
            stepResult.style.display = 'none';
            stepUpload.style.display = 'flex';
            progressBar.style.width = "0%";
            statusText.innerText = "";
            aiContentDiv.innerHTML = "";
            document.getElementById('fileInput').value = "";
        };

        window.downloadImage = () => {
            const element = document.getElementById("render-target");
            
            // Use html2canvas to capture the div with the image and text
            html2canvas(element, {
                useCORS: true,
                backgroundColor: null,
                scale: 2 // High res
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'nano-banana-pro-analysis.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        };
    </script>
</body>
</html>