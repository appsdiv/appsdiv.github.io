<!doctype html>
<html lang="fa" dir="rtl" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5e9" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Ù†Ø²Ø¯ÛŒÚ© Ù…Ù† â€” Ú©Ø§ÙÙ‡ØŒ Ø±Ø³ØªÙˆØ±Ø§Ù†ØŒ Ù¾Ø§Ø±Ú©â€¦</title>
  <link rel="manifest" id="manifestLink" />
  <style>
    :root{--bg:#0b1220;--card:rgba(20,28,46,.6);--stroke:rgba(255,255,255,.08);--text:#e8eefc;--muted:#a9b6d7;--brand:#0ea5e9;--glass:blur(12px) saturate(140%)}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 100% -10%,rgba(14,165,233,.15),transparent),radial-gradient(1000px 700px at -10% 120%,rgba(34,197,94,.08),transparent),var(--bg);color:var(--text);font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,"Vazirmatn",sans-serif;-webkit-font-smoothing:antialiased}
    .app-header{position:sticky;top:0;z-index:50;backdrop-filter:var(--glass);-webkit-backdrop-filter:var(--glass);background:linear-gradient(180deg,rgba(11,18,32,.75),rgba(11,18,32,.45));border-bottom:1px solid var(--stroke);padding:10px 12px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center}.logo{font-size:26px}.brand h1{font-size:18px;margin:0}.brand small{display:block;color:var(--muted);font-size:12px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn,.select,.input{appearance:none;border:1px solid var(--stroke);background:rgba(255,255,255,.05);color:var(--text);padding:10px 12px;border-radius:10px;font-size:14px;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg, rgba(14,165,233,.9), rgba(14,165,233,.75));border:0}
    #main{max-width:980px;margin:0 auto;padding:14px}
    .status{border:1px dashed var(--stroke);color:var(--muted);padding:10px 12px;border-radius:12px;margin-bottom:12px;background:rgba(255,255,255,.03)}
    .filters{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
    .filters label{border:1px solid var(--stroke);padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.04);font-size:13px;cursor:pointer}
    .cards{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:12px}
    @media (min-width:600px){.cards{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (min-width:900px){.cards{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .card{display:flex;flex-direction:column;overflow:hidden;border-radius:16px;backdrop-filter:var(--glass);-webkit-backdrop-filter:var(--glass);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid var(--stroke);box-shadow:0 24px 60px rgba(2,6,23,.25)}
    .media{position:relative;aspect-ratio:4/3;background:rgba(255,255,255,.03)}.media img{width:100%;height:100%;object-fit:cover;display:block}
    .badge{position:absolute;bottom:10px;left:10px;font-size:12px;padding:6px 8px;border-radius:999px;background:rgba(0,0,0,.45);border:1px solid var(--stroke)}
    .badge.open{background:rgba(16,185,129,.2);border-color:rgba(16,185,129,.45)}.badge.closed{background:rgba(239,68,68,.2);border-color:rgba(239,68,68,.45)}
    .meta{padding:10px 12px;display:flex;flex-direction:column;gap:6px}.name{margin:0;font-size:16px}
    .line{display:flex;gap:6px;color:var(--muted);font-size:13px}.addr,.cats{color:var(--muted);font-size:13px}.sep{opacity:.6}
    .actions{display:flex;gap:8px;padding:10px 12px;padding-top:0;margin-top:-4px}.actions .btn{flex:1;text-align:center}
    .row{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <header class="app-header">
    <div class="brand"><span class="logo">ğŸ“</span><div><h1>Ù†Ø²Ø¯ÛŒÚ© Ù…Ù†</h1><small>Ú©Ø§ÙÙ‡ â€¢ Ø±Ø³ØªÙˆØ±Ø§Ù† â€¢ Ø³Ø±ÙˆÛŒØ³â€ŒØ¨Ù‡Ø¯Ø§Ø´ØªÛŒ â€¢ Ù¾Ø§Ø±Ú© â€¢ Ø¯ÛŒØ¯Ù†ÛŒâ€ŒÙ‡Ø§</small></div></div>
    <div class="controls">
      <button id="locBtn" class="btn primary">ØªØ´Ø®ÛŒØµ Ù…ÙˆÙ‚Ø¹ÛŒØª</button>
      <select id="sortSelect" class="select" title="Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ"><option value="distance">Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ†</option><option value="rating">Ø§Ù…ØªÛŒØ§Ø²</option></select>
      <button id="refreshBtn" class="btn">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
    </div>
  </header>

  <main id="main">
    <section id="statusBar" class="status">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø±ÙˆÛŒ Â«ØªØ´Ø®ÛŒØµ Ù…ÙˆÙ‚Ø¹ÛŒØªÂ» Ø¨Ø²Ù†.</section>

    <section id="filters" class="filters">
      <label><input type="checkbox" data-q="cafe" checked> Ú©Ø§ÙÙ‡</label>
      <label><input type="checkbox" data-q="restaurant" checked> Ø±Ø³ØªÙˆØ±Ø§Ù†</label>
      <label><input type="checkbox" data-q="toilet restroom wc" checked> Ø³Ø±ÙˆÛŒØ³â€ŒØ¨Ù‡Ø¯Ø§Ø´ØªÛŒ</label>
      <label><input type="checkbox" data-q="park" checked> Ù¾Ø§Ø±Ú©</label>
      <label><input type="checkbox" data-q="attraction landmark museum" checked> Ø¯ÛŒØ¯Ù†ÛŒâ€ŒÙ‡Ø§</label>
    </section>

    <section class="row" style="margin-bottom:12px">
      <input id="manualLat" class="input" placeholder="Ø¹Ø±Ø¶ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" inputmode="decimal" style="width:170px">
      <input id="manualLng" class="input" placeholder="Ø·ÙˆÙ„ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" inputmode="decimal" style="width:170px">
      <button id="useManual" class="btn">Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…Ø®ØªØµØ§Øª Ø¯Ø³ØªÛŒ</button>
    </section>

    <section id="cards" class="cards"></section>
  </main>

  <footer class="app-footer" style="opacity:.75;color:#a9b6d7;text-align:center;padding:20px 12px">
    <span>Â© 2025 â€¢ Ù†Ø³Ø®Ù‡ Ø³Ø¨Ú© PWA â€” iPhone Ready</span>
  </footer>

  <template id="cardTpl">
    <article class="card">
      <div class="media"><img loading="lazy" alt="" /><span class="badge open-state"></span></div>
      <div class="meta">
        <h3 class="name"></h3>
        <div class="line"><span class="rating"></span><span class="sep">â€¢</span><span class="distance"></span></div>
        <div class="addr"></div><div class="cats"></div>
      </div>
      <div class="actions"><a class="btn directions" target="_blank" rel="noopener">Ù…Ø³ÛŒØ±</a></div>
    </article>
  </template>

  <script type="module">
    // ---------- Manifest in-memory ----------
    const manifest = {"name":"Ù†Ø²Ø¯ÛŒÚ© Ù…Ù†","short_name":"Ù†Ø²Ø¯ÛŒÚ© Ù…Ù†","dir":"rtl","lang":"fa","display":"standalone","start_url":".","background_color":"#0b1220","theme_color":"#0ea5e9","icons":[]};
    const manifestBlob = new Blob([JSON.stringify(manifest)], {type: "application/manifest+json"});
    document.getElementById("manifestLink").href = URL.createObjectURL(manifestBlob);

    // ---------- Service Worker (network-first) ----------
    const swCode = `self.addEventListener('install',e=>self.skipWaiting());self.addEventListener('activate',e=>e.waitUntil(self.clients.claim()));self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request).catch(()=>caches.match(e.request)))})`;
    if ('serviceWorker' in navigator) {
      const swUrl = URL.createObjectURL(new Blob([swCode], {type:'text/javascript'}));
      navigator.serviceWorker.register(swUrl).catch(()=>{});
    }

    // ---------- API key (light obfuscation; not security) ----------
    function decodeKey(){return "NYPKSWBVLNHHUONKGQ3J2KEMQGMOWLP05XNBGR23OOJ0QEKP";}
    const FSQ_KEY = decodeKey();

    // ---------- UI refs ----------
    const statusBar = document.getElementById('statusBar');
    const cardsEl = document.getElementById('cards');
    const tpl = document.getElementById('cardTpl');
    const locBtn = document.getElementById('locBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const sortSelect = document.getElementById('sortSelect');
    const filterEl = document.getElementById('filters');
    const manualLat = document.getElementById('manualLat');
    const manualLng = document.getElementById('manualLng');
    const useManual = document.getElementById('useManual');

    let userPos = null;
    let placesCache = [];

    // ---------- Helpers ----------
    const setStatus = (msg)=> statusBar.textContent = msg;
    const metersToKm = (m)=> (m<1000? `${m|0} m` : (m/1000).toFixed(m<10000?2:1)+" km");
    const toAppleMaps = (lat,lng,name)=> `maps://?daddr=${lat},${lng}&q=${encodeURIComponent(name||"Destination")}`;
    const toGoogleMaps = (lat,lng,name)=> `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving&dir_action=navigate&destination_place=${encodeURIComponent(name||"Destination")}`;
    const haversine=(a,b,c,d)=>{const R=6371000,toRad=x=>x*Math.PI/180;const dLa=toRad(c-a),dLo=toRad(d-b);const A=Math.sin(dLa/2)**2+Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLo/2)**2;return 2*R*Math.asin(Math.sqrt(A));};

    // ---------- Secure-context checks ----------
    function checkSecure(){
      if (!window.isSecureContext) {
        setStatus("âš ï¸ Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¯Ø± secure context Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø·Ø±ÛŒÙ‚ https ÛŒØ§ http://localhost Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯Ø› file:// Ø¬ÙˆØ§Ø¨ Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.");
        return false;
      }
      return true;
    }

    // ---------- Geolocation (robust) ----------
    function getPositionOnce(){
      return new Promise((resolve, reject)=>{
        if(!navigator.geolocation) return reject(new Error("GPS Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª."));
        navigator.geolocation.getCurrentPosition(
          pos=>resolve(pos.coords),
          err=>reject(err),
          { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
        );
      });
    }
    function watchPositionOnce(){
      return new Promise((resolve, reject)=>{
        if(!navigator.geolocation) return reject(new Error("GPS Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª."));
        const id = navigator.geolocation.watchPosition(
          pos=>{navigator.geolocation.clearWatch(id); resolve(pos.coords);},
          err=>{navigator.geolocation.clearWatch(id); reject(err);},
          { enableHighAccuracy:true, maximumAge:0, timeout:20000 }
        );
      });
    }
    async function getPositionRobust(){
      // race getCurrentPosition with watchPosition fallback
      const p = Promise.race([getPositionOnce(), watchPositionOnce()]);
      return await p;
    }

    // ---------- FSQ API ----------
    async function fsqSearch(ll, query, limit=30, radius=4000){
      const url = new URL("https://api.foursquare.com/v3/places/search");
      url.searchParams.set("ll", ll);
      url.searchParams.set("query", query);
      url.searchParams.set("radius", radius);
      url.searchParams.set("limit", Math.min(limit, 50));
      url.searchParams.set("sort", "DISTANCE");
      const res = await fetch(url, {headers:{Accept:"application/json", Authorization:FSQ_KEY}});
      if(!res.ok) throw new Error("Foursquare search failed");
      const data = await res.json();
      return data.results||[];
    }
    async function fsqDetails(id){
      const res = await fetch(`https://api.foursquare.com/v3/places/${id}`, {headers:{Accept:"application/json", Authorization:FSQ_KEY}});
      return res.ok? res.json(): null;
    }
    async function fsqHours(id){
      const res = await fetch(`https://api.foursquare.com/v3/places/${id}/hours`, {headers:{Accept:"application/json", Authorization:FSQ_KEY}});
      return res.ok? res.json(): null;
    }
    async function fsqPhoto(id){
      const res = await fetch(`https://api.foursquare.com/v3/places/${id}/photos?limit=1`, {headers:{Accept:"application/json", Authorization:FSQ_KEY}});
      if(!res.ok) return null; const arr = await res.json();
      if(!Array.isArray(arr)||!arr.length) return null; const p=arr[0]; return `${p.prefix}360x240${p.suffix}`;
    }
    const uniqById = (arr)=>{const s=new Set();const out=[];for(const x of arr){if(!x.fsq_id||s.has(x.fsq_id)) continue;s.add(x.fsq_id);out.push(x)}return out;};

    async function loadPlaces(){
      if(!userPos) throw new Error("Ù…ÙˆÙ‚Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ù…Ø´Ø®Øµ Ù†ÛŒØ³Øª.");
      const qList = [...filterEl.querySelectorAll('input[type=checkbox]')].filter(ch=>ch.checked).map(ch=>ch.dataset.q);
      if(qList.length===0){ setStatus("Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¯Ø³ØªÙ‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯."); return; }

      setStatus("Ø¯Ø±ÛŒØ§ÙØª Ù†ØªØ§ÛŒØ¬ Ù†Ø²Ø¯ÛŒÚ©â€¦");
      const ll = `${userPos.latitude},${userPos.longitude}`;
      const resArrays = await Promise.allSettled(qList.map(q=>fsqSearch(ll,q,30,4000)));

      let merged=[]; for(const r of resArrays){ if(r.status==="fulfilled") merged=merged.concat(r.value); }
      let unique = uniqById(merged);
      unique.sort((a,b)=>(a.distance??1e9)-(b.distance??1e9));
      const top = unique.slice(0,40);

      setStatus("ØªÚ©Ù…ÛŒÙ„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§â€¦");
      const enriched = await Promise.all(top.map(async p=>{
        const [detail,hours,photo] = await Promise.all([fsqDetails(p.fsq_id), fsqHours(p.fsq_id), fsqPhoto(p.fsq_id)]);
        const rating = detail?.rating ?? null;
        const addr = detail?.location?.formatted_address || p.location?.formatted_address || "";
        const cats = (detail?.categories||p.categories||[]).map(c=>c.name).join("ØŒ ");
        const isOpen = hours?.is_open ?? detail?.hours?.is_open ?? null;
        const name = detail?.name || p.name || "Ø¨Ø¯ÙˆÙ†â€ŒÙ†Ø§Ù…";
        const lat = detail?.geocodes?.main?.latitude ?? p.geocodes?.main?.latitude;
        const lng = detail?.geocodes?.main?.longitude ?? p.geocodes?.main?.longitude;
        const distance = p.distance ?? ((typeof lat==="number"&&typeof lng==="number")? haversine(userPos.latitude,userPos.longitude,lat,lng): null);
        return {id:p.fsq_id,name,rating,addr,cats,isOpen,lat,lng,distance,photo:photo||null};
      }));
      placesCache = enriched.filter(x=>x.lat&&x.lng);
      applySortAndRender();
      setStatus(`${Math.min(placesCache.length,30)} Ù…ÙˆØ±Ø¯ Ù†Ø²Ø¯ÛŒÚ© ÛŒØ§ÙØª Ø´Ø¯.`);
    }

    function applySortAndRender(){
      const mode = sortSelect.value;
      let arr = [...placesCache];
      if(mode==="rating"){
        arr.sort((a,b)=>((typeof b.rating==="number"?b.rating:-1)-(typeof a.rating==="number"?a.rating:-1))||((a.distance??1e9)-(b.distance??1e9)));
      } else {
        arr.sort((a,b)=>(a.distance??1e9)-(b.distance??1e9));
      }
      renderCards(arr.slice(0,30));
    }

    function renderCards(items){
      cardsEl.innerHTML="";
      for(const it of items){
        const n = tpl.content.firstElementChild.cloneNode(true);
        const img = n.querySelector("img");
        const badge = n.querySelector(".open-state");
        n.querySelector(".name").textContent = it.name;
        n.querySelector(".rating").textContent = (typeof it.rating==="number")? `Ø§Ù…ØªÛŒØ§Ø²: ${it.rating.toFixed(1)}` : "Ø§Ù…ØªÛŒØ§Ø²: Ù†Ø§Ù…Ø´Ø®Øµ";
        n.querySelector(".distance").textContent = (typeof it.distance==="number")? `ÙØ§ØµÙ„Ù‡: ${metersToKm(it.distance)}` : "ÙØ§ØµÙ„Ù‡: â€”";
        n.querySelector(".addr").textContent = it.addr || "Ø¢Ø¯Ø±Ø³ Ù†Ø§Ù…Ø´Ø®Øµ";
        n.querySelector(".cats").textContent = it.cats || "";
        if(it.isOpen===true){ badge.textContent="Ø¨Ø§Ø²"; badge.classList.add("badge","open"); }
        else if(it.isOpen===false){ badge.textContent="Ø¨Ø³ØªÙ‡"; badge.classList.add("badge","closed"); }
        else { badge.textContent="Ù†Ø§Ù…Ø´Ø®Øµ"; badge.classList.add("badge"); }
        img.src = it.photo || "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 640 480'><defs><linearGradient id='g' x1='0' x2='1'><stop stop-color='#0ea5e9'/><stop offset='1' stop-color='#0b1220'/></linearGradient></defs><rect width='640' height='480' fill='url(#g)' /><text x='50%' y='52%' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='28' fill='white' opacity='.8'>Ø¨Ø¯ÙˆÙ† Ø¹Ú©Ø³</text></svg>`);
        img.alt = it.name;

        const dir = n.querySelector(".directions");
        const apple = toAppleMaps(it.lat,it.lng,it.name);
        const google = toGoogleMaps(it.lat,it.lng,it.name);
        dir.href = apple;
        dir.addEventListener('click', ()=>{ setTimeout(()=>window.open(google,"_blank","noopener"), 400); });

        cardsEl.appendChild(n);
      }
    }

    // ---------- Events ----------
    locBtn.addEventListener('click', async ()=>{
      if(!checkSecure()) return;
      setStatus("Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ GPSâ€¦ Ø§Ú¯Ø± Ù¾ÛŒØºØ§Ù…ÛŒ Ø¢Ù…Ø¯ Â«AllowÂ» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.");
      try{
        // iOS: ÙÙ‚Ø· Ø¯Ø± ØªØ¹Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø±
        const coords = await getPositionRobust();
        userPos = coords;
        setStatus(`Ù…Ø®ØªØµØ§Øª Ø´Ù…Ø§: ${coords.latitude.toFixed(5)}, ${coords.longitude.toFixed(5)} â€” Ø¯Ø±ÛŒØ§ÙØª Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù†Ø²Ø¯ÛŒÚ©â€¦`);
        await loadPlaces();
      }catch(e){
        console.error(e);
        const code = e.code;
        let msg = "Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ GPS.";
        if(code===1) msg = "Ø§Ø¬Ø§Ø²Ù‡Ù” Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø¯ Ø´Ø¯Ù‡. Ù…Ø³ÛŒØ±: Settings â†’ Safari â†’ Location â†’ Allow/Ask";
        else if(code===2) msg = "Ø§Ù…Ú©Ø§Ù† ØªØ¹ÛŒÛŒÙ† Ù…ÙˆÙ‚Ø¹ÛŒØª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯. Ù„Ø·ÙØ§Ù‹ Location Services Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.";
        else if(code===3) msg = "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ø± Ø´Ø¯. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ù‡ ÙØ¶Ø§ÛŒ Ø¨Ø§Ø²ØªØ± Ø¨Ø±ÙˆÛŒØ¯.";
        setStatus(`âš ï¸ ${msg}`);
      }
    });

    refreshBtn.addEventListener('click', async ()=>{
      if(!userPos){ setStatus("Ø§Ø¨ØªØ¯Ø§ Â«ØªØ´Ø®ÛŒØµ Ù…ÙˆÙ‚Ø¹ÛŒØªÂ» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯ ÛŒØ§ Ù…Ø®ØªØµØ§Øª Ø¯Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯."); return; }
      try{ setStatus("Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†ØªØ§ÛŒØ¬â€¦"); await loadPlaces(); }catch{ setStatus("Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯."); }
    });
    sortSelect.addEventListener('change', applySortAndRender);
    filterEl.addEventListener('change', async ()=>{ if(userPos){ try{ await loadPlaces(); }catch{} } });

    // ÙˆØ±ÙˆØ¯ Ø¯Ø³ØªÛŒ Ù…Ø®ØªØµØ§Øª (Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø§Ø¬Ø§Ø²Ù‡ Ù†Ø¯Ù‡Ø¯)
    useManual.addEventListener('click', async ()=>{
      const lat = parseFloat(manualLat.value), lng = parseFloat(manualLng.value);
      if(isFinite(lat) && isFinite(lng)){
        userPos = {latitude:lat, longitude:lng};
        setStatus(`Ù…Ø®ØªØµØ§Øª Ø¯Ø³ØªÛŒ: ${lat.toFixed(5)}, ${lng.toFixed(5)} â€” Ø¯Ø±ÛŒØ§ÙØª Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù†Ø²Ø¯ÛŒÚ©â€¦`);
        try{ await loadPlaces(); }catch(e){ setStatus("Ø¯Ø±ÛŒØ§ÙØª Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯."); }
      } else {
        setStatus("Ù„Ø·ÙØ§Ù‹ Ù…Ø®ØªØµØ§Øª Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹ 35.6892 Ùˆ 51.3890).");
      }
    });

    // Ù†Ú©ØªÙ‡: ØªÙ„Ø§Ø´ Ø®ÙˆØ¯Ú©Ø§Ø± Ø­Ø°Ù Ø´Ø¯ ØªØ§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙÙ‚Ø· Ø¨Ø§ ØªØ¹Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§Ø´Ø¯ (Ø³Ø§Ø²Ú¯Ø§Ø± Ø¨Ø§ iOS)
  </script>
</body>
</html>
