<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>انتخابگر تاریخ جلالی</title>

    <link
        href="https://cdn.jsdelivr.net/npm/vazirmatn@33.0.3/Vazirmatn-font-face.min.css"
        rel="stylesheet"
    />
    <style>
        /* General Styles */
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .date-input {
            width: 288px;
            max-width: 90%;
            padding: 12px;
            text-align: center;
            font-size: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 8px;
            max-width: 320px;
            width: 100%;
            margin: 16px;
            text-align: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .selectors-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            /* To make layout LTR inside the modal for Year-Month-Day order */
            direction: ltr;
        }

        /* iOS-style Selector Styles */
        .selector-column {
            flex: 1;
            max-width: 80px;
            height: 288px;
            border-radius: 8px;
            background-color: #e5e7eb;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            overflow: hidden;
            position: relative;
        }

        .selector-list {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .selector-item {
            font-size: 1.125rem;
            line-height: 40px;
            height: 40px;
            color: #4b5563;
            opacity: 0.3;
            transition: opacity 0.3s;
            user-select: none;
        }

        .selector-item.selected {
            color: #111827;
            opacity: 1;
            font-weight: 600;
        }

        .selector-highlight {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 40px;
            transform: translateY(-50%);
            border-top: 1px solid #d1d5db;
            border-bottom: 1px solid #d1d5db;
            pointer-events: none;
        }

        /* Button Styles */
        .btn {
            width: 100%;
            color: white;
            padding: 8px 0;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            /* --- Font Fix --- */
            font-family: inherit;
            font-size: 1rem;
            font-weight: 500;
        }

        .btn-confirm {
            background-color: #10b981;
            margin-bottom: 12px;
        }
        .btn-confirm:hover {
            background-color: #059669;
        }

        .btn-close {
            background-color: #ef4444;
        }
        .btn-close:hover {
            background-color: #dc2626;
        }
    </style>
</head>
<body>
    <input
        type="text"
        id="deliveryDate"
        class="date-input"
        placeholder="تاریخ را انتخاب کنید"
        readonly
    />

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            // ===================================================================
            // Jalali Date Conversion Functions (No external library needed)
            // ===================================================================
            function toJalali(gy, gm, gd) {
                const g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
                const gy2 = (gm > 2) ? (gy + 1) : gy;
                let days = 355666 + (365 * gy) + Math.floor((gy2 + 3) / 4) - Math.floor((gy2 + 99) / 100) + Math.floor((gy2 + 399) / 400) + gd + g_d_m[gm - 1];
                let jy = -1595 + (33 * Math.floor(days / 12053));
                days %= 12053;
                jy += 4 * Math.floor(days / 1461);
                days %= 1461;
                if (days > 365) {
                    jy += Math.floor((days - 1) / 365);
                    days = (days - 1) % 365;
                }
                const jm = (days < 186) ? 1 + Math.floor(days / 31) : 7 + Math.floor((days - 186) / 30);
                const jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
                return { jy, jm, jd };
            }

            function getJalaliMonthLength(year, month) {
                if (month <= 6) return 31;
                if (month <= 11) return 30;
                // For Esfand, check for leap year
                const isLeap = ((((year - 474) % 2820) + 512) * 682) % 2816 < 682;
                return isLeap ? 30 : 29;
            }

            // ===================================================================
            // Date Picker Code
            // ===================================================================

            function createDatePickerModal() {
                const modalHTML = `
                <div id="datePickerModal" class="modal-overlay hidden">
                    <div class="modal-content">
                        <div class="selectors-container">
                            <div id="pdp-year" class="selector-column"></div>
                            <div id="pdp-month" class="selector-column"></div>
                            <div id="pdp-day" class="selector-column"></div>
                        </div>
                        <button id="confirmDate" class="btn btn-confirm">تایید</button>
                        <button id="closeModal" class="btn btn-close">بستن</button>
                    </div>
                </div>`;
                document.body.insertAdjacentHTML("beforeend", modalHTML);
            }

            function initializePersianDatePicker(inputId) {
                createDatePickerModal();

                const today = toJalali(new Date().getFullYear(), new Date().getMonth() + 1, new Date().getDate());
                const modal = document.getElementById("datePickerModal");
                const body = document.body;

                const openModal = () => {
                    modal.classList.remove("hidden");
                    body.style.overflow = "hidden";
                };

                const closeModal = () => {
                    modal.classList.add("hidden");
                    body.style.overflow = "";
                };

                function setupEventListeners() {
                    document.getElementById(inputId).addEventListener("click", openModal);
                    document.getElementById("closeModal").addEventListener("click", closeModal);

                    window.addEventListener("click", (event) => {
                        if (event.target === modal) {
                            closeModal();
                        }
                    });

                    document.getElementById("confirmDate").addEventListener("click", () => {
                        const selectedYear = parseInt(yearSelector.getValue());
                        const selectedMonth = parseInt(monthSelector.getValue());
                        const selectedDay = parseInt(daySelector.getValue());

                        const format = (date) => (date < 10 ? `0${date}` : date);
                        
                        document.getElementById(inputId).value = `${selectedYear}/${format(selectedMonth)}/${format(selectedDay)}`;
                        closeModal();
                    });
                }

                class IosSelector {
                    constructor(options) {
                        this.el = document.querySelector(options.el);
                        this.source = options.source;
                        this.selectedIndex = options.selectedIndex || 0;
                        this.itemHeight = 40;
                        this.visibleRows = 7;
                        this.middleIndex = Math.floor(this.visibleRows / 2);
                        this.onChange = options.onChange || function() {};
                        this._init();
                    }

                    _init() {
                        this.el.innerHTML = `<ul class="selector-list">${this.source
                            .map((item) =>`<li class="selector-item">${item.text}</li>`)
                            .join("")}</ul><div class="selector-highlight"></div>`;

                        this.list = this.el.querySelector("ul");
                        this.items = this.el.querySelectorAll("li");
                        this.list.style.transform = `translateY(${(this.middleIndex - this.selectedIndex) * this.itemHeight}px)`;
                        this._attachEvents();
                        this._updateSelection();
                    }

                    _attachEvents() {
                        let startY = 0, scrollStart = 0, isDragging = false;
                        const onStart = (e) => {
                            e.stopPropagation();
                            startY = e.touches ? e.touches[0].clientY : e.clientY;
                            scrollStart = parseFloat(this.list.style.transform.replace("translateY(", "")) || 0;
                            this.list.style.transition = "none";
                            isDragging = true;
                        };
                        const onMove = (e) => {
                            if (!isDragging) return;
                            e.preventDefault();
                            let moveY = (e.touches ? e.touches[0].clientY : e.clientY) - startY;
                            this.list.style.transform = `translateY(${scrollStart + moveY}px)`;
                        };
                        const onEnd = () => {
                            if (!isDragging) return;
                            isDragging = false;
                            this._snap();
                        };
                        const onWheel = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            let currentScroll = parseFloat(this.list.style.transform.replace("translateY(", "")) || 0;
                            this.list.style.transition = "none";
                            this.list.style.transform = `translateY(${currentScroll - e.deltaY}px)`;
                            clearTimeout(this.wheelTimeout);
                            this.wheelTimeout = setTimeout(() => this._snap(), 150);
                        };

                        this.el.addEventListener("mousedown", onStart);
                        document.addEventListener("mousemove", onMove);
                        document.addEventListener("mouseup", onEnd);
                        this.el.addEventListener("wheel", onWheel);
                        this.el.addEventListener("touchstart", onStart, { passive: false });
                        this.el.addEventListener("touchmove", onMove, { passive: false });
                        this.el.addEventListener("touchend", onEnd);
                    }

                    _snap() {
                        let finalScroll = parseFloat(this.list.style.transform.replace("translateY(", "")) || 0;
                        let targetIndex = Math.round((finalScroll - this.middleIndex * this.itemHeight) / -this.itemHeight);
                        this.select(targetIndex);
                    }

                    select(index) {
                        index = Math.max(0, Math.min(index, this.source.length - 1));
                        if (this.selectedIndex !== index) {
                            this.selectedIndex = index;
                            if (this.onChange) {
                                this.onChange();
                            }
                        }
                        this.list.style.transition = "transform 0.3s ease-out";
                        this.list.style.transform = `translateY(${(this.middleIndex - this.selectedIndex) * this.itemHeight}px)`;
                        this._updateSelection();
                    }

                    _updateSelection() {
                        this.items.forEach((item, i) => {
                            item.classList.toggle("selected", i === this.selectedIndex);
                        });
                    }
                    
                    getValue() {
                        return this.source[this.selectedIndex].value;
                    }
                }

                const getRange = (start, end) => Array.from({ length: end - start + 1 }, (_, i) => ({ value: start + i, text: start + i }));
                const getDays = (year, month) => getRange(1, getJalaliMonthLength(year, month));
                const getMonths = () => [
                    "فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", 
                    "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"
                ].map((name, i) => ({ value: i + 1, text: name }));

                const updateDaySelector = () => {
                    const yearValue = parseInt(yearSelector.getValue());
                    const monthValue = parseInt(monthSelector.getValue());
                    const daysInMonth = getDays(yearValue, monthValue);
                    
                    daySelector = new IosSelector({
                        el: "#pdp-day",
                        source: daysInMonth,
                        selectedIndex: Math.min(daySelector.selectedIndex, daysInMonth.length - 1),
                    });
                };

                let yearSelector = new IosSelector({
                    el: "#pdp-year",
                    source: getRange(1300, 1500),
                    selectedIndex: today.jy - 1300,
                    onChange: updateDaySelector
                });

                let monthSelector = new IosSelector({
                    el: "#pdp-month",
                    source: getMonths(),
                    selectedIndex: today.jm - 1,
                    onChange: updateDaySelector
                });

                let daySelector = new IosSelector({
                    el: "#pdp-day",
                    source: getDays(today.jy, today.jm),
                    selectedIndex: today.jd - 1,
                });

                setupEventListeners();
            }

            initializePersianDatePicker("deliveryDate");
        });
    </script>
</body>
</html>