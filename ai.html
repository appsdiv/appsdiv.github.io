<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مشاور تخصصی ایران پودر</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS styles remain the same */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .chat-container { background-color: #ffffff; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); width: 100%; max-width: 600px; display: flex; flex-direction: column; overflow: hidden; height: 85vh; max-height: 800px; }
        .chat-header { background-color: #4f46e5; color: white; padding: 1.5rem; text-align: center; font-size: 1.5rem; font-weight: 600; border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem; }
        .chat-messages { flex-grow: 1; padding: 1.5rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem; background-color: #f9fafb; }
        .message { max-width: 85%; padding: 0.75rem 1rem; border-radius: 1rem; line-height: 1.6; word-wrap: break-word; }
        .message.user { background-color: #e0e7ff; align-self: flex-end; color: #1e3a8a; border-bottom-right-radius: 0.25rem; }
        .message.bot { background-color: #d1fae5; align-self: flex-start; color: #065f46; border-bottom-left-radius: 0.25rem; }
        .chat-input-container { display: flex; padding: 1.5rem; border-top: 1px solid #e5e7eb; background-color: #ffffff; border-bottom-left-radius: 1.5rem; border-bottom-right-radius: 1.5rem; }
        .chat-input { flex-grow: 1; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.75rem; font-size: 1rem; outline: none; transition: border-color 0.2s; text-align: right; }
        .send-button { background-color: #4f46e5; color: white; border: none; padding: 0.75rem 1.25rem; border-radius: 0.75rem; margin-right: 1rem; cursor: pointer; font-size: 1rem; }
        .loading-indicator { display: flex; align-items: center; justify-content: flex-start; padding: 0.75rem 1rem; border-radius: 1rem; background-color: #d1fae5; align-self: flex-start; color: #065f46; }
        .loading-indicator .dot { width: 8px; height: 8px; background-color: #065f46; border-radius: 50%; margin: 0 2px; animation: bounce 0.6s infinite alternate; }
        .loading-indicator .dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-indicator .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-5px); } }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            مشاور تخصصی ایران پودر
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input-container">
            <input type="text" id="user-input" class="chat-input" placeholder="پیام خود را اینجا بنویسید..." />
            <button id="send-button" class="send-button">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script type="module">
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        // --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
        //   !!! توجه بسیار مهم !!!
        //   لطفاً کلید API خود را که از Google AI Studio دریافت کرده‌اید،
        //   در خط زیر به جای "YOUR_API_KEY_HERE" قرار دهید.
        // --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
        const API_KEY = "AIzaSyAZ7tN8EQOBR_Eu1JmQmBBf6x0ObfMjUXc"; 
        
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
        const MAX_RETRIES = 3;

        let chatHistory = [];
        let userInfo = {
            name: null,
            goal: null,
            age: null,
            gender: null,
            height: null,
            weight: null, // New field
            dietActivity: null,
            healthAllergies: null,
            phone: null,
        };
        let conversationState = 'collecting_info';

        const iranPowderProducts = [
             { name: "پروتئین وی ایران پودر", price: "۲,۵۰۰,۰۰۰ تومان", howToUse: "یک پیمانه بعد از تمرین", sideEffects: "در صورت حساسیت به لاکتوز با احتیاط مصرف شود." },
             { name: "گینر ایران پودر", price: "۱,۸۰۰,۰۰۰ تومان", howToUse: "دو پیمانه در روز، بعد از تمرین و به عنوان میان‌وعده", sideEffects: "ممکن است باعث نفخ موقت شود." },
             { name: "کراتین مونوهیدرات ایران پودر", price: "۹۵۰,۰۰۰ تومان", howToUse: "۵ گرم در روز همراه با آب یا آبمیوه", sideEffects: "نیاز به مصرف آب فراوان دارد." },
        ];
        
        const COMPLETION_MESSAGE = "بسیار عالی! به نظر میرسه تمام اطلاعات کلیدی برای تنظیم یک پیشنهاد اولیه رو در اختیار دارم. لطفاً فقط چند لحظه به من فرصت بدید.";

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        function appendMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            const processedText = sender === 'bot' ? text.replace(/ایران پودر/g, '<strong>ایران پودر</strong>') : text;
            messageDiv.innerHTML = processedText;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showLoadingIndicator(text = '') {
            const existingIndicator = document.querySelector('.loading-indicator');
            if (existingIndicator) {
                existingIndicator.innerHTML = text ? `<span>${text}</span>` : `<div class="dot"></div><div class="dot"></div><div class="dot"></div>`;
                return existingIndicator;
            }
            const loadingDiv = document.createElement('div');
            loadingDiv.classList.add('loading-indicator');
            loadingDiv.innerHTML = text ? `<span>${text}</span>` : `<div class="dot"></div><div class="dot"></div><div class="dot"></div>`;
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return loadingDiv;
        }
        
        function removeElement(element) {
            if (element && element.parentNode) {
                element.parentNode.removeChild(element);
            }
        }
        
        async function fetchWithRetry(prompt) {
            for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: chatHistory.concat([{ role: "user", parts: [{ text: prompt }] }]),
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    if (!result.candidates || !result.candidates[0].content.parts[0].text) throw new Error("Invalid API response structure.");
                    const rawResponseText = result.candidates[0].content.parts[0].text;
                    try {
                        return JSON.parse(rawResponseText);
                    } catch (e) {
                        const jsonMatch = rawResponseText.match(/{[\s\S]*}/);
                        if (jsonMatch) return JSON.parse(jsonMatch[0]);
                        throw new Error("JSON rescue failed.");
                    }
                } catch (error) {
                    console.error(`Attempt ${attempt} failed:`, error);
                    if (attempt < MAX_RETRIES) {
                        showLoadingIndicator(`ارتباط ناپایدار است، در حال تلاش مجدد...`);
                        await sleep(attempt * 1500);
                    } else {
                        throw error;
                    }
                }
            }
        }

        async function handleConversation() {
            const messageText = userInput.value.trim();
            if (messageText === '' || API_KEY === "YOUR_API_KEY_HERE") return;

            appendMessage(messageText, 'user');
            userInput.value = '';
            toggleInput(false);

            chatHistory.push({ role: "user", parts: [{ text: messageText }] });
            const loadingIndicator = showLoadingIndicator();

            try {
                const prompt = conversationState === 'collecting_info' 
                    ? createDataCollectionPrompt(messageText) 
                    : createRecommendationPrompt();
                const parsedResponse = await fetchWithRetry(prompt);
                
                removeElement(loadingIndicator);
                
                if (parsedResponse.collectedData) {
                    Object.assign(userInfo, parsedResponse.collectedData);
                }
                
                const botResponseText = parsedResponse.responseText;
                appendMessage(botResponseText, 'bot');
                chatHistory.push({ role: "model", parts: [{ text: botResponseText }] });

                if (botResponseText === COMPLETION_MESSAGE) {
                    conversationState = 'generating_recommendation';
                    await handleConversation();
                }
            } catch (error) {
                removeElement(loadingIndicator);
                console.error("All retry attempts failed:", error);
                appendMessage("متاسفانه در حال حاضر امکان پاسخگویی وجود ندارد. لطفاً چند دقیقه دیگر دوباره تلاش کنید.", 'bot');
            } finally {
                if (conversationState === 'collecting_info') {
                    toggleInput(true);
                }
            }
        }
        
        function createDataCollectionPrompt(userMessage) {
            const neededInfoKey = Object.keys(userInfo).find(key => userInfo[key] === null);
            
            // Map keys to Persian names for the prompt
            const keyToPersian = {
                name: "نام کاربر",
                goal: "هدف تمرینی",
                age: "سن",
                gender: "جنسیت",
                height: "قد",
                weight: "وزن فعلی",
                dietActivity: "رژیم غذایی و سطح فعالیت",
                healthAllergies: "وضعیت سلامتی و حساسیت‌ها",
                phone: "شماره تماس"
            };

            return `
                **شخصیت و ماموریت شما:**
                شما یک **متخصص و مشاور ارشد تغذیه ورزشی** برای برند "ایران پودر" هستید. شما **آرام، با اعتماد به نفس، تحلیلی و بسیار باتجربه** به نظر می‌رسید. ماموریت شما ایجاد یک گفتگوی عمیق و تشخیصی برای درک کامل وضعیت کاربر است.

                **قوانین کلیدی مکالمه:**
                1.  **قانون تک وظیفه‌ای (مهم‌ترین قانون):** در هر نوبت از مکالمه، شما فقط یک وظیفه اصلی دارید. وظیفه شما این است که **فقط یک قطعه از اطلاعات** مورد نیاز را از کاربر بپرسید. هرگز و تحت هیچ شرایطی دو سوال را در یک پیام نپرسید.
                2.  **قانون تشخیصی:** قبل از پرسیدن سوال اصلی خود، به پاسخ قبلی کاربر فکر کنید. اگر پاسخ او کوتاه یا مبهم بود، ابتدا یک سوال عمیق‌تر و مرتبط بپرسید تا آن موضوع شفاف شود و سپس به سراغ وظیفه اصلی خود بروید.
                3.  **قانون شخصی‌سازی:** همیشه کاربر را با نامش (${userInfo.name || ''}) خطاب قرار دهید.
                4.  **قانون پاسخگویی:** اگر کاربر سوالی پرسید (مثلا قیمت)، با دقت پاسخ دهید و سپس به آرامی به مسیر مشاوره بازگردید.
                5.  **قانون تکمیل:** وقتی تمام اطلاعات ضروری (همه موارد به جز شماره تماس) جمع‌آوری شد، پیام ثابت "${COMPLETION_MESSAGE}" را نمایش دهید.

                **اطلاعات و وضعیت فعلی:**
                -   اطلاعاتی که تا الان جمع‌آوری کرده‌اید: ${JSON.stringify(userInfo)}
                -   اطلاعات محصولات ما: ${JSON.stringify(iranPowderProducts)}
                -   پاسخ اخیر کاربر: "${userMessage}"
                -   **وظیفه اصلی شما در این لحظه:** شما باید اطلاعات مربوط به **'${keyToPersian[neededInfoKey]}'** را از کاربر دریافت کنید. یک سوال طبیعی و محاوره‌ای برای پرسیدن این موضوع طراحی کنید.

                **وظیفه و خروجی شما:**
                **مهم:** کل پاسخ شما باید **فقط و فقط** یک آبجکت JSON معتبر باشد و هیچ متنی خارج از آن وجود نداشته باشد.
                {
                  "responseText": "متنی که باید به کاربر نمایش داده شود (فقط یک سوال)",
                  "collectedData": { "key": "value" } 
                }
            `;
        }

        function createRecommendationPrompt() {
             chatHistory = []; 
             return `
                 شما یک مشاور ارشد تغذیه ورزشی برای برند "ایران پودر" هستید و بر اساس یک گفتگوی عمیق، در حال ارائه پیشنهاد نهایی هستید.
                 اطلاعات کامل کاربر: ${JSON.stringify(userInfo)}
                 لیست محصولات موجود: ${JSON.stringify(iranPowderProducts)}
                 **وظیفه و خروجی شما:**
                 1. یک مقدمه کاملا حرفه‌ای خطاب به کاربر (${userInfo.name}) بنویسید و اشاره کنید که این پیشنهاد بر اساس تحلیل دقیق اطلاعاتی است که در گفتگو به دست آمده.
                 2. 1 تا 3 محصول **کاملا مرتبط** را انتخاب کنید و به صورت تحلیلی توضیح دهید که چرا هر محصول برای شرایط خاص این فرد (هدف، سن، وزن، سطح فعالیت و...) مفید است.
                 3. نحوه مصرف و قیمت هر محصول را ذکر کنید.
                 4. در پایان، یک جمع‌بندی تخصصی ارائه دهید و کاربر را برای قدم بعدی راهنمایی کنید.
                 5. **مهم:** کل پاسخ شما باید **فقط و فقط** یک آبجکت JSON معتبر باشد.
                 {
                   "responseText": "توصیه نهایی شما به کاربر",
                   "collectedData": {}
                 }
            `;
        }
        
        function toggleInput(enabled) {
            userInput.disabled = !enabled;
            sendButton.disabled = !enabled;
            if (enabled) userInput.focus();
        }
        
        function startConversation() {
            if (API_KEY === "YOUR_API_KEY_HERE") {
                appendMessage("خطا: کلید API تنظیم نشده است. لطفاً کد را ویرایش کرده و کلید API خود را وارد کنید.", 'bot');
                return;
            }
            const initialMessage = "وقت بخیر. من مشاور تخصصی ایران پودر هستم. برای اینکه بتونم یک برنامه دقیق و شخصی‌سازی شده برای شما آماده کنم، نیاز دارم چند سوال از شما بپرسم. موافقید؟";
            appendMessage(initialMessage, 'bot');
            chatHistory.push({ role: "model", parts: [{ text: initialMessage }] });
            toggleInput(true);
        }

        sendButton.addEventListener('click', handleConversation);
        userInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !userInput.disabled) {
                handleConversation();
            }
        });

        window.onload = startConversation;
    </script>
</body>
</html>