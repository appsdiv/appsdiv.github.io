<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Golden Hours</title>
  <meta name="description" content="Precise golden hour, sunrise/sunset, and twilight times with live countdowns." />
  <meta name="theme-color" content="#0b1220" id="themeColorMeta" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            display: ['Poppins', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'sans-serif']
          }
        }
      }
    }
  </script>

  <style>
    :root {
      --bg-from: #0b1220;
      --bg-to: #000000;
      --text-main: #f1f5f9;
      --text-sub: #94a3b8;
      --card-bg: rgba(255, 255, 255, 0.1);
      --card-border: rgba(255, 255, 255, 0.15);
      --input-bg: rgba(255, 255, 255, 0.1);
      --placeholder: rgba(241, 245, 249, 0.7);
    }
    body {
      font-family: 'Poppins', sans-serif;
      background-image: linear-gradient(180deg, var(--bg-from), var(--bg-to));
      color: var(--text-main);
      text-shadow: 0 1px 3px rgba(0,0,0,0.4);
      transition: background-color 1s ease-in-out;
    }
    .text-sub { color: var(--text-sub); }
    .card {
      background-color: var(--card-bg);
      border-color: var(--card-border);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      transition: background-color 0.5s ease, border-color 0.5s ease, transform 0.3s ease;
    }
    .card:hover { transform: scale(1.02); }
    .search-input { background-color: var(--input-bg); }
    .search-input::placeholder { color: var(--placeholder); }
    .icon {
        display: inline-block;
        width: 1em;
        height: 1em;
        margin-right: 0.5rem;
        vertical-align: -0.125em;
    }
    .phase-highlight {
        background-size: 200% auto;
        color: #fff;
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: text-shine 5s linear infinite;
    }
    @keyframes text-shine {
        to { background-position: 200% center; }
    }
  </style>

  <link rel="icon" href="icons/icon-192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="manifest" href="manifest.webmanifest" />

  <script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://unpkg.com/geo-tz@6.0.1/dist/geo-tz.umd.min.js"></script>
</head>
<body id="appBody" class="min-h-screen font-display">
    <header class="px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-6 h-6"><path fill="currentColor" d="M12 3a9 9 0 0 1 9 9a9 9 0 0 1-9 9a9 9 0 0 1-9-9a9 9 0 0 1 9-9m0 2a7 7 0 0 0-7 7a7 7 0 0 0 7 7a7 7 0 0 0 7-7a7 7 0 0 0-7-7m0 2a5 5 0 0 1 5 5a5 5 0 0 1-5 5a5 5 0 0 1-5-5a5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3a3 3 0 0 0 3 3a3 3 0 0 0 3-3a3 3 0 0 0-3-3Z"/></svg>
            <h1 class="font-semibold tracking-tight text-lg">Golden Hours</h1>
        </div>
        <button id="installBtn" class="hidden text-xs px-3 py-1 rounded-full card hover:bg-white/30">Install</button>
    </header>

    <main class="space-y-4 p-4">
        <section class="grid grid-cols-1 gap-3">
            <div class="flex gap-3">
                <input id="search" type="text" inputmode="search" placeholder="Search for a city or landmark..." class="search-input w-full px-4 py-2 rounded-xl border-0 outline-none" autocomplete="off" />
                <button id="gpsBtn" class="px-4 py-2 rounded-xl card border whitespace-nowrap">Use GPS</button>
            </div>
            <div id="results" class="relative z-20 -mt-2"></div>
            <div class="flex items-center gap-3">
                <input id="datePick" type="date" class="search-input w-full px-4 py-2 rounded-xl border-0" />
                <button id="todayBtn" class="px-4 py-2 rounded-xl card border">Today</button>
            </div>
            <p id="locLine" class="text-sm text-sub text-center"></p>
        </section>

        <section class="rounded-2xl p-4 card border">
            <p class="text-xs uppercase tracking-widest text-sub">Now</p>
            <div class="flex items-baseline justify-between mt-1">
                <h2 id="phaseText" class="text-3xl font-bold transition-colors duration-500">—</h2>
                <p id="timeNow" class="text-sm text-sub transition-colors duration-500 font-semibold">—</p>
            </div>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <div class="rounded-xl p-3 card border">
                    <p class="text-sub">Next Golden Hour</p>
                    <p id="nextGolden" class="text-lg font-semibold">—</p>
                    <p id="goldenCountdown" class="text-sub mt-0.5 transition-colors duration-500">—</p>
                </div>
                <div class="rounded-xl p-3 card border">
                    <p class="text-sub">Next Sunrise / Sunset</p>
                    <p id="nextRiseSet" class="text-lg font-semibold">—</p>
                    <p id="riseSetCountdown" class="text-sub mt-0.5 transition-colors duration-500">—</p>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="rounded-2xl p-4 card border">
                <h3 class="font-semibold flex items-center"><span id="icon-golden"></span>Golden Hour</h3>
                <div class="mt-2 text-sm space-y-1.5">
                    <div class="flex justify-between"><span>Morning start</span><span id="ghAmStart" class="font-semibold">—</span></div>
                    <div class="flex justify-between"><span>Morning end</span><span id="ghAmEnd" class="font-semibold">—</span></div>
                    <div class="flex justify-between"><span>Evening start</span><span id="ghPmStart" class="font-semibold">—</span></div>
                    <div class="flex justify-between"><span>Evening end</span><span id="ghPmEnd" class="font-semibold">—</span></div>
                </div>
            </div>
            <div class="rounded-2xl p-4 card border">
                <h3 class="font-semibold flex items-center"><span id="icon-sun"></span>Sunrise & Sunset</h3>
                <div class="mt-2 text-sm space-y-1.5">
                    <div class="flex justify-between"><span>Sunrise</span><span id="sunrise" class="font-semibold">—</span></div>
                    <div class="flex justify-between"><span>Solar noon</span><span id="solarNoon" class="font-semibold">—</span></div>
                    <div class="flex justify-between"><span>Sunset</span><span id="sunset" class="font-semibold">—</span></div>
                    <div class="flex justify-between"><span>Day length</span><span id="dayLength" class="font-semibold">—</span></div>
                </div>
            </div>
            <div class="rounded-2xl p-4 card border">
                <h3 class="font-semibold flex items-center"><span id="icon-twilight"></span>Twilights</h3>
                <div class="mt-2 text-sm space-y-1.5">
                    <div class="flex justify-between"><span>Civil dawn</span><span id="civilDawn" class="font-semibold">—</span></div>
                    <div class="flex justify-between"><span>Civil dusk</span><span id="civilDusk" class="font-semibold">—</span></div>
                    <div class="flex justify-between"><span>Nautical dawn</span><span id="nautDawn" class="font-semibold">—</span></div>
                    <div class="flex justify-between"><span>Nautical dusk</span><span id="nautDusk" class="font-semibold">—</span></div>
                    <div class="flex justify-between"><span>Astronomical dawn</span><span id="astroDawn" class="font-semibold">—</span></div>
                    <div class="flex justify-between"><span>Astronomical dusk</span><span id="astroDusk" class="font-semibold">—</span></div>
                </div>
            </div>
            <div class="rounded-2xl p-4 card border">
                <h3 class="font-semibold flex items-center"><span id="icon-position"></span>Sun Position (now)</h3>
                <div class="mt-2 text-sm space-y-1.5">
                    <div class="flex justify-between"><span>Altitude</span><span id="altitude" class="font-semibold">—</span></div>
                    <div class="flex justify-between"><span>Azimuth</span><span id="azimuth" class="font-semibold">—</span></div>
                </div>
            </div>
        </section>
    </main>

    <footer class="px-4 py-6 text-center text-xs text-sub">Offline-ready PWA • Data from SunCalc • Geocoding by OpenStreetMap Nominatim</footer>
    
    <script>
    const DateTime = luxon.DateTime;

    // ---- State ----
    let state = {
      lat: null, lon: null, tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
      placeLabel: '',
      date: DateTime.now().setZone(Intl.DateTimeFormat().resolvedOptions().timeZone).toISODate()
    };

    // Restore last selection
    try {
      const saved = JSON.parse(localStorage.getItem('gh_state') || 'null');
      if (saved && saved.lat && saved.lon) state = Object.assign(state, saved);
    } catch (e) { console.error("Could not restore state:", e); }

    const $ = (id) => document.getElementById(id);

    // ---- UI Refs ----
    const appBody = $('appBody');
    const themeMeta = $('themeColorMeta');
    const gpsBtn = $('gpsBtn');
    const search = $('search');
    const results = $('results');
    const datePick = $('datePick');
    const todayBtn = $('todayBtn');
    const phaseText = $('phaseText');

    // Init inputs
    datePick.value = state.date;

    // ---- Themes and Icons ----
    const ICONS = {
        golden: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 9a3 3 0 0 0-3 3a3 3 0 0 0 3 3a3 3 0 0 0 3-3a3 3 0 0 0-3-3m0-4.5c.61 0 1.17.05 1.76.12l-1.42 1.42c-.1-.43-.14-.88-.14-1.34c0-.03 0-.06 0-.1M6.24.86L7.66 2.28c.43-.1.88-.14 1.34-.14c.03 0 .06 0 .1 0L7.68.74C7.2 1 6.75 1 6.24.86M17.76.86c.51.14 1 .36 1.42.68l-1.42 1.42c-.45 0-1-.04-1.34-.14c-.04 0-.07 0-.1 0M3.51 3.51a8.91 8.91 0 0 0-.64 1.55L4.29 6.5c.34-.45.75-.86 1.2-1.2L3.51 3.51M19.07 3.51L17.65 5.3c.45.34.86.75 1.2 1.2l1.42-1.42c-.22-.51-.48-1-.79-1.42M2.14 6.24c-.14.51-.22 1.05-.28 1.55H.44c.05-.61.16-1.2.33-1.76L2.14 6.24M21.53 6.24l1.37 1.37c.17-.56.28-1.15.33-1.76h-1.8c-.06.5-.14 1.04-.28 1.55M23.56 12h-1.8c0 .61-.05 1.17-.12 1.76l1.58 1.58c.2-.54.34-1.1.44-1.68c0-.21.03-.43.03-.66M.44 12c0 .23.01.45.03.66c.1.58.24 1.14.44 1.68l1.58-1.58C2.39 13.17 2.34 12.61 2.34 12H.44M4.93 17.65l-1.42 1.42c.31.31.67.57 1.06.79l1.8-1.8c-.34-.45-.63-.94-.84-1.41M19.07 17.65c-.21.47-.5.96-.84 1.41l1.8 1.8c.39-.22.75-.48 1.06-.79l-1.42-1.42m-1.41-1.8l-1.42 1.42c.45.1.9.14 1.34.14c.04 0 .07 0 .1 0l1.42-1.42c0-.45-.04-.9-.14-1.34M7.68 23.26c.48-.24.93-.54 1.34-.88l-1.42-1.42c-.43.1-.88.14-1.34.14c-.03 0-.06 0-.1 0l1.42 1.42c.04.1.08.17.1.24m8.08 0c.02-.07.06-.14.1-.24l1.42-1.42c-.45 0-1 .04-1.34-.14c-.04 0-.07 0-.1 0l-1.42 1.42c.41.34.86.64 1.34.88Z"/></svg>`,
        sun: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3.55 19.09l1.41 1.41l1.79-1.8l-1.41-1.41l-1.79 1.8M11 22.45h2V19.5h-2v2.95M12 5.5c-3.31 0-6 2.69-6 6s2.69 6 6 6s6-2.69 6-6s-2.69-6-6-6m1.41-1.41l1.8-1.79l1.41 1.41l-1.79 1.8l-1.42-1.42M12 3.5V.55h-2V3.5h2m7.09 3.55l1.41-1.41l1.8 1.79l-1.42 1.42l-1.79-1.8M18.5 13h2.95v-2H18.5v2m-1.55 5.09l1.41 1.41l1.8-1.79l-1.42-1.42l-1.79 1.8M4.91 4.91l1.41-1.41l1.8 1.79l-1.42 1.42L4.91 4.91M1.55 11h2.95v2H1.55v-2Z"/></svg>`,
        twilight: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M22 12a10 10 0 0 0-10-10A10 10 0 0 0 2 12a10 10 0 0 0 10 10a10 10 0 0 0 10-10m-3.9 4.91c-1.37.89-3.09 1.4-4.91 1.4c-4.42 0-8-2.69-8-6c0-1.82.63-3.44 1.69-4.73C6 8.35 6 9.61 6 11c0 3.87 3.13 7 7 7c1.39 0 2.65-.4 3.71-.91l.29.17Z"/></svg>`,
        position: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 0 1 10 10a10 10 0 0 1-10 10A10 10 0 0 1 2 12A10 10 0 0 1 12 2m0 2a8 8 0 0 0-8 8a8 8 0 0 0 8 8a8 8 0 0 0 8-8a8 8 0 0 0-8-8m0 2a6 6 0 0 1 6 6a6 6 0 0 1-6 6a6 6 0 0 1-6-6a6 6 0 0 1 6-6m0 2a4 4 0 0 0-4 4a4 4 0 0 0 4 4a4 4 0 0 0 4-4a4 4 0 0 0-4-4Z"/></svg>`
    };

    const THEMES = {
      golden: { from: '#ffc371', to: '#ff5f6d', themeColor: '#ff9a6d', textMain: '#431407', textSub: '#7f2709', cardBg: 'rgba(255, 255, 255, 0.6)', cardBorder: 'rgba(255, 255, 255, 0.4)' },
      day:    { from: '#89f7fe', to: '#66a6ff', themeColor: '#66a6ff', textMain: '#07325f', textSub: '#1e40af', cardBg: 'rgba(255, 255, 255, 0.7)', cardBorder: 'rgba(255, 255, 255, 0.5)' },
      civil:  { from: '#592c85', to: '#2c3e50', themeColor: '#343063', textMain: '#e0e7ff', textSub: '#c7d2fe', cardBg: 'rgba(255, 255, 255, 0.1)', cardBorder: 'rgba(255, 255, 255, 0.15)' },
      nautical:{ from: '#141e30', to: '#243b55', themeColor: '#1d2a41', textMain: '#dbeafe', textSub: '#93c5fd', cardBg: 'rgba(255, 255, 255, 0.1)', cardBorder: 'rgba(255, 255, 255, 0.15)' },
      astro:  { from: '#0f0c29', to: '#0c162e', themeColor: '#0c1122', textMain: '#eef2ff', textSub: '#a5b4fc', cardBg: 'rgba(255, 255, 255, 0.1)', cardBorder: 'rgba(255, 255, 255, 0.15)' },
      night:  { from: '#0b1220', to: '#000000', themeColor: '#0b1220', textMain: '#f1f5f9', textSub: '#94a3b8', cardBg: 'rgba(255, 255, 255, 0.1)', cardBorder: 'rgba(255, 255, 255, 0.15)' },
    };

    function setTheme(phase) {
        const theme = THEMES[phase] || THEMES.night;
        
        appBody.style.setProperty('--bg-from', theme.from);
        appBody.style.setProperty('--bg-to', theme.to);
        appBody.style.setProperty('--text-main', theme.textMain);
        appBody.style.setProperty('--text-sub', theme.textSub);
        appBody.style.setProperty('--card-bg', theme.cardBg);
        appBody.style.setProperty('--card-border', theme.cardBorder);

        const isLight = phase === 'day' || phase === 'golden';
        appBody.style.setProperty('--placeholder', isLight ? 'rgba(15, 23, 42, 0.7)' : 'rgba(241, 245, 249, 0.7)');
        appBody.style.setProperty('--input-bg', isLight ? 'rgba(255, 255, 255, 0.4)' : 'rgba(0, 0, 0, 0.2)');
        
        phaseText.classList.toggle('phase-highlight', !isLight);
        phaseText.style.backgroundImage = `linear-gradient(to right, ${theme.from}, ${theme.to}, ${theme.from})`;

        themeMeta.setAttribute('content', theme.themeColor);
    }

    function setIcons() {
        $('icon-golden').innerHTML = ICONS.golden;
        $('icon-sun').innerHTML = ICONS.sun;
        $('icon-twilight').innerHTML = ICONS.twilight;
        $('icon-position').innerHTML = ICONS.position;
    }
    setIcons();

    // ---- Logic Functions ----
    function setPlace(lat, lon, label) {
        let tz = state.tz;
        try { tz = (GeoTZ.find(lat, lon) || [])[0] || tz; } catch (e) { console.error("Could not find timezone", e); }
        state = { ...state, lat, lon, tz, placeLabel: label || `${lat.toFixed(4)}, ${lon.toFixed(4)}` };
        localStorage.setItem('gh_state', JSON.stringify(state));
        $('locLine').textContent = `Location: ${state.placeLabel} • Time zone: ${state.tz.replace(/_/g, ' ')}`;
        computeAndRender();
    }

    // Geolocation
    gpsBtn.addEventListener('click', () => {
        if (!navigator.geolocation) return alert('Geolocation not supported');
        navigator.geolocation.getCurrentPosition(pos => {
            const { latitude, longitude } = pos.coords;
            setPlace(latitude, longitude, 'My GPS Location');
        }, err => alert(err.message), { enableHighAccuracy: true, timeout: 10000 });
    });

    // Type-ahead search (OpenStreetMap Nominatim)
    let searchTimer;
    search.addEventListener('input', () => {
        const q = search.value.trim();
        clearTimeout(searchTimer);
        if (q.length < 3) { results.innerHTML = ''; return; }
        searchTimer = setTimeout(async () => {
            try {
                const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&addressdetails=1&limit=5`;
                const res = await fetch(url, { headers: { 'Accept-Language': 'en', 'Referer': location.href } });
                const data = await res.json();
                results.innerHTML = data.length > 0 ? `<div class="rounded-xl overflow-hidden shadow-lg card border">${data.map(row => {
                    const name = row.display_name;
                    return `<button data-lat="${row.lat}" data-lon="${row.lon}" class="w-full text-left px-4 py-2.5 text-sm hover:bg-black/20">${name}</button>`;
                }).join('')}</div>` : '';
            } catch (e) { results.innerHTML = ''; }
        }, 300);
    });

    results.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-lat]');
        if (!btn) return;
        const lat = parseFloat(btn.getAttribute('data-lat'));
        const lon = parseFloat(btn.getAttribute('data-lon'));
        const label = btn.textContent.trim();
        results.innerHTML = '';
        search.value = '';
        setPlace(lat, lon, label);
    });
    document.addEventListener('click', (e) => {
        if (!results.contains(e.target) && e.target !== search) {
            results.innerHTML = '';
        }
    });


    // Date handlers
    todayBtn.addEventListener('click', () => {
        state.date = DateTime.now().setZone(state.tz).toISODate();
        datePick.value = state.date;
        computeAndRender();
    });
    datePick.addEventListener('change', () => {
        state.date = datePick.value;
        computeAndRender();
    });

    // Helpers
    function fmt(dt, withDate = false) {
        if (!dt) return '—';
        return withDate ? dt.toFormat('ccc, dd LLL • HH:mm') : dt.toFormat('HH:mm');
    }
    function fmtLen(ms) {
        if (!isFinite(ms)) return '—';
        const s = Math.round(ms / 1000);
        const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60);
        return `${h}h ${m}m`;
    }
    function fmtCountdown(ms) {
        const neg = ms < 0;
        const t = Math.abs(ms);
        const s = Math.floor(t / 1000) % 60;
        const m = Math.floor(t / 60000) % 60;
        const h = Math.floor(t / 3600000);
        const core = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        return neg ? `−${core}` : core;
    }
    function safeDT(d) {
        if (!d || isNaN(d.getTime())) return null;
        return DateTime.fromJSDate(d).setZone(state.tz);
    }

    function makeTimes(dateISO) {
        if (state.lat == null || state.lon == null) return null;
        const dLocalNoon = DateTime.fromISO(dateISO, { zone: state.tz }).set({ hour: 12 });
        const forSun = new Date(dLocalNoon.toUTC().toMillis());
        const t = SunCalc.getTimes(forSun, state.lat, state.lon);
        const posNow = SunCalc.getPosition(new Date(), state.lat, state.lon);
        return {
            sunrise: safeDT(t.sunrise), solarNoon: safeDT(t.solarNoon), sunset: safeDT(t.sunset),
            goldenAmStart: safeDT(t.sunrise), goldenAmEnd: safeDT(t.goldenHourEnd),
            goldenPmStart: safeDT(t.goldenHour), goldenPmEnd: safeDT(t.sunset),
            civilDawn: safeDT(t.dawn), civilDusk: safeDT(t.dusk),
            nautDawn: safeDT(t.nauticalDawn), nautDusk: safeDT(t.nauticalDusk),
            astroDawn: safeDT(t.nightEnd), astroDusk: safeDT(t.night),
            dayLengthMs: (safeDT(t.sunset) && safeDT(t.sunrise)) ? (t.sunset - t.sunrise) : NaN,
            posNow
        };
    }

    function detectPhase(now, T) {
        if (T.goldenAmStart && now >= T.goldenAmStart && now <= T.goldenAmEnd) return 'golden';
        if (T.goldenPmStart && now >= T.goldenPmStart && now <= T.goldenPmEnd) return 'golden';
        if (T.sunrise && T.sunset && now > T.sunrise && now < T.sunset) return 'day';
        if (T.civilDawn && T.sunrise && now >= T.civilDawn && now < T.sunrise) return 'civil';
        if (T.sunset && T.civilDusk && now > T.sunset && now <= T.civilDusk) return 'civil';
        if (T.nautDawn && T.civilDawn && now >= T.nautDawn && now < T.civilDawn) return 'nautical';
        if (T.civilDusk && T.nautDusk && now > T.civilDusk && now <= T.nautDusk) return 'nautical';
        if (T.astroDawn && T.nautDawn && now >= T.astroDawn && now < T.nautDawn) return 'astro';
        if (T.nautDusk && T.astroDusk && now > T.nautDusk && now <= T.astroDusk) return 'astro';
        return 'night';
    }

    function nextGoldenEvent(now, T, Tnext) {
        const windows = [
            ['Morning golden hour starts', T.goldenAmStart], ['Morning golden hour ends', T.goldenAmEnd],
            ['Evening golden hour starts', T.goldenPmStart], ['Evening golden hour ends', T.goldenPmEnd],
            ['Morning golden hour starts', Tnext.goldenAmStart]
        ].filter(([, dt]) => dt);
        for (const [label, dt] of windows) { if (dt > now) return { label, at: dt }; }
        return { label: 'Morning golden hour', at: Tnext.goldenAmStart };
    }

    function nextRiseSet(now, T, Tnext) {
        const windows = [['Sunrise', T.sunrise], ['Sunset', T.sunset], ['Sunrise', Tnext.sunrise]].filter(([, dt]) => dt);
        for (const [label, dt] of windows) { if (dt > now) return { label, at: dt }; }
        return { label: 'Sunrise', at: Tnext.sunrise };
    }

    function computeAndRender() {
        if (state.lat == null || state.lon == null) {
            $('phaseText').textContent = 'Pick a location';
            return;
        }
        const T = makeTimes(state.date);
        const Tnext = makeTimes(DateTime.fromISO(state.date, { zone: state.tz }).plus({ days: 1 }).toISODate());
        if (!T) return;

        const now = DateTime.now().setZone(state.tz);
        const phase = detectPhase(now, T);
        $('phaseText').textContent = phase.charAt(0).toUpperCase() + phase.slice(1);
        setTheme(phase);

        $('ghAmStart').textContent = fmt(T.goldenAmStart);
        $('ghAmEnd').textContent = fmt(T.goldenAmEnd);
        $('ghPmStart').textContent = fmt(T.goldenPmStart);
        $('ghPmEnd').textContent = fmt(T.goldenPmEnd);
        $('sunrise').textContent = fmt(T.sunrise);
        $('solarNoon').textContent = fmt(T.solarNoon);
        $('sunset').textContent = fmt(T.sunset);
        $('dayLength').textContent = fmtLen(T.dayLengthMs);
        $('civilDawn').textContent = fmt(T.civilDawn);
        $('civilDusk').textContent = fmt(T.civilDusk);
        $('nautDawn').textContent = fmt(T.nautDawn);
        $('nautDusk').textContent = fmt(T.nautDusk);
        $('astroDawn').textContent = fmt(T.astroDawn);
        $('astroDusk').textContent = fmt(T.astroDusk);

        if (T.posNow) {
            const alt = (T.posNow.altitude * 180 / Math.PI);
            const azi = (T.posNow.azimuth * 180 / Math.PI);
            $('altitude').textContent = `${alt.toFixed(2)}°`;
            $('azimuth').textContent = `${(azi + 180).toFixed(2)}°`;
        }

        const ng = nextGoldenEvent(now, T, Tnext);
        $('nextGolden').textContent = `${ng.label} • ${fmt(ng.at, true)}`;
        $('goldenCountdown').dataset.at = ng.at.toMillis();

        const nr = nextRiseSet(now, T, Tnext);
        $('nextRiseSet').textContent = `${nr.label} • ${fmt(nr.at, true)}`;
        $('riseSetCountdown').dataset.at = nr.at.toMillis();
    }

    function tick() {
        if (!state.tz) return;
        const now = DateTime.now().setZone(state.tz);
        $('timeNow').textContent = now.toFormat('ccc, dd LLL yyyy • HH:mm:ss');
        for (const el of [$('goldenCountdown'), $('riseSetCountdown')]) {
            const at = parseInt(el.dataset.at || 'NaN', 10);
            if (isFinite(at)) el.textContent = fmtCountdown(at - now.toMillis());
        }
    }
    
    // ---- Init ----
    setInterval(tick, 1000);
    if (state.lat && state.lon) {
        setPlace(state.lat, state.lon, state.placeLabel);
    } else {
        $('phaseText').textContent = 'Pick a location';
    }

    // ---- PWA ----
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(err => console.error('Service worker registration failed:', err));
    }
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        $('installBtn').classList.remove('hidden');
    });
    $('installBtn').addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt = null;
        }
    });
    </script>
    
    <script type="text/plain" data-filename="sw.js">
    const CACHE_NAME = 'golden-hours-v3';
    const ASSETS = [
      './',
      './index.html',
      './manifest.webmanifest',
      './icons/icon-192.png',
      './icons/icon-512.png',
      'https://cdn.tailwindcss.com',
      'https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.min.js',
      'https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js',
      'https://unpkg.com/geo-tz@6.0.1/dist/geo-tz.umd.min.js',
      'https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap',
      'https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLGT9Z1xlFQ.woff2'
    ];
    self.addEventListener('install', (e) => {
      e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(ASSETS)));
    });
    self.addEventListener('activate', (e) => {
      e.waitUntil(
        caches.keys().then(keys => Promise.all(keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k))))
      );
    });
    self.addEventListener('fetch', (e) => {
      e.respondWith(
        caches.match(e.request).then(cachedResponse => {
          if (cachedResponse) {
            return cachedResponse;
          }
          return fetch(e.request).then(networkResponse => {
            if (networkResponse && networkResponse.status === 200 && e.request.method === 'GET') {
              const clone = networkResponse.clone();
              caches.open(CACHE_NAME).then(cache => cache.put(e.request, clone));
            }
            return networkResponse;
          });
        })
      );
    });
    </script>

    <script type="application/manifest+json" data-filename="manifest.webmanifest">
    {
      "name": "Golden Hours",
      "short_name": "Golden",
      "start_url": "./index.html",
      "display": "standalone",
      "theme_color": "#0b1220",
      "background_color": "#0b1220",
      "icons": [
        { "src": "icons/icon-192.png", "sizes": "192x192", "type": "image/png" },
        { "src": "icons/icon-512.png", "sizes": "512x512", "type": "image/png" }
      ]
    }
    </script>
</body>
</html>