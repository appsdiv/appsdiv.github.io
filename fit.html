<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano Banana Pro v7.0</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/misc/Farsi-digits/Vazirmatn-FD-font-face.css" rel="stylesheet" type="text/css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #050a14;
            --bg-card: #0f172a;
            --primary: #00f3ff;
            --secondary: #d946ef;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Background Gradient */
        body::before {
            content: '';
            position: absolute;
            top: -20%; left: -20%;
            width: 140%; height: 140%;
            background: radial-gradient(circle at 50% 0%, rgba(0, 243, 255, 0.08) 0%, transparent 60%);
            z-index: -1;
            pointer-events: none;
        }

        /* Header */
        header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
        }

        .logo {
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--primary);
            text-transform: uppercase;
            text-shadow: 0 0 15px rgba(0, 243, 255, 0.4);
        }

        .version { font-size: 0.7rem; color: var(--secondary); opacity: 0.9; margin-top: 4px; }

        /* Main Container */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Card Styles */
        .card {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 24px;
            padding: 2px; /* For gradient border trick if needed */
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        /* Step 1: Upload */
        .upload-area {
            height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed rgba(255,255,255,0.1);
            border-radius: 22px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.01);
            position: relative;
        }

        .upload-area:active { background: rgba(0, 243, 255, 0.05); border-color: var(--primary); }
        
        .icon-upload {
            width: 64px; height: 64px;
            margin-bottom: 20px;
            color: var(--primary);
            filter: drop-shadow(0 0 10px rgba(0,243,255,0.3));
        }

        .upload-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            text-align: center;
        }

        .upload-sub { font-size: 0.85rem; color: var(--text-muted); margin-top: 8px; }

        input[type="file"] { display: none; }

        /* Step 2: Processing */
        .processing-view {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            width: 100%;
        }

        .loader-text {
            margin-top: 20px;
            color: var(--primary);
            font-family: monospace;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }

        .progress-container {
            width: 80%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            box-shadow: 0 0 15px var(--primary);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        /* Step 3: Result */
        .result-view {
            display: none;
            width: 100%;
            flex-direction: column;
            gap: 20px;
            animation: fadeIn 0.5s ease;
        }

        .image-wrapper {
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            background: #000;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .generated-img {
            width: 100%;
            height: auto;
            display: block;
            object-fit: cover;
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .btn {
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:active { transform: scale(0.97); }

        .btn-primary {
            background: var(--primary);
            color: #050a14;
            box-shadow: 0 4px 20px rgba(0, 243, 255, 0.2);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.05);
            color: white;
            border: 1px solid rgba(255,255,255,0.1);
        }

        footer {
            margin-top: auto;
            padding: 25px;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-muted);
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .footer-credit span { color: var(--primary); font-weight: 600; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Error Box */
        .error-msg {
            color: #ff4d4d;
            background: rgba(255, 77, 77, 0.1);
            border: 1px solid rgba(255, 77, 77, 0.2);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            margin-top: 10px;
            display: none;
            text-align: center;
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">Nano Banana Pro</div>
        <div class="version">GEMINI 3 PRO PREVIEW | v7.0</div>
    </header>

    <main>
        
        <div class="card" id="stepUpload">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <svg class="icon-upload" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                <div class="upload-text">Upload Physique Photo</div>
                <div class="upload-sub">Supports JPG, PNG (Max 5MB)</div>
                <input type="file" id="fileInput" accept="image/jpeg, image/png, image/webp" onchange="handleFile(event)">
            </div>
            <div id="errorBox" class="error-msg"></div>
        </div>

        <div class="processing-view" id="stepProcess">
            <div style="position: relative;">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="animation: spin 3s linear infinite"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
            </div>
            <div class="loader-text" id="statusText">Initializing Nano Core...</div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>

        <div class="result-view" id="stepResult">
            <div class="image-wrapper">
                <img id="resultImage" class="generated-img" src="" alt="Nano Banana Analysis">
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="resetApp()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Start Again
                </button>
                <button class="btn btn-primary" onclick="downloadImage()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4-4m0 0l-4 4m4-4v12"></path></svg>
                    Save Analysis
                </button>
            </div>
        </div>

    </main>

    <footer>
        <div class="footer-credit">created by <span>peyman</span></div>
    </footer>

    <script>
        // API Configuration
        const API_KEY = "AIzaSyD6GYtr65fA4KR6ixnMZZjudtl_0-BRu0g";
        const MODEL_NAME = "gemini-3-pro-image-preview"; // Nano Banana Pro

        // The Massive Prompt
        const JSON_PROMPT = {
          "meta": {
            "role": "Nano Banana Pro v7.0",
            "mode": "IMAGE_EDIT_OVERLAY_ONLY",
            "language": "en",
            "note": "Edit overlays on the real user photo only. You may replace the background with a simple dark navy field. Do NOT modify body/face pixels.",
            "scoring_policy": {
              "bodyfat_rules": "Estimate Body Fat ONLY from real visual cues. If unsure, pick a realistic mid value, not extremes.",
              "label_rules": "Use ‘weak’ (ضعیف) ONLY if muscle score <4.0. 4–6 → متوسط/نسبتا متوسط, 6–8 → نسبتا قوی/خوب, >8 → قوی/خیلی قوی.",
              "tier_thresholds": "Tier: GOD TIER if Matrix avg ≥8.5 AND BF competition-level; TOP TIER for avg 7.0–8.5; MID TIER for 4.0–7.0; LOW TIER <4.0.",
              "text_language_policy": "ALL visible overlay text, labels and notes on the image must be in Persian (Farsi) using a Vazirmatn-like font and neon cyan/magenta accents. Internal logic may be English."
            }
          },
          "prompt": "Act as «Nano Banana Pro v7.0» in strict IMAGE EDIT OVERLAY ONLY mode. Use the real uploaded user photo as the ONLY body/face source. DO NOT repaint, retouch, reshape, slim, enlarge, beautify or relight body/face. You may ONLY: (1) remove the original background and set a clean dark navy backdrop, and (2) draw infographic overlays. ALL overlay TEXT ON THE IMAGE must be in Farsi. On the edited photo (with dark navy background) add these Farsi overlay blocks: 1) Physical ID Card (Height, Weight, BF%, Somatotype). 2) Alignment & Visual Symmetry lines. 3) Local Muscle Metrics (0-10 gauge) for visible groups. 4) Left-Right Symmetry score. 5) Nano Physics Matrix. 6) Nano Final Tier box (GOD/TOP/MID/LOW). 7) Nano Tip. 8) World-Class Contest Simulation box. 9) Nano Judging Report. 10) Nano Final Score /100. Style: all overlays on the unchanged real body/face, with the new dark navy background, Farsi text in Vazirmatn-like font, thin minimal lines, neon cyan/magenta accents.",
          "negative_prompt": "do not generate a new body or person, no generic fitness model, no stock photo, no AI-drawn character, no face/body replacement, no repainting or retouching of body/face, no smoothing, no slimming, no muscle enhancement, no pose change."
        };

        // DOM Elements
        const stepUpload = document.getElementById('stepUpload');
        const stepProcess = document.getElementById('stepProcess');
        const stepResult = document.getElementById('stepResult');
        const progressBar = document.getElementById('progressBar');
        const statusText = document.getElementById('statusText');
        const resultImage = document.getElementById('resultImage');
        const errorBox = document.getElementById('errorBox');

        async function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Simple Validation
            if (file.size > 5 * 1024 * 1024) {
                showError("File too large. Please upload an image under 5MB.");
                return;
            }

            // Transition UI
            stepUpload.style.display = 'none';
            stepProcess.style.display = 'flex';
            errorBox.style.display = 'none';

            // Start Process
            try {
                const base64Image = await convertToBase64(file);
                startProgress();
                await generateNanoAnalysis(base64Image);
            } catch (error) {
                console.error(error);
                stepProcess.style.display = 'none';
                stepUpload.style.display = 'block';
                showError("Analysis Failed: " + error.message);
            }
        }

        function convertToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = (error) => reject(error);
            });
        }

        async function generateNanoAnalysis(base64Data) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;

            const payload = {
                contents: [
                    {
                        parts: [
                            { text: JSON.stringify(JSON_PROMPT) }, // Pass the logic as text
                            {
                                inline_data: {
                                    mime_type: "image/jpeg",
                                    data: base64Data
                                }
                            }
                        ]
                    }
                ],
                generationConfig: {
                    response_modalities: ["IMAGE"], // Force image only response
                    image_config: {
                        aspect_ratio: "9:16",
                        image_size: "4K" // Nano Banana Pro feature
                    }
                }
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error?.message || "Server Error");
            }

            const data = await response.json();
            
            // Extract Image from Response
            // Note: The API usually returns base64 in inline_data for generated images
            if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts) {
                const parts = data.candidates[0].content.parts;
                const imgPart = parts.find(p => p.inline_data);
                
                if (imgPart) {
                    const finalImageBase64 = imgPart.inline_data.data;
                    const mimeType = imgPart.inline_data.mime_type || "image/png";
                    displayResult(`data:${mimeType};base64,${finalImageBase64}`);
                } else {
                    throw new Error("No image generated.");
                }
            } else {
                throw new Error("Invalid response format.");
            }
        }

        function displayResult(imgSrc) {
            progressBar.style.width = "100%";
            statusText.innerText = "Analysis Complete.";
            
            setTimeout(() => {
                resultImage.src = imgSrc;
                stepProcess.style.display = 'none';
                stepResult.style.display = 'flex';
            }, 500);
        }

        function startProgress() {
            let width = 0;
            const messages = [
                "Scanning Physique Geometry...",
                "Calculating Body Fat %...",
                "Analyzing Muscle Symmetry...",
                "Generating Nano Matrix...",
                "Rendering Farsi Overlays..."
            ];
            
            const interval = setInterval(() => {
                if (width >= 95) {
                    clearInterval(interval);
                } else {
                    width += Math.random() * 2;
                    progressBar.style.width = width + "%";
                    
                    // Update text based on progress stage
                    const stage = Math.floor((width / 100) * messages.length);
                    if(messages[stage]) statusText.innerText = messages[stage];
                }
            }, 200);
        }

        function resetApp() {
            stepResult.style.display = 'none';
            stepUpload.style.display = 'block';
            progressBar.style.width = "0%";
            document.getElementById('fileInput').value = "";
            resultImage.src = "";
            errorBox.style.display = 'none';
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.href = resultImage.src;
            link.download = 'Nano-Banana-Pro-Analysis.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showError(msg) {
            errorBox.innerText = msg;
            errorBox.style.display = 'block';
        }

        // Animation Keyframes
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes spin { 100% { transform: rotate(360deg); } }
        `;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>