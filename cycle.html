<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>ردیاب پریود هوشمند</title>
    <link href="https://cdn.jsdelivr.net/npm/vazirmatn@33.0.3/Vazirmatn-font-face.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --bg-gradient: linear-gradient(170deg, #fdf6f9, #f4f6fc);
            --card-bg: rgba(255, 255, 255, 0.85);
            --text-main: #1d1d1f;
            --text-subtle: #57575c;
            --primary-accent: #e91e63;
            --primary-gradient: linear-gradient(135deg, #e91e63, #c2185b);
            --border-color: rgba(0, 0, 0, 0.08);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
            --font-family: 'Vazirmatn', sans-serif;
        }
        
        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: var(--font-family);
            background: var(--bg-gradient);
            color: var(--text-main);
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            padding: 15px;
            min-height: 100vh;
        }

        /* --- App Header --- */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 10px;
        }
        .app-title { font-size: 1.5rem; font-weight: 800; }
        .settings-btn {
            background: none; border: none; font-size: 1.5rem;
            color: var(--text-subtle); cursor: pointer;
        }

        /* --- Setup View --- */
        .setup-view { padding: 20px; text-align: center; }
        .setup-view h1 { font-size: 1.8rem; margin-bottom: 15px; }
        .setup-view p { font-size: 1.1rem; color: var(--text-subtle); margin-bottom: 40px; }
        .input-group { margin-bottom: 25px; text-align: right; }
        .input-group label {
            font-size: 1rem; font-weight: 500; margin-bottom: 10px;
            display: flex; align-items: center; gap: 10px; color: var(--text-main);
        }
        .input-field {
            width: 100%; padding: 16px; font-size: 1rem;
            border: 1px solid var(--border-color); border-radius: 14px;
            background-color: var(--card-bg); font-family: var(--font-family);
        }
        #startTrackingBtn {
            width: 100%; padding: 18px; font-size: 1.1rem; font-weight: 700;
            color: white; background: var(--primary-gradient);
            border: none; border-radius: 16px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.3);
            transition: all 0.2s ease;
        }
        #startTrackingBtn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(233, 30, 99, 0.4); }

        /* --- Tracker View --- */
        .tracker-view { display: none; flex-direction: column; gap: 20px; animation: fadeIn 0.5s; }
        .progress-card {
            background: var(--card-bg); padding: 25px; border-radius: 24px;
            box-shadow: var(--shadow); display: flex; flex-direction: column;
            align-items: center; gap: 20px; backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .progress-display { position: relative; width: 220px; height: 220px; }
        .progress-svg { transform: rotate(-90deg); }
        .progress-text {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .day-number { font-size: 4.5rem; font-weight: 800; line-height: 1; color: var(--text-main); }
        .day-label { font-size: 1.1rem; font-weight: 500; color: var(--text-subtle); }
        .phase-title { font-size: 1.4rem; font-weight: 600; text-align: center; }

        /* --- Detail Cards --- */
        .details-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .detail-card {
            background: var(--card-bg); padding: 20px; border-radius: 18px;
            animation: slideUp 0.6s ease-out; backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .card-icon { font-size: 1rem; color: var(--primary-accent); width: 30px; height: 30px;
            background-color: #fce4ec; border-radius: 8px; display: grid; place-items: center;
        }
        .card-title { font-size: 1.1rem; font-weight: 600; margin: 0; }
        .card-content p { margin: 0; color: var(--text-subtle); line-height: 1.7; }
        .progress-bar-container { width: 100%; height: 8px; background-color: var(--border-color); border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .progress-bar { height: 100%; width: 0%; background: var(--primary-gradient); border-radius: 4px; transition: width 0.5s ease-out; }
        
        /* --- Settings Panel --- */
        .settings-overlay {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.3);
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease;
            backdrop-filter: blur(5px); z-index: 999;
        }
        .settings-overlay.active { opacity: 1; visibility: visible; }
        .settings-panel {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--bg-gradient); padding: 20px;
            border-radius: 28px 28px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            transform: translateY(100%); transition: transform 0.4s ease-out;
            z-index: 1000;
        }
        .settings-panel.active { transform: translateY(0); }
        .settings-panel h2 { text-align: center; margin-top: 0; margin-bottom: 25px; }
        .settings-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;}
        #saveSettingsBtn, #cancelSettingsBtn { padding: 16px; font-size: 1.1rem; font-weight: 600; border-radius: 14px; border: none; cursor: pointer; }
        #saveSettingsBtn { color: white; background-color: var(--primary-accent); }
        #cancelSettingsBtn { background-color: var(--border-color); }

        /* Animations & Other Helpers */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }

        /* Date Picker Styles */
        /* ... (minified styles from previous version for brevity) ... */
        .modal-overlay{position:fixed;inset:0;background-color:rgba(0,0,0,.5);display:flex;align-items:flex-end;justify-content:center;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s;z-index:1001}.modal-overlay.visible{opacity:1;visibility:visible}.modal-content{background-color:var(--card-bg);border-radius:16px 16px 0 0;width:100%;max-width:480px;text-align:center;box-shadow:0 -5px 25px rgba(0,0,0,.1);transform:translateY(100%);transition:transform .3s ease-out}.modal-overlay.visible .modal-content{transform:translateY(0)}.modal-header{padding:12px 20px;border-bottom:1px solid #e8e8e8;display:flex;justify-content:space-between;align-items:center}.selectors-container{display:flex;justify-content:center;gap:0;padding:20px;direction:ltr}.selector-column{flex:1;height:220px;overflow:hidden;position:relative}.selector-list{position:absolute;width:100%;list-style:none;padding:0;margin:0}.selector-item{font-size:1.25rem;line-height:44px;height:44px;color:var(--text-subtle);user-select:none;transition:color .3s,font-weight .3s}.selector-item.selected{color:var(--text-main);font-weight:500}.selector-highlight{position:absolute;top:50%;left:10px;right:10px;height:44px;transform:translateY(-50%);background-color:rgba(120,120,128,.12);border-radius:8px;pointer-events:none}.btn{background:none;border:none;padding:12px 20px;cursor:pointer;font-family:inherit;font-size:1rem;font-weight:500;border-radius:8px}.btn-confirm{color:var(--primary-accent);font-weight:600}.btn-close{color:#8e8e93}
    </style>
</head>
<body>

    <div class="app-container">
        <header class="app-header">
            <h1 class="app-title">پیام دوره</h1>
            <button class="settings-btn" id="openSettingsBtn"><i class="fa-solid fa-gear"></i></button>
        </header>

        <main id="setupView">
            <div class="setup-view">
                <h1>سلامتی خود را دنبال کنید</h1>
                <p>برای شروع، تاریخ آخرین پریود و طول دوره خود را وارد کنید.</p>
                <div class="input-group">
                    <label for="lastPeriodDate"><i class="fa-solid fa-calendar-day"></i> تاریخ شروع آخرین پریود</label>
                    <input type="text" id="lastPeriodDate" class="input-field" placeholder="انتخاب تاریخ" readonly/>
                </div>
                <div class="input-group">
                    <label for="cycleLength"><i class="fa-solid fa-arrows-rotate"></i> طول معمول چرخه</label>
                    <input type="number" id="cycleLength" class="input-field" value="28" min="15" max="45" />
                </div>
                <button id="startTrackingBtn">شروع ردیابی</button>
            </div>
        </main>
        
        <main id="trackerView" class="tracker-view">
            <div class="progress-card">
                <div class="progress-display">
                    <svg class="progress-svg" viewBox="0 0 100 100">
                        <defs>
                            <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#f8bbd0" />
                                <stop offset="100%" stop-color="#e91e63" />
                            </linearGradient>
                        </defs>
                        <circle cx="50" cy="50" r="45" fill="none" stroke="var(--border-color)" stroke-width="8"></circle>
                        <circle id="progress-circle-fg" cx="50" cy="50" r="45" fill="none" stroke="url(#progressGradient)" stroke-width="8" stroke-linecap="round"></circle>
                    </svg>
                    <div class="progress-text">
                        <span id="progressDayNumber" class="day-number">۱۲</span>
                        <span class="day-label">روز از چرخه</span>
                    </div>
                </div>
                <h2 id="cyclePhaseTitle" class="phase-title">فاز فولیکولی</h2>
            </div>
            <div id="detailsGrid" class="details-grid"></div>
        </main>
    </div>

    <div class="settings-overlay" id="settingsOverlay"></div>
    <div class="settings-panel" id="settingsPanel">
        <h2>تنظیمات</h2>
        <div class="input-group">
            <label for="settingsPeriodDate"><i class="fa-solid fa-calendar-day"></i> تاریخ شروع آخرین پریود</label>
            <input type="text" id="settingsPeriodDate" class="input-field" readonly/>
        </div>
        <div class="input-group">
            <label for="settingsCycleLength"><i class="fa-solid fa-arrows-rotate"></i> طول معمول چرخه</label>
            <input type="number" id="settingsCycleLength" class="input-field" min="15" max="45" />
        </div>
        <div class="settings-buttons">
            <button id="cancelSettingsBtn">انصراف</button>
            <button id="saveSettingsBtn">ذخیره</button>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // ... (Date picker and data code is unchanged and minified for brevity)
        const cycleData=[{},{day:1,phase:"قاعدگی",description:"ریزش پوشش داخلی رحم و آغاز خونریزی؛ معمولاً سطح انرژی پایین است.",bleeding:10,hormones:"استروژن و پروژسترون در پایین‌ترین حد خود قرار دارند.",mood:"ممکن است خلق پایین و تحریک‌پذیری وجود داشته باشد.",energy:2,libido:2,partner:"حمایت، صبوری و درک متقابل اهمیت ویژه‌ای دارد.",pregnancy:0},{day:2,phase:"قاعدگی",description:"ادامه خونریزی؛ سطح انرژی کمی افزایش می‌یابد.",bleeding:8,hormones:"استروژن و پروژسترون همچنان پایین هستند.",mood:"خلق پایین و تحریک‌پذیری ممکن است ادامه داشته باشد.",energy:3,libido:2,partner:"همچنان حمایت و صبوری توصیه می‌شود.",pregnancy:0},{day:3,phase:"قاعدگی",description:"پایان تدریجی خونریزی؛ انرژی و میل جنسی در حال افزایش است.",bleeding:5,hormones:"استروژن و پروژسترون پایین اما رو به افزایش‌اند.",mood:"احتمالاً خلق بهبود می‌یابد اما همچنان حساسیت وجود دارد.",energy:4,libido:3,partner:"حمایت و درک شریک همچنان مؤثر است.",pregnancy:0},{day:4,phase:"قاعدگی",description:"خونریزی بسیار کم. فولیکول‌ها در تخمدان شروع به رشد می‌کنند.",bleeding:2,hormones:"افزایش تدریجی استروژن.",mood:"خلق و انگیزه بهتر می‌شود.",energy:5,libido:4,partner:"تشویق به فعالیت و تجربه‌های مشترک.",pregnancy:1},{day:5,phase:"فولیکولی",description:"بهبود بیشتر انرژی و میل جنسی. پایان خونریزی.",bleeding:0,hormones:"استروژن همچنان در حال افزایش است.",mood:"انگیزه و خلق بهبود یافته.",energy:6,libido:5,partner:"تشویق به فعالیت و تجربه‌های مشترک.",pregnancy:1},{day:6,phase:"فولیکولی",description:"افزایش محسوس انرژی و میل جنسی.",bleeding:0,hormones:"استروژن همچنان افزایش می‌یابد.",mood:"روحیه مثبت‌تر و انگیزه بالاتر.",energy:6,libido:6,partner:"تشویق به فعالیت و تجربه‌های مشترک.",pregnancy:2},{day:7,phase:"فولیکولی",description:"سطح انرژی و میل جنسی بیشتر شده است.",bleeding:0,hormones:"استروژن رو به افزایش است.",mood:"خلق خوب و انگیزه بیشتر.",energy:7,libido:6,partner:"تشویق به فعالیت و تجربه‌های مشترک.",pregnancy:2},{day:8,phase:"فولیکولی",description:"انرژی بالا؛ میل جنسی و روحیه مثبت.",bleeding:0,hormones:"استروژن بالا می‌رود.",mood:"خلق عالی و انگیزه زیاد.",energy:7,libido:7,partner:"تشویق به فعالیت و تجربه‌های مشترک.",pregnancy:3},{day:9,phase:"فولیکولی",description:"روزهای اوج انرژی؛ نزدیک شدن به تخمک‌گذاری.",bleeding:0,hormones:"استروژن به سطح بالایی می‌رسد.",mood:"روحیه بسیار خوب و میل جنسی بیشتر.",energy:8,libido:8,partner:"تشویق به فعالیت و تجربه‌های مشترک.",pregnancy:4},{day:10,phase:"فولیکولی",description:"انرژی و میل جنسی بالا باقی می‌ماند.",bleeding:0,hormones:"استروژن زیاد است.",mood:"روحیه عالی و انگیزه بالا.",energy:8,libido:8,partner:"تشویق به فعالیت و تجربه‌های مشترک.",pregnancy:5},{day:11,phase:"فولیکولی",description:"نزدیک به تخمک‌گذاری؛ انرژی و میل جنسی زیاد.",bleeding:0,hormones:"استروژن در سطح بالا.",mood:"انگیزه و میل جنسی قابل توجه.",energy:9,libido:9,partner:"تشویق به فعالیت و تجربه‌های مشترک.",pregnancy:6},{day:12,phase:"فولیکولی",description:"همچنان انرژی بالا؛ اوج میل جنسی.",bleeding:0,hormones:"استروژن به بیشینه نزدیک می‌شود.",mood:"خلق عالی و انرژی زیاد.",energy:9,libido:9,partner:"تشویق به فعالیت و تجربه‌های مشترک.",pregnancy:7},{day:13,phase:"فولیکولی",description:"آماده شدن برای تخمک‌گذاری؛ انرژی و میل جنسی بالا.",bleeding:0,hormones:"استروژن در بیشترین مقدار.",mood:"انگیزه و میل جنسی بالا.",energy:9,libido:10,partner:"تشویق به فعالیت و تجربه‌های مشترک.",pregnancy:8},{day:14,phase:"فولیکولی",description:"بالاترین سطح انرژی و میل جنسی.",bleeding:0,hormones:"استروژن در پیک خود است.",mood:"روحیه عالی و انرژی زیاد.",energy:10,libido:10,partner:"تشویق به فعالیت و تجربه‌های مشترک.",pregnancy:9},{day:15,phase:"فولیکولی",description:"پایان فاز فولیکولی؛ انرژی و میل جنسی در اوج.",bleeding:0,hormones:"استروژن بسیار بالاست.",mood:"انگیزه و میل جنسی بالا.",energy:10,libido:10,partner:"تشویق به فعالیت و تجربه‌های مشترک.",pregnancy:9},{day:16,phase:"فولیکولی",description:"انتقال به فاز تخمک‌گذاری؛ انرژی بالا.",bleeding:0,hormones:"استروژن بالا؛ آماده تخمک‌گذاری.",mood:"خلق و انرژی زیاد.",energy:10,libido:10,partner:"تشویق به فعالیت و تجربه‌های مشترک.",pregnancy:10},{day:17,phase:"تخمک‌گذاری",description:"اوج باروری؛ میل جنسی در بیشترین حد.",bleeding:0,hormones:"اوج استروژن و افزایش ناگهانی LH که باعث تخمک‌گذاری می‌شود.",mood:"اعتماد به نفس و تمایل به تعامل اجتماعی بالا.",energy:10,libido:10,partner:"ابراز محبت و برنامه‌ریزی فعالیت‌های عاشقانه.",pregnancy:10},{day:18,phase:"لوتئال",description:"آغاز فاز لوتئال؛ انرژی و میل جنسی در سطح بالایی باقی می‌ماند.",bleeding:0,hormones:"افزایش پروژسترون، سپس کاهش در صورت عدم بارداری.",mood:"احتمال تحریک‌پذیری و تغییرات خلقی.",energy:9,libido:9,partner:"حمایت و صبوری در این فاز اهمیت دارد.",pregnancy:8},{day:19,phase:"لوتئال",description:"انرژی کمی کمتر و نشانه‌های پیش از قاعدگی ممکن است ظاهر شوند.",bleeding:0,hormones:"پروژسترون بالا.",mood:"امکان اضطراب یا تغییرات خلقی بیشتر است.",energy:8,libido:8,partner:"حمایت و صبوری توصیه می‌شود.",pregnancy:7},{day:20,phase:"لوتئال",description:"انرژی و میل جنسی کاهش یافته است.",bleeding:0,hormones:"پروژسترون همچنان بالا.",mood:"احتمال تحریک‌پذیری و تغییرات خلقی.",energy:8,libido:7,partner:"حمایت و صبوری توصیه می‌شود.",pregnancy:6},{day:21,phase:"لوتئال",description:"سطح انرژی متوسط؛ شروع علائم پیش از قاعدگی.",bleeding:0,hormones:"پروژسترون بالا.",mood:"احتمال تغییرات خلقی و حساسیت احساسی.",energy:7,libido:6,partner:"حمایت و صبوری توصیه می‌شود.",pregnancy:5},{day:22,phase:"لوتئال",description:"انرژی و میل جنسی روند نزولی دارد.",bleeding:0,hormones:"پروژسترون رو به کاهش است.",mood:"احتمال تحریک‌پذیری بیشتر است.",energy:6,libido:5,partner:"حمایت و صبوری توصیه می‌شود.",pregnancy:4},{day:23,phase:"لوتئال",description:"ادامه کاهش انرژی و احتمال بروز علائم جسمی (مثل نفخ، سردرد).",bleeding:0,hormones:"پروژسترون در حال کاهش است.",mood:"امکان اضطراب یا حساسیت احساسی بیشتر است.",energy:6,libido:4,partner:"حمایت و صبوری توصیه می‌شود.",pregnancy:3},{day:24,phase:"لوتئال",description:"سطح انرژی و میل جنسی کاهش می‌یابد.",bleeding:0,hormones:"پروژسترون پایین می‌آید.",mood:"احتمال بروز علائم پیش از قاعدگی بیشتر است.",energy:5,libido:4,partner:"حمایت و صبوری توصیه می‌شود.",pregnancy:2},{day:25,phase:"لوتئال",description:"انرژی متوسط؛ شروع آمادگی بدن برای قاعدگی جدید.",bleeding:0,hormones:"پروژسترون کاهش یافته است.",mood:"احتمال تغییرات خلقی و حساسیت احساسی وجود دارد.",energy:5,libido:3,partner:"حمایت و صبوری توصیه می‌شود.",pregnancy:1},{day:26,phase:"لوتئال",description:"انرژی کم و آماده شدن برای شروع سیکل جدید.",bleeding:0,hormones:"پروژسترون پایین‌تر شده است.",mood:"خلق ممکن است متغیر باشد.",energy:4,libido:3,partner:"حمایت و صبوری توصیه می‌شود.",pregnancy:1},{day:27,phase:"لوتئال",description:"نزدیک به قاعدگی؛ انرژی و میل جنسی کم است.",bleeding:0,hormones:"پروژسترون نزدیک به پایین‌ترین مقدار است.",mood:"علائم پیش از قاعدگی می‌تواند شدیدتر شود.",energy:3,libido:2,partner:"حمایت و صبوری توصیه می‌شود.",pregnancy:0},{day:28,phase:"لوتئال",description:"آمادگی نهایی برای قاعدگی؛ انرژی پایین است.",bleeding:0,hormones:"پروژسترون بسیار پایین است.",mood:"حساسیت و تحریک‌پذیری ممکن است زیاد باشد.",energy:3,libido:2,partner:"حمایت و صبوری توصیه می‌شود.",pregnancy:0},{day:29,phase:"لوتئال",description:"انرژی پایین و آمادگی کامل برای شروع قاعدگی.",bleeding:0,hormones:"پروژسترون پایین.",mood:"علائم جسمی و خلقی می‌تواند اوج بگیرد.",energy:2,libido:1,partner:"حمایت و صبوری توصیه می‌شود.",pregnancy:0},{day:30,phase:"لوتئال",description:"پایان فاز لوتئال؛ انرژی و میل جنسی پایین‌ترین مقدار است.",bleeding:0,hormones:"پروژسترون به حداقل رسیده است.",mood:"حساسیت و تحریک‌پذیری زیاد است.",energy:2,libido:1,partner:"حمایت و صبوری توصیه می‌شود.",pregnancy:0},{day:31,phase:"لوتئال",description:"روز پایانی؛ بدن آماده شروع دوباره قاعدگی می‌شود.",bleeding:0,hormones:"پروژسترون و استروژن هر دو پایین هستند.",mood:"حساسیت و نوسانات خلقی زیاد است.",energy:1,libido:1,partner:"حمایت و صبوری توصیه می‌شود.",pregnancy:0}]; function toJalali(a,e,t){const n=[0,31,59,90,120,151,181,212,243,273,304,334],o=e>2?a+1:a;let r=355666+365*a+Math.floor((o+3)/4)-Math.floor((o+99)/100)+Math.floor((o+399)/400)+t+n[e-1];let i=-1595+33*Math.floor(r/12053);r%=12053,i+=4*Math.floor(r/1461),r%=1461,r>365&&(i+=Math.floor((r-1)/365),r=(r-1)%365);const l=r<186?1+Math.floor(r/31):7+Math.floor((r-186)/30),s=1+(r<186?r%31:(r-186)%30);return{jy:i,jm:l,jd:s}}function getJalaliMonthLength(a,e){return e<=6?31:e<=11?30:((a-474)%2820+512)*682%2816<682?30:29}function createDatePickerModal(){const a=`<div id="datePickerModal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><button id="closeModal" class="btn btn-close">انصراف</button><button id="confirmDate" class="btn btn-confirm">تایید</button></div><div class="selectors-container"><div id="pdp-year" class="selector-column"></div><div id="pdp-month" class="selector-column"></div><div id="pdp-day" class="selector-column"></div></div></div></div>`;document.body.insertAdjacentHTML("beforeend",a)}function initializePersianDatePicker(a){createDatePickerModal();const e=toJalali(new Date().getFullYear(),new Date().getMonth()+1,new Date().getDate()),t=document.getElementById("datePickerModal"),n=()=>t.classList.add("visible"),o=()=>t.classList.remove("visible");function r(){document.getElementById(a).addEventListener("click",n),document.getElementById("settingsPeriodDate").addEventListener("click",n),document.getElementById("closeModal").addEventListener("click",o),t.addEventListener("click",a=>{a.target===t&&o()}),document.getElementById("confirmDate").addEventListener("click",()=>{const t=parseInt(i.getValue()),n=parseInt(l.getValue()),r=parseInt(s.getValue()),d=a=>(a<10?"0":"")+a,c=document.getElementById(a),g=document.getElementById("settingsPeriodDate");c&&(c.value=`${t}/${d(n)}/${d(r)}`,c.dataset.jalaliDate=`${t}-${n}-${r}`),g&&(g.value=`${t}/${d(n)}/${d(r)}`,g.dataset.jalaliDate=`${t}-${n}-${r}`),o()})}class d{constructor(a){this.el=document.querySelector(a.el),this.source=a.source,this.itemHeight=44,this.middleIndex=2,this.onChange=a.onChange||function(){},this._init(a.selectedIndex||0)}_init(a){this.el.innerHTML=`<ul class="selector-list">${this.source.map(a=>`<li class="selector-item">${a.text}</li>`).join("")}</ul><div class="selector-highlight"></div>`,this.list=this.el.querySelector("ul"),this.items=this.el.querySelectorAll("li"),this.select(a,!1),this._attachEvents()}_attachEvents(){let a=0,e=0,t=!1;const n=(n=>{n.stopPropagation(),a=n.touches?n.touches[0].clientY:n.clientY,e=parseFloat(this.list.style.transform.replace("translateY(",""))||0,this.list.style.transition="none",t=!0}),o=(n=>{if(!t)return;n.preventDefault();let o=(n.touches?n.touches[0].clientY:n.clientY)-a;this.list.style.transform=`translateY(${e+o}px)`}),r=(()=>{"-version"===this.el.id?console.log(this.source[this.selectedIndex].text):t&&(t=!1,this._snap())});this.el.addEventListener("mousedown",n),document.addEventListener("mousemove",o),document.addEventListener("mouseup",r),this.el.addEventListener("touchstart",n,{passive:!1}),this.el.addEventListener("touchmove",o,{passive:!1}),this.el.addEventListener("touchend",r)}_snap(){let a=parseFloat(this.list.style.transform.replace("translateY(",""))||0,e=Math.round((a-this.middleIndex*this.itemHeight)/-this.itemHeight);this.select(e)}select(a,e=!0){a=Math.max(0,Math.min(a,this.source.length-1));const t=this.selectedIndex!==a;this.selectedIndex=a,this.list.style.transition="transform 0.2s ease-out",this.list.style.transform=`translateY(${(this.middleIndex-this.selectedIndex)*this.itemHeight}px)`,this.items.forEach((e,t)=>{e.classList.toggle("selected",t===a)}),t&&e&&this.onChange()}updateSource(a){this.source=a,this.list.innerHTML=this.source.map(a=>`<li class="selector-item">${a.text}</li>`).join(""),this.items=this.el.querySelectorAll("li");const e=Math.min(this.selectedIndex,this.source.length-1);this.select(e,!1)}getValue(){return this.source[this.selectedIndex].value}}const c=(a,e)=>Array.from({length:e-a+1},(_,t)=>({value:a+t,text:a+t})),g=(a,e)=>c(1,getJalaliMonthLength(a,e)),p=()=>[{value:1,text:"فروردین"},{value:2,text:"اردیبهشت"},{value:3,text:"خرداد"},{value:4,text:"تیر"},{value:5,text:"مرداد"},{value:6,text:"شهریور"},{value:7,text:"مهر"},{value:8,text:"آبان"},{value:9,text:"آذر"},{value:10,text:"دی"},{value:11,text:"بهمن"},{value:12,text:"اسفند"}],u=()=>{const a=parseInt(i.getValue()),e=parseInt(l.getValue());s.updateSource(g(a,e))};let i=new d({el:"#pdp-year",source:c(1390,e.jy+1),selectedIndex:e.jy-1390,onChange:u}),l=new d({el:"#pdp-month",source:p(),selectedIndex:e.jm-1,onChange:u}),s=new d({el:"#pdp-day",source:g(e.jy,e.jm),selectedIndex:e.jd-1});r()}
        initializePersianDatePicker("lastPeriodDate");
        
        // --- NEW APP LOGIC ---

        const dom = {
            setupView: document.getElementById('setupView'),
            trackerView: document.getElementById('trackerView'),
            startTrackingBtn: document.getElementById('startTrackingBtn'),
            openSettingsBtn: document.getElementById('openSettingsBtn'),
            settingsOverlay: document.getElementById('settingsOverlay'),
            settingsPanel: document.getElementById('settingsPanel'),
            saveSettingsBtn: document.getElementById('saveSettingsBtn'),
            cancelSettingsBtn: document.getElementById('cancelSettingsBtn'),
            // Input fields
            lastPeriodDateInput: document.getElementById('lastPeriodDate'),
            cycleLengthInput: document.getElementById('cycleLength'),
            settingsPeriodDateInput: document.getElementById('settingsPeriodDate'),
            settingsCycleLengthInput: document.getElementById('settingsCycleLength'),
            // Tracker display
            progressCircleFg: document.getElementById('progress-circle-fg'),
            progressDayNumber: document.getElementById('progressDayNumber'),
            cyclePhaseTitle: document.getElementById('cyclePhaseTitle'),
            detailsGrid: document.getElementById('detailsGrid'),
        };

        const appState = {
            startDate: null,
            cycleLength: 28,
        };

        // --- HELPER FUNCTIONS ---
        const toPersianDigits = str => {
            if (str === null || str === undefined) return '';
            const persian = { '0': '۰', '1': '۱', '2': '۲', '3': '۳', '4': '۴', '5': '۵', '6': '۶', '7': '۷', '8': '۸', '9': '۹' };
            return str.toString().replace(/[0-9]/g, (w) => persian[w]);
        };
        const jalaliStringToDate = str => {
            const [y, m, d] = str.split('-').map(Number);
            const gYear = y + 621;
            return new Date(Date.UTC(gYear, m + 1, d + 20)); // Adjusted for better accuracy
        };
        const dateDiffInDays = (a, b) => {
            const _MS_PER_DAY = 1000 * 60 * 60 * 24;
            return Math.floor((b - a) / _MS_PER_DAY);
        };
        const getDayData = (dayOfCycle, totalCycleLength) => {
            const MENSTRUAL_DAYS = 4, OVULATION_DAY = Math.max(10, totalCycleLength - 14);
            if (dayOfCycle <= MENSTRUAL_DAYS) return cycleData[dayOfCycle];
            if (dayOfCycle < OVULATION_DAY) {
                const phaseLength = OVULATION_DAY - MENSTRUAL_DAYS - 1, dataStart = 5, dataEnd = 16, dataLength = dataEnd - dataStart + 1;
                const mappedDay = dataStart + Math.round(((dayOfCycle - (MENSTRUAL_DAYS + 1)) / phaseLength) * dataLength);
                return cycleData[Math.min(dataEnd, Math.max(dataStart, mappedDay))];
            }
            if (dayOfCycle === OVULATION_DAY) return cycleData[17];
            if (dayOfCycle > OVULATION_DAY) {
                const dayIntoPhase = dayOfCycle - OVULATION_DAY, phaseLength = totalCycleLength - OVULATION_DAY;
                const dataStart = 18, dataEnd = 31, dataLength = dataEnd - dataStart + 1;
                const mappedDay = dataStart + Math.round((dayIntoPhase / phaseLength) * dataLength);
                return cycleData[Math.min(dataEnd, Math.max(dataStart, mappedDay))];
            }
            return cycleData[1];
        };

        // --- LOCAL STORAGE ---
        const saveSettings = () => {
            const settings = {
                startDate: dom.lastPeriodDateInput.dataset.jalaliDate || dom.settingsPeriodDateInput.dataset.jalaliDate,
                cycleLength: parseInt(dom.cycleLengthInput.value || dom.settingsCycleLengthInput.value, 10)
            };
            localStorage.setItem('periodTrackerSettings', JSON.stringify(settings));
            return settings;
        };

        const loadSettings = () => {
            const settings = localStorage.getItem('periodTrackerSettings');
            return settings ? JSON.parse(settings) : null;
        };

        // --- UI RENDERING ---
        const updateUI = (displayDate = new Date()) => {
            if (!appState.startDate) return;
            const dayDifference = dateDiffInDays(appState.startDate, displayDate);
            const dayOfCycle = (dayDifference % appState.cycleLength) + 1;

            if (dayDifference < 0) return; // Don't display for dates before start

            const data = getDayData(dayOfCycle, appState.cycleLength);
            
            // Progress Circle
            const r = 45;
            const circumference = 2 * Math.PI * r;
            const offset = circumference - (dayOfCycle / appState.cycleLength) * circumference;
            dom.progressCircleFg.style.strokeDasharray = circumference;
            dom.progressCircleFg.style.strokeDashoffset = offset;

            dom.progressDayNumber.textContent = toPersianDigits(dayOfCycle);
            dom.cyclePhaseTitle.textContent = data.phase;

            // Detail Cards
            const renderProgressBar = val => `<div class="progress-bar-container"><div class="progress-bar" style="width: ${val * 10}%"></div></div>`;
            dom.detailsGrid.innerHTML = `
                <div class="detail-card"><div class="card-header"><i class="card-icon fa-solid fa-book-open"></i><h3 class="card-title">توضیحات روز</h3></div><div class="card-content"><p>${data.description}</p></div></div>
                <div class="detail-card"><div class="card-header"><i class="card-icon fa-solid fa-face-smile"></i><h3 class="card-title">وضعیت احساسی</h3></div><div class="card-content"><p>${data.mood}</p></div></div>
                <div class="detail-card"><div class="card-header"><i class="card-icon fa-solid fa-bolt"></i><h3 class="card-title">سطح انرژی</h3></div><div class="card-content">${renderProgressBar(data.energy)}</div></div>
                <div class="detail-card"><div class="card-header"><i class="card-icon fa-solid fa-heart"></i><h3 class="card-title">میل جنسی</h3></div><div class="card-content">${renderProgressBar(data.libido)}</div></div>
                <div class="detail-card"><div class="card-header"><i class="card-icon fa-solid fa-baby"></i><h3 class="card-title">احتمال بارداری</h3></div><div class="card-content">${renderProgressBar(data.pregnancy)}</div></div>
                <div class="detail-card"><div class="card-header"><i class="card-icon fa-solid fa-hand-holding-heart"></i><h3 class="card-title">راهنمایی</h3></div><div class="card-content"><p>${data.partner}</p></div></div>
            `;
        };

        const showTracker = (settings) => {
            appState.startDate = jalaliStringToDate(settings.startDate);
            appState.cycleLength = settings.cycleLength;
            dom.setupView.classList.add('hidden');
            dom.trackerView.classList.remove('hidden');
            dom.trackerView.style.display = 'flex';
        };

        // --- SETTINGS PANEL LOGIC ---
        const toggleSettingsPanel = (show) => {
            if (show) {
                const settings = loadSettings();
                if (settings) {
                    const [y, m, d] = settings.startDate.split('-');
                    dom.settingsPeriodDateInput.value = toPersianDigits(`${y}/${m.padStart(2, '0')}/${d.padStart(2, '0')}`);
                    dom.settingsPeriodDateInput.dataset.jalaliDate = settings.startDate;
                    dom.settingsCycleLengthInput.value = settings.cycleLength;
                }
                dom.settingsOverlay.classList.add('active');
                dom.settingsPanel.classList.add('active');
            } else {
                dom.settingsOverlay.classList.remove('active');
                dom.settingsPanel.classList.remove('active');
            }
        };

        dom.openSettingsBtn.addEventListener('click', () => toggleSettingsPanel(true));
        dom.cancelSettingsBtn.addEventListener('click', () => toggleSettingsPanel(false));
        dom.settingsOverlay.addEventListener('click', () => toggleSettingsPanel(false));
        
        dom.saveSettingsBtn.addEventListener('click', () => {
            const newSettings = {
                startDate: dom.settingsPeriodDateInput.dataset.jalaliDate,
                cycleLength: parseInt(dom.settingsCycleLengthInput.value, 10),
            };
            if (!newSettings.startDate) { alert('لطفا تاریخ را انتخاب کنید.'); return; }

            localStorage.setItem('periodTrackerSettings', JSON.stringify(newSettings));
            appState.startDate = jalaliStringToDate(newSettings.startDate);
            appState.cycleLength = newSettings.cycleLength;
            
            toggleSettingsPanel(false);
            
            // Show status for the selected start date first
            updateUI(appState.startDate);
            
            // After a short delay, revert to today's date
            setTimeout(() => {
                updateUI(new Date());
                dom.app-header.scrollIntoView({ behavior: 'smooth' });
            }, 2500); // 2.5 second delay
        });


        // --- INITIALIZATION ---
        dom.startTrackingBtn.addEventListener('click', () => {
            const settings = saveSettings();
            if (!settings.startDate) { alert('لطفا تاریخ را انتخاب کنید.'); return; }
            showTracker(settings);
            updateUI(new Date());
        });

        const savedSettings = loadSettings();
        if (savedSettings && savedSettings.startDate) {
            showTracker(savedSettings);
            updateUI(new Date());
        } else {
            dom.trackerView.classList.add('hidden');
            dom.setupView.classList.remove('hidden');
        }
    });
    </script>
</body>
</html>